<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="springcloud, springcloud-alibaba, note">
    <meta name="description" content="微服务 SrpingCloud 学习笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>微服务 SrpingCloud 学习笔记 | Qing</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qing</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/solution" class="waves-effect waves-light">

      
      <i class="fas fa-flag" style="zoom: 0.6;"></i>
      
      <span>题解系列</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/solution/leetcode">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Leetcode</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qing</div>
        <div class="logo-desc">
            
            这个人没啥子特点 喜欢一切随缘咯 ( •̀ ω •́ )✧
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-flag"></i>
			
			题解系列
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/solution/leetcode " style="margin-left:75px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:50px" ></i>
			      
		          <span>Leetcode</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/RobertSunq/RobertSunq.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/RobertSunq/RobertSunq.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('哟！你知道密码不？')).toString(CryptoJS.enc.Hex)) {
                alert('好可惜你不知道哎，那只能回到主页咯！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">微服务 SrpingCloud 学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/note/">
                                <span class="chip bg-color">note</span>
                            </a>
                        
                            <a href="/tags/springcloud/">
                                <span class="chip bg-color">springcloud</span>
                            </a>
                        
                            <a href="/tags/springcloud-alibaba/">
                                <span class="chip bg-color">springcloud-alibaba</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/cs-frameworks-tools/" class="post-category">
                                cs-frameworks-tools
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-12
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-08-12
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    34 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="微服务-SrpingCloud-学习笔记"><a href="#微服务-SrpingCloud-学习笔记" class="headerlink" title="微服务 SrpingCloud 学习笔记"></a>微服务 SrpingCloud 学习笔记</h1><blockquote>
<p>说明：</p>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">Spring Cloud</a> : <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobertSunq/springCloud-learn">my code</a>: <a target="_blank" rel="noopener" href="https://github.com/RobertSunq/springCloud-learn">https://github.com/RobertSunq/springCloud-learn</a></p>
<p>本文为早期学习的笔记，所有行文比较混乱，这里只做了简单的格式化。</p>
</blockquote>
<h2 id="springCloud"><a href="#springCloud" class="headerlink" title="springCloud"></a>springCloud</h2><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/springCloud.png" class="" title="springCloud">

<h3 id="Lifecycle——Maven生命周期"><a href="#Lifecycle——Maven生命周期" class="headerlink" title="Lifecycle——Maven生命周期"></a>Lifecycle——Maven生命周期</h3><p><strong>注</strong>：执行 <code>Maven Project</code> 中的生命周期的来管理项目时必须停止运行项目，否则无法对<code>Maven</code>项目进行生命周期的管理，同时注意一个重要的事情，<code>Maven</code>的生命周期在执行过程中有一个非常重要的特点，就是顺序依次自前向后执行，即如果执行<code>compile</code>,那么 <code>clean</code> 和 <code>validate</code>都已经自动执行了！！！</p>
<p><strong>具体的生命周期作用</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Clean</strong></td>
<td>清理</td>
<td>清空项目中的<code>target</code>目录，<code>target</code>是用来存放项目构建后的文件和目录、<code>jar</code>包、<code>war</code>包、编译的<code>class</code>文件，所有都是<code>Maven</code>构建时生成的。</td>
</tr>
<tr>
<td><strong>Validate</strong></td>
<td>验证</td>
<td>验证项目是否正确，所有必要的信息可用。</td>
</tr>
<tr>
<td><strong>Compile</strong></td>
<td>编译</td>
<td>编译<code>Java</code>文件。</td>
</tr>
<tr>
<td><strong>Test</strong></td>
<td>测试</td>
<td>走单元测试的，报错信息处理，报错信息在<code>target</code>里面，<code>console</code>里不会报错。</td>
</tr>
<tr>
<td><strong>Package</strong></td>
<td>打包</td>
<td>将会对项目进行打包。</td>
</tr>
<tr>
<td><strong>verify</strong></td>
<td>验证</td>
<td>对集成测试的结果执行任何检查，以确保满足质量标准。</td>
</tr>
<tr>
<td><strong>install</strong></td>
<td>安装</td>
<td>将打包过的<code>jar</code>包安装到本地<code>Maven</code>仓库，覆盖原来<code>Maven</code>本地仓库中的<code>jar</code>包，用作本地其他项目的依赖项。</td>
</tr>
<tr>
<td><strong>site</strong></td>
<td>发布</td>
<td>生成项目站点文档，将项目站点发布到服务器。</td>
</tr>
<tr>
<td><strong>Deploy</strong></td>
<td>部署</td>
<td>在构建环境中完成，将最终的包复制到远程存储库以与其他开发人员和项目共享。</td>
</tr>
</tbody></table>
<h2 id="Eureka的保护机制"><a href="#Eureka的保护机制" class="headerlink" title="Eureka的保护机制"></a>Eureka的保护机制</h2><p><strong>一句话概括为：某时刻某一个微服务不可用了，Eureka不会立即清理，依旧会对该微服务的信心进行保存</strong> <u>（分布式CAP思想中的AP分支）</u></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/eureka_safe.png" class="" title="eureka_safe">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/eureka_safe00.png" class="" title="eureka_safe00">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/eureka_safe01.png" class="" title="eureka_safe01">

<p>​		<strong>再自我保护模式中，<code>Eureka Server</code>会保护服务注册表中的信息，不再注销任何服务实例</strong>。他的设计哲学就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例。一句话就是：好死不如赖活着。</p>
<p>​		<strong>综上，自我保护模式是一种应对网络异常的安全保护措施。它的哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留）也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定</strong>。</p>
<h2 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h2><p>注：<strong>关于 <code>zookeeper</code> 的集群搭建，目前使用较少，而且在 <code>yml</code> 文件中的配置也是类似，以列表形式写入 <code>zookeeper</code> 的多个地址即可，而且<code>zookeeper</code> 集群，在 <code>hadoop</code>的笔记中也有记录。总而言之，只要配合<code>zookeeper</code>集群，以及<code>yml</code>文件的配置就能完成集群搭建</strong></p>
<h2 id="consul"><a href="#consul" class="headerlink" title="consul"></a>consul</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 以开发模式启动：</span>
consul agent <span class="token operator">-</span>dev
<span class="token comment"># 启动后前端地址：http://localhost:8500/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h2><table>
<thead>
<tr>
<th>组件名</th>
<th>语言</th>
<th>CAP</th>
<th>服务健康检查</th>
<th>对外暴露接口</th>
<th>Spring Cloud集成</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配支持</td>
<td>HTTP</td>
<td>已集成</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>支持</td>
<td>HTTP/DNS</td>
<td>已集成</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>客户端</td>
<td>已集成</td>
</tr>
</tbody></table>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/Theorem00.png" class="" title="Theorem">

<p><strong>最多只能同时较好的满足两个。</strong></p>
<p><code>CAP</code>理论的核心是：一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，因此，根据<code>CAP</code>原理将<code>NoSQL</code>数据库分成了满足<code>CA</code>原则、满足<code>CP</code>原则、满足<code>AP</code>原则三大类：</p>
<p><del><strong><code>CA</code></strong> - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。</del></p>
<p><strong><code>CP</code></strong> - 满足一致性，分区容忍性的系统，通常性能不是特别高。</p>
<p><strong><code>AP</code></strong> - 满足可用性，分区容忍性的系统，通常可能对一致性要求低一点。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/CAP00.png" class="" title="CAP00">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/AP00.png" class="" title="AP00">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/CP00.png" class="" title="CP">

<h2 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h2><p><code>Spring Cloud Ribbon</code>是基于<code>Netflix Ribbon</code>实现的一套客户端   <strong>负载均衡工具</strong>。</p>
<p>简单的说，<code>Ribbon</code>是<code>NetFlix</code>发布的开源项目，主要功能是提供客户端的软件<strong>负载均衡算法和服务调用</strong>。<code>Ribbon</code>客户端组件提供一系列晚上的配置项如链接超时，重试登。简单的说，就是在配置文件中列出<code>Load Balance（LB）</code>后面所有的机器，<code>Ribbon</code>会自动的帮助你基于某种规则（如简单轮询，随机连接等）去连接这些机器。我们很容易使用<code>Ribbon</code>实现自定义的负载均衡算法。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/Rebbon00.png" class="" title="Rebbon00">



<p>核心组件<code>IRule</code>：根据特定算法中从服务列表中选取一个要访问的服务：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># com.netfilx.loadbalancer.RoundRobinRule	轮询</span>
<span class="token comment"># com.netfilx.loadbalancer.RandomRule	随机</span>
<span class="token comment"># com.netfilx.loadbalancer.RetryRule	先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用服务</span>
<span class="token comment"># WeightedResponseTimeRule	对RoundRobinRule的扩展，相应速度越快的实列选择权重越大，越容易被选择</span>
<span class="token comment"># BestAvailableRule	会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</span>
<span class="token comment"># AvailabilityFilteringRule	先过滤故障实例，再选择并发较小的实例</span>
<span class="token comment"># ZoneAvoidanceRule	默认规则，复合判断server所在区域的性能和server的可用性选择服务器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>负载均衡算法：<code>rest</code>接口第几次请求数 <code>%</code> 服务器集群总数量 = 实际调用服务器位置下标， 每次服务重启后<code>rest</code>接口计数从1 开始</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">List<span class="token operator">&lt;</span>ServiceInstance<span class="token operator">&gt;</span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span>getInstances<span class="token punctuation">(</span><span class="token string">"CLOUD-PROVIDER-SERVICE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注：在（<code>spring-cloud-starter-netflix-eureka-server</code>）中已经集成引入了<code>Ribbon</code>。</p>
<h2 id="Hystrix服务降级"><a href="#Hystrix服务降级" class="headerlink" title="Hystrix服务降级"></a>Hystrix服务降级</h2><p><strong>服务降级、服务熔断、接近实时的监控</strong></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/hystrix00.png" class="" title="hystrix00">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/hystrix01.png" class="" title="hystrix01">

<h4 id="服务降级fallback"><a href="#服务降级fallback" class="headerlink" title="服务降级	fallback"></a>服务降级	fallback</h4><p>​		服务器忙，请稍后再试，不让客户端等待并立刻返回一个优化提示	<code>||</code>	正常流程运行存在问题，进行记录，之后根据记录数据进行补救。</p>
<p>​		哪些情况：程序运行异常、超时、服务熔断触发服务降级、线程池/信号量打满也会导致服务降级</p>
<h4 id="服务熔断break"><a href="#服务熔断break" class="headerlink" title="服务熔断	break"></a>服务熔断	break</h4><p>​		当达到最大服务访问后，直接拒绝访问，然后调用服务降级的方法并返回友好提示</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>熔断打开</td>
<td>请求不再进行调用当前服务，内部设置时钟一般为<code>MTTR</code>（平均故障处理时间），当打开时长达到所设时钟则进入版熔断状态</td>
</tr>
<tr>
<td>熔断关闭</td>
<td>熔断关闭不会对服务进行熔断</td>
</tr>
<tr>
<td>熔断半开</td>
<td>部分请求根据规则调用当前服务，如果请求成功且符合规则认为当前服务恢复正常，关闭熔断</td>
</tr>
</tbody></table>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/hystrix02.png" class="" title="hystrix02">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/hystrix03.png" class="" title="hystrix03">

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">"str_fallbackMethod"</span><span class="token punctuation">,</span>
            groupKey <span class="token operator">=</span> <span class="token string">"strGroupCommand"</span><span class="token punctuation">,</span>
            commandKey <span class="token operator">=</span> <span class="token string">"strCommand"</span><span class="token punctuation">,</span>
            threadPoolKey <span class="token operator">=</span> <span class="token string">"strThreadPool"</span><span class="token punctuation">,</span>
            commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 设置隔离策略，THREAD表示线程池   SEMAPHORE：信号池隔离</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.isolation.strategy"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"THREAD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 当隔离策略选择信号池隔离的时候，用来设置信号池的大小（最大并发数）</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.isolation.semaphore.maxConcurrentRequests"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 配置命令执行的超时时间</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.isolation.thread.timeoutInMilliseconds"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 是否启用超时时间</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.timeout.enabled"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 设置超时的时候是否中断</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.isolation.thread.interruptOnTimeout"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 执行被取消的时候是否中断</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"execution.isolation.thread.interruptOnCancel"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 允许方法执行的最大并发数</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"fallback.isolation.semaphore.maxConcurrentRequests"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 服务降级是否启用，是否执行回调函数</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"fallback.enabled"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 是否开启断路器</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.enabled"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置在滚动时间窗种，断路器熔断的最小请求数，例如：默认该值是20的时候，</span>
                    <span class="token comment">// 如果滚动时间窗（默认10秒）内仅收到了19个请求，即使这19个请求都失败了，断路器也不会打开</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.requestVolumeThreshold"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置在滚动时间窗中，表示在滚动时间窗中，器请求数量超过circuitBreaker.requestVolumeThreshold 的情况下，</span>
                    <span class="token comment">// 如果错误请求的百分比超过了50，就把断路器设置为“打开”状态，否则设置为“关闭”状态。</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.errorThresholdPercentage"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 断路器强制打开</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.forceOpen"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 断路器强制关闭</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"circuitBreaker.forceClosed"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 滚动时间窗设置，该时间用于断路器判断健康度时需要手机信息的持续时间</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingStats.timeInMilliseconds"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 滚动时间窗设置，该时间用于断路器判断健康度时，需要收集指标信息的时候会根据设置的时间窗长度拆分成多个“桶”来累计个度量值，</span>
                    <span class="token comment">// 每个“桶”记录了一段时间内的采集指标。比如10秒内拆分成10个“桶”收集这样，所以timeInMilliseconds必须能被numBuckets整除，否则会抛出异常</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingStats.numBuckets"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置对命令执行的延迟石头使用百分位数来跟踪和计算。如果设置为false，那么所有的概要统计东江返回-1</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingPercentile.enabled"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置百分位统计的滚动窗口的持续时间，单位为毫秒</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingPercentile.timeInMilliseconds"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"60000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置百分比统计滚动窗口使用“桶”的数量</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingPercentile.numBuckets"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"60000"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置在执行过程中每个“桶”中保留的最大执行次数。如果在滚动时间窗内发生超过该设定值的执行此说，就从最初的位置重写。</span>
                    <span class="token comment">// 例如，将该值设置为100，滚动窗口为10秒，若在10秒内一个“桶”中发生了500次执行，那么该“桶”中只保留最后的100次执行的统计。</span>
                    <span class="token comment">// 另外，增加该值的大小将会增加内存量的小猴，并增加排序百分位数所需的计算时间。</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.rollingPercentile.bucketSize"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该属性用来设置采集影响断路器状态的健康快照（请求的成功、错误百分比）的间隔等待时间</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"metrics.healthSnapshot.intervalInMilliseconds"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"500"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 是否开启请求缓存</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"requestCache.enabled"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// HystrixCommand的执行和事件是否打印日志到HystrixRequestLog 中</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"requestLog"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            threadPoolProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 该参数用来设置执行命令线程池的核心线程数，该值也就是命令执行的最大并发量</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"coreSize"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该参数用来设置线程池的最大队列大小。当设置为-1时，线程池将使用SynchronousQueue实现的队列，</span>
                    <span class="token comment">// 否则将使用LinkedBlockingQueue 实现的队列</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"maxQueueSize"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"-1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment">// 该参数用来为队列设置拒绝阈值。通过该参数，即使队列没有达到最大值也能拒绝请求。</span>
                    <span class="token comment">// 该参数主要时对LinBlockingQueue 队列的补充，因为LinkedBlockingQueue 队列不能动态修改它的对象大小，</span>
                    <span class="token comment">// 而通过该属性就可以调整拒绝请求的队列大小了。</span>
                    <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"queueSizeRejectionThreshold"</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">"5"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">defaultCommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="服务限流flowlimit"><a href="#服务限流flowlimit" class="headerlink" title="服务限流	flowlimit"></a>服务限流	flowlimit</h4><p>​		秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行</p>
<h4>Hystrix Dashboard</h4>

<p>​		除了隔离以来服务的调用以外，<code>Hystrix</code>还提供了<strong>准实时的调用监控（Hystrix Dashboard）</strong>，<code>Hystrix</code>会秩序地记录所用通过<code>Hystrix</code>发起的请求的执行信息，并以统计报表的形式展示给用户，包括每秒执行多少请求多少成功，多少失败等。<code>Netfix</code>通过<code>Hystrix-metrics-event-stream</code>项目实现了对以上指标的监控。<code>Spring Cloud</code>也提供了<code>Hystrix Dashboard</code>的整合，对健康内容转化成可视化界面。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 注：新版本的Hystrix需要在被监控的主启动类中指定监控路径，否则会提示 Unable to connect to Command Metirc Stream 404</span>
<span class="token comment"># 访问路径：http://localhost:18015/hystrix.stream</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/hystrix04.png" class="" title="hystrix04.png">

<h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><p>​		<code>Gateway</code> 是在<code>Spring</code>生态系统上构建的API网关服务，基于<code>Spring 5</code>，<code>Spring Boot 2</code>和<code>Project Reactor</code>等技术。<code>SpringCloud Gateway</code>是基于<code>WebFlux</code>框架实现的，而<code>WebFlux</code>框架底层则使用了高性能的<code>Reactor</code>模式通信框架<code>Netty</code>。</p>
<p>​		<code>Gateway</code>旨在提供一种简单而有效的方式来对<code>API</code>进行路由，以及提供一些强大的过滤功能，例如：熔断、限流、重试等。目标是提供统一的路由方式且基于<code>Filter</code>链的方式提供了网关基本的功能，例如：安全，监控/指标和限流。同时还支持<code>WebSocket</code></p>
<p>​		<code>Gateway</code>是基于<strong>异步非阻塞模型</strong>上进行开发的，性能方面不需要担心。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway00.png" class="" title="gateway00">

<h3 id="部分新特性"><a href="#部分新特性" class="headerlink" title="部分新特性"></a>部分新特性</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway01.png" class="" title="gateway01">



<p>三大核心：<strong>路由——&gt;断言——&gt;过滤</strong></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway03.png" class="" title="gateway03">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway02.png" class="" title="gateway02">

<h3 id="断言规则"><a href="#断言规则" class="headerlink" title="断言规则"></a>断言规则</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway04.png" class="" title="gateway04">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway06.png" class="" title="gateway06">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway07.png" class="" title="gateway07">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/getaway08.png" class="" title="gateway08">

<h2 id="分布式系统面临的问题"><a href="#分布式系统面临的问题" class="headerlink" title="分布式系统面临的问题"></a>分布式系统面临的问题</h2><h3 id="配置问题"><a href="#配置问题" class="headerlink" title="配置问题"></a>配置问题</h3><p>​		微服务意味着要将单体应用中的业务拆分成一个个自服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息才能运行，所用一套集中式的、动态的配置管理设施是必不可少的。———–	SpringCloud Config 配置中心  为微服务架构中的微服务提供集中化的外部配置支持 配置服务器为<strong>各个不同微服务应用</strong>的所有环境提供了<strong>一个中心化的外部配置</strong>。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config00.png" class="" title="config00">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config01.png" class="" title="config01">

<p><strong>label:分支（branch）</strong></p>
<p><strong>name：服务名</strong></p>
<p><strong>profiles：环境（dev/test/prod）</strong></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config02.png" class="" title="config02">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config03.png" class="" title="config036">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config04.png" class="" title="config04">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config05.png" class="" title="config05">

<p><code>bootstrap.yml</code></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bootstrap00.png" class="" title="bootstrap00">

<h3 id="动态刷新问题"><a href="#动态刷新问题" class="headerlink" title="动态刷新问题"></a>动态刷新问题</h3><blockquote>
<p>由于config Server 项目上是动态更新的，但是，client端的项目中的配置，还是之前的，它不能动态更新，必须重启才行，所以需要开启动态刷新</p>
</blockquote>
<p>1、引入依赖</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!--actuator监控--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、在客户端的<code>boostrap</code>中添加注解</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"># 暴露监控端点
management:
  endpoints:
    web:
      exposure:
        include: "*"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、<code>controller</code>添加刷新注解</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/config06.png" class="" title="config06">

<p>4、同时在需要<code>client</code>端发送一个<code>POST</code>请求进行刷新</p>
<blockquote>
<p>如 <code>curl -X POST "http://localhost:3355/actuator/refresh"</code></p>
</blockquote>
<blockquote>
<p>两个必须：1.必须是 <code>POST</code> 请求，2.请求地址：<a target="_blank" rel="noopener" href="http://localhost:3355/actuator/refresh">http://localhost:3355/actuator/refresh</a></p>
</blockquote>
<p>注意：这里是刷新哪个<code>config client</code> 就像哪个<code>config client</code> 发送相关请求</p>
<p>但是同时又存在一个问题，就是要向每个微服务发送一次<code>POST</code>请求，当微服务数量庞大，又是一个新的问题。同时也为了可以进行广播，一次通知，处处生效，进行大范围的自动刷新。故可采用消息总线。</p>
<h3 id="消息总线-Bus"><a href="#消息总线-Bus" class="headerlink" title="消息总线 Bus"></a>消息总线 Bus</h3><p>支持两种消息代理：<code>RabbitMQ</code>和<code>KafKa</code></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus.png" class="" title="bus">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus00.png" class="" title="bus00">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus01.png" class="" title="bus01.png">

<h4 id="相关环境配置"><a href="#相关环境配置" class="headerlink" title="相关环境配置"></a>相关环境配置</h4><blockquote>
<p>安装<code>RabbitMQ</code>的依赖环境 <code>Erlang</code>  下载地址： <a target="_blank" rel="noopener" href="http://erlang.org/download/otp_win64_21.3.exe">http://erlang.org/download/otp_win64_21.3.exe</a> </p>
<p>安装<code>RabbitMQ</code>   下载地址： <a target="_blank" rel="noopener" href="http://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.14/rabbitmq-server-3.7.14.exe">http://dl.bintray.com/rabbitmq/all/rabbitmq-server/3.7.14/rabbitmq-server-3.7.14.exe</a> </p>
<p>进入 <code>rabbitMQ</code>安装目录的<code>sbin</code>目录下，打开<code>cmd</code>窗口，执行 <code>rabbitmq-plugins enable rabbitmq_management</code></p>
<p>访问		<a target="_blank" rel="noopener" href="http://localhost:15672/">http://localhost:15672/</a>		，输入密码和账号：默认都为 <code>guest</code></p>
</blockquote>
<h4 id="设计思想"><a href="#设计思想" class="headerlink" title="设计思想"></a>设计思想</h4><p>1、利用消息总线触发一个<strong>客户端</strong><code>/bus/refresh</code>，而刷新所有客户端的配置</p>
<p>​		该方案不合适的原因：</p>
<p>​				①	打破了微服务的职责单一性，因为微服务本身是业务模块，它本不应该承担配置刷新的职责。</p>
<p>​				②	破坏了微服务各节点的对等性。</p>
<p>​				③	有一定的局限性。例如，微服务在迁移时，它的网络地址常常会发生变换，此时如果想要做到自动刷新，那会增加更多的修改。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus03.png" class="" title="bus03.png">

<p>2、利用消息总线触发一个<strong>服务端</strong><code>ConfigServer</code>的<code>/bus/refresh</code>端点，而刷新所有客户端的配置</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus02.png" class="" title="bus02">

<p>相关配置完成后，修改文件，向<code>config server</code>发送刷新请求</p>
<blockquote>
<p><code>curl -X POST "http://localhost:3344/actuator/bus-refresh"</code></p>
</blockquote>
<p>注意，之前是向<code>config client</code> 一个个发送请求，但是这次是向 <code>config Server</code> 发送请求，而所有的<code>config client</code> 的配置也都全部更新</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus04.png" class="" title="bus04">

<p>定点通知：</p>
<p>​		指定具体某一个实例生效而不是全部</p>
<blockquote>
<p>​	公式：<code>http://localhost:配置中心的端口号/actuator/bus-refresh/{destination}</code></p>
</blockquote>
<p>​		<code>/bus/refresh</code>请求不再发送到具体的服务实例上，而是发给<code>config server</code>并通过<code>destination</code>参数类指定需要更新配置的服务或实例</p>
<blockquote>
<p><code>curl -X POST "http://localhost:3344/actuator/bus-refresh/config-client:3355"</code>  (服务名+端口号)</p>
</blockquote>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/bus05.png" class="" title="bus05">

<h2 id="消息驱动"><a href="#消息驱动" class="headerlink" title="消息驱动"></a>消息驱动</h2><p>是什么：</p>
<p>​				屏蔽底层消息中间件的差异，降低切换成本，同意消息的编程模型</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/stream00.png" class="" title="stream00">

<p>原理：</p>
<p>​	标准<code>MQ</code>：	</p>
<p>​						1、生产者/消费者之间靠消息媒介传递信息内容——&gt;<code>Message</code></p>
<p>​						2、消息必须走特定的通道——&gt;消息通道<code>MessageChannel</code></p>
<p>​						3、消息通道里的消息如何被消费，谁负责收发处理——&gt;消息通道<code>MessageChannel</code>的子接口<code>SubscribableChannel</code>，由<code>MessageHandler</code>消息处理器所订阅。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/stream01.png" class="" title="stream01">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/stream02.png" class="" title="stream02">

<p><code>Stream</code>中的消息通信方式遵循了发布-订阅模式——<code>Topic</code>主题进行广播——（在<code>RabbitMQ</code>中是<code>Exchange</code>，在<code>Kafka</code>中就是<code>Topic</code>）</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/stream03.png" class="" title="stream03">

<blockquote>
<blockquote>
<p><code>Binder</code>：很方便的连接中间件，屏蔽差异</p>
<p><code>Channel</code>：通道，是队列<code>Queue</code>的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过Channel对队列进行配置</p>
<p><code>Source</code>和<code>Sink</code>：简单的可理解为 参照对象是<code>Spring Cloud Stream</code>自身，从<code>Stream</code>发布消息就是输出，接受消息就是输入。</p>
</blockquote>
</blockquote>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/stream04.png" class="" title="stream04">

<p>注意：在<code>stream</code>中处于同一个<code>group</code>中的多个消费者是竞争关系，就能够保证消息指挥被其中一个应用消费一次。</p>
<p>​			不同组是可以全面消费的（重复消费）。</p>
<p>​			同一组内发生竞争关系，只有其中一个可以消费。</p>
<p>通过分组来解决重复消费的问题</p>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>原理：微服务应用放置于同一个<code>group</code>中，就能够有保证消息只会被其中一个应用消费一次。不同的组是可以消费的，同一个组内会发生竞争关系，只有其中一个可以消费，就可以保证同一个组的多个微服务实例进行抢占，只有一个可以消费。</p>
<h2 id="分布式请求链路跟踪Sleuth"><a href="#分布式请求链路跟踪Sleuth" class="headerlink" title="分布式请求链路跟踪Sleuth"></a>分布式请求链路跟踪Sleuth</h2><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sleuth00.png" class="" title="sleuth00">

<p><code>spring cloud sleuth</code> 提供了一套完成的服务跟踪的解决方案，在分布式系统中提供追踪解决方案并兼容支持了<code>zipkin</code></p>
<p>安装<code>zipkin</code>：</p>
<blockquote>
<p>在官网下载<code>zipkin-xxx.jar</code>后，在<code>cmd</code>中运行该<code>jar</code>包， 输入 &gt;    <code>java - jar zipkin-xxx.jar</code></p>
<p>浏览器中访问：<a target="_blank" rel="noopener" href="http://localhost:9411/zipkin/">http://localhost:9411/zipkin/</a></p>
</blockquote>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sleuth01.png" class="" title="sleuth01">

<p>精简后</p>
<p><code>Trace</code>：类似与树结构的<code>Span</code>集合，表示一条调用链路，存在唯一标识</p>
<p><code>Span</code>：表示调用链路来源，通俗的理解<code>span</code>就是一次请求信息</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sleuth02.png" class="" title="sleuth02">

<h2 id="SpringCloud-Alibaba-入门简介"><a href="#SpringCloud-Alibaba-入门简介" class="headerlink" title="SpringCloud Alibaba 入门简介"></a>SpringCloud Alibaba 入门简介</h2><p>参考文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</a></p>
<p>最新的<code>pom</code>配置：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.5.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p>是什么：一个更易于构建的云原生应用的动态服务发现、配置管理和服务管理平台。即注册中心与配置中心。<code>= Eureka + Config + Bus</code></p>
<p>支持负载均衡</p>
<blockquote>
<p><code>github</code>地址：  <a target="_blank" rel="noopener" href="https://github.com/alibaba/Nacos">https://github.com/alibaba/Nacos</a> </p>
<p><code>Nacos</code> 地址：  <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/">https://nacos.io/zh-cn/</a> </p>
<p>下载地址： <a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/">https://github.com/alibaba/nacos/releases/</a></p>
<p>安装：</p>
<p>​		解压压缩包以后，进入<code>bin</code>目录，打开<code>dos</code>窗口，执行<code>startup.cmd</code></p>
<p>访问地址 ： 【<a target="_blank" rel="noopener" href="http://localhost:8848/nacos/%E3%80%91%E5%9C%B0%E5%9D%80%EF%BC%8C%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E9%83%BD%E6%98%AF%60nacos%60">http://localhost:8848/nacos/】地址，默认账号密码都是`nacos`</a></p>
<p><code>nacos</code>可以切换 <code>AP</code> 和 <code>CP</code> ,使用如下命令切换成<code>CP</code>模式：</p>
<p>​		<code>curl -X PUT '$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP'</code></p>
</blockquote>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos00.png" class="" title="nacos00">

<blockquote>
<p>设置虚拟映射启动：<code>-DServer.port=19002</code></p>
</blockquote>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos01.png" class="" title="nacos01">

<p><strong>强一致性(C)、高可用(A)、分区容错性(P)</strong></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos02.png" class="" title="nacos02">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos03.png" class="" title="nacos03">

<h3 id="为什么配置文件需要-application-yml-和bootstrap-yml-两个"><a href="#为什么配置文件需要-application-yml-和bootstrap-yml-两个" class="headerlink" title="为什么配置文件需要 application.yml 和bootstrap.yml 两个"></a>为什么配置文件需要 application.yml 和bootstrap.yml 两个</h3><p>​		<code>Nacos</code>同<code>Springcloud-config</code>一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常启动，</p>
<p>​		<code>Springboot</code>中配置文件的加载是存在优先级顺序的，<font color="red">bootstrap优先级高于application</font></p>
<h3 id="Nacos中的dataid的组成格式与SpringBoot配置文件中的匹配规则"><a href="#Nacos中的dataid的组成格式与SpringBoot配置文件中的匹配规则" class="headerlink" title="Nacos中的dataid的组成格式与SpringBoot配置文件中的匹配规则"></a>Nacos中的dataid的组成格式与SpringBoot配置文件中的匹配规则</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos04.png" class="" title="nacos04">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos05.png" class="" title="nacos05">

<h3 id="Namespace-Group-Data-ID"><a href="#Namespace-Group-Data-ID" class="headerlink" title="Namespace+Group+Data ID"></a>Namespace+Group+Data ID</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos06.png" class="" title="nacos06">



<p>默认情况：</p>
<p>​		<code>Namespace=public</code>，<code>Group=DEFAULT_GROUP</code>，默认<code>Cluster</code>是<code>DEFAULT</code></p>
<p>​		<code>nacos</code>默认的命名空间是<code>public</code>，<code>Namespace</code>主要是用来实现隔离。</p>
<p>​		<code>Group</code>默认是<code>DEFAULT_GROUP</code>，<code>Group</code>可以把不同的微服务划分到同一个分组里面去。</p>
<p>​		<code>Service</code>就是微服务；一个<code>Service</code>可以包含多个<code>CLuster</code>（集群），<code>Nacos</code>默认<code>Cluster</code>是<code>DEFAULT</code>，<code>Cluster</code>是对指定微服务的一个虚拟划分。</p>
<p>​		最后<code>Instance</code>，就是微服务的实例。</p>
<h3 id="集群版"><a href="#集群版" class="headerlink" title="集群版"></a>集群版</h3> <img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos07.png" class="" title="nacos07">

<p>默认<code>Nacos</code>使用嵌入式数据库实现数据的存储。所以，如果启动多个默认配置下的<code>Nacos</code>节点，数据存储是存在一致性问题的。为了解决这个问题，<code>Nacos</code>采用了<font color="red">集中式存储的方式来支持集群化部署，目前支持MySQL的存储</font>    <em><code>Nacos</code>默认使用其自带的嵌入式数据库<code>Derby</code></em></p>
<p><code>Nacos</code>支持三种部署模式</p>
<ul>
<li>单机模式 - 用于测试和单机试用</li>
<li>集群模式 - 用于生产环境，确保高可用</li>
<li>多集群模式 - 用于多数据中心场景</li>
</ul>
<p><code>Windows</code></p>
<p>​	<code>cmd starup.cmd</code> 或者双击<code>startup.cmd</code>文件</p>
<p><code>linux</code></p>
<p>​	<code>starup.sh</code></p>
<h4 id="单机模式配置持久化配置mysql"><a href="#单机模式配置持久化配置mysql" class="headerlink" title="单机模式配置持久化配置mysql"></a>单机模式配置持久化配置mysql</h4><ul>
<li>1、安装数据库，版本要求：<code>5.6.5+</code></li>
<li>2、初始化<code>mysql</code>数据库，数据库初始化文件：<code>conf/nacos-mysql.sql</code>   </li>
<li>3、修改<code>conf/application.properties</code>文件，增加支持<code>mysql</code>数据源配置（目前只支持<code>mysql</code>），添加<code>mysql</code>数据源的 <code>url</code>、<code>username</code>、<code>password</code><ul>
<li><code>(nacos-mysql.sql</code>、<code>application.properties</code>存在于<code>nacos-server</code>的<code>conf</code>目录)</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.datasource.platform</span><span class="token punctuation">=</span><span class="token attr-value">mysql</span>

<span class="token attr-name">db.num</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">db.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://192.168.1.104:3366/nacos_dev?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span>
<span class="token attr-name">db.user</span><span class="token punctuation">=</span><span class="token attr-value">nacos_dev</span>
<span class="token attr-name">db.password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在以单机模式启动<code>nacos</code>，<code>nacos</code>所有写入嵌入式数据库的数据都写到了<code>mysql</code></p>
<h4 id="集群版配置"><a href="#集群版配置" class="headerlink" title="集群版配置"></a>集群版配置</h4><blockquote>
<p>一台<code>linux</code>虚拟机：<code>nginx</code>服务器，3个<code>nacos</code>服务，一个<code>mysql</code>数据库。</p>
</blockquote>
<blockquote>
<p><code>nginx</code>的安装参考之前学，使用 <code>ContOs7</code> 至少需要安装<code>gcc</code>库，不然无法编译安装【<code>yum install gcc</code>】</p>
</blockquote>
<blockquote>
<p> <code>nacos</code>下载<code>linux</code>版本的 <code>tar.gz</code> 包：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases/download/1.1.4/nacos-server-1.1.4.tar.gz">https://github.com/alibaba/nacos/releases/download/1.1.4/nacos-server-1.1.4.tar.gz</a></p>
</blockquote>
<blockquote>
<p><code>mysql root</code>用户密码为 <code>Dkf!!2020</code></p>
</blockquote>
<ol>
<li><p>首先对 <code>nacos</code> 进行持久化操作，步骤类似单机版</p>
</li>
<li><p>对集群进行梳理</p>
<ul>
<li>修改 <code>nacos/conf</code> 下的<code>cluster</code>文件，最好复制一份进行备份，添加如下内容:</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># it is ip</span>
<span class="token comment"># example</span>
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.105</span><span class="token punctuation">:</span><span class="token number">3333</span>
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.105</span><span class="token punctuation">:</span><span class="token number">4444</span>
<span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.105</span><span class="token punctuation">:</span><span class="token number">5555</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>模拟三台<code>nacos</code>服务，编辑<code>nacos</code>的<code>startup</code>启动脚本，使其能够支持不同的端口启动多次</p>
<ul>
<li><p><code>nacos/bin</code> 目录下有<code>startup.sh</code>，单机版启动直接执行即可，但是集群启动，我们希望可以类似其他软件的<code>shell</code>命令，<font color="red">传递不同的端口号启动不同的nacos实例</font>。</p>
</li>
<li><p>命令：<code>./startup.sh -p 3333</code> 就表示启动端口号为<code>3333</code>的<code>nacos</code>服务器实例，故需进行配置<code>./startup.sh</code></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos08.png" class="" title="nacos08"></li>
</ul>
</li>
</ol>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos09.png" class="" title="nacos09">

<ol start="4">
<li><p><code>Nginx</code>的配置，由它作为负载均衡器</p>
<ul>
<li>修改<code>nginx</code>的配置文件</li>
</ul>
<p><code>/usr/local/nginx/conf/nigix.conf</code></p>
<ul>
<li><p><code>nginx.conf</code></p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos10.png" class="" title="nacos10">
</li>
<li><p>按照指定启动</p>
<blockquote>
<p><code>./nginx -c /usr/local/nginx/conf/nginx.conf</code></p>
</blockquote>
</li>
</ul>
</li>
</ol>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/nacos11.png" class="" title="nacos11.png">

<h2 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h2><p>与<code>Hystrix</code>的对比</p>
<table>
<thead>
<tr>
<th>Hystrix</th>
<th>Sentinel</th>
</tr>
</thead>
<tbody><tr>
<td>需要手动搭建监控平台</td>
<td>单独一个组件，可以独立出来</td>
</tr>
<tr>
<td>没有一套<code>web</code>界面可以给我们进行更加细粒度化的<br>配置流控、速率控制、服务熔断、服务降级。。。</td>
<td>直接界面化的细粒度统一配置</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="是什么："><a href="#是什么：" class="headerlink" title="是什么："></a>是什么：</h3><p>​		<code>Sentinel</code> 是面向分布式服务架构的高可用流量防护组件，主要以流量为切入点，从限流、流量整形、熔断降级、系统负载保护、热点防护等多个维度来帮助开发者保障微服务的稳定性</p>
<h3 id="流控规则："><a href="#流控规则：" class="headerlink" title="流控规则："></a>流控规则：</h3><ul>
<li><p>资源名：唯一名称，默认请求路径</p>
</li>
<li><p>针对来源：<code>Sentinel</code>可以针对调用者进行限流，填写微服务名，默认<code>default</code>（不区分来源）</p>
<ul>
<li>阈值类型/单机阈值<br> <code>QPS</code>（每秒钟的请求数量）：当调用该<code>api</code>的<code>QPS</code>达到阈值的时候，进行限流<ul>
<li>线程数：当调用该<code>api</code>的线程数达到阈值的时候，进行限流</li>
</ul>
</li>
</ul>
</li>
<li><p>是否集群：不需要集群</p>
</li>
<li><p>流控模式</p>
<ul>
<li>直接：<code>api</code>达到限流条件时，直接限流</li>
<li>关联：当关联的资源达到阈值时，就限流自己</li>
<li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【<code>api</code>级别的针对来源】</li>
</ul>
</li>
<li><p>流控效果：</p>
<ul>
<li>快速失败：直接失败，抛出异常</li>
<li><code>Warm Up</code>：根据<code>codeFactor</code>（零加载因子，默认3）的值，从阈值<code>/codeFactor</code>，经过预热是时长，才达到设置的<code>QPS</code>阈值</li>
<li>排队等待：匀速排队，让请求以匀速的速度通过，与值类型必修设置为<code>QPS</code>，否则无效</li>
</ul>
</li>
</ul>
<h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a>降级规则</h3><p><code>Sentinel</code>的断路器是没有<font color="red">半开状态</font>的</p>
<ul>
<li><p><code>RT</code>(平均响应时间，秒级)</p>
<ul>
<li>平均响应时间	<font color="blue">&nbsp;超出阈值</font> <font color="red">且</font> <font color="blue">在时间窗口内通过的请求 &gt;= 5</font>，两个条件同时满足后触发降级</li>
<li>窗口期过后关闭断路器</li>
<li><code>RT</code>最大<code>4900</code>（等大的需要通过 <code>-Dcsp.sentinel.statistic.max.rt=XXXX</code>才能生效）</li>
<li><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel00.png" class="" title="sentinel00"></li>
</ul>
</li>
<li><p>异常比例（秒级）</p>
<ul>
<li><code>QPS</code> &gt;= 5 且异常比例（秒级统计）超过阈值时，触发降级；时间窗口结束后，关闭降级</li>
<li><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel01.png" class="" title="sentinel01"></li>
<li><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel02.png" class="" title="sentinel02"></li>
</ul>
</li>
<li><p>异常数（分钟级）</p>
<ul>
<li>异常数（分钟统计）超过阈值时，触发降级；时间窗口结束后，关闭降级。</li>
<li><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel03.png" class="" title="sentinel03"></li>
<li><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel04.png" class="" title="sentinel04"></li>
</ul>
</li>
</ul>
<p>​        <code>Sentinel</code> 熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响岛其他的资源而导致级联错误。</p>
<p>​		当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是爆出<code>DegradeException</code>）。</p>
<h3 id="热点key限流"><a href="#热点key限流" class="headerlink" title="热点key限流"></a>热点key限流</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel05.png" class="" title="sentinel05">

<h3 id="系统自适应限流"><a href="#系统自适应限流" class="headerlink" title="系统自适应限流"></a>系统自适应限流</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>​		<code>Sentinel</code>系统自适应限流从整体维度对应用入口流量进行控制，结合应用的<code>Load</code>、<code>CPU</code>使用率、总体平均RT、入口<code>QPS</code>和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p>​		系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量生效。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如<code>Web</code>服务或者<code>Dubbo</code>服务端接收的请求，都属于入口流量</p>
<h4 id="系统规则支持以下模式："><a href="#系统规则支持以下模式：" class="headerlink" title="系统规则支持以下模式："></a>系统规则支持以下模式：</h4><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel06.png" class="" title="sentinel06">

<h3 id="自定义全局BlockHandler处理类"><a href="#自定义全局BlockHandler处理类" class="headerlink" title="自定义全局BlockHandler处理类"></a>自定义全局BlockHandler处理类</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel07.png" class="" title="sentinel07">

<h3 id="sentinel整合ribbon-openFeign-fallback"><a href="#sentinel整合ribbon-openFeign-fallback" class="headerlink" title="sentinel整合ribbon+openFeign+fallback"></a>sentinel整合ribbon+openFeign+fallback</h3><h4 id="Ribbon系列"><a href="#Ribbon系列" class="headerlink" title="Ribbon系列"></a>Ribbon系列</h4><p>loading…</p>
<h4 id="Feign系列"><a href="#Feign系列" class="headerlink" title="Feign系列"></a>Feign系列</h4><p>loading…</p>
<h3 id="熔断框架比较"><a href="#熔断框架比较" class="headerlink" title="熔断框架比较"></a>熔断框架比较</h3><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/sentinel08.png" class="" title="sentinel08">

<h3 id="sentinel规则持久化"><a href="#sentinel规则持久化" class="headerlink" title="sentinel规则持久化"></a>sentinel规则持久化</h3><p>就是在 <code>sentinel</code> 启动的时候，去 <code>nacos</code> 上读取相关规则配置信息，及将其相关的规则配置持久化到<code>nacos</code>上。</p>
<p><code>nacos</code>上的配置说明：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"/testA"</span><span class="token punctuation">,</span>
        <span class="token property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
        <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"count"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"clusterMode"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment">/**
* 
* resource: 资源名称
* limitApp:	来源应用
* grade: 阈值类型，0表示线程数，1表示QPS
* count: 单机阈值
* strategy: 流控模式。0表示直接，1表示关联，2表示链路
* controlBehavior: 流控效果，0表示快速失败，2表示warm Up,2表示排队等待
* clusterMode: 是否是集群
* 
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Seata处理分布式事务"><a href="#Seata处理分布式事务" class="headerlink" title="Seata处理分布式事务"></a>Seata处理分布式事务</h2><p>一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题：</p>
<p>​		单体应用配拆分成微服务应用，原来的三个模块被拆分成为三个独立的应用，分别使用三个独立的数据源，业务操作需要调用三个服务来完成。此时每个服务内部的数据一致性由本地事务来保证，但是全局的数据一致性问题没法保证。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata00.png" class="" title="seata00">

<p>一加三的套件</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata01.png" class="" title="seata01">



<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata02.png" class="" title="seata02">

<p>新建模块的部分相关配置：</p>
<p>（自己电脑上未解决<code>seata</code>连接数据库<code>MySQL8.0.20</code>的问题，故未作具体实现，替换了驱动包还是不好使）</p>
<p>新建模块 <code>cloudalibaba-seata-order2001</code> ：</p>
<p><code>pom</code>依赖：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
       <span class="token comment">&lt;!-- seata --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>seata-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token comment">&lt;!-- springcloud alibaba nacos 依赖,Nacos Server 服务注册中心 --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

       <span class="token comment">&lt;!-- open feign 服务调用 --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

       <span class="token comment">&lt;!-- springboot整合Web组件 --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

       <span class="token comment">&lt;!-- 持久层支持 --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token comment">&lt;!--mysql-connector-java--&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token comment">&lt;!--jdbc--&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token comment">&lt;!-- mybatis --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

       <span class="token comment">&lt;!-- 日常通用jar包 --&gt;</span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.qing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>cloud-api-commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
           <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>yml</code>配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2001</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>order<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">alibaba</span><span class="token punctuation">:</span>
      <span class="token key atrule">seata</span><span class="token punctuation">:</span>
        <span class="token comment"># 自定义事务组，需要和当时在 seata/conf/file.conf 中的一致</span>
        <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> dkf_tx_group
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/seata_order
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>


<span class="token comment"># 注意，这是自定义的，原来的是mapper_locations</span>
<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapperLocations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*.xml</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">io</span><span class="token punctuation">:</span>
      <span class="token key atrule">seata</span><span class="token punctuation">:</span> info<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>config</code> （特殊点）:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//下面是两个配置类，这个是和mybatis整合需要的配置</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"com.dkf.springcloud.alibaba.dao"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token comment">//这个是配置使用 seata 管理数据源，所以必须配置</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>dkf<span class="token punctuation">.</span>springcloud<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>pool<span class="token punctuation">.</span></span><span class="token class-name">DruidDataSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>seata<span class="token punctuation">.</span>rm<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceProxy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">SqlSessionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span></span><span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">SpringManagedTransactionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span><span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceProxyConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${mybatis.mapperLocations}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mapperLocations<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">druidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceProxy</span> <span class="token function">dataSourceProxy</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">sqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProxy</span> dataSourceProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SqlSessionFactoryBean</span> sqlSessionFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSourceProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>mapperLocations<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setTransactionFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringManagedTransactionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主启动类：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//这里必须排除数据源自动配置，因为写了配置类，让 seata 管理数据源</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeataOrderMain2001</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SeataOrderMain2001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Seata使用"><a href="#Seata使用" class="headerlink" title="Seata使用"></a>Seata使用</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token comment">//只需要在业务类的方法上加上该注解，name值自定义唯一即可。</span>
   <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"dkf-create-order"</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 开始创建订单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDao<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务开始调用库存，做扣减---Count-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       storageService<span class="token punctuation">.</span><span class="token function">decrease</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务开始调用库存，库存扣减完成！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务开始调用账户，账户扣减---money-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       accountService<span class="token punctuation">.</span><span class="token function">decrease</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>order<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务开始调用账户，账户扣减完成!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//修改订单状态，从0到1</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务修改订单状态，start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--------》 订单微服务修改订单状态，end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"--订单结束--"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata03.png" class="" title="seata03">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata04.png" class="" title="seata04">

<h3 id="seata是什么"><a href="#seata是什么" class="headerlink" title="seata是什么"></a>seata是什么</h3><p>​		<code>Seata</code>是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。<code>Seata</code>将为用户提供了<code>AT</code>、<code>TCC</code>、<code>SAGA</code>和<code>XA</code>事务模式。</p>
<h4 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h4><h5 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h5><ul>
<li>基于支持本地<code>ACID</code>事务的关系型数据库</li>
<li><code>Java</code>应用，通过<code>JDBC</code>访问数据库</li>
</ul>
<h5 id="整体机制"><a href="#整体机制" class="headerlink" title="整体机制"></a>整体机制</h5><ul>
<li>一阶段：业务数据和回滚日志记录在同一个本地事务种 提交，释放本地锁和连接资源</li>
<li>二阶段<ul>
<li>提交异步化，非常快速的完成</li>
<li>回滚通过一阶段的回滚日志进行反向补偿</li>
</ul>
</li>
</ul>
<p>在第一阶段，<code>Seata</code>会拦截“业务<code>SQL</code>”</p>
<p>1 解析<code>SQL</code>语义，找到“业务<code>SQl</code>”要更新的业务数据，在业务数据被更新前，将其保存成“<code>before image</code>”</p>
<p>2 执行“业务<code>SQL</code>”更新业务数据，在业务数据更新之后</p>
<p>3 其保存成“after image” 最后生成行锁</p>
<p>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata05.png" class="" title="seata05">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata06.png" class="" title="seata06">

<h5 id="二阶段回滚"><a href="#二阶段回滚" class="headerlink" title="二阶段回滚"></a>二阶段回滚</h5><p>二阶段如果是回滚的话，<code>Seata</code>就需要回滚一阶段已经执行的“业务<code>SQL</code>”，还原业务数据。</p>
<p>回滚方式便是用“<code>before image</code>”还原业务数据；但在还原之前要首先要校验脏写，对比“数据库当前业务数据”和“<code>after image</code>”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p>
<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata07.png" class="" title="seata07">

<img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/seata08.png" class="" title="seata08">

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="ResTemplate"><a href="#ResTemplate" class="headerlink" title="ResTemplate"></a>ResTemplate</h2><img src="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/ResTemplate00.png" class="" title="ResTemplate00">



<hr>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/centos/">CentOS 阿里云镜像</a>：<a target="_blank" rel="noopener" href="http://mirrors.aliyun.com/centos/">http://mirrors.aliyun.com/centos/</a></p>
<p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/zookeepe">zookeeper</a>:<a target="_blank" rel="noopener" href="http://archive.apache.org/dist/zookeepe">http://archive.apache.org/dist/zookeepe</a></p>
<p><a target="_blank" rel="noopener" href="https://www.consul.io/downloads">consul</a>：<a target="_blank" rel="noopener" href="https://www.consul.io/downloads">https://www.consul.io/downloads</a></p>
<p><a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-consul.html">consul中文文档</a>：<a target="_blank" rel="noopener" href="https://www.springcloud.cc/spring-cloud-consul.html">https://www.springcloud.cc/spring-cloud-consul.html</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.hashicorp.com/tutorials/consul/get-started-install">consul安装视频教程</a>：<a target="_blank" rel="noopener" href="https://learn.hashicorp.com/tutorials/consul/get-started-install">https://learn.hashicorp.com/tutorials/consul/get-started-install</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18E411x7eT/?spm_id_from=333.337.search-card.all.click&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959">尚硅谷springCloud</a> :<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18E411x7eT/?spm_id_from=333.337.search-card.all.click&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959">https://www.bilibili.com/video/BV18E411x7eT/?spm_id_from=333.337.search-card.all.click&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io" rel="external nofollow noreferrer">Robert Sunq</a>
                    </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/">https://robertsunq.github.io/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://robertsunq.github.io" target="_blank">Robert Sunq</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/note/">
                                    <span class="chip bg-color">note</span>
                                </a>
                            
                                <a href="/tags/springcloud/">
                                    <span class="chip bg-color">springcloud</span>
                                </a>
                            
                                <a href="/tags/springcloud-alibaba/">
                                    <span class="chip bg-color">springcloud-alibaba</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/12/12/hello-world/hello-world/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Hello World">
                        
                        <span class="card-title">Hello World</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Hexo自动生成，展示留存
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-12-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/hello-world/" class="post-category">
                                    hello-world
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/hello-world/">
                        <span class="chip bg-color">hello-world</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="far fa-dot-circle"></i>
            </div>
            <div class="card">
                <a href="/2021/07/12/cs-frameworks-tools/frameworks-springcloud-note/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="微服务 SrpingCloud 学习笔记">
                        
                        <span class="card-title">微服务 SrpingCloud 学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            微服务 SrpingCloud 学习笔记
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cs-frameworks-tools/" class="post-category">
                                    cs-frameworks-tools
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/note/">
                        <span class="chip bg-color">note</span>
                    </a>
                    
                    <a href="/tags/springcloud/">
                        <span class="chip bg-color">springcloud</span>
                    </a>
                    
                    <a href="/tags/springcloud-alibaba/">
                        <span class="chip bg-color">springcloud-alibaba</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Qing<br />'
            + '文章作者: Robert Sunq<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '<原创文章> 著作权归Robert Sunq所有，<转载文章> 著作权归原作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">Robert Sunq</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">244.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/RobertSunq" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:loading@xx.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=loading..." class="tooltipped" target="_blank" data-tooltip="QQ联系我: loading..." data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"left","width":150,"height":350},"mobile":{"show":true},"log":false});</script></body>

</html>
