<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="sql, note, mysql">
    <meta name="description" content="SQL学习笔记，主要是对于SQL的基础概念和使用方法做记录">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>SQL学习笔记 | Qing</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qing</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/solution" class="waves-effect waves-light">

      
      <i class="fas fa-flag" style="zoom: 0.6;"></i>
      
      <span>题解系列</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/solution/leetcode">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Leetcode</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qing</div>
        <div class="logo-desc">
            
            这个人没啥子特点 喜欢一切随缘咯 ( •̀ ω •́ )✧
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-flag"></i>
			
			题解系列
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/solution/leetcode " style="margin-left:75px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:50px" ></i>
			      
		          <span>Leetcode</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/RobertSunq/RobertSunq.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/RobertSunq/RobertSunq.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('哟！你知道密码不？')).toString(CryptoJS.enc.Hex)) {
                alert('好可惜你不知道哎，那只能回到主页咯！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">SQL学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%8E%9F%E5%88%9B/">
                                <span class="chip bg-color">原创</span>
                            </a>
                        
                            <a href="/tags/note/">
                                <span class="chip bg-color">note</span>
                            </a>
                        
                            <a href="/tags/mysql/">
                                <span class="chip bg-color">mysql</span>
                            </a>
                        
                            <a href="/tags/sql/">
                                <span class="chip bg-color">sql</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/cs-data/" class="post-category">
                                cs-data
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-04-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-05-09
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    22.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    87 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="SQL学习笔记"><a href="#SQL学习笔记" class="headerlink" title="SQL学习笔记"></a>SQL学习笔记</h1><blockquote>
<p>本文将基于<code>MySql</code>数据库来进行测试。</p>
</blockquote>
<h2 id="什么是SQL"><a href="#什么是SQL" class="headerlink" title="什么是SQL"></a>什么是SQL</h2><p>数据库是一种以易于访问的格式存储数据的集合。为了方便管理数据库，使用了一种叫做“<strong>数据库管理系统</strong>”或 <code>DBMS</code>（<code>Database Management System</code>） 的软件应用。我么连接到一个<code>DBMS</code>然后下达查询或者修改数据的指令，<code>DBMS</code>就会执行我们输入的指令并返回结果。</p>
<img src="/2023/04/23/cs-data/data-sql/image_000.png" class="" title="image_000">

<p>现有的几种<code>DBMS</code>被分为两个大类：</p>
<ul>
<li><p>关系型（<code>Relational</code>）</p>
<ul>
<li><p>在关系型数据库中，把数据存储在利用关系相互链接的表中。每张表都存储一类特定对象的数据，这也是被叫做关系型数据库的原因。</p>
</li>
<li><p><code>SQL</code>或者<code>SQUEL</code>就是用来处理这些关系型<code>DBMS</code>的语言。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 类似于</span>
<span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> products
<span class="token keyword">where</span> category <span class="token operator">=</span> <span class="token string">'food'</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> price<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>目前通用的数据库有 <code>MySql</code>、<code>SQL server</code>、<code>Oracle</code>。每种数据库的<code>SQL</code>语句有所不同，但是操作类似，且都是基于<code>SQL</code>规范。</p>
</li>
</ul>
</li>
<li><p>非关系型（<code>NoSql</code>）</p>
</li>
</ul>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><p>见本博客文章 <a href="https://robertsunq.github.io/2023/04/13/cs-data/linux-install-mysql/">基于Linux系统安装Mysql</a></p>
<p>MacOS和Windows系统可以按照安装包的UI界面进行配置安装即可。</p>
<h3 id="基础数据表创建"><a href="#基础数据表创建" class="headerlink" title="基础数据表创建"></a>基础数据表创建</h3><p>详见脚本：<a target="_blank" rel="noopener" href="https://github.com/RobertSunq/data/tree/master/qing/blog/hexo/sql/create-databases.sql" title="点击跳转">create-databases.sql</a> <a target="_blank" rel="noopener" href="https://github.com/RobertSunq/data/tree/master/qing/blog/hexo/sql/load_1000_customers.sql" title="点击跳转">load_1000_customers.sql</a>  </p>
<p>其中<code>load_1000_customers.sql</code> 可在索引部分再使用</p>
<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><blockquote>
<p><code>Retrieving Data</code></p>
</blockquote>
<h3 id="SELECT-语句"><a href="#SELECT-语句" class="headerlink" title="SELECT 语句"></a>SELECT 语句</h3><h4 id="基础结构"><a href="#基础结构" class="headerlink" title="基础结构"></a>基础结构</h4><p>首先是选择一个数据库，使用 <code>USE</code> 关键词，在SQL种这些关键词是不区分大小写的，但是最好的写法是使用大写。</p>
<blockquote>
<p>当然也可以不用事前选择一个数据库，可以在查询语句种的表名前添加上数据库名的前缀。</p>
<p><code>SELECT * FROM sql_store.customers;</code></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 选择一个数据库</span>
<span class="token keyword">USE</span> sql_store<span class="token punctuation">;</span>
<span class="token comment">-- Database changed</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>在<code>SQL</code>语句中，使用<code>--</code>作为注释符号，用来注释不需要执行的语句</p>
</blockquote>
<p>然后指定需要查询的列，这里使用<code>SELECT</code>关键词，可以指定具体的列名，也可以使用 <code>*</code>来获取<strong>所有的列</strong>。</p>
<p>在然后是指定明确要查询的表，这里使用<code>FROM</code> 关键词。</p>
<p>最后使用<code>;</code>来终止每条要执行的语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 指定列</span>
<span class="token keyword">SELECT</span> customer_id<span class="token punctuation">,</span> first_name <span class="token keyword">FROM</span> customers<span class="token punctuation">;</span>

<span class="token comment">-- 查询所有列</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>选择语句这里有两个子句就是，<code>SELECT</code>子句和<code>FROM</code>子句。当然还可以搭配其他子句，这里会在后续逐步介绍到。</p>
<blockquote>
<p>当然也可以指使用<code>SELECT</code>子句，例如：<code>SELECT 1, 2;</code></p>
</blockquote>
<blockquote>
<p>在SQL语句中，换行符、空白符、制表符在执行SQL语句时都是没有作用的，例如</p>
<p><code>SELECT 1, 2;</code> 与 <code>SELECT 1,2;</code> 结果相同，没有区别。</p>
</blockquote>
<img src="/2023/04/23/cs-data/data-sql/image_001.png" class="" title="image_001">

<h4 id="字段运算"><a href="#字段运算" class="headerlink" title="字段运算"></a>字段运算</h4><p>在<code>SELECT</code>子句中，不仅仅可以指定列表，也可以对列进行一些函数计算，例如对于<code>customers</code>表中的<code>points</code>字段（该字段是个数字），我们可以进行一些数学运算。这里的运算优先级与数学中的相同。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> customer_id<span class="token punctuation">,</span> first_name<span class="token punctuation">,</span> points<span class="token punctuation">,</span> points <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span> points <span class="token operator">%</span> <span class="token number">10</span> <span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_002.png" class="" title="image_002">

<h4 id="AS关键词"><a href="#AS关键词" class="headerlink" title="AS关键词"></a>AS关键词</h4><p>可以使用<code>()</code>来改变运算顺序，同时也可以使用<code>AS</code> 关键词来设置别名，将结果列设置一个易于读取的名称。同时别名也可以设置在已有列上。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用括号来改变运算顺序</span>
<span class="token comment">-- 并使用 AS 设置别名</span>
<span class="token keyword">SELECT</span>
	customer_id<span class="token punctuation">,</span>
	first_name <span class="token keyword">as</span> tmp_first_name<span class="token punctuation">,</span>
	points<span class="token punctuation">,</span>
	points <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span> points <span class="token operator">+</span> <span class="token number">10</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> discount_factor 
<span class="token keyword">FROM</span>
	customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_003.png" class="" title="image_003">

<h4 id="DISTINCT关键词"><a href="#DISTINCT关键词" class="headerlink" title="DISTINCT关键词"></a>DISTINCT关键词</h4><p>使用<code>DISTINCT</code> 关键词可以达到对结果进行去重的效果，即相同的字段只显示一个。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 数据准备</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>customers<span class="token punctuation">`</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token string">'Babara_1'</span><span class="token punctuation">,</span><span class="token string">'MacCaffrey_1'</span><span class="token punctuation">,</span><span class="token string">'1986-03-29'</span><span class="token punctuation">,</span><span class="token string">'781-932-9755'</span><span class="token punctuation">,</span><span class="token string">'0 Sage Terrace 1'</span><span class="token punctuation">,</span><span class="token string">'Waltham_1'</span><span class="token punctuation">,</span><span class="token string">'MA'</span><span class="token punctuation">,</span><span class="token number">2274</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询单列数据，可以看到 state 字段重复值 MA, 如图 image_004</span>
<span class="token keyword">SELECT</span> state <span class="token keyword">FROM</span> customers<span class="token punctuation">;</span>

<span class="token comment">-- 然后使用 DISTINCT 来做去重查询, 如图 image_005</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> state <span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_004.png" class="" title="image_004">

<img src="/2023/04/23/cs-data/data-sql/image_005.png" class="" title="image_005">

<h3 id="WHERE语句"><a href="#WHERE语句" class="headerlink" title="WHERE语句"></a>WHERE语句</h3><h4 id="基础结构-1"><a href="#基础结构-1" class="headerlink" title="基础结构"></a>基础结构</h4><p>如果不需要数据表中列，只需要一些符合某种条件的数据是，就可以使用<code>WHERE</code>关键词，来添加过滤条件。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 检索积分值高于 3000 的顾客, 这里 &gt; 是比较运算符之一</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	points <span class="token operator">&gt;</span> <span class="token number">3000</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 检索 state 等于 MA 的数据</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	state <span class="token operator">=</span> <span class="token string">'MA'</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 检索 birth_date 大于 1990-01-01 的数据</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	birth_date <span class="token operator">&gt;</span> <span class="token string">'1991-01-01'</span><span class="token punctuation">;</span>
<span class="token comment">-- 注意，在SQL中可以使用字符串来对 date （日期）的字段进行比较，这里并不是进行字符串比较</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><p>在<code>WHERE</code>语句中的比较运算符包含：</p>
<ul>
<li><code>&gt;</code> <ul>
<li>小于</li>
</ul>
</li>
<li><code>&gt;=</code><ul>
<li>小于等于</li>
</ul>
</li>
<li><code>&lt;</code><ul>
<li>大于</li>
</ul>
</li>
<li><code>&lt;=</code><ul>
<li>大于等于</li>
</ul>
</li>
<li><code>=</code><ul>
<li>等于</li>
</ul>
</li>
<li><code>!=</code><ul>
<li>不等于</li>
</ul>
</li>
<li><code>&lt;&gt;</code><ul>
<li>不等于</li>
</ul>
</li>
</ul>
<h4 id="AND、OR、NOT运算符"><a href="#AND、OR、NOT运算符" class="headerlink" title="AND、OR、NOT运算符"></a>AND、OR、NOT运算符</h4><p>如果对数据要有多个条件进行逻辑运算组合筛选，就需要使用到逻辑运算符 <code>AND</code>、<code>OR</code>、<code>NOT</code>关键词</p>
<p><code>AND</code> 逻辑与，即需要多个条件并列满足</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询 生日大于  1991-01-01 且 小于 1993-01-01 的消费者</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	birth_date <span class="token operator">&gt;</span> <span class="token string">'1991-01-01'</span> <span class="token operator">AND</span> birth_date <span class="token operator">&lt;</span> <span class="token string">'1993-01-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>OR</code> 逻辑或，即多个条件满足一个即可</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询 生日大于  1993-01-01 或者 小于 1991-01-01 的消费者</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	birth_date <span class="token operator">&gt;</span> <span class="token string">'1993-01-01'</span> <span class="token operator">OR</span> birth_date <span class="token operator">&lt;</span> <span class="token string">'1991-01-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>NOT</code> 逻辑非，即对条件进行取反。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询不符合条件 （生日大于 1991-01-01 且 积分大于 1000 ）的消费者</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	<span class="token operator">NOT</span> <span class="token punctuation">(</span>birth_date <span class="token operator">&gt;</span> <span class="token string">'1991-01-01'</span> <span class="token operator">AND</span> points <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="IN-运算符"><a href="#IN-运算符" class="headerlink" title="IN 运算符"></a>IN 运算符</h4><p>用于对数据中某个字段符合多个指定值时的行，例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 要查询 state 是MA或者VA或者CO的消费者，可以使用如下方式。</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    state <span class="token operator">=</span> <span class="token string">'MA'</span> <span class="token operator">OR</span> state <span class="token operator">=</span> <span class="token string">'VA'</span> <span class="token operator">OR</span> state <span class="token operator">=</span> <span class="token string">'CO'</span><span class="token punctuation">;</span>
    
<span class="token comment">-- 但是这样的使用 OR 进行排列导致语句什么臃肿，所有可以使用运算符 IN 来进行简化</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    state <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'MA'</span><span class="token punctuation">,</span> <span class="token string">'VA'</span><span class="token punctuation">,</span> <span class="token string">'CO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>可以理解为数学中，一个属性是否属于一个集合。 <code>a ∈ A , (A = [a, b, c])</code>  </p>
</blockquote>
<h4 id="BETWEEN-运算符"><a href="#BETWEEN-运算符" class="headerlink" title="BETWEEN 运算符"></a>BETWEEN 运算符</h4><p>用于查询数据中某个字段属于一个范围的行，例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询 积分在 1000 与 3000 之间的用户，可以使用如下方式</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	points <span class="token operator">&gt;=</span> <span class="token number">1000</span> <span class="token operator">AND</span> points <span class="token operator">&lt;=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 也可以使用 BETWEEN 进行范围过滤</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
	points <span class="token operator">BETWEEN</span> <span class="token number">1000</span> <span class="token operator">AND</span> <span class="token number">3000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>可以理解为数学中国的，  值属于一个闭合区间， <code>a ∈[1000, 3000]</code></p>
</blockquote>
<h4 id="LIKE-运算符"><a href="#LIKE-运算符" class="headerlink" title="LIKE  运算符"></a>LIKE  运算符</h4><p>用于查询某个字段中是否包含特定字符串的行，例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询名字中以 b 开头的任意长度的行</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    last_name <span class="token operator">LIKE</span> <span class="token string">'b%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询名字中以 b 结尾</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    last_name <span class="token operator">LIKE</span> <span class="token string">'%b'</span><span class="token punctuation">;</span>
    
<span class="token comment">-- 查询名字中包含 b 的行</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    last_name <span class="token operator">LIKE</span> <span class="token string">'%b%'</span><span class="token punctuation">;</span>
    
<span class="token comment">-- 查询名字是两个字符长度，且以 y 为结尾的行</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
    last_name <span class="token operator">LIKE</span> <span class="token string">'_y'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="模糊匹配符"><a href="#模糊匹配符" class="headerlink" title="模糊匹配符"></a>模糊匹配符</h5><p> <strong><code>%</code> 为任意长度字符模糊匹配符</strong>，表示任意字段</p>
<p><strong><code>_</code>为单字符模糊匹配符</strong>，表示一个字段</p>
<p>对其使用规则总结如下：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>A%</code></td>
<td><strong>右模糊匹配</strong>，即以A开头后，右侧可以是任意长度字符（任意长度包含长度为 0）</td>
</tr>
<tr>
<td><code>%B</code></td>
<td><strong>左模糊匹配</strong>， 即以B为结尾，左侧可以是任意长度字符</td>
</tr>
<tr>
<td><code>%C%</code></td>
<td><strong>全模糊匹配</strong>，即包含C字符，左右两侧都可以谁任意长度字符</td>
</tr>
<tr>
<td><code>y_</code></td>
<td><strong>固定长度模糊匹配</strong>，<code>_</code>用来代表任意一个字符。</td>
</tr>
<tr>
<td><code>y_A___c%</code></td>
<td>两个模糊匹配符号可以混合使用。</td>
</tr>
</tbody></table>
<h4 id="REGEXP-运算符"><a href="#REGEXP-运算符" class="headerlink" title="REGEXP 运算符"></a>REGEXP 运算符</h4><p>该运算符是<strong>正则表达式</strong>（<code>regular expression</code>）的缩写，即使用正则表达式来进行搜索字符串，使用正则表达式可以进行比上述 <code>LIKE</code> 运算符更加复杂且多样化的匹配模式（匹配符号不再仅限于 <code>%</code> 和 <code>_</code>）。</p>
<p>至于正则表达式子的语法，这里不做过多的介绍，感兴趣的可以另行查询。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 搜索名字中包含 field 字符的顾客</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
   last_name <span class="token operator">REGEXP</span> <span class="token string">'field'</span><span class="token punctuation">;</span> 

<span class="token comment">-- 搜索名字中以 field 开头或者结尾的顾客</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
   last_name <span class="token operator">REGEXP</span> <span class="token string">'^field|field$'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="IS-NULL-运算符"><a href="#IS-NULL-运算符" class="headerlink" title="IS NULL 运算符"></a>IS NULL 运算符</h4><p>用于查询某些字段缺失的行，可以认为是字段值为 <code>NULL</code></p>
<blockquote>
<p>注意：这里说的是数据行中某列没有属性值时，此时字段的值认为时 NULL （一种缺省状态），而不是字段真实值为字符串 NULL</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询数据中手机号 不存在的 顾客</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
   phone <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="IS-NOT-NULL-运算符"><a href="#IS-NOT-NULL-运算符" class="headerlink" title="IS NOT NULL 运算符"></a>IS NOT NULL 运算符</h4><p>用于从查询某些字段值存在，不为 <code>NULL</code> 的行。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询数据中手机号 存在的 顾客</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">WHERE</span>
   phone <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ORDER-BY-语句"><a href="#ORDER-BY-语句" class="headerlink" title="ORDER BY 语句"></a>ORDER BY 语句</h3><p>用于对查询的结果数据进行排序，可以指定排序使用的列以及大小顺序（递增(<code>ASC</code>)、递减(<code>DESC</code>)）。</p>
<p>在不指定的情况下，默认按照主键递增排序；指定排序字段但是不指定大小顺序时默认递增。（<em>是否跟具体的数据库管理系统有关未查证，待查证</em>）</p>
<blockquote>
<p>这里使用的时<code>MySql</code>数据库，所有在排序的时候，排序字段可以不用存在于查询结果列中（即可以不用在 <code>SELECT</code> 子句中），即可以不用查询<code>A</code>列，但是使用<code>A</code>列排序。</p>
<p>一些其他数据库管理系统中，默认配置下需要排序字段必须存在于查询结果列中。</p>
</blockquote>
<p>例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 这里我们通过关键词 order by 指定按照姓氏排序</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	first_name<span class="token punctuation">;</span>
	
<span class="token comment">-- 可以指定递减排序</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	first_name <span class="token keyword">DESC</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 也可以指定多个字段排序，即先按照第一个字段排序，在按照第二个字段排序</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	first_name <span class="token keyword">DESC</span><span class="token punctuation">,</span> state<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="LIMIT-语句"><a href="#LIMIT-语句" class="headerlink" title="LIMIT 语句"></a>LIMIT 语句</h3><p>限制返回数据的数量，以及偏移量。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 限制只返回 3 条数据。限制数量超过了总数时，将返回所有数据</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">LIMIT</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">-- 限制偏移量以及数据量，通常应用于分页查询</span>
<span class="token comment">-- page 1: 1 - 3</span>
<span class="token comment">-- page 2: 4 - 6</span>
<span class="token comment">-- page 3: 7 - 9</span>
<span class="token comment">-- 从第6条记录开始偏移计数，返回三条数据</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">LIMIT</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">-- 查询结果中 id 是从 7 - 9</span>

<span class="token comment">-- 于上节的排序同时使用，就是返回某个顺序下的限制数量</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	customers 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	points <span class="token keyword">DESC</span> 
<span class="token keyword">LIMIT</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>通常情况下，可能需要使用到多列数据会存在于不同的表之中，这时候就需要使用到<code>连接</code>来将多张表连接到一块来获取到不同表中的多列数据。</p>
<img src="/2023/04/23/cs-data/data-sql/image_006.png" class="" title="image_006">

<blockquote>
<p>图片来源：百度百科</p>
</blockquote>
<ul>
<li><strong>内连接</strong>（<code>INNER JOIN</code>）<ul>
<li>只连接匹配的行</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A INNER JOIN TableB B ON A.Key = B.Key;</code></li>
<li>图<code>image_006</code>最中间的图列</li>
</ul>
</li>
<li><strong>左连接</strong>（<code>LEFT JOIN</code>）<ul>
<li>左外连接</li>
<li>包含左边表的全部行（不管右边的表中是否存在于左边表适配的行）以及右边表中全部匹配的行</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A LEFT JOIN TableB B ON A.Key = B.Key;</code></li>
<li>图<code>image_006</code>左上角的图列</li>
</ul>
</li>
<li><strong>右连接</strong>（<code>RIGHT JOIN</code>）<ul>
<li>右外连接</li>
<li>包含右边表的全部行（不管左边的表中是否存在与右边表适配的行）以及左边表中全部匹配的行</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A RIGHT JOIN TableB B ON A.Key = B.Key;</code></li>
<li>图<code>image_006</code>右上角的图列</li>
</ul>
</li>
<li><strong>全连接</strong>（<code>FULL JOIN</code>）<ul>
<li>全外简介</li>
<li>包含左、右两个表的全部行，不管在另一边的表中是否存在于它们匹配的行</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A FULL JOIN TableB B ON A.Key = B.Key;</code></li>
<li>图<code>image_006</code>左下角的图列</li>
</ul>
</li>
<li><strong>θ连接</strong><ul>
<li>使用等值以外的条件来匹配左、右两个表中的行</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A FULL OUTER JOIN TableB B ON A.Key = B.Key WHERE A.Key IS NULL OR B.Key IS NULL;</code></li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A JOIN TableB B ON A.Key != B.Key;</code></li>
<li>图<code>image_006</code>右下角的图列</li>
</ul>
</li>
<li><strong>交叉连接</strong><ul>
<li>生成笛卡尔积——不适用任何匹配或者选取条件，而是直接将一个数据源中的每个行于另一个数据源的每个行一一匹配</li>
<li><code>SELECT &lt;select_list&gt; FROM TableA A, TableB B</code></li>
</ul>
</li>
</ul>
<h4 id="INNER-JOIN-内连接"><a href="#INNER-JOIN-内连接" class="headerlink" title="INNER JOIN 内连接"></a>INNER JOIN 内连接</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 内连接，这里的 INNER 可以省略不写。</span>
<span class="token comment">-- 使用 ON 来指定两张表的连接条件</span>
<span class="token comment">-- 通过顾客ID将 订单和顾客关联起来</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	orders
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers  <span class="token keyword">ON</span> orders<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> customers<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="LEFT-JOIN-左外连接"><a href="#LEFT-JOIN-左外连接" class="headerlink" title="LEFT JOIN 左外连接"></a>LEFT JOIN 左外连接</h4><p>又称为左连接。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 返回 包含右边表的全部行（不管左边的表中是否存在与右边表适配的行）以及左边表中全部匹配的行</span>
<span class="token keyword">SELECT</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span>
	c<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>order_id 
<span class="token keyword">FROM</span>
	customers c
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> orders o <span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="RIGHT-JOIN-右外连接"><a href="#RIGHT-JOIN-右外连接" class="headerlink" title="RIGHT JOIN 右外连接"></a>RIGHT JOIN 右外连接</h4><p>又称为右连接。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 返回 包含左边表的全部行（不管右边的表中是否存在于左边表适配的行）以及右边表中全部匹配的行</span>
<span class="token keyword">SELECT</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span>
	c<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>order_id 
<span class="token keyword">FROM</span>
	customers c
	<span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> orders o <span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="交叉连接"><a href="#交叉连接" class="headerlink" title="交叉连接"></a>交叉连接</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 生成笛卡尔积——不适用任何匹配或者选取条件，而是直接将一个数据源中的每个行于另一个数据源的每个行一一匹配</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
	<span class="token keyword">FROM</span> customers c
<span class="token keyword">CROSS</span> <span class="token keyword">JOIN</span> products p<span class="token punctuation">;</span>

<span class="token comment">-- 也可也直接省略关键词 CROSS JOIN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
	<span class="token keyword">FROM</span> customers c<span class="token punctuation">,</span> products p<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="指定列名"><a href="#指定列名" class="headerlink" title="指定列名"></a>指定列名</h4><p>在连接查询中，SELECT 语句中可以指定所有连接表中的字段，例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 指定 订单表中的订单ID 和 顾客表中的顾客名</span>
<span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span> first_name
<span class="token keyword">FROM</span>
	orders
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers  <span class="token keyword">ON</span> orders<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> customers<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果连接的表中存在列表相同的，可以通过在列名前指定表前缀来查询（不重复的列也可以使用表前缀指定，但是通常可以省略）。</p>
<p>如果不指定表前缀的话，数据库管理器将会无法确定查询的是哪张表中列而报错。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用前缀指定表的列</span>
<span class="token keyword">SELECT</span>
	orders<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span> customers<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span> order_id<span class="token punctuation">,</span> first_name
<span class="token keyword">FROM</span>
	orders
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers  <span class="token keyword">ON</span> orders<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> customers<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span>
	
<span class="token comment">-- 设置别名来区分</span>
<span class="token keyword">SELECT</span>
	orders<span class="token punctuation">.</span>customer_id <span class="token keyword">as</span> customer_id_in_orders<span class="token punctuation">,</span>
    customers<span class="token punctuation">.</span>customer_id <span class="token keyword">as</span> customer_id_in_customers<span class="token punctuation">,</span>
    order_id<span class="token punctuation">,</span>
    first_name
<span class="token keyword">FROM</span>
	orders
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers  <span class="token keyword">ON</span> orders<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> customers<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可以对表设置别名来简化指定表名时的复杂度</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 其中给表设置别名的关键词 AS 可以省略</span>
<span class="token keyword">SELECT</span>
	o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span> c<span class="token punctuation">.</span>first_name
<span class="token keyword">FROM</span>
	orders <span class="token keyword">AS</span> o
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers <span class="token keyword">AS</span> c
	<span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="跨数据库连接"><a href="#跨数据库连接" class="headerlink" title="跨数据库连接"></a>跨数据库连接</h4><p>有时候需要跨数据库来进行表之间的连接，这里就需要对访问的表指定其所在数据库前缀了，例如：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 注意，保证使用的账号具有跨数据库的权限</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	sql_store<span class="token punctuation">.</span>order_items oi
	<span class="token keyword">JOIN</span> sql_inventory<span class="token punctuation">.</span>products p <span class="token keyword">ON</span> oi<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注意这里对所有的数据表都添加了数据库前缀，如果你当前指定了默认使用的数据库，可以对这个库中的表不添加前缀</p>
</blockquote>
<h4 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h4><p>即表自身与自身进行连接。</p>
<p>例如，在表 <code>employees</code> 表中，有一个员工<code>ID</code>（<code>employee_id</code>），以及一个 上级管理者<code>ID</code>（<code>reports_to</code>）。这里可以选择表中一行将 <code>reports_to</code> 字段设置为<code>NULL</code>， 标识这个员工没有上级管理者，是公司的<code>CEO</code>。这时候如果我们需要同时查询员工以及员工的上级管理者的信息，就需要使用自连接。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 切换数据库</span>
<span class="token keyword">USE</span> sql_hr<span class="token punctuation">;</span>

<span class="token comment">-- 自内连接</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	employees e
	<span class="token keyword">JOIN</span> employees m <span class="token keyword">ON</span> e<span class="token punctuation">.</span>reports_to <span class="token operator">=</span> m<span class="token punctuation">.</span>employee_id<span class="token punctuation">;</span>
	
<span class="token comment">-- 指定查询列，由于是一张表，所以所有的列都是重复的</span>
<span class="token keyword">SELECT</span>
	e<span class="token punctuation">.</span>employee_id<span class="token punctuation">,</span>
	e<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
	m<span class="token punctuation">.</span>first_name manager_name
<span class="token keyword">FROM</span>
	employees e
	<span class="token keyword">JOIN</span> employees m <span class="token keyword">ON</span> e<span class="token punctuation">.</span>reports_to <span class="token operator">=</span> m<span class="token punctuation">.</span>employee_id<span class="token punctuation">;</span>
	
<span class="token comment">-- 自外连接</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	employees e
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> employees m <span class="token keyword">ON</span> e<span class="token punctuation">.</span>reports_to <span class="token operator">=</span> m<span class="token punctuation">.</span>employee_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="多表连接"><a href="#多表连接" class="headerlink" title="多表连接"></a>多表连接</h4><p>在需要使用到多张表进行连接的时候，其语法与上述章节中两张表的类似，就是添加需要的合适连接关联词与<code>ON</code>关联条件连接即可。例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
    o<span class="token punctuation">.</span>order_date<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
    c<span class="token punctuation">.</span>last_name<span class="token punctuation">,</span>
    os<span class="token punctuation">.</span>name <span class="token keyword">AS</span> <span class="token keyword">status</span>
<span class="token keyword">FROM</span>
	orders o
	<span class="token keyword">JOIN</span> customers c <span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id
	<span class="token keyword">JOIN</span> order_statuses os <span class="token keyword">ON</span> o<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token operator">=</span> os<span class="token punctuation">.</span>order_status_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="复合连接条件"><a href="#复合连接条件" class="headerlink" title="复合连接条件"></a>复合连接条件</h4><p>在进行连接的时候，如果做连接的条件不止一个时，就需要使用到复合连接条件了，其具体语法就是在关键词 ON 后添加多个连接条件，连接条件语法与WHERE语句中类似。例如</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将订单元素表与订单元素备注关联起来，这里需要符合两张表中的产品ID和订单ID相同才符合连接条件</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	order_items oi
	<span class="token keyword">JOIN</span> order_item_notes oin <span class="token keyword">ON</span> oi<span class="token punctuation">.</span>order_id <span class="token operator">=</span> oin<span class="token punctuation">.</span>order_id 
	<span class="token operator">AND</span> oi<span class="token punctuation">.</span>product_id <span class="token operator">=</span> oin<span class="token punctuation">.</span>product_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="隐式连接语法"><a href="#隐式连接语法" class="headerlink" title="隐式连接语法"></a>隐式连接语法</h4><p><code>Implpicit Join Syntax</code>。进来还是使用显式的连接语法，隐式连接语法尽管可以省略部分语句，但是叫容易出错。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 对于简单的连接关系，可以省略 JOIN 关键词，采用 WHERE 条件来隐式的连接</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	orders <span class="token keyword">AS</span> o
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
	customers <span class="token keyword">AS</span> c
	<span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span>
	
<span class="token comment">-- 隐式连接语法如下</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	orders o<span class="token punctuation">,</span> customers c
<span class="token keyword">WHERE</span>
	o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span>
<span class="token comment">-- 注意这里 WHERE 条件语句不可省略，如果省略了就成交叉连接了，数据结果就是 n * m</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span>
<span class="token keyword">FROM</span>
	orders o<span class="token punctuation">,</span> customers c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="USING-语句"><a href="#USING-语句" class="headerlink" title="USING 语句"></a>USING 语句</h4><p>在<code>mysql</code>中可以使用 <code>USING</code>来省略连接条件（<code>o.customer_id = c.customer_id</code>），这需要<strong>连接的两列在两张表中列名相同</strong></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">,</span>
	c<span class="token punctuation">.</span>first_name<span class="token punctuation">,</span>
	o<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
	sh<span class="token punctuation">.</span>name <span class="token keyword">AS</span> shipper 
<span class="token keyword">FROM</span>
	customers c
	<span class="token keyword">JOIN</span> orders o 
	<span class="token comment">-- ON o.customer_id = c.customer_id </span>
	<span class="token keyword">USING</span> <span class="token punctuation">(</span> customer_id <span class="token punctuation">)</span>
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> shippers sh
	<span class="token comment">-- ON o.shipper_id = sh.customer_id </span>
	<span class="token keyword">USING</span> <span class="token punctuation">(</span> shipper_id <span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	c<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span>
	
<span class="token comment">-- 多个连接条件时</span>
<span class="token keyword">SELECT</span>
	<span class="token operator">*</span> 
<span class="token keyword">FROM</span>
	order_items oi
	<span class="token keyword">JOIN</span> order_item_notes oin 
	<span class="token comment">-- ON oi.order_id = oin.order_id AND oi.product_id = oin.product_id;</span>
	<span class="token keyword">USING</span> <span class="token punctuation">(</span> order_id<span class="token punctuation">,</span> product_id <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="自然连接"><a href="#自然连接" class="headerlink" title="自然连接"></a>自然连接</h4><p>连接时不需要输入连接条件，交由数据库引擎自行决定基于共同的列连接。不推荐使用，因为不可控。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
	<span class="token keyword">FROM</span> orders o
<span class="token keyword">NATURAL</span> <span class="token keyword">JOIN</span> customers c<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="联合"><a href="#联合" class="headerlink" title="联合"></a>联合</h4><p>结合多个查询的结果</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 2019-01-01 之后的为活跃的订单</span>
<span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token string">'Active'</span> <span class="token keyword">AS</span> <span class="token keyword">STATUS</span> 
<span class="token keyword">FROM</span>
	orders 
<span class="token keyword">WHERE</span>
	order_date <span class="token operator">&gt;=</span> <span class="token string">'2019-01-01'</span><span class="token punctuation">;</span>
<span class="token comment">-- 2019-01-01 之后的为完成的订单</span>
<span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token string">'Archived'</span> <span class="token keyword">AS</span> <span class="token keyword">STATUS</span> 
<span class="token keyword">FROM</span>
	orders 
<span class="token keyword">WHERE</span>
	order_date <span class="token operator">&lt;</span> <span class="token string">'2019-01-01'</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 通过使用 UNION 将两个查询结果合并， 其中返回结果的列明，取决于第一个查询的结果</span>
<span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token string">'Active'</span> <span class="token keyword">AS</span> <span class="token keyword">STATUS</span> 
<span class="token keyword">FROM</span>
	orders 
<span class="token keyword">WHERE</span>
	order_date <span class="token operator">&gt;=</span> <span class="token string">'2019-01-01'</span> 
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token string">'Archived'</span> <span class="token keyword">AS</span> <span class="token keyword">STATUS</span> 
<span class="token keyword">FROM</span>
	orders 
<span class="token keyword">WHERE</span>
	order_date <span class="token operator">&lt;</span> <span class="token string">'2019-01-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><blockquote>
<p><code>Inserting Data</code></p>
</blockquote>
<h3 id="插入单行"><a href="#插入单行" class="headerlink" title="插入单行"></a>插入单行</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 第一列为主键列，因为这里对主键列设置了自增，以及主键不可重复，所以最好不要使用手动设置值，而是由引擎自动生成</span>
<span class="token comment">-- DEFAULT 由引擎根据默认值自动填充</span>
<span class="token comment">-- 不指定列名时，默认按照创建表时候的顺序插入</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> customers <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Smith'</span><span class="token punctuation">,</span> <span class="token string">'1990-01-01'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">,</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 也可也指定列表</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> customers 
<span class="token punctuation">(</span>customer_id<span class="token punctuation">,</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> birth_date<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> address<span class="token punctuation">,</span> city<span class="token punctuation">,</span> state<span class="token punctuation">,</span> points<span class="token punctuation">)</span> 
<span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'Smith'</span><span class="token punctuation">,</span> <span class="token string">'1990-01-01'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">,</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 当然也可以对列名的顺序进行调整，只需要保证值与其一一对应即可</span>
<span class="token comment">-- 这里调整了名字和姓氏的顺序</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> customers 
<span class="token punctuation">(</span>customer_id<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> first_name<span class="token punctuation">,</span> birth_date<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> address<span class="token punctuation">,</span> city<span class="token punctuation">,</span> state<span class="token punctuation">,</span> points<span class="token punctuation">)</span> 
<span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token string">'Smith'</span><span class="token punctuation">,</span> <span class="token string">'John'</span><span class="token punctuation">,</span> <span class="token string">'1990-01-01'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">,</span> <span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 如果对于一些由默认值的列，或者没有设置必填的列可以在插入的时候不指定值</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> customers 
<span class="token punctuation">(</span>first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> address<span class="token punctuation">,</span> city<span class="token punctuation">,</span> state<span class="token punctuation">)</span> 
<span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token string">'John_1'</span><span class="token punctuation">,</span> <span class="token string">'Smith_1'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">,</span> <span class="token string">'city'</span><span class="token punctuation">,</span> <span class="token string">'CA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="插入多行"><a href="#插入多行" class="headerlink" title="插入多行"></a>插入多行</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 插入多行语法基本于上节的单行类似。 不同的地方在于 VALUES 之后的值可以设置多组。</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> shippers 
<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token string">'Shipper1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'Shipper2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'Shipper3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="多张表插入行"><a href="#多张表插入行" class="headerlink" title="多张表插入行"></a>多张表插入行</h3><p>主要应用于有多张表关联之间存在<code>ID</code>关联的情况。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders 
<span class="token punctuation">(</span>customer_id<span class="token punctuation">,</span> order_date<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> 
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-01-02'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> order_items
<span class="token keyword">VALUES</span>
<span class="token punctuation">(</span>LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.95</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span>LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 在MYSQL中有一个内置方法用来获取 最近插入的ID， 即 LAST_INSERT_ID(); 这个方法视不同的数据库有不同的方法</span>
<span class="token keyword">SELECT</span> LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将一张表中的数据复制到另一张表</span>

<span class="token comment">-- 如果没有表，创建一张表，复制原始表的结构以及数据</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders_archived <span class="token keyword">AS</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders<span class="token punctuation">;</span>
<span class="token comment">-- 这里有个问题，复制的新表会忽略掉原始表中的索引以及自增这些属性</span>
<span class="token comment">-- 这里的 “SELECT * FROM orders” 属于sql中子查询的部分</span>

<span class="token comment">-- 如果已经有表的存在，只需要复制数据，（当然子查询部分可以使用一些条件属性来复制部分的数据）</span>
<span class="token keyword">INSERT</span>  <span class="token keyword">INTO</span> orders_archived 
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> orders 
<span class="token keyword">WHERE</span> order_date <span class="token operator">&lt;</span> <span class="token string">'2019-01-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><blockquote>
<p><code>Updating Data</code></p>
</blockquote>
<h3 id="更新单行"><a href="#更新单行" class="headerlink" title="更新单行"></a>更新单行</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 根据条件更新一行数据, 这里指定了ID为过滤条件，所以只有一行会符合条件，故只会更新一行数据，本质上是根据条件更新</span>
<span class="token keyword">UPDATE</span> invoices 
<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> payment_date <span class="token operator">=</span> <span class="token string">'2019-03-01'</span>
<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 有默认值的行，也可以设置为默认值</span>
<span class="token keyword">UPDATE</span> invoices 
<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> payment_date <span class="token operator">=</span> <span class="token string">'2019-03-01'</span>
<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="更新多行"><a href="#更新多行" class="headerlink" title="更新多行"></a>更新多行</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 更新多行基本语法于上节更新一行一样，不过是限定条件去匹配多行就可以更新了，本质上也是根据条件更新</span>
<span class="token keyword">UPDATE</span> invoices
<span class="token keyword">SET</span> 
	payment_total <span class="token operator">=</span> invoice_total <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
	payment_date <span class="token operator">=</span> due_date
<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="更新语句中使用子查询"><a href="#更新语句中使用子查询" class="headerlink" title="更新语句中使用子查询"></a>更新语句中使用子查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 通过子查询部分来更新，本质上也是根据条件更新</span>
<span class="token keyword">UPDATE</span> invoices
<span class="token keyword">SET</span> 
	payment_total <span class="token operator">=</span> invoice_total <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
	payment_date <span class="token operator">=</span> due_date
<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> client_id 
                  <span class="token keyword">FROM</span> clients
                  <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'Myworks'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 如果子查询结果有多行，中间的连接关键字可以换成 IN， 当然这里可以根据实际需求可以使用多种限定的组合</span>
<span class="token keyword">UPDATE</span> invoices
<span class="token keyword">SET</span> 
	payment_total <span class="token operator">=</span> invoice_total <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
	payment_date <span class="token operator">=</span> due_date
<span class="token keyword">WHERE</span> client_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> client_id 
                  <span class="token keyword">FROM</span> clients
                  <span class="token keyword">WHERE</span> state <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'CA'</span><span class="token punctuation">,</span> <span class="token string">'NY'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  
<span class="token keyword">UPDATE</span> invoices
<span class="token keyword">SET</span> 
	payment_total <span class="token operator">=</span> invoice_total <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
	payment_date <span class="token operator">=</span> due_date
<span class="token keyword">WHERE</span> payment_date <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h2><blockquote>
<p><code>Deleting Data</code></p>
</blockquote>
<h3 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 类似于更新语句，根据指定条件删除数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> invoices <span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 这里如果去掉了限制条件，将会是删除所有数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> invoices<span class="token punctuation">;</span>

<span class="token comment">-- 类似于更新语句，也可以使用子查询</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> client_id <span class="token operator">in</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
    <span class="token keyword">FROM</span> clients
    <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'Myworks'</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="汇总数据"><a href="#汇总数据" class="headerlink" title="汇总数据"></a>汇总数据</h2><blockquote>
<p><code>Summarizing Data</code></p>
</blockquote>
<h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><p>MySql中有很多函数，其中有一写聚合函数是取一系列的只并根据规则合并为一个单一的值。例如</p>
<ul>
<li><code>MAX()</code><ul>
<li>最大值</li>
</ul>
</li>
<li><code>MIN()</code><ul>
<li>最小值</li>
</ul>
</li>
<li><code>AVG()</code><ul>
<li>平均值</li>
</ul>
</li>
<li><code>SUM()</code><ul>
<li>求和</li>
</ul>
</li>
<li><code>COUNT()</code><ul>
<li>计数</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意，这里的聚合函数默认只统计非空值的行，如果所统计的列中存在空值，将不会被计算。</p>
<p>使用<code>COUNT()</code>时，如果想要统计空值，可以使用<code>COUNT(*)</code>语法来统计。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 应用函数在指定的列上，当然下方也可以添加 WHERE 语句来过滤数据后统计</span>
<span class="token keyword">SELECT</span>
	<span class="token function">MAX</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> highest<span class="token punctuation">,</span>
	<span class="token function">MIN</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> lowest<span class="token punctuation">,</span>
	<span class="token function">AVG</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> average<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total<span class="token punctuation">,</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> number_of_invoices<span class="token punctuation">,</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token keyword">DISTINCT</span> client_id <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_records<span class="token punctuation">,</span> <span class="token comment">-- 将列去重后再计数</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token operator">*</span> <span class="token number">1.1</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_1_1 <span class="token comment">-- 这里将先对所有列 * 1.1，后计算总和</span>
<span class="token keyword">FROM</span>
	invoices
<span class="token keyword">WHERE</span> invoice_date <span class="token operator">&gt;</span> <span class="token string">'2019-07-01'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="GROUP-BY-子句"><a href="#GROUP-BY-子句" class="headerlink" title="GROUP BY 子句"></a>GROUP BY 子句</h3><p>根据指定一个或多个列进行分组。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 根据client_id分组，即该列字段值相同就会分为一组，对每组分别执行聚合函数。 最终是每组分别求和</span>
<span class="token keyword">SELECT</span> 
	client_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id<span class="token punctuation">;</span>

<span class="token comment">-- 当然这个也可也搭配其他语句使用, 这里将会先进行WHERE过滤语句，然后分组之后，根据计算的总和进行排序返回</span>
<span class="token keyword">SELECT</span> 
	client_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> invoice_date <span class="token operator">&gt;=</span> <span class="token string">'2019-07-01'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> total_sales <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 这里是根据多列进行分组，即这两列字段分别相同将分为一组，就可以获得每个state和city组合下的total_sales了。</span>
<span class="token keyword">SELECT</span> 
	state<span class="token punctuation">,</span>
	city<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices i
<span class="token keyword">JOIN</span> clients <span class="token keyword">USING</span> <span class="token punctuation">(</span> client_id <span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> state<span class="token punctuation">,</span> city<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="HAVING-子句"><a href="#HAVING-子句" class="headerlink" title="HAVING 子句"></a>HAVING 子句</h3><p>如果需要对聚合后的值进行过滤，除了使用内查询的方式来解决，也可也尝试使用 <code>HAVING</code></p>
<blockquote>
<p>注意，<code>HAVING</code>中使用的列必须要存在于 <code>SELECT</code> 结果列中，这点不同于<code>WHERE</code>语句可以使用结果列中不存在但是存在于表中的字段。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 获得销售总额大于 500 的数据 </span>
<span class="token keyword">SELECT</span> 
	client_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id
<span class="token keyword">HAVING</span> total_sales <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">;</span>

<span class="token comment">-- 当然 HAVING 中也可以添加多个过滤条件</span>
<span class="token keyword">SELECT</span> 
	client_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales<span class="token punctuation">,</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> number_of_invoices
<span class="token keyword">FROM</span> invoices
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id
<span class="token keyword">HAVING</span> total_sales <span class="token operator">&gt;</span> <span class="token number">500</span> <span class="token operator">AND</span> number_of_invoices <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ROLLUP运算符"><a href="#ROLLUP运算符" class="headerlink" title="ROLLUP运算符"></a>ROLLUP运算符</h3><p><code>MySql</code>中在使用了<code>GROUP BY</code>之后再跟上 <code>WITH ROLLUP</code> 将会汇总整个结果集。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 返回对invoice_total的汇总</span>
<span class="token keyword">SELECT</span> 
	client_id<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id <span class="token keyword">WITH ROLLUP</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_008.png" class="" title="image_008">

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 将会对每个组以及整个结果集进行汇总</span>
<span class="token keyword">SELECT</span> 
	state<span class="token punctuation">,</span>
	city<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> invoices i
<span class="token keyword">JOIN</span> clients <span class="token keyword">USING</span> <span class="token punctuation">(</span> client_id <span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> state<span class="token punctuation">,</span> city <span class="token keyword">WITH ROLLUP</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_009.png" class="" title="image_009">

<h2 id="复杂查询语句"><a href="#复杂查询语句" class="headerlink" title="复杂查询语句"></a>复杂查询语句</h2><blockquote>
<p><code>Writing Complex Queries</code></p>
</blockquote>
<p>这里主要就是应用前几章简单应用过的子查询语句。</p>
<h3 id="子查询-x2F-内查询"><a href="#子查询-x2F-内查询" class="headerlink" title="子查询/内查询"></a>子查询/内查询</h3><p>子查询就是再另一个SQL语句中嵌套执行的一个查询语句。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_store

<span class="token comment">-- 再这个示例中，将会先执行括号中的内查询语句（也就是子查询），将获取到的结果返回给外部的查询</span>
<span class="token comment">-- 注意这里使用了 &gt; 比较符号，是因为结果只有一个，所以可以使用比较符号。 如果内查询返回多个的话就会出现错误</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> products
<span class="token keyword">WHERE</span> unit_price <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> unit_price
    <span class="token keyword">FROM</span> products
    <span class="token keyword">WHERE</span> product_id <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注意，上述示例使用了 <code>&gt;</code> 比较符号，是因为结果只有一个，所以可以使用比较符号。 如果内查询返回多个的话就会出现错误。</p>
<p>解决方案可以参考 ALL 关键字的使用。</p>
</blockquote>
<h3 id="IN-运算符-1"><a href="#IN-运算符-1" class="headerlink" title="IN 运算符"></a>IN 运算符</h3><p>针对内查询有多个返回结果的情况，就可以使用<code>IN</code>进行连接。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 这里是返回 product_id 不再子查询结果中的行</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> products
<span class="token keyword">WHERE</span> product_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> product_id
	<span class="token keyword">FROM</span> order_items
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>注意，这里外查询时使用一个列的数据进行对比，所以内查询返回的数据也是一列。如果内查询返回多列数据的话，同样也会执行错误。</p>
</blockquote>
<h3 id="子查询-VS-连接"><a href="#子查询-VS-连接" class="headerlink" title="子查询 VS 连接"></a>子查询 VS 连接</h3><p>通常简单的子查询语句也可以使用连接来达到相同的结果。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 对比下以下两个语句</span>
<span class="token comment">-- 内查询方式</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> clients
<span class="token keyword">WHERE</span> client_id <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> client_id
    <span class="token keyword">FROM</span> invoices
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 连接方式</span>
<span class="token keyword">SELECT</span> c<span class="token punctuation">.</span><span class="token operator">*</span> 
<span class="token keyword">FROM</span> clients c
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> invoices <span class="token keyword">USING</span> <span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> invoice_id <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>具体使用哪种实现方式，视自己的需求来决定，选择相对简单易读的</p>
</blockquote>
<h3 id="ALL-关键字"><a href="#ALL-关键字" class="headerlink" title="ALL 关键字"></a>ALL 关键字</h3><p><code>ALL</code> ，将数值对比应用到子查询的每一行上，可以用来对子查询返回多个结果但需要使用单一的比较操作符时。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 查询比 client_id = 3 的发票总额还要大的所以发票信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> invoice_total <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>invoice_total<span class="token punctuation">)</span>
	<span class="token keyword">FROM</span> invoices
	<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 这中查询，就可以使用 ALL 关键词来简化查询</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> invoice_total <span class="token operator">&gt;</span> <span class="token keyword">ALL</span> <span class="token punctuation">(</span> <span class="token comment">-- 即于子查询中所有返回结果进行对比</span>
	<span class="token keyword">SELECT</span> invoice_total <span class="token comment">-- 注意这里返回了多个结果，如果不添加ALL关键词，将无法进行数值对比</span>
	<span class="token keyword">FROM</span> invoices
	<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> <span class="token number">3</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>可以解决 子查询章节中说的数值对比，内查询返回不唯一的问题。</p>
</blockquote>
<h3 id="ANY-关键字"><a href="#ANY-关键字" class="headerlink" title="ANY 关键字"></a>ANY 关键字</h3><p><code>MySql</code>里还有一些其他字段于 <code>ALL</code> 字段类似，例如 <code>ANY</code>、<code>SOME</code>，作用于<code>ALL</code>略用不同，<code>ALL</code>时针对子查询中的所有行都需要符合比较符，而 <code>ANY</code>、<code>SOME</code>则是有任意一个或多个符合比较符即可。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 子查询返回结果有多个，这里是获取客户的发票数多于2两张的信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> clients
<span class="token keyword">WHERE</span> client_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> client_id
    <span class="token keyword">FROM</span> invoices
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id
    <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token number">2</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用 ANY 改造</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> clients
<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> <span class="token keyword">ANY</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> client_id
    <span class="token keyword">FROM</span> invoices
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id
    <span class="token keyword">HAVING</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span><span class="token number">2</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="相关子查询"><a href="#相关子查询" class="headerlink" title="相关子查询"></a>相关子查询</h3><p>即子查询和外查询具有相关性，例如下方的示例中，在子查询的过滤条件上使用到了外查询的字段。之前章节的查询都非相关子查询。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> employees e
<span class="token keyword">WHERE</span> salary <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> employees
    <span class="token keyword">WHERE</span> office_id <span class="token operator">=</span> e<span class="token punctuation">.</span>office_id <span class="token comment">-- 注意这里的比较条件，第二个office_id前有表名前缀，针对的是外查询的 employees</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 在这个查询中，将会先扫描外部查询表 employees 的第一行，然后在执行内部查询计算平均值，和外部查询的第一行对比，符合条件则返回；之后会扫描外部查询表 employees 的第二行执行相同的操作，直到所有行遍历完。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<strong>非相关子查询</strong>中，因为没有利用到外查询中的属性，所有子查询只会执行一次就返回结果给外查询。</p>
<p>在<strong>相关子查询</strong>中，子查询将会在主查询每一行的层面执行，所有执行的非常慢，数据越多，查询越非时间也会占用更多的存储。所以通常不推荐使用。</p>
<h3 id="EXISTS-运算符"><a href="#EXISTS-运算符" class="headerlink" title="EXISTS 运算符"></a>EXISTS 运算符</h3><p>将外查询表的<strong>每一行</strong>，代入内查询作为检验，如果内查询返回的结果取非空值，则EXISTS子句返回TRUE，这一行行可作为外查询的结果行，否则不能作为结果。</p>
<p>执行顺序如下：</p>
<ol>
<li><strong>首先执行一次外查询</strong></li>
<li><strong>对于外查询中的每一行分别执行一次子查询，而且每次执行子查询时都会引用外查询中当前行的值</strong></li>
<li><strong>使用子查询的结果来确定外查询的结果集。 如果外部查询返回10行，SQL 就将执行11次查询，一次执行外查询，然后为外查询返回的每一行执行一次子查询</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用子查询来查询在 invoices 中拥有发票记录的 client 信息</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> clients 
<span class="token keyword">WHERE</span> client_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> client_id
    <span class="token keyword">FROM</span> invoices
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 这种可以使用 EXISTS 来实现同样的结果</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> clients c
<span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span> <span class="token comment">-- 使用 EXISTS 运算符来查看是否有符合条件的行</span>
	<span class="token keyword">SELECT</span> client_id
    <span class="token keyword">FROM</span> invoices
    <span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> c<span class="token punctuation">.</span>client_id
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>使用 <code>IN</code> 的方式执行子查询，实际上是先执行子查询，将子查询的结果返回给外查询，<code>SQL</code>类似于：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> clients 
<span class="token keyword">WHERE</span> client_id <span class="token operator">IN</span> <span class="token punctuation">(</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是当符合条件的数据成千上万或者上亿时，<code>IN</code> 的列表就会有很多数据，性能将会降低很多。</p>
<p>这样的情况下，使用<code>EXISTS</code>运算符会能够极大的提高效率。</p>
<p>使用 <code>EXISTS</code> 并不会给外查询返回一个结果，而是返回一个指令，说明这个子查询是否符合这个搜索条件的行，符合时即返回 <code>TRUE</code>。</p>
</blockquote>
<h3 id="SELECT-语句中的子查询"><a href="#SELECT-语句中的子查询" class="headerlink" title="SELECT 语句中的子查询"></a>SELECT 语句中的子查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 在SELECT语句中也可也嵌入子查询</span>
<span class="token keyword">SELECT</span>
	invoice_id<span class="token punctuation">,</span>
	invoice_total<span class="token punctuation">,</span>
	<span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span>
    	<span class="token keyword">FROM</span> invoices<span class="token punctuation">)</span> <span class="token keyword">AS</span> invoice_average<span class="token punctuation">,</span> <span class="token comment">-- 子查询计算</span>
    invoice_total <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span>
    	<span class="token keyword">FROM</span> invoices<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 这里的计算方式可以简化为下面列的子查询</span>
    invoice_total <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token keyword">SELECT</span> invoice_average <span class="token punctuation">)</span> <span class="token comment">-- 这里 ( SELECT invoice_average ) 也是一个子查询</span>
<span class="token keyword">FROM</span> invoices<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="FROM-语句中的子查询"><a href="#FROM-语句中的子查询" class="headerlink" title="FROM 语句中的子查询"></a>FROM 语句中的子查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 本质上时通过 子查询产生一个临时表，然后在基于这个临时表做一些查询过滤</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> client_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span>
    	<span class="token keyword">FROM</span> invoices
    	<span class="token keyword">WHERE</span> client_id <span class="token operator">=</span> c<span class="token punctuation">.</span>client_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">FROM</span> invoices<span class="token punctuation">)</span> <span class="token keyword">AS</span> average<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> total_sales <span class="token operator">-</span> average<span class="token punctuation">)</span> <span class="token keyword">AS</span> difference
    <span class="token keyword">FROM</span> clients c
<span class="token punctuation">)</span> <span class="token keyword">AS</span> sales_summary <span class="token comment">-- 这里到上面的 FROM 部分就是属于一个子查询</span>
<span class="token keyword">WHERE</span> total_sales <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="MySql常用内置函数"><a href="#MySql常用内置函数" class="headerlink" title="MySql常用内置函数"></a>MySql常用内置函数</h2><blockquote>
<p><code>Built-in Functions</code></p>
</blockquote>
<p>当然不同数据库中内置的函数有所区别，具体使用方式可以去翻看对应的数据库文档</p>
<h3 id="数值函数"><a href="#数值函数" class="headerlink" title="数值函数"></a>数值函数</h3><p>这里汇总了MySQL中部分函数，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/numeric-functions.html" title="点击跳转">完整函数名单</a>详见 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/numeric-functions.html">https://dev.mysql.com/doc/refman/8.0/en/numeric-functions.html</a></p>
<ul>
<li><p><code>SELECT ROUND(5.7346)</code> </p>
<ul>
<li>四舍五入为整数</li>
</ul>
</li>
<li><p><code>SELECT ROUND(5.7346, 2)</code></p>
<ul>
<li>指定四舍五入后的数据精度为保留两位小数</li>
</ul>
</li>
<li><p><code>SELECT TRUNCATE(5.7346, 2)</code></p>
<ul>
<li>截断数字</li>
</ul>
</li>
<li><p><code>SELECT CEILING(5.7346)</code></p>
<ul>
<li>向上取整，返回大于或等于这个数字的最小整数</li>
</ul>
</li>
<li><p><code>SELECT FLOOR(5.7346, 2)</code></p>
<ul>
<li>向下取整，返回小于或等于这个数字的最大整数</li>
</ul>
</li>
<li><p><code>SELECT ABS(5.7346, 2)</code></p>
<ul>
<li>计算绝对值</li>
</ul>
</li>
<li><p><code>SELECT RAND()</code></p>
<ul>
<li>生成 0——1 区间的随机浮点数</li>
</ul>
</li>
</ul>
<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><p>这里汇总了MySQL中部分函数，<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/string-functions.html" title="点击跳转">完整函数名单</a>详见 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/string-functions.html">https://dev.mysql.com/doc/refman/8.0/en/string-functions.html</a></p>
<ul>
<li><p><code>SELECT LENGTH('sky')</code></p>
<ul>
<li>返回字符串长度</li>
</ul>
</li>
<li><p><code>SELECT UPPER('sky')</code></p>
<ul>
<li>返回字符串的大写模式</li>
</ul>
</li>
<li><p><code>SELECT LOWER('sky')</code></p>
<ul>
<li>返回字符串的小写模式</li>
</ul>
</li>
<li><p><code>SELECT LTRIM('sky')</code>、<code>left trim的缩写</code></p>
<ul>
<li>移除字符串左侧空白字符或其他预定义字符</li>
</ul>
</li>
<li><p><code>SELECT RTRIM('sky')</code>、<code>right trim的缩写</code></p>
<ul>
<li>移除字符串右侧空白字符或其他预定义字符</li>
</ul>
</li>
<li><p><code>SELECT TRIM('sky')</code></p>
<ul>
<li>移除字符串左右侧空白字符或其他预定义字符</li>
</ul>
</li>
<li><p><code>SELECT LEFT('Kindergarten', 4)</code></p>
<ul>
<li>返回字符串左侧4个字符</li>
</ul>
</li>
<li><p><code>SELECT RIGHT('Kindergarten', 6)</code></p>
<ul>
<li>返回字符串右侧6个字符</li>
</ul>
</li>
<li><p><code>SELECT SUBSTRING('Kindergarten', 3, 5)</code></p>
<ul>
<li>返回字符串的子字符串，从3号位之后5个字符长度的字符串<code>nderg</code>。第三个参数不填写时返回剩余字符串。索引由 1 开始增长。</li>
</ul>
</li>
<li><p><code>SELECT LOCATE('n','Kindergarten')</code></p>
<ul>
<li>返回字符串中<code>Kindergarten</code>中<code>n</code>第一次出现的位置3。如果字符串不存在则返回0，因为这里索引由1开始增长。</li>
</ul>
</li>
<li><p><code>SELECT REPLACE('Kindergarten', 'garten', 'garden')</code></p>
<ul>
<li>使用<code>garden</code>来替换<code>Kindergarten</code>中出现的<code>garten</code>。</li>
</ul>
</li>
<li><p><code>SELECT CONCAT('frist', 'last', '_n')</code></p>
<ul>
<li><p>将多个字符串拼接为一个字符串</p>
</li>
<li><p>```sql<br>SELECT CONCAT(first_name, ‘ ‘, last_name) AS full_name<br>FROM customers;</p>
<pre class="line-numbers language-none"><code class="language-none">
  + 

### 日期函数

这里汇总了MySQL中部分函数，[完整函数名单](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html '点击跳转')详见 https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html

+ `SELECT NOW()`
  + 返回当前系统的日期和时间
+ `SELECT CURDATE()`
  + 返回当前系统的日期
+ `SELECT CURTIME()`
  + 返回当前系统的时间
+ `SELECT YEAR(NOW()), MONTH(NOW()), DAY(NOW()), HOUR(NOW()), MINUTE(NOW()), SECOND(NOW()). DAYNAME(NOW()), MONTHNAME(NOW())`
  + 分别返回时间中的年、月、日、小时、分钟、秒、字符串的星期、字符串的月份
+ `SELECT EXTRACT(DAY FROM NOW())`， `SELECT EXTRACT(YEAR FROM NOW())`
  + 这是SQL标准语言中的函数，获得时间中指定的参数

### 格式化日期函数

+ `SELECT DATE_FORMAT(NOW(), '%M %d %Y')`
  + 按照指定的模式串返回时间的字符串形式。[模式串在线文档](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_date-format '点击跳转')。

### 计算日期和时间

+ `SELECT DATE_ADD(NOW(), INTERVAL 1 DAY)`，`SELECT DATE_ADD(NOW(), INTERVAL 1 YEAR)`，`SELECT DATE_ADD(NOW(), INTERVAL -1 DAY)`
  + 给时间加上指定的天数，或者其他单位时间
+ `SELECT DATE_SUB(NOW(), INTERVAL 1 DAY)`
  + 给时间减去指定的天数
+ `SELECT DATEDIFF('2019-01-05 09:00', '2019-01-01 10:00')`
  + 返回两个时间之间天数的差距，如果后面的更大则返回小数
+ `SELECT TIME_TO_SEC('09:00')`
  + 计算当前时间在当天的第几秒。即转换单位为秒

### IFNULL 函数

```sql
SELECT 
	order_id,
	IFNULL(shipper_id, 'Not assigned') AS shipper -- 如果shipper_id是NULL,则返回第二个参数
FROM orders;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
</ul>
<img src="/2023/04/23/cs-data/data-sql/image_010.png" class="" title="image_010">

<h3 id="COALESCE函数"><a href="#COALESCE函数" class="headerlink" title="COALESCE函数"></a>COALESCE函数</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
	order_id<span class="token punctuation">,</span>
	<span class="token keyword">COALESCE</span><span class="token punctuation">(</span>shipper_id<span class="token punctuation">,</span> comments<span class="token punctuation">,</span> <span class="token string">'Not assigned'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> shipper <span class="token comment">-- 如果shipper_id是NULL,则返回第二个参数, 如果第二个参数还是NULL，则返回第三个参数</span>
<span class="token keyword">FROM</span> orders<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_011.png" class="" title="image_011">

<h3 id="IF-函数"><a href="#IF-函数" class="headerlink" title="IF 函数"></a>IF 函数</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token keyword">IF</span> <span class="token punctuation">(</span>  <span class="token comment">-- if 判断</span>
    	<span class="token keyword">YEAR</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">-- 判断条件</span>
        <span class="token string">'Active'</span><span class="token punctuation">,</span> <span class="token comment">-- 如果判断条件是 TRUE 返回该参数</span>
        <span class="token string">'Archived'</span> <span class="token comment">-- 如果判断条件是 FALSE 返回该参数</span>
    <span class="token punctuation">)</span>
<span class="token keyword">FROM</span> orders<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="CASE-运算符"><a href="#CASE-运算符" class="headerlink" title="CASE 运算符"></a>CASE 运算符</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	order_id<span class="token punctuation">,</span>
	order_date<span class="token punctuation">,</span>
	<span class="token keyword">CASE</span>  <span class="token comment">-- 多条件判断</span>
		<span class="token keyword">WHEN</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span> <span class="token string">'Active'</span> <span class="token comment">-- 判断条件为 真 则返回 THEN 之后的数据</span>
		<span class="token keyword">WHEN</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'Last Year'</span>
		<span class="token keyword">WHEN</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>order_date<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span><span class="token string">'2019-01-01'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'Archived'</span>
		<span class="token keyword">ELSE</span> <span class="token string">'Future'</span>  <span class="token comment">-- 以上所有判断条件都为 假 返回该数据</span>
	<span class="token keyword">END</span> <span class="token keyword">AS</span> category<span class="token comment">-- 结束多条件判断</span>
<span class="token keyword">FROM</span> orders<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><blockquote>
<p><code>Views</code></p>
</blockquote>
<p>将查询或者子查询保存到视图里，这样可以直接通过视图查询，而不用每次查询数据都写一遍复杂的查询语句。</p>
<p><strong>视图提供了一种对表的抽象化</strong>。</p>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 根据查询语句创建一个视图</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> sales_by_client <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
	c<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
	c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> clients c
<span class="token keyword">JOIN</span> invoices i <span class="token keyword">USING</span> <span class="token punctuation">(</span> client_id <span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id<span class="token punctuation">,</span> name<span class="token punctuation">;</span>

<span class="token comment">-- 之后便可以直接基于视图查询了, 其查询语句语法和普通的表相同，也可以执行连接等语法。</span>
<span class="token comment">-- 将视图视为一张虚拟的表即可</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> sales_by_client
<span class="token keyword">WHERE</span> total_sales <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_012.png" class="" title="image_012">

<h3 id="更改视图"><a href="#更改视图" class="headerlink" title="更改视图"></a>更改视图</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 如果要修改视图</span>
<span class="token comment">-- 方案一，是先删除原有的视图，之后再创建一个同名的新视图</span>

<span class="token comment">-- 方案二，是使用 REPLACE </span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> sales_by_client <span class="token keyword">AS</span>  <span class="token comment">-- 如果不存在就会创建，已存在就会替换</span>
<span class="token keyword">SELECT</span>
	c<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span>
	c<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
	<span class="token function">SUM</span><span class="token punctuation">(</span> invoice_total <span class="token punctuation">)</span> <span class="token keyword">AS</span> total_sales
<span class="token keyword">FROM</span> clients c
<span class="token keyword">JOIN</span> invoices i <span class="token keyword">USING</span> <span class="token punctuation">(</span> client_id <span class="token punctuation">)</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> client_id<span class="token punctuation">,</span> name<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> sales_by_client<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="可更新视图"><a href="#可更新视图" class="headerlink" title="可更新视图"></a>可更新视图</h3><p>当然，在一些特定的情况下，也可也针对视图使用 <code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code></p>
<p>即再视图中没有以下关键字的使用，就可以称为可更新的视图</p>
<ul>
<li><code>DISTINCT</code></li>
<li>聚合函数，例如：<code>MIN</code>、<code>MAX</code>、<code>SUM</code></li>
<li><code>GROUP BY</code>、<code>HAVING</code></li>
<li><code>UNION</code></li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建一个视图</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> invoices_with_balance <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
	invoice_id<span class="token punctuation">,</span>
	number<span class="token punctuation">,</span>
	client_id<span class="token punctuation">,</span>
	payment_total<span class="token punctuation">,</span>
	invoice_total <span class="token operator">-</span> payment_total <span class="token keyword">AS</span> balance<span class="token punctuation">,</span>
	invoice_date<span class="token punctuation">,</span>
	due_date<span class="token punctuation">,</span>
	payment_date
<span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>invoice_total <span class="token operator">-</span> payment_total<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- 之后就可以向操作一张表一样操作视图了</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> invoices_with_balance <span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> invoices_with_balance <span class="token keyword">SET</span> due_date <span class="token operator">=</span> DATE_ADD<span class="token punctuation">(</span>due_date<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token number">2</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">-- 在插入数据时，只有视图中具有基础表中的所有列是才能正常插入数据，比如，如果视图中少了基础表中的一个必填列时，将不能再视图中插入数据。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="WITH-OPTION-CHECK子句"><a href="#WITH-OPTION-CHECK子句" class="headerlink" title="WITH OPTION CHECK子句"></a>WITH OPTION CHECK子句</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 当使用如下语句更新视图中的数据后，再次查询视图，会发现缺少了一部分数据</span>
<span class="token keyword">UPDATE</span> invoices_with_balance
<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> invoice_total
<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- 因为当通过视图更新或者删除数据时，会导致一些行的消失</span>
<span class="token comment">-- 如果不希望UPDATE或者DELETE语句将行从视图中删除，则需要再视图的最后一行添加上</span>
<span class="token comment">-- WITH CHECK OPTION</span>
<span class="token comment">-- 来防止行从视图中删除</span>
<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> invoices_with_balance <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
	invoice_id<span class="token punctuation">,</span>
	number<span class="token punctuation">,</span>
	client_id<span class="token punctuation">,</span>
	payment_total<span class="token punctuation">,</span>
	invoice_total <span class="token operator">-</span> payment_total <span class="token keyword">AS</span> balance<span class="token punctuation">,</span>
	invoice_date<span class="token punctuation">,</span>
	due_date<span class="token punctuation">,</span>
	payment_date
<span class="token keyword">FROM</span> invoices
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>invoice_total <span class="token operator">-</span> payment_total<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">WITH</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span> <span class="token comment">-- 防止数据被视图中删除， 这样如果导致被删除的语句操作会无法执行，有错误提示</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="视图的其他优点"><a href="#视图的其他优点" class="headerlink" title="视图的其他优点"></a>视图的其他优点</h3><ul>
<li>简化查询</li>
<li>减小因数据库设计改动的影响<ul>
<li>​	当视图的基础表发生改变时，如果我们的查询都时基于视图，我们只需要修改视图重新基于基础表即可，而原本的基于视图的查询语句不需要进行修改。</li>
<li>视图提供了一种对表的抽象化</li>
</ul>
</li>
<li>使用视图限制基础表访问</li>
</ul>
<h2 id="存储过程和函数"><a href="#存储过程和函数" class="headerlink" title="存储过程和函数"></a>存储过程和函数</h2><blockquote>
<p><code>Stored Procedures</code></p>
</blockquote>
<h3 id="什么时存储过程"><a href="#什么时存储过程" class="headerlink" title="什么时存储过程"></a>什么时存储过程</h3><p>存储过程时一个包含一堆<code>SQL</code>代码的数据库对象，在应用代码中，可以通过调用这些过程来获取或保存数据，使用存储过程来存储和管理<code>SQL</code>代码。大多数<code>DBMS</code>可以对存储过程里的代码做一些优化，因此在存储过程里的<code>SQL</code>代码有时候可以执行起来更快，也能加强数据安全性。</p>
<ul>
<li><code>Store and orgainze SQL</code></li>
<li><code>Faster execution</code></li>
<li><code>Data security</code></li>
</ul>
<h3 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients<span class="token punctuation">;</span> <span class="token comment">-- 因为在存储过程中,存在多个SQL语句,所有须用另一个分隔符来表示结束符号， 这里可以使用系统默认的 ;</span>
<span class="token comment">-- 但是为了区分存储过程的结束，通常会临时修改为自定义的分隔符号来结束存储过程，如下所示</span>
<span class="token keyword">END</span>

<span class="token comment">-- 创建存储过程</span>
<span class="token keyword">DELIMITER</span> $$ <span class="token comment">-- 临时修改分隔符为 $$， 当然也可也修改为其他合适的自定义字符。 主要是因为具体的执行实体上会用';' 来分割语句的结束，如果在存储过程的结束也用 ';'，容易歧义，所有修改临时的分隔符用作存储过程的结束</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients
<span class="token keyword">END</span>$$ <span class="token comment">-- 结束符号，标示存储过程完毕</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> <span class="token comment">-- 恢复分隔符</span>

<span class="token comment">-- 执行一个存储过程</span>
<span class="token keyword">CALL</span> get_clients<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="删除存储过程"><a href="#删除存储过程" class="headerlink" title="删除存储过程"></a>删除存储过程</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> get_clients<span class="token punctuation">;</span> <span class="token comment">-- 不存在时会报错</span>

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_clients<span class="token punctuation">;</span> <span class="token comment">-- 不存在时不执行，存在视图时才会执行</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建带参数的存储过程</span>
<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_clients_by_state<span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients_by_state
<span class="token punctuation">(</span>
    	state <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 定义一个参数，类型是 CHAR(2)</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients c
	<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span> <span class="token comment">-- 注意这里要跟参数的名称和列名区分开，可以选择参数重命名，或者添加表前缀</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> 

<span class="token comment">-- 调用存储过程</span>
<span class="token keyword">CALL</span> get_clients_by_state<span class="token punctuation">(</span><span class="token string">'CA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="带默认值的参数"><a href="#带默认值的参数" class="headerlink" title="带默认值的参数"></a>带默认值的参数</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建带参数的存储过程</span>
<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_clients_by_state<span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients_by_state
<span class="token punctuation">(</span>
    	state <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 定义一个参数，类型是 CHAR(2)</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">IF</span> state <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token comment">-- 声明参数为NULL时的处理</span>
		<span class="token keyword">SET</span> state <span class="token operator">=</span> <span class="token string">'CA'</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span> <span class="token comment">-- 结束 IF 子句</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients c
	<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span> <span class="token comment">-- 注意这里要跟参数的名称和列名区分开，可以选择参数重命名，或者添加表前缀</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> 
<span class="token comment">-- 调用存储过程</span>
<span class="token keyword">CALL</span> get_clients_by_state<span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 注意这里声明传递 NULL 是必须的，不能省略</span>


<span class="token comment">-- 当然 IF 不仅可以给参数设置默认值 </span>
<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_clients_by_state<span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients_by_state
<span class="token punctuation">(</span>
    	state <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 定义一个参数，类型是 CHAR(2)</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">IF</span> state <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token comment">-- 声明参数为NULL时的处理</span>
		<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients<span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span>
		<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients c
		<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>state <span class="token operator">=</span> state<span class="token punctuation">;</span> 
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span> <span class="token comment">-- 结束 IF 子句</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> 

<span class="token comment">-- 也可也简化为如下</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_clients_by_state
<span class="token punctuation">(</span>
    	state <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 定义一个参数，类型是 CHAR(2)</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> clients c
	<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>state <span class="token operator">=</span> IFNULL<span class="token punctuation">(</span>state<span class="token punctuation">,</span> c<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="参数验证"><a href="#参数验证" class="headerlink" title="参数验证"></a>参数验证</h3><p><code>SQL</code>错误码<a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/db2-for-zos/11?topic=codes-sqlstate-values-common-error" title="点击跳转">连接地址</a> ：<a target="_blank" rel="noopener" href="https://www.ibm.com/docs/en/db2-for-zos/11?topic=codes-sqlstate-values-common-error">https://www.ibm.com/docs/en/db2-for-zos/11?topic=codes-sqlstate-values-common-error</a></p>
<img src="/2023/04/23/cs-data/data-sql/image_013.png" class="" title="image_013">

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> make_payment<span class="token punctuation">;</span>
 <span class="token comment">-- 创建带有参数验证的存储过程</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> make_payment
<span class="token punctuation">(</span>
	invoice_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
	payment_amount <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	payment_date <span class="token keyword">DATE</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span> 
	<span class="token keyword">IF</span> payment_amount <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">THEN</span>
		SIGNAL SQLSTATE <span class="token string">'22003'</span>  <span class="token comment">-- 设置错误信号，以及错误码</span>
			<span class="token keyword">SET</span> MESSAGE_TEXT <span class="token operator">=</span> <span class="token string">'Invalid payment amount'</span><span class="token punctuation">;</span> <span class="token comment">-- 设置错误文本</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
	<span class="token keyword">UPDATE</span> invoices i
	<span class="token keyword">SET</span>
		i<span class="token punctuation">.</span>payment_total <span class="token operator">=</span> payment_amount<span class="token punctuation">,</span> <span class="token comment">-- 因为这里 payment_total 有非空的校验，所以就不需要再参数那里添加校验了</span>
		i<span class="token punctuation">.</span>payment_date <span class="token operator">=</span> payment_date
	<span class="token keyword">WHERE</span> i<span class="token punctuation">.</span>invoice_id <span class="token operator">=</span> invoice_id<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 测试</span>
<span class="token keyword">CALL</span> make_payment<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'2023-05-05'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_014.png" class="" title="image_014">

<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_unpaid_invoices_for_client<span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_unpaid_invoices_for_client
<span class="token punctuation">(</span>
	client_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
	<span class="token keyword">OUT</span> invoices_count <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token comment">-- 标记该参数为输出参数</span>
	<span class="token keyword">OUT</span> invoices_total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- 标记该参数为输出参数</span>
<span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span> 
	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>invoice_total<span class="token punctuation">)</span>
	<span class="token keyword">INTO</span> invoices_count<span class="token punctuation">,</span> invoices_total <span class="token comment">-- 将查询结果复制到指定参数中</span>
	<span class="token keyword">FROM</span> invoices i
	<span class="token keyword">WHERE</span> i<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client_id
		<span class="token operator">AND</span> payment_total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>


<span class="token keyword">set</span> <span class="token variable">@invoices_count</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">-- 用户自定义的变量，并设置默认值</span>
<span class="token keyword">set</span> <span class="token variable">@invoices_total</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">-- 用户自定义的变量，并设置默认值</span>

<span class="token keyword">CALL</span> get_unpaid_invoices_for_client<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token variable">@invoices_count</span><span class="token punctuation">,</span> <span class="token variable">@invoices_total</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 调用存储过程，并传递参数</span>

<span class="token keyword">SELECT</span> <span class="token variable">@invoices_count</span><span class="token punctuation">,</span> <span class="token variable">@invoices_total</span><span class="token punctuation">;</span> <span class="token comment">-- 显示参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 用户自定义参数的格式如下： SET @参数名</span>
<span class="token comment">-- 定义一个参数 invoices_count 并初始化为 0</span>
<span class="token keyword">SET</span> <span class="token variable">@invoices_count</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>


<span class="token comment">-- 本地变量， 可以再存储过程和函数中使用</span>
<span class="token comment">-- 这些变量不会再整个客户端绘画过程中保存，存储过程完成任务后就被回收</span>
<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_risk_factor<span class="token punctuation">;</span>

<span class="token comment">-- 这里的 risk_factor、invoices_total、invoices_count 就是本地变量，也可也理解为局部变量</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> get_risk_factor <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span> 
<span class="token comment">-- risk_factor = invoices_total / invoices_count * 5</span>
	<span class="token keyword">DECLARE</span> risk_factor <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">-- 定义一个本地变量，并设置默认值</span>
	<span class="token keyword">DECLARE</span> invoices_total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">DECLARE</span> invoices_count <span class="token keyword">INT</span><span class="token punctuation">;</span> 
	
	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>invoice_total<span class="token punctuation">)</span>
	<span class="token keyword">INTO</span> invoices_count<span class="token punctuation">,</span> invoices_total <span class="token comment">-- 拷贝结果</span>
	<span class="token keyword">FROM</span> invoices<span class="token punctuation">;</span>
	
	<span class="token keyword">SET</span> risk_factor <span class="token operator">=</span> invoices_total <span class="token operator">/</span> invoices_count <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">-- 计算，并设置值</span>
	
	<span class="token keyword">SELECT</span> risk_factor<span class="token punctuation">;</span> <span class="token comment">-- 展示结果</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 调用</span>
<span class="token keyword">CALL</span> get_risk_factor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><p>函数和存储过程很类似，不同的是<strong>函数只能返回单一值</strong>，比起存储过程，其无法返回拥有多行和多列的结果集。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> get_risk_factor_for_client<span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> get_risk_factor_for_client 
<span class="token punctuation">(</span>
	client_id <span class="token keyword">INT</span>
<span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">INTEGER</span>  <span class="token comment">-- 设置返回值和类型，这里和存储过程有所区别</span>
<span class="token keyword">DETERMINISTIC</span> <span class="token comment">-- 声明返回值具有确定性，即数据一样的情况下，返回值一样</span>
<span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> <span class="token comment">-- 声明属性是 读取SQL数据</span>
<span class="token comment">-- MODIFIES SQL DATA  -- 声明属性是 修改SQL数据</span>
<span class="token keyword">BEGIN</span> 
<span class="token comment">-- risk_factor = invoices_total / invoices_count * 5</span>
	<span class="token keyword">DECLARE</span> risk_factor <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">-- 定义一个本地变量，并设置默认值</span>
	<span class="token keyword">DECLARE</span> invoices_total <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token keyword">DECLARE</span> invoices_count <span class="token keyword">INT</span><span class="token punctuation">;</span> 
	
	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>invoice_total<span class="token punctuation">)</span>
	<span class="token keyword">INTO</span> invoices_count<span class="token punctuation">,</span> invoices_total <span class="token comment">-- 拷贝结果</span>
	<span class="token keyword">FROM</span> invoices i
	<span class="token keyword">WHERE</span> i<span class="token punctuation">.</span>client_id <span class="token operator">=</span> client_id<span class="token punctuation">;</span>
	
	<span class="token keyword">SET</span> risk_factor <span class="token operator">=</span> invoices_total <span class="token operator">/</span> invoices_count <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">-- 计算，并设置值</span>
	
	<span class="token keyword">RETURN</span> IFNULL<span class="token punctuation">(</span> risk_factor<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 设置返回值</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>


<span class="token comment">-- 调用</span>
<span class="token keyword">SELECT</span>
	client_id<span class="token punctuation">,</span>
	NAME<span class="token punctuation">,</span>
	get_risk_factor_for_client <span class="token punctuation">(</span> client_id <span class="token punctuation">)</span> <span class="token comment">-- 调用我们声明的函数</span>
<span class="token keyword">FROM</span>
	clients<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>函数中除了可以声明为 读取SQL数据类型外有，这些属性是可以同时声明的：</p>
<ul>
<li>READS SQL DATA<ul>
<li>读取SQL数据</li>
<li>即函数中有查询读取数据</li>
</ul>
</li>
<li>MODIFIES SQL DATA<ul>
<li>修改SQL数据</li>
<li>即函数中有插入、更新或者删除数据</li>
</ul>
</li>
</ul>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><blockquote>
<p><code>Triggers</code></p>
</blockquote>
<p>触发器实在插入、更新和删除语句前后自动执行的一堆SQL代码，通常使用触发器增强数据一致性。</p>
<h3 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 删除重名的触发器</span>
<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> payments_after_insert<span class="token punctuation">;</span>

<span class="token comment">-- 创建触发器</span>
<span class="token keyword">DELIMITER</span> $$  <span class="token comment">-- 修改分隔符</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> payments_after_insert 
	<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> payments <span class="token comment">-- 明确触发时机，在payments插入数据之后；	-- BEFORE -- 在执行操作之前触发</span>
	<span class="token keyword">FOR EACH ROW</span> <span class="token comment">-- 在每一个受影响的行触发，当然也有语句级别的触发范围，每次执行语句只触发一次（但目前mysql尚不支持）</span>
<span class="token keyword">BEGIN</span> <span class="token comment">-- 触发的实体内容</span>
<span class="token comment">-- 这部分可以写任意SQL修改代码，也可以写存储过程</span>
	
	<span class="token comment">-- 示例, 每次插入 payments 后，就去修改 invoices表中对应数据的总额</span>
	<span class="token keyword">UPDATE</span> invoices
	<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> payment_total <span class="token operator">+</span> NEW<span class="token punctuation">.</span>amount <span class="token comment">-- NEW 关键词就是新的数据库（新增或更新后）； OLD 关键词就是旧的数据行(更新或删除前)</span>
	<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> NEW<span class="token punctuation">.</span>invoice_id<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> <span class="token comment">-- 恢复分隔符</span>


<span class="token comment">-- 测试</span>
<span class="token keyword">SELECT</span> payment_total <span class="token keyword">FROM</span> invoices <span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">-- 0</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> payments
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'2023-05-07'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> payment_total <span class="token keyword">FROM</span> invoices <span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">-- 10</span>




<span class="token comment">-- </span>
<span class="token keyword">DELIMITER</span> $$  <span class="token comment">-- 修改分隔符</span>

<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> payments_after_insert<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> payments_after_delete
	<span class="token keyword">AFTER</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> payments <span class="token comment">-- 明确触发时机，在删除之后</span>
	<span class="token keyword">FOR EACH ROW</span> <span class="token comment">-- 在每一个受影响的行触发</span>
<span class="token keyword">BEGIN</span> 
	<span class="token keyword">UPDATE</span> invoices
	<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> payment_total <span class="token operator">-</span> OLD<span class="token punctuation">.</span>amount <span class="token comment">-- OLD 关键词就是旧的数据行(更新或删除前)</span>
	<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> OLD<span class="token punctuation">.</span>invoice_id<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> <span class="token comment">-- 恢复分隔符</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="查看触发器"><a href="#查看触发器" class="headerlink" title="查看触发器"></a>查看触发器</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看当前数据库的所有触发器</span>
<span class="token keyword">SHOW</span> TRIGGERS<span class="token punctuation">;</span>

<span class="token comment">-- 对名称进行过滤</span>
<span class="token keyword">SHOW</span> TRIGGERS <span class="token operator">LIKE</span> <span class="token string">'payment%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_015.png" class="" title="image_015">

<h3 id="删除触发器"><a href="#删除触发器" class="headerlink" title="删除触发器"></a>删除触发器</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 删除触发器</span>
<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> payments_after_insert<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="使用触发器进行审计"><a href="#使用触发器进行审计" class="headerlink" title="使用触发器进行审计"></a>使用触发器进行审计</h3><p>触发器的另一个常用用途就是为了审计的目的来记录对数据库的修改，比如，记录谁对数据库进行了相关的什么操作。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 环境准备</span>
<span class="token keyword">USE</span> sql_invoicing<span class="token punctuation">;</span>

<span class="token comment">-- 用来记录对payments表的修改</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> payments_audit <span class="token punctuation">(</span>
	client_id 		<span class="token keyword">INT</span><span class="token punctuation">,</span>
	<span class="token keyword">date</span>					<span class="token keyword">DATE</span><span class="token punctuation">,</span>
	amount 				<span class="token keyword">DECIMAL</span> <span class="token punctuation">(</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	action_type 	<span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	action_date 	<span class="token keyword">DATETIME</span> 
<span class="token punctuation">)</span>

<span class="token comment">-- 创建触发器</span>
<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> payments_after_insert<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> payments_after_insert
	<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> payments
	<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">UPDATE</span> invoices
	<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> payment_total <span class="token operator">+</span> NEW<span class="token punctuation">.</span>amount
	<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> NEW<span class="token punctuation">.</span>invoice_id<span class="token punctuation">;</span>

	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> payments_audit
	<span class="token keyword">VALUES</span><span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span> NEW<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> NEW<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> <span class="token string">'Insert'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>

<span class="token comment">-- 第二个</span>
<span class="token keyword">DELIMITER</span> $$  <span class="token comment">-- 修改分隔符</span>

<span class="token keyword">DROP</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> payments_after_delete<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> payments_after_delete
	<span class="token keyword">AFTER</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> payments <span class="token comment">-- 明确触发时机，在删除之后</span>
	<span class="token keyword">FOR EACH ROW</span> <span class="token comment">-- 在每一个受影响的行触发</span>
<span class="token keyword">BEGIN</span> 
	<span class="token keyword">UPDATE</span> invoices
	<span class="token keyword">SET</span> payment_total <span class="token operator">=</span> payment_total <span class="token operator">-</span> OLD<span class="token punctuation">.</span>amount <span class="token comment">-- OLD 关键词就是旧的数据行(更新或删除前)</span>
	<span class="token keyword">WHERE</span> invoice_id <span class="token operator">=</span> OLD<span class="token punctuation">.</span>invoice_id<span class="token punctuation">;</span>
	
	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> payments_audit
	<span class="token keyword">VALUES</span><span class="token punctuation">(</span>OLD<span class="token punctuation">.</span>client_id<span class="token punctuation">,</span> OLD<span class="token punctuation">.</span><span class="token keyword">date</span><span class="token punctuation">,</span> OLD<span class="token punctuation">.</span>amount<span class="token punctuation">,</span> <span class="token string">'Delete'</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span> <span class="token comment">-- 恢复分隔符</span>



<span class="token comment">-- 测试</span>

<span class="token comment">-- 查询操作表</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> payments_audit<span class="token punctuation">;</span>

<span class="token comment">-- 插入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> payments
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'2023-05-07'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 再次查询查看记录</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> payments_audit<span class="token punctuation">;</span>

<span class="token comment">-- 删除刚刚插入的数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> payments <span class="token keyword">WHERE</span> payment_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 再次查看记录</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> payments_audit<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_016.png" class="" title="image_016">

<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><blockquote>
<p><code>Events</code></p>
</blockquote>
<p>事件是根据计划执行的任务或一堆SQL代码，可以只执行一次或者按照规律执行，例如：每天一次或每月一次。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 可以先打开 MySql 事件调度器，这是一个后台程序，时刻在检查需要执行的事件</span>

<span class="token comment">-- 查看系统变量，</span>
<span class="token keyword">SHOW</span> VARIABLES<span class="token punctuation">;</span>

<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'event%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 关闭事件调度器</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> event_scheduler <span class="token operator">=</span> <span class="token keyword">OFF</span><span class="token punctuation">;</span>
<span class="token comment">-- 开始事件调度器</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> event_scheduler <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_017.png" class="" title="image_017">

<h3 id="创建事件"><a href="#创建事件" class="headerlink" title="创建事件"></a>创建事件</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建事件</span>
<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> EVENT <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> yearly_delete_stale_audit_rows<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> EVENT yearly_delete_stale_audit_rows
<span class="token keyword">ON</span> SCHEDULE  <span class="token comment">-- 设置调度规则</span>
	<span class="token comment">-- AT '2023-05-07'  -- 在这天调度</span>
	EVERY <span class="token number">1</span> <span class="token keyword">HOUR</span> <span class="token comment">-- 每一小时， 当然也可也设置为 DAY、YAER</span>
	STARTS <span class="token string">'2023-05-01'</span> ENDS <span class="token string">'2023-05-10'</span>  <span class="token comment">-- 设置调度的启示时间和终止时间</span>
<span class="token keyword">DO</span> <span class="token keyword">BEGIN</span>  <span class="token comment">-- 执行的部分</span>
	<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> payments_audit
	<span class="token keyword">WHERE</span> action_date <span class="token operator">&lt;</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">;</span>  <span class="token comment">-- 当前时间 减去 一年。 这里和之前的 DATEADD() DATESUB() 函数表达式一致，当然也可以使用这两个函数</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="查看事件"><a href="#查看事件" class="headerlink" title="查看事件"></a>查看事件</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看事件</span>
<span class="token keyword">SHOW</span> EVENTS<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_018.png" class="" title="image_018">

<h3 id="删除事件"><a href="#删除事件" class="headerlink" title="删除事件"></a>删除事件</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 删除事件</span>
<span class="token keyword">DROP</span> EVENT <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> yearly_delete_stale_audit_rows<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="更改事件"><a href="#更改事件" class="headerlink" title="更改事件"></a>更改事件</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 更改事件, 这里可以使用 ALTER 来修改事件，就像修改一张表一样，而不用类似于存储过程一样，要先删除再创建</span>
<span class="token comment">-- 但是这里只能修改  执行体 部分，不能修改调度体</span>
<span class="token keyword">ALTER</span> EVENT yearly_delete_stale_audit_rows
<span class="token keyword">ON</span> SCHEDULE  <span class="token comment">-- 设置调度规则</span>
	<span class="token comment">-- AT '2023-05-07'  -- 在这天调度</span>
	EVERY <span class="token number">1</span> <span class="token keyword">HOUR</span> <span class="token comment">-- 每一小时， 当然也可也设置为 DAY、YAER</span>
	STARTS <span class="token string">'2023-05-01'</span> ENDS <span class="token string">'2023-05-10'</span>  <span class="token comment">-- 设置调度的启示时间和终止时间</span>
<span class="token keyword">DO</span> <span class="token keyword">BEGIN</span>  <span class="token comment">-- 执行的部分</span>
	<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> payments_audit
	<span class="token keyword">WHERE</span> action_date <span class="token operator">&lt;</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span><span class="token punctuation">;</span>  <span class="token comment">-- 当前时间 减去 一年。 这里和之前的 DATEADD() DATESUB() 函数表达式一致，当然也可以使用这两个函数</span>
<span class="token keyword">END</span>$$

<span class="token comment">-- 关闭一个事件</span>
<span class="token keyword">ALTER</span> EVENT yearly_delete_stale_audit_rows <span class="token keyword">DISABLE</span><span class="token punctuation">;</span>

<span class="token comment">-- 开启一个事件</span>
<span class="token keyword">ALTER</span> EVENT yearly_delete_stale_audit_rows <span class="token keyword">ENABLE</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><blockquote>
<p><code>Transactions</code></p>
</blockquote>
<p>事务是代表单个工作单元的一组<code>SQL</code>语句，所有的语句都成功完成才算完成，否则事务就会运行失败。</p>
<p>事务具有如下特性（<code>ACID</code>）</p>
<ul>
<li>原子性（<code>Atomicity</code>）<ul>
<li>每个事务都是一个工作单元，不管其包含了多少语句，要么这些语句都执行成功且事务被提交，要么就有所失败事务被退回所有更改都被撤销。</li>
</ul>
</li>
<li>一致性（<code>Consistency</code>）<ul>
<li>通过事务，数据库将始终保持一致的状态</li>
</ul>
</li>
<li>隔离性（<code>Isolation</code>）<ul>
<li>事务都是相互隔离的，互不干扰。如果多个事务需要更新同一行，受影响的行将会被锁定，只有上一个事务完成修改提交后才会释放锁，允许下一个事务的修改。</li>
</ul>
</li>
<li>持久性（<code>Durability</code>）<ul>
<li>一旦事务被提交，产生的修改将会是永久的</li>
</ul>
</li>
</ul>
<h3 id="创建事务"><a href="#创建事务" class="headerlink" title="创建事务"></a>创建事务</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_store<span class="token punctuation">;</span>

<span class="token comment">-- 创建事务</span>

<span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>  <span class="token comment">-- 开始创建一个事务</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders <span class="token punctuation">(</span>customer_id<span class="token punctuation">,</span> order_date<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> 
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> order_items
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">COMMIT</span><span class="token punctuation">;</span> <span class="token comment">-- 提交，  如果前面的执行不错误，就会提交之前的所有修改，如果出现错误就会撤销修改。</span>
<span class="token comment">-- ROLLBACK; -- 替换COMMIT， 作用是退回事务并撤销所有的更改</span>


<span class="token comment">-- 查看MySql的自动提交配置</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'autocommit'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="并发和锁"><a href="#并发和锁" class="headerlink" title="并发和锁"></a>并发和锁</h3><blockquote>
<p><code>Concurrency</code></p>
</blockquote>
<p>真实的应用场景中，会存在有两个以及更多的用户同时访问相同数据的情况，这就是并发。而锁机制是为了控制并发访问时的数据访问权限。在 <code>SQL</code> 中，锁可以分为共享锁和排他锁两种。</p>
<ul>
<li>共享锁（<code>Shared Lock</code>）<ul>
<li>一种保护读操作的锁，它允许多个用户同时访问同一份数据，但是不允许写操作。当一个用户持有共享锁时，其他用户也可以获得共享锁，但是不能获得排他锁。</li>
</ul>
</li>
<li>排他锁（<code>Exclusive Lock</code>）<ul>
<li>一种保护写操作的锁，它只允许一个用户访问数据，其他用户必须等待该用户释放锁才能访问。当一个用户持有排他锁时，其他用户不可以获得共享锁或排他锁。</li>
</ul>
</li>
</ul>
<h3 id="并发问题"><a href="#并发问题" class="headerlink" title="并发问题"></a>并发问题</h3><ul>
<li>丢失更新（<code>Lost Updates</code>）<ul>
<li>当两个事务尝试更新相同的数据并且没有上锁时，就可能发生。较晚提交的事务会覆盖较早事务做的更改</li>
</ul>
</li>
<li>读脏数据（<code>Dirty Reads</code>）<ul>
<li>一个事务<code>A</code>读取了另一个事务<code>B</code>尚未被提交的数据，当另一个事务<code>B</code>发生错误回退了修改，数据恢复原始。这时候最开始的事务<code>A</code>就会读取一个已经不存在的脏数据。</li>
<li>使用<strong>读已提交隔离</strong>级别（<code>Read committed</code>）来解决</li>
</ul>
</li>
<li>不可重复度（<code>Non-repeating Reads</code>）<ul>
<li>在事务执行中，读取一个数据两次，在两次读取之间有另一个事务修改了这个数据，就会导致两次得到的结果不同。</li>
<li>使用<strong>可重复读隔离</strong>级别（<code>Repeatable read</code>）来解决</li>
</ul>
</li>
<li>幻读（<code>Phantom Reads</code>）<ul>
<li>当某个事务<code>A</code>范围查询数据时，另一个事务<code>B</code>在该范围内插入了数据，当事务<code>A</code>再次范围查询时，会产生幻行（即多了事务<code>B</code>插入的那行数据，因为是读已提交的，所以事务B为提交的读，A第一次查询时查询不到的）。</li>
<li>使用<strong>序列化隔离</strong>级别（<code>Serializable</code>）来解决</li>
</ul>
</li>
</ul>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>由上而下，隔离级别越高</p>
<ul>
<li><strong>读未提交</strong><ul>
<li>解决不了上述四个问题中的任何一个</li>
</ul>
</li>
<li><strong>读已提交</strong><ul>
<li>可以解决读藏数据的问题</li>
</ul>
</li>
<li><strong>可重复度</strong><ul>
<li>可以解决丢失更新、读脏数据、不可重复读三个问题</li>
</ul>
</li>
<li><strong>序列化</strong><ul>
<li>四个问题都可以解决</li>
</ul>
</li>
</ul>
<p>但是，随着隔离级别越高，存在着越大的性能和可扩展性问题，因为需要使用到了更多或更高级别的锁，并发的数量更少。</p>
<img src="/2023/04/23/cs-data/data-sql/image_019.png" class="" title="image_019">

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看当前数据库的事务的隔离级别</span>
<span class="token keyword">SHOW</span> VARIABLES <span class="token operator">LIKE</span> <span class="token string">'transaction_isolation'</span><span class="token punctuation">;</span>


<span class="token comment">-- 更改隔离级别</span>
<span class="token keyword">SET</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">SERIALIZABLE</span><span class="token punctuation">;</span>  <span class="token comment">-- 设置当前事务的隔离级别为 序列化级别。 只会影响当前事务的隔离级别，而不会影响其他事务的隔离级别</span>
<span class="token keyword">SET</span> <span class="token keyword">SESSION</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">SERIALIZABLE</span><span class="token punctuation">;</span> <span class="token comment">-- 设置当前会话的事务隔离级别</span>
<span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">SERIALIZABLE</span><span class="token punctuation">;</span><span class="token comment">-- 为所有会话中所有新事务设置全局隔离级别</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>当不同的事务均因为拥有了别的事务锁需要的“<strong>锁</strong>”而无法完成的情况，两个事务之间都在等待对方释放锁，这种情况就是死锁。具体来说，当一个事务持有某个资源并试图获取另一个资源时，而另一个事务持有该资源并试图获取第一个事务持有的资源时，就会形成死锁。</p>
<p>死锁可能会导致系统崩溃或无响应，因此需要采取一些措施来避免或解决死锁问题。常用的解决方法包括：</p>
<ul>
<li><strong>避免死锁</strong><ul>
<li>通过一些算法和策略来避免死锁的产生，例如资源分配图算法、银行家算法等</li>
</ul>
</li>
<li><strong>检测死锁</strong><ul>
<li>在系统中定期扫描资源的使用情况，发现死锁后进行解除</li>
</ul>
</li>
<li><strong>恢复死锁</strong><ul>
<li>中断部分线程，释放资源使系统恢复正常</li>
</ul>
</li>
<li><strong>预防死锁</strong><ul>
<li>通过设计良好的程序和算法来避免死锁的发生</li>
</ul>
</li>
</ul>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><blockquote>
<p><code>Designing Databases</code></p>
</blockquote>
<h3 id="数据类型-1"><a href="#数据类型-1" class="headerlink" title="数据类型"></a>数据类型</h3><p><code>Mysql</code>中的数据类型分为以下几类</p>
<ul>
<li>字符串类型</li>
<li>数值类型</li>
<li>日期时间类型</li>
<li>BLOB类型<ul>
<li>存储二进制数据</li>
</ul>
</li>
<li>空间类型<ul>
<li>存储几何或者地区值</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/data-types.html" title="点击跳转"><code>MySql</code>文档上的说明</a>：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/data-types.html">https://dev.mysql.com/doc/refman/8.0/en/data-types.html</a></p>
<h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h3><p>在进行数据导入和导出时，需要注意数据是否正确地转换为其他数据类型。</p>
<ul>
<li><code>CHAR(x)</code><ul>
<li>用于存储固定长度的字符数据，其中<code>x</code>表示列的长度（以字符为单位）。这意味着<code>CHAR</code>类型始终使用<code>x</code>个字符的存储空间，无论实际存储的数据大小如何。<code>CHAR</code>类型的最大长度是<code>255</code>个字符。如果需要存储更大的数据，可以考虑使用<code>VARCHAR</code>、<code>MEDIUMTEXT</code>或<code>LONGTEXT</code>类型。</li>
<li><code>CHAR</code>类型始终使用固定长度的存储空间，这可能会浪费存储空间；</li>
</ul>
</li>
<li><code>VARCHAR(x)</code><ul>
<li>存储可变长度的字符数据，其中x表示列的最大长度（以字符为单位）。这意味着<code>VARCHAR</code>类型可以存储长度不等的字符串，最大长度为<code>x</code>个字符。存储空间是根据实际存储的数据大小而变化的，因此可以节省存储空间。例如，如果一个<code>VARCHAR(255)</code>列中只存储了<code>10</code>个字符的数据，则该列实际上只使用了<code>10</code>个字符的存储空间，而不是<code>255</code>个字符的存储空间。最大长度是<code>65535</code>个字符（<code>64KB</code>）。如果需要存储更大的数据，可以考虑使用<code>MEDIUMTEXT</code>或<code>LONGTEXT</code>类型。</li>
<li><code>VARCHAR</code>类型的大小可以动态变化，这可能会影响性能和存储空间的使用；</li>
</ul>
</li>
<li><code>MEDIUMTEXT</code><ul>
<li>存储中等长度的文本数据，最大长度为16MB。在<code>MySql</code>中，<code>MEDIUMTEXT</code>类型使用3字节来存储长度信息，因此其最大长度为16,777,215个字符。</li>
<li><code>MEDIUMTEXT</code>类型<strong>不支持索引</strong></li>
</ul>
</li>
<li><code>LONGTEXT</code><ul>
<li>用于存储较长的文本数据，最大长度为<code>4GB</code>.</li>
<li><code>LONGTEXT</code>类型<strong>不支持索引</strong></li>
</ul>
</li>
<li><code>TINYTEXT</code><ul>
<li>用于存储短文本数据，最大长度为<code>255</code>个字符，与<code>VARCHAR</code>和<code>TEXT</code>类型不同，<code>TINYTEXT</code>类型是固定长度的数据类型，始终使用<code>1</code>字节来存储长度信息。</li>
<li><code>TINYTEXT</code>类型<strong>不支持索引</strong>，因此在进行查询时可能会影响性能</li>
</ul>
</li>
<li><code>TEXT</code><ul>
<li>用于存储较长的文本数据，最大长度为<strong>64KB</strong>。</li>
<li><code>TEXT</code>类型<strong>不支持索引</strong></li>
</ul>
</li>
</ul>
<h4 id="UTF-8编码"><a href="#UTF-8编码" class="headerlink" title="UTF-8编码"></a>UTF-8编码</h4><p><code>UTF-8</code>编码是一种变长的字符编码方式，一个字符的存储空间可以是1到4个字节。由于<code>UTF-8</code>编码支持多种语言和字符集，不同真实语言中的字符可能占用不同数量的字节。常见的如下</p>
<ul>
<li>英文字母、数字和标点符号：1个字节</li>
<li>拉丁字母扩展字符集（如法语、德语、西班牙语中的字符）：1到2个字节</li>
<li>希腊字母、西里尔字母和亚美尼亚字母等：2个字节</li>
<li>中文、日文、韩文和泰文等字符：3个字节</li>
<li>图形符号和表情符号等：3到4个字节</li>
</ul>
<h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><p>当用 <code>unsigned</code> 修饰时为无符号的整数。在进行数据导入和导出时，需要注意整数类型的数据是否正确地转换为其他数据类型。</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/integer-types.html" title="点击跳转"><code>MySql</code>文档上的说明</a>：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/integer-types.html">https://dev.mysql.com/doc/refman/8.0/en/integer-types.html</a></p>
<ul>
<li><code>TINYINT</code><ul>
<li><code>TINYINT</code>是<code>MySql</code>数据库中一种整数数据类型，用于存储小整数值。<code>TINYINT</code>类型可以存储范围从<code>-128</code>到<code>127</code>的整数值，或者范围从<code>0</code>到<code>255</code>的无符号整数值。</li>
<li><code>TINYINT</code>类型占用<code>1</code>个字节的存储空间。</li>
</ul>
</li>
<li><code>SMALLINT</code><ul>
<li>用于存储较小的整数值。<code>SMALLINT</code>类型可以存储范围从<code>-32768</code>到<code>32767</code>的整数值，或者范围从<code>0</code>到<code>65535</code>的无符号整数值。</li>
<li><code>SMALLINT</code>类型占用<code>2</code>个字节的存储空间。</li>
</ul>
</li>
<li><code>MEDIUMINT</code><ul>
<li>用于存储中等大小的整数值。<code>MEDIUMINT</code>类型可以存储范围从<code>-8388608</code>到<code>8388607</code>的整数值，或者范围从<code>0</code>到<code>16777215</code>的无符号整数值。</li>
<li><code>MEDIUMINT</code>类型占用<code>3</code>个字节的存储空间。</li>
</ul>
</li>
<li><code>INT</code><ul>
<li>用于存储常规大小的整数值。<code>INT</code>类型可以存储范围从<code>-2147483648</code>到<code>2147483647</code>的整数值，或者范围从<code>0</code>到<code>4294967295</code>的无符号整数值。</li>
<li><code>INT</code>类型占用<code>4</code>个字节的存储空间</li>
</ul>
</li>
<li><code>BIGINT</code><ul>
<li>用于存储大整数值。<code>BIGINT</code>类型可以存储范围从<code>-9223372036854775808</code>到<code>9223372036854775807</code>的整数值，或者范围从<code>0</code>到<code>18446744073709551615</code>的无符号整数值。</li>
<li><code>BIGINT</code>类型占用<code>8</code>个字节的存储空间</li>
</ul>
</li>
</ul>
<h3 id="定点数类型"><a href="#定点数类型" class="headerlink" title="定点数类型"></a>定点数类型</h3><p><code>MySql</code>中的定点数类型是指<code>DECIMAL</code>和<code>NUMERIC</code>类型，用于存储精确的小数值。<code>DECIMAL</code>和<code>NUMERIC</code>类型可以指定精度和小数位数，因此可以确保存储的小数值具有一定的精确性。</p>
<p>在<code>MySql</code>中，<code>DECIMAL</code>和<code>NUMERIC</code>类型的定义形式如下：</p>
<ul>
<li><code>DECIMAL(M,D)</code></li>
<li><code>NUMERIC(M,D)</code></li>
</ul>
<p>其中，<code>M</code>表示数字的总位数，<code>D</code>表示小数点后的位数。例如，<code>DECIMAL(10,2)</code>表示一个最大值为<code>9999999999.99</code>的数值，其中<code>10</code>表示数字的总位数，<code>2</code>表示小数点后的位数。</p>
<p>在指定<code>DECIMAL</code>类型的精度和小数位数时，需要考虑存储的数据类型以及数据库的存储空间限制；</p>
<h3 id="浮点数类型"><a href="#浮点数类型" class="headerlink" title="浮点数类型"></a>浮点数类型</h3><p><code>MySql</code>数据库中有两种浮点数类型：<code>FLOAT</code>和<code>DOUBLE</code>。浮点数类型用于存储近似的小数值。<code>FLOAT</code>类型可以存储<code>4</code>个字节的单精度浮点数，而<code>DOUBLE</code>类型可以存储<code>8</code>个字节的双精度浮点数。</p>
<ul>
<li><code>FLOAT</code></li>
<li><code>DOUBLE</code></li>
</ul>
<p>浮点数类型的精度是有限的，因此在进行精确计算时需要注意精度损失的问题</p>
<h3 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h3><p><code>MySql</code>中的布尔类型是<code>TINYINT</code>类型，其值为<code>0</code>或<code>1</code>，用于表示逻辑真或假。</p>
<p><code>MySql</code>中会自动的把 <code>TRUE</code> 转为 <code>1</code>， <code>FALSE</code> 转为 <code>0</code>。</p>
<h3 id="枚举和集合类型"><a href="#枚举和集合类型" class="headerlink" title="枚举和集合类型"></a>枚举和集合类型</h3><p>枚举和集合类型用于存储离散的值，可以用于表示一组预定义的取值。枚举类型用于存储单个取值，而集合类型用于存储多个取值。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 枚举的定义方式</span>
<span class="token keyword">ENUM</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">,</span> value3<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment">-- 例如</span>
<span class="token keyword">ENUM</span><span class="token punctuation">(</span><span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span>

<span class="token comment">-- 集合的定义方式</span>
<span class="token keyword">SET</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">,</span> value3<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment">-- 例如</span>
<span class="token keyword">SET</span><span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="日期和时间类型"><a href="#日期和时间类型" class="headerlink" title="日期和时间类型"></a>日期和时间类型</h3><p>有多种日期和时间类型，主要包括<code>DATE</code>、<code>TIME</code>、<code>DATETIME</code>、<code>TIMESTAMP</code>和<code>YEAR</code>类型。</p>
<ul>
<li><code>DATE</code><ul>
<li>用于存储日期值，包括年、月、日。<code>DATE</code>类型的格式为<code>'YYYY-MM-DD'</code>。</li>
</ul>
</li>
<li><code>TIME</code><ul>
<li>用于存储时间值，包括时、分、秒。<code>TIME</code>类型的格式为<code>'HH:MM:SS'</code>。</li>
</ul>
</li>
<li><code>DATETIME</code><ul>
<li>有<code>8B</code>大小，用于存储日期和时间值，包括年、月、日、时、分、秒。<code>DATETIME</code>类型的格式为<code>'YYYY-MM-DD HH:MM:SS'</code>。</li>
</ul>
</li>
<li><code>TIMESTAMP</code><ul>
<li>只有<code>4B</code>大小，用于存储日期和时间值，包括年、月、日、时、分、秒。<code>TIMESTAMP</code>类型的格式为<code>'YYYY-MM-DD HH:MM:SS'</code>。与<code>DATETIME</code>类型不同的是，<code>TIMESTAMP</code>类型的取值范围比<code>DATETIME</code>类型更小，可以表示的时间范围为<code>'1970-01-01 00:00:01'</code>到<code>'2038-01-19 03:14:07'</code>。</li>
</ul>
</li>
<li><code>YEAR</code><ul>
<li><code>YEAR</code>类型用于存储年份值，包括<code>4</code>位数的年份值。<code>YEAR</code>类型的格式为<code>'YYYY'</code>。</li>
</ul>
</li>
</ul>
<h3 id="Blob类型"><a href="#Blob类型" class="headerlink" title="Blob类型"></a>Blob类型</h3><p>用于存储二进制大对象数据，例如图像、音频、视频等。<code>BLOB</code>类型可以存储任意长度的二进制数据，最大支持存储<code>4GB</code>的数据。</p>
<p><code>BLOB</code>类型可以分为以下几种：</p>
<ul>
<li><code>TINYBLOB</code>	<ul>
<li>最大长度为<code>255</code>个字节的BLOB类型。<code>255B</code></li>
</ul>
</li>
<li><code>BLOB</code><ul>
<li>最大长度为<code>65,535</code>个字节的BLOB类型。<code>65KB</code></li>
</ul>
</li>
<li><code>MEDIUMBLOB</code><ul>
<li>最大长度为<code>16,777,215</code>个字节的<code>BLOB</code>类型。<code>16MB</code></li>
</ul>
</li>
<li><code>LONGBLOB</code><ul>
<li>最大长度为<code>4GB</code>的<code>BLOB</code>类型。</li>
</ul>
</li>
</ul>
<h3 id="JSON类型"><a href="#JSON类型" class="headerlink" title="JSON类型"></a>JSON类型</h3><p>用于存储<code>JSON</code>格式的数据。</p>
<p><code>JSON</code>类型可以用于存储任何合法的<code>JSON</code>格式的数据，包括对象、数组、字符串、数字、布尔值和<code>null</code>值等。使用<code>JSON</code>类型时，可以使用<code>MySQL</code>提供的<code>JSON</code>函数对<code>JSON</code>数据进行操作和查询。</p>
<p>需要注意的是，由于<code>JSON</code>类型比较新，因此在一些老版本的<code>MySQL</code>中可能不支持JSON<code>类型</code>。在使用<code>JSON</code>类型时，需要确认<code>MySql</code>的版本是否支持该数据类型。</p>
<h2 id="设计数据库"><a href="#设计数据库" class="headerlink" title="设计数据库"></a>设计数据库</h2><h3 id="数据建模"><a href="#数据建模" class="headerlink" title="数据建模"></a>数据建模</h3><ol>
<li><code>Understand the requirements</code>，理解需求</li>
<li><code>Build a Conceptual Model</code>，构建业务的概念模型</li>
<li><code>Build a Logical Model</code>，构建逻辑模型</li>
<li><code>Build a Physical Model</code>，构建实体模型</li>
</ol>
<h3 id="概念模型"><a href="#概念模型" class="headerlink" title="概念模型"></a>概念模型</h3><p>概念模型是指对现实世界的某个领域或问题域进行抽象和概括，形成一个抽象的模型。在数据库设计中，概念模型是指对要设计的数据库中的实体、属性、关系等进行抽象和概括，形成一个高层次的模型，以便于后续的数据库设计和实现。</p>
<p>通常可以使用实体关系图或<code>UML</code>图（<code>uified modeling languages</code> 标准建模语言图）来直观的展示概念模型。</p>
<p><strong>实体-关系图</strong>(<code>Entity-Relationship Diagram, ERD</code>)。在<code>ERD</code>中，<strong>实体</strong>表示现实世界中的具体事物或概念，<strong>属性</strong>表示实体的特征或属性，<strong>关系</strong>表示实体之间的关联或联系。</p>
<p>一个典型的<code>ERD</code>包括以下几个部分：</p>
<ul>
<li><p><strong>实体</strong>(<code>Entity</code>)</p>
<ul>
<li>表示现实世界中的具体事物或概念，通常用矩形表示。</li>
</ul>
</li>
<li><p><strong>属性</strong>(<code>Attribute</code>)</p>
<ul>
<li>表示实体的特征或属性，通常用椭圆形表示。</li>
</ul>
</li>
<li><p><strong>主键</strong>(<code>Primary Key</code>)</p>
<ul>
<li>表示实体的唯一标识符，通常用下划线表示。</li>
</ul>
</li>
<li><p><strong>外键</strong>(<code>Foreign Key</code>)</p>
<ul>
<li>表示实体之间的关联或联系，通常用箭头表示。</li>
</ul>
</li>
<li><p><strong>关系</strong>(<code>Relationship</code>)</p>
<ul>
<li>表示实体之间的关联或联系，通常用菱形表示。</li>
</ul>
</li>
</ul>
<blockquote>
<p>推荐绘图工具 <a target="_blank" rel="noopener" href="https://www.drawio.com/" title="点击跳转">draw.io</a> ：<a target="_blank" rel="noopener" href="https://www.drawio.com/">https://www.drawio.com/</a></p>
<p>在线使用地址：<a target="_blank" rel="noopener" href="https://app.diagrams.net/">https://app.diagrams.net/</a></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/jgraph/drawio/releases">https://github.com/jgraph/drawio/releases</a></p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://www.diagrams.net/">https://www.diagrams.net/</a></p>
</blockquote>
<p>示例：</p>
<img src="/2023/04/23/cs-data/data-sql/image_020.png" class="" title="image_020">

<h3 id="逻辑模型"><a href="#逻辑模型" class="headerlink" title="逻辑模型"></a>逻辑模型</h3><p>对概念模型进行细化和扩展，形成一个更加具体和详细的模型。在数据库设计中，逻辑模型是指在概念模型的基础上，进一步定义实体、属性、关系、约束等，形成一个更加具体和详细的模型，以便于后续的数据库实现和应用。</p>
<p>设计逻辑模型时需要注意以下几点：</p>
<ul>
<li><p>在设计表和字段时，需要考虑实体在逻辑模型中的属性和特征，以及在数据库中的存储需求和查询需求。</p>
</li>
<li><p>在设计关系时，需要考虑实体之间的联系和关联，以及在数据库中的存储需求和查询需求。</p>
</li>
<li><p>在设计主键和外键时，需要考虑实体之间的关系和约束，以确保数据的完整性和准确性。</p>
</li>
<li><p>在设计约束时，需要考虑数据的完整性和准确性，以确保数据库中的数据符合要求。</p>
</li>
</ul>
<p>示例：</p>
<p>对应关系示例图</p>
<img src="/2023/04/23/cs-data/data-sql/image_021.png" class="" title="image_021">

<img src="/2023/04/23/cs-data/data-sql/image_022.png" class="" title="image-20230507205811634">

<h3 id="实体模型"><a href="#实体模型" class="headerlink" title="实体模型"></a>实体模型</h3><p>对数据库中的实体、属性、关系等进行具体化和实现，形成一个实际的数据库模型。在数据库设计中，实体模型是最终的数据库设计结果，是一个具体的、可实现的数据库模型。</p>
<p>实体模型通常使用关系模型表示，与逻辑模型类似。不同的是，在实体模型中，需要对关系模型进行实现和优化，以便于实际的数据库应用和操作。</p>
<p>示例</p>
<img src="/2023/04/23/cs-data/data-sql/image_023.png" class="" title="image_023">

<h3 id="主键"><a href="#主键" class="headerlink" title="主键"></a>主键</h3><p>主键，是唯一标识给定表里每条记录的字段或字段组合。键的作用是确保表中的每一行数据都有一个唯一的标识符，以便于在表中查找、更新或删除数据。</p>
<p>主键具有以下特点：</p>
<ul>
<li><p>主键必须唯一：每行数据必须有一个唯一的主键值，以确保表中的每一行数据都可以被唯一地标识。</p>
</li>
<li><p>主键不能为空：主键值不能为<code>NULL</code>，以确保表中的每一行数据都有一个有效的主键值。</p>
</li>
<li><p>主键不可修改：主键值在插入后不能被修改，以确保表中的每一行数据都有一个唯一且不可修改的标识符。</p>
</li>
</ul>
<h3 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h3><p>外键是指一个表中的字段，它与另一个表中的主键形成了关联。通过外键，可以建立表与表之间的联系，实现数据的关联和查询。</p>
<p>外键具有以下特点：</p>
<ul>
<li><p>外键是另一个表的主键或唯一键；</p>
</li>
<li><p>外键用于建立表与表之间的联系；</p>
</li>
<li><p>外键用于保持数据的一致性和完整性；</p>
</li>
<li><p>外键用于实现级联更新和级联删除。</p>
</li>
</ul>
<h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><p>外键约束是关系型数据库中用于保证数据完整性的一种约束。它建立于一个表的一个或多个字段上，这些字段引用了另一个表中的主键或唯一键。外键约束确保了两个表之间的一致性，即引用表中的每个外键值必须对应于主表中的一个主键值或唯一键值。</p>
<p>外键约束的作用主要有以下几个方面：</p>
<ul>
<li><p>保证数据的完整性：外键约束可以防止向表中插入无效的数据，确保数据的一致性和完整性。</p>
</li>
<li><p>级联更新：外键约束可以实现级联更新，即当主表中的主键值发生变化时，外键表中的对应外键值也会自动更新。</p>
</li>
<li><p>级联删除：外键约束可以实现级联删除，即当主表中的某个主键值被删除时，外键表中对应的外键值也会自动删除。</p>
</li>
<li><p>查询优化：外键约束可以提高查询效率，因为它可以通过索引快速查找与主键或唯一键相关的数据。</p>
</li>
</ul>
<h3 id="标准化"><a href="#标准化" class="headerlink" title="标准化"></a>标准化</h3><p>指对关系型数据库中的表进行优化和规范化，以提高数据库的效率、可靠性和灵活性。标准化的主要目的是消除数据冗余，减少数据存储空间，提高数据的一致性和完整性，避免数据更新异常和插入异常。</p>
<p>在关系型数据库中，标准化通常分为三个层次</p>
<ul>
<li>第一范式（<code>1NF</code>）<ul>
<li>要求每个列都是不可分的基本数据项，即每个列的值都是原子的，不能再分解成更小的数据项。这样可以消除表中的重复数据，减少数据冗余。</li>
</ul>
</li>
<li>第二范式（<code>2NF</code>）<ul>
<li>要求每个表必须有一个主键，并且每个非主键列都必须完全依赖于主键，即非主键列都与主键有直接关系，不能与其他非主键列有关系。这样可以消除数据更新异常和插入异常。</li>
</ul>
</li>
<li>第三范式（<code>3NF</code>）<ul>
<li>要求每个非主键列都必须直接依赖于主键，而不能间接依赖于主键。如果一个非主键列可以通过其他非主键列推导得出，那么就应该把这个非主键列独立出来形成一个新表。这样可以消除数据冗余，提高数据库的效率。</li>
</ul>
</li>
</ul>
<p>除了以上三个范式外，还有更高级别的范式，如巴斯-科德范式（<code>BCNF</code>）和第四范式（<code>4NF</code>），它们对数据的规范化要求更加严格和复杂</p>
<h3 id="创建和删除数据库"><a href="#创建和删除数据库" class="headerlink" title="创建和删除数据库"></a>创建和删除数据库</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> sql_store_2<span class="token punctuation">;</span>

<span class="token comment">-- 删除数据库</span>
<span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> sql_store_2<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_store_2<span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> customers<span class="token punctuation">;</span>
<span class="token comment">-- 创建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> customers <span class="token punctuation">(</span>
	customer_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    first_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    points <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">UNIQUE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="更改表"><a href="#更改表" class="headerlink" title="更改表"></a>更改表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
<span class="token comment">-- 修改表，添加字段</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customers
	<span class="token keyword">ADD</span> last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AFTER</span> first_name<span class="token punctuation">;</span> <span class="token comment">-- 在 first_name 表之后添加字段</span>
	
<span class="token comment">-- 当然一次可以执行多个操作</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customers
	<span class="token keyword">ADD</span> last_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AFTER</span> first_name<span class="token punctuation">,</span> <span class="token comment">-- 在 first_name 表之后添加字段</span>
	<span class="token keyword">ADD</span> city <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token keyword">MODIFY</span> <span class="token keyword">COLUMN</span> first_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">-- 修改列</span>
	<span class="token keyword">DROP</span> points<span class="token punctuation">;</span>  <span class="token comment">-- 删除列</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建外键关系"><a href="#创建外键关系" class="headerlink" title="创建外键关系"></a>创建外键关系</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> orders<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
	order_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    customer_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_orders_customers<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>customer_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> fk_orders_customers <span class="token comment">-- 设置外键名</span>
    	<span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span>  <span class="token comment">-- 创建外键</span>
    	<span class="token keyword">REFERENCES</span> customers <span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token comment">-- 连接的表和字段</span>
    	<span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> <span class="token comment">-- 设置更新操作为  级联</span>
    	<span class="token comment">-- ON UPDATE SET NULL -- 或者设置为空值</span>
    	<span class="token comment">-- ON UPDATE NO ACTION -- 或者设置不做操作 </span>
    	<span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span> <span class="token comment">-- 设置更新时 ，不做操作  </span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="更改主键和外键约束"><a href="#更改主键和外键约束" class="headerlink" title="更改主键和外键约束"></a>更改主键和外键约束</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 给已有的表更改外键约束</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> orders
	<span class="token keyword">DROP</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>  <span class="token comment">-- 删除主键</span>
	<span class="token keyword">ADD</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 添加主键</span>
	<span class="token keyword">DROP</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> fk_orders_customers<span class="token punctuation">,</span>
	<span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_orders_customers 
		<span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span>  <span class="token comment">-- 创建外键</span>
    	<span class="token keyword">REFERENCES</span> customers <span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span> <span class="token comment">-- 连接的表和字段</span>
    	<span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> <span class="token comment">-- 设置更新操作为  级联</span>
    	<span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span><span class="token punctuation">;</span> <span class="token comment">-- 设置更新时 ，不做操作 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="字符集和排序规则"><a href="#字符集和排序规则" class="headerlink" title="字符集和排序规则"></a>字符集和排序规则</h3><p>字符集是指计算机中用于表示字符的编码方式和字符集合。</p>
<p>在关系型数据库中，字符集通常用于指定数据库中存储的字符编码方式，以确保数据的正确性和一致性。</p>
<p>常见的字符集包括<code>ASCII</code>、<code>ISO-8859</code>、<code>Unicode</code>、<code>UTF-8</code>、<code>UTF-16</code>等。</p>
<ul>
<li><code>ASCII</code><ul>
<li>最早的字符集，只能表示英文字符和少量符号，不能表示其他语言的字符</li>
</ul>
</li>
<li><code>ISO-8859</code><ul>
<li><code>ASCII</code>的扩展，支持更多的语言字符，但仍有局限性</li>
</ul>
</li>
<li><code>Unicode</code><ul>
<li>一种国际标准，能够表示世界上所有语言的字符，包括中文、日文、韩文等</li>
</ul>
</li>
<li><code>UTF-8</code><ul>
<li><code>Unicode</code>的实现方式，<code>UTF-8</code>采用变长编码，可以节省存储空间</li>
</ul>
</li>
<li><code>UTF-16</code><ul>
<li><code>Unicode</code>的实现方式，<code>UTF-16</code>采用定长编码，可以提高查询效率</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询当前支持的字符集</span>
<span class="token keyword">SHOW</span> <span class="token keyword">CHARSET</span><span class="token punctuation">;</span>  
<span class="token comment">-- 在查询结果中还有一列 Default collation 是该字符集的默认排序规则，决定如何排序</span>
<span class="token comment">-- Maxlen， 是最大保存列，例如 UFT-8 对应的值是 3， 所以创建字段类型 CHAR(10), MySql就会为该字段预留 10 * 3 = 30 字节的空间</span>

<span class="token comment">-- 创建数据库时指定 字符集</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_name <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1<span class="token punctuation">;</span>

<span class="token comment">-- 修改 字符集</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> db_name <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1<span class="token punctuation">;</span>

<span class="token comment">-- 创建表时指定 字符集</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table1 <span class="token punctuation">(</span>
<span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1<span class="token punctuation">;</span>

<span class="token comment">-- 修改 字符集</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> table1 <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1<span class="token punctuation">;</span>

<span class="token comment">-- 当然也能为单独的一个字段设置字符集</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> customers <span class="token punctuation">(</span>
	customer_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    first_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>  <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1 <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    points <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">UNIQUE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><p>存储引擎是指关系型数据库中用于存储和管理数据的软件组件或模块，它们实现了不同的存储方式、索引策略和事务特性等功能。在<code>MySql</code>数据库中，常用的存储引擎包括<code>InnoDB</code>、<code>MyISAM</code>、<code>MEMORY</code>等。</p>
<ul>
<li><p><code>InnoDB</code></p>
<ul>
<li><code>InnoDB</code>是<code>MySqL</code>数据库默认的存储引擎，支持事务、行级锁定、外键等特性。它采用<code>B+</code>树索引结构，可以提高查询效率，同时也支持全文搜索功能。</li>
<li><code>InnoDB</code>适用于需要高并发、可靠性和数据一致性的应用场景，如电商、金融和游戏等领域。</li>
</ul>
</li>
<li><p><code>MyISAM</code></p>
<ul>
<li><code>MyISAM</code>是<code>MySql</code>数据库最早的存储引擎，不支持事务和行级锁定，但支持全文索引和压缩等特性。</li>
<li>它采用<code>B</code>树索引结构，可以提高查询效率，但不适合高并发和写入频繁的应用场景。</li>
</ul>
</li>
<li><p><code>MEMORY</code></p>
<ul>
<li><code>MEMORY</code>是<code>MySql</code>数据库的内存存储引擎，数据存储在内存中，查询速度非常快，但数据容易丢失。</li>
<li>它适用于需要高速读写和临时存储数据的应用场景，如缓存和计数器等。</li>
</ul>
</li>
</ul>
<p>除了以上三个存储引擎外，<code>MySql</code>数据库还支持其他存储引擎，如<code>CSV</code>、<code>ARCHIVE</code>、<code>BLACKHOLE</code>等。每个存储引擎都有其特点和适用场景，需要根据实际需求进行选择和配置。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看存储引擎</span>
<span class="token keyword">SHOW</span> ENGINES<span class="token punctuation">;</span>

<span class="token comment">-- 修改表使用的引擎</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customers
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span><span class="token punctuation">;</span>

<span class="token comment">-- 当然也能在创建表的时候指定</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> table1 <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> latin1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="高效索引"><a href="#高效索引" class="headerlink" title="高效索引"></a>高效索引</h2><blockquote>
<p><code>Indexing for High Performance</code></p>
</blockquote>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>用于提高关系型数据库的查询效率。索引可以帮助数据库快速定位表中的数据，降低查询的时间复杂度，提高数据库的性能。</p>
<p>在关系型数据库中，索引通常是在表的列上创建的，用于加速对该列的查询操作。索引可以分为<strong>聚簇索引</strong>和<strong>非聚簇索引</strong></p>
<p>可以通过索引快速的找到原始数据，</p>
<img src="/2023/04/23/cs-data/data-sql/image_024.png" class="" title="image_024">

<p>索引通常很小，可以放到内存中进行查询，这也是其比直接检索在磁盘中的数据要快得多的一个原因、</p>
<img src="/2023/04/23/cs-data/data-sql/image_025.png" class="" title="image_025">

<p>但是索引也存在一些弊端</p>
<ul>
<li>会增加数据库的大小，因为其必须永久存储在表的旁边</li>
<li>每次添加、更新或者删除记录时，MySQL必须更新对应的索引，这会影响我们正常操作的性能</li>
</ul>
<p>因为这些原因的存在，所以通常都是为比较关键的查询和字段添加索引。</p>
<p>如下图所示，索引通常是以树的形式存在的，这样是为了可以更快的查询遍历。这里就不对这类数据结构做过多的介绍了，有兴趣的话可以另行查询。</p>
<img src="/2023/04/23/cs-data/data-sql/image_026.png" class="" title="image_026">

<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span><span class="token punctuation">;</span> <span class="token comment">-- 用EXPLAIN分析语句</span>
<span class="token comment">-- 从图片 image_027 注意下 type 字段和 rows</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_027.png" class="" title="image_027">

<p><code>EXPLAIN</code> 的具体说明可见本站文章：loading…</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_state <span class="token keyword">ON</span> customers <span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 之后再次分析语句</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span><span class="token punctuation">;</span>
<span class="token comment">-- 可以看到将会查询使用到的行数减少了， 而且使用到了索引</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_028.png" class="" title="image-20230507230354160">

<h3 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看表的索引</span>
<span class="token keyword">SHOW</span> INDEXES <span class="token operator">IN</span> customers<span class="token punctuation">;</span>

<span class="token comment">-- 如果相关的参数评估不准确，可以使用下面的命令重新统计表的信息</span>
<span class="token keyword">ANALYZE</span> <span class="token keyword">TABLE</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行过之后可以看到两个索引，一个是主键索引名称为 <code>PRIMARY</code>，一个是二级索引名为为 <code>idx_state</code>，两者说明如下：</p>
<ul>
<li><p>主键索引</p>
<ul>
<li>主键索引是一种特殊的索引，用于加速对表中主键列的查询操作。</li>
<li>主键索引的特点是唯一性和非空性，即主键列的值必须唯一且不能为空。</li>
<li>主键索引可以帮助数据库快速定位表中的数据行，因此在设计表结构时通常会在主键列上创建主键索引。</li>
</ul>
</li>
<li><p>二级索引</p>
<ul>
<li>二级索引是指在表的非主键列上创建的索引。</li>
<li>与主键索引不同的是，二级索引并不要求列的值唯一或非空。</li>
<li>二级索引可以加速对非主键列的查询操作，提高查询效率。</li>
<li>在设计表结构时，可以根据实际需求在表的重要列上创建二级索引。</li>
<li><code>MySQL</code>自动的会将id或者主键列纳入到二级索引中。</li>
</ul>
</li>
</ul>
<p>需要注意的是，二级索引只是一种辅助索引，它只能加速对索引列的查询操作，而不能加速对其他列的查询操作。当查询条件不包含索引列时，数据库仍然需要进行全表扫描（这就是<strong>回表查询</strong>），查询效率会降低。</p>
<h3 id="前缀索引"><a href="#前缀索引" class="headerlink" title="前缀索引"></a>前缀索引</h3><p>一种特殊的索引，它是在字符串类型的列上创建的一种索引方式。与普通索引不同的是，前缀索引只索引字符串的前缀部分，而不是整个字符串。这样<strong>可以减少索引的大小，提高索引效率</strong>。通常应用在数据类型为 <code>CHAR</code>、<code>VARCHAR</code>、<code>TEXT</code>、<code>BLOB</code>的列上。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建前缀所用</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_lastname <span class="token keyword">ON</span> customers <span class="token punctuation">(</span>last_name<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 使用 last_name 的前20个字符创建索引</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>前缀索引锁设置的长度是根据实际需求选择。如果前缀长度太短，可能会导致索引失效，影响查询效率；如果前缀长度太长，可能会导致索引过大，降低数据库的性能。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 通过对比在不同前缀下记录的不重复数量，来简短的判断下选取多长的前缀区分度更高</span>
<span class="token keyword">SELECT</span> 
	<span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>last_name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">-- 统计选取不同长度的前缀，不重复的记录个数</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>last_name<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">COUNT</span><span class="token punctuation">(</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>last_name<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> customers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h3><p>一种特殊的索引，用于加速对文本类型列的模糊查询操作。与普通索引不同的是，全文索引可以对文本类型的列中的单词或短语进行索引，而不是对整个列进行索引。这样可以提高对文本内容的模糊查询效率。</p>
<p>在创建全文索引时，需要注意以下几点：</p>
<ul>
<li><p>只有<code>MyISAM</code>和<code>InnoDB</code>存储引擎支持全文索引，其他存储引擎不支持。</p>
</li>
<li><p>只有<code>CHAR</code>、<code>VARCHAR</code>和<code>TEXT</code>类型的列才能创建全文索引。</p>
</li>
<li><p>全文索引只能对英文、中文、日文等一些特定的语言进行索引，对于其他语言可能不支持或效果不佳。及对语言进行分词查询。</p>
</li>
<li><p>全文索引使用了一些特殊的算法，如<strong>自然语言搜索</strong>（<code>Natural Language Search</code>）和<strong>布尔搜索</strong>（<code>Boolean Search</code>），可以根据实际需求选择合适的搜索方式。</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_blog<span class="token punctuation">;</span>

<span class="token comment">-- 创建全文索引前， 模糊匹配查询数据比较大的字段</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	title <span class="token operator">LIKE</span> <span class="token string">'%react redux%'</span> <span class="token operator">OR</span>
	body <span class="token operator">LIKE</span> <span class="token string">'%react redux%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建全文索引</span>
<span class="token keyword">CREATE</span> FULLTEXT <span class="token keyword">INDEX</span> idx_title_body <span class="token keyword">ON</span> posts <span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用全文检索</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token comment">-- 注意这里需要把索引中的列都包含</span>
	AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 查询的关键词</span>
<span class="token comment">-- 查看结果，可以发现 title中只有redux的也可以查询出来，这是全文搜索的 '相关性得分' 所匹配的</span>

<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span> AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span> <span class="token comment">-- 相关性得分</span>
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span>  AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token comment">-- 还有一种布尔模式，可以包含或者排除某些单词</span>
<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span> AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span> <span class="token comment">-- 相关性得分</span>
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span>  AGAINST <span class="token punctuation">(</span><span class="token string">'react -redux'</span> <span class="token operator">IN</span> <span class="token keyword">BOOLEAN</span> <span class="token keyword">MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 查找包含 react 但是不包含 redux的行</span>
	
<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span> AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span> <span class="token comment">-- 相关性得分</span>
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span>  AGAINST <span class="token punctuation">(</span><span class="token string">'react -redux +form'</span> <span class="token operator">IN</span> <span class="token keyword">BOOLEAN</span> <span class="token keyword">MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 查找包含 react 但是不包含 redux的行 还必须包含form</span>
	
<span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span> AGAINST <span class="token punctuation">(</span><span class="token string">'react redux'</span><span class="token punctuation">)</span> <span class="token comment">-- 相关性得分</span>
<span class="token keyword">FROM</span> posts
<span class="token keyword">WHERE</span> 
	<span class="token keyword">MATCH</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> body<span class="token punctuation">)</span>  AGAINST <span class="token punctuation">(</span><span class="token string">'"handling a form"'</span> <span class="token operator">IN</span> <span class="token keyword">BOOLEAN</span> <span class="token keyword">MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 查找包含短语 handling a form 的行</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="复合索引"><a href="#复合索引" class="headerlink" title="复合索引"></a>复合索引</h3><p>一种在多个列上创建的联合索引。与单列索引不同的是，复合索引可以同时索引多个列，可以提高多列查询的效率</p>
<p>在创建复合索引时，需要注意以下几点：</p>
<ul>
<li><p>复合索引的顺序很重要，不同的顺序可能会影响查询效率。一般来说，将选择性高的列放在前面可以提高索引的效率。</p>
</li>
<li><p>复合索引只适用于同时查询多个列的场景，对于单列查询可能不适用。</p>
</li>
<li><p>复合索引的大小和效率受到列类型、列长度、数据分布等多种因素的影响，需要根据实际情况进行优化。</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> sql_store<span class="token punctuation">;</span>

<span class="token comment">-- 在只有 idx_state 索引的情况下分析该语句</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span> <span class="token operator">AND</span> points <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_029.png" class="" title="image_029">

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建联合索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_state_points <span class="token keyword">ON</span> customers <span class="token punctuation">(</span>state<span class="token punctuation">,</span> points<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 重新分析语句</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span> <span class="token operator">AND</span> points <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token comment">-- 可以发现过滤的行数 rows 减少了很多，且使用了联合索引， 需要遍历的行数减少，查询也就会相对更快。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_030.png" class="" title="image_030">

<p>如果某个索引中存在多列，数据排序也会加快。</p>
<p>这里很容易发生错误认知，为了方便使用，为每列创建单独的索引，但是有且情况如上面的例子所示，单列索引并不能帮助获得最佳性能，并且这些索引占用很多空间，每次修改表中的数据时，必须更新这些索引，索引越多，写入操作越慢，同时，<code>MySQL</code>会自动将表的主键包含在每个二级索引中，这些单列索引会浪费很多空间。因此使用复合索引会更好。</p>
<p>那么索引中应该包含多少列？<code>MySQL</code>中，一个索引中最多可以包含<code>16</code>列，但是通常不会使用这么多，一般推荐<code>4——6</code>个列，当然这不是最佳实践，最重要的是要根据使用的数据量和需求决定。</p>
<h4 id="复合索引中列的顺序"><a href="#复合索引中列的顺序" class="headerlink" title="复合索引中列的顺序"></a>复合索引中列的顺序</h4><p>有两个常用规则的推荐</p>
<ul>
<li>对列进行排序<ul>
<li>让更频繁被使用的列排在最前面。通过被频繁使用的列可以更快的缩小对索引遍历查询的范围</li>
</ul>
</li>
<li>基数更高的列排在最前面<ul>
<li>基数表示索引中唯一值的数量。这样也是为了更快速的缩小查询范围，因为唯一值更多，所以重复的可能性就更低，在指定条件时可以更快的缩小查询的数据范围。</li>
</ul>
</li>
</ul>
<p>但是，不一定要必须遵守上述的规则，<strong>更重要的是根据自己的实际情况来选择索引的顺序</strong>。</p>
<h3 id="指定索引查询"><a href="#指定索引查询" class="headerlink" title="指定索引查询"></a>指定索引查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers
<span class="token keyword">USE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span>idx_state_points<span class="token punctuation">)</span> <span class="token comment">-- 指定使用索引的范围，可以指定多个</span>
<span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers
<span class="token keyword">FORCE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span>idx_state_points<span class="token punctuation">)</span> <span class="token comment">-- 强制使用指定的索引查询</span>
<span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers
<span class="token keyword">IGNORE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">(</span>idx_state_points<span class="token punctuation">)</span> <span class="token comment">-- 忽略指定的索引</span>
<span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="索引无效时"><a href="#索引无效时" class="headerlink" title="索引无效时"></a>索引无效时</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span> <span class="token operator">OR</span> points <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">-- 查看图 image_03 可以看到，使用了索引，但是将会使用到的行数基本等于整张表，类似于一个全索引扫描。</span>
<span class="token comment">-- 这时候就是没能正确使用索引，一般通过改造sql来更好的使用索引</span>

<span class="token keyword">EXPLAIN</span> 
<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'CA'</span> 
<span class="token keyword">UNION</span> 
<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> points <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">-- 但是这里并不能使用到索引 idx_state_points， 因为最左匹配原则存在（即在联合索引中，需要先匹配第一个列的值才能去匹配第二列，无法直接匹配第二列，这个和联合索引的使用B+树存储的有关）</span>
<span class="token comment">-- 所以推荐再单独为 points 字段创建一个索引来加速查询</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_031.png" class="" title="image_031">

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">WHERE</span> points <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token comment">-- 分析下上面的语句，可以看到这里还是基本进行了全局检索，如果数据很多，查询将会很慢</span>
<span class="token comment">-- 这里没有正确使用索引的原因在于，我们对列进行了计算，MySQL无法以最优方式利用索引了，索引最好的方式是将计算放到表达式的右侧，不要直接对列进行计算</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_032.png" class="" title="image_032">

<p>常见的索引失效原因和场景包括以下几种：</p>
<ul>
<li><p>索引列未被使用</p>
<ul>
<li>如果查询中未包含索引列，那么索引将无法被使用。</li>
<li>例如，如果一个表有一个包含两个列的联合索引 (<code>col1, col2</code>)，但是查询只包含 ` col12 列，那么该索引将无法被使用。</li>
</ul>
</li>
<li><p>列类型不匹配</p>
<ul>
<li>索引列的类型必须与查询中的列类型相匹配，否则索引将无法被使用。</li>
<li>例如，如果一个表的索引列为字符串类型，但是查询中使用的是数值类型，那么该索引将无法被使用。</li>
</ul>
</li>
<li><p>函数操作</p>
<ul>
<li>如果查询中使用了函数操作，那么索引将无法被使用。</li>
<li>例如，如果一个表有一个包含两个列的联合索引 (<code>col1, col2</code>)，但是查询中使用了 <code>col1</code> 的函数操作，那么该索引将无法被使用。</li>
</ul>
</li>
<li><p>数据不均匀</p>
<ul>
<li>如果表中的数据分布不均匀，那么索引可能无法有效加速查询。</li>
<li>例如，如果一个表的索引列中有大量的重复值，那么该索引将无法有效加速查询。</li>
</ul>
</li>
</ul>
<h3 id="使用索引排序"><a href="#使用索引排序" class="headerlink" title="使用索引排序"></a>使用索引排序</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">;</span>
<span class="token comment">-- 如图 image_033 这里可以看到，没有使用索引，还使用了 “外部排序” 这是一种十分耗时的操作</span>

<span class="token comment">-- 查看数据库的状态</span>
<span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行排序</span>
<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">;</span>
<span class="token comment">-- 查看 上次查询 的消耗, 注意和下面的查询再一个连接中同时执行</span>
<span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'last_query_cost'</span><span class="token punctuation">;</span>
<span class="token comment">-- Last_query_cost 1117.149000</span>

<span class="token comment">-- 之后使用有索引的字段来排序</span>
<span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> state<span class="token punctuation">;</span>
<span class="token keyword">SHOW</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'last_query_cost'</span><span class="token punctuation">;</span>
<span class="token comment">-- Last_query_cost 103.149000</span>
<span class="token comment">-- 可以看到查询成本的下降 </span>


<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> customer_id <span class="token keyword">FROM</span> customers <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> state<span class="token punctuation">;</span>
<span class="token comment">-- 如图 image_034 可以看到这里不在使用 “外部排序”， 而是使用了索引</span>

<span class="token comment">-- 当然排序的 递增和递减也会有区别， 以及在使用联合索引时，根据不同的字段排序也有所区别，这里就不做过多说明了</span>
<span class="token comment">-- 基本的规则就是 能基于索引的排序是效率最高的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/04/23/cs-data/data-sql/image_033.png" class="" title="image_033">

<img src="/2023/04/23/cs-data/data-sql/image_034.png" class="" title="image_034">

<h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><p>指一个索引包含了所有需要查询的列或者排序使用到的列，因此查询可以直接使用该索引来返回结果，而不需要再次访问表中的数据行。覆盖索引可以大大提高查询的性能，因为它可以避免了访问表中的数据行，减少了磁盘I/O的开销。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> customer_id<span class="token punctuation">,</span> state <span class="token keyword">FROM</span> customers <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> state<span class="token punctuation">;</span>
<span class="token comment">-- 这类查询就是使用到的数据和返回的数据，都在索引中，而不需要进行回表查询去查找访问表中的数据行。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="数据库安全"><a href="#数据库安全" class="headerlink" title="数据库安全"></a>数据库安全</h2><blockquote>
<p><code>Securing databases</code></p>
</blockquote>
<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建一个用户</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> 
	qing<span class="token variable">@127.0.0.1</span> <span class="token comment">-- 创建用户和用户可以通过什么主机IP访问数据库</span>
	<span class="token comment">-- qing@localhost  -- 也可以指定主机名</span>
	<span class="token comment">-- qing@code.com  -- 也可以指定域名</span>
	<span class="token comment">-- qing@'%.code.com' -- 当然也可以使用匹配符，不过这时候就需要使用 引号包裹</span>
	<span class="token comment">-- qing@'%' -- 不做限定，任意IP均可访问</span>
IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'1234'</span><span class="token punctuation">;</span>  <span class="token comment">-- 设置认证密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="查看用户"><a href="#查看用户" class="headerlink" title="查看用户"></a>查看用户</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查询用户</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 删除用户</span>
<span class="token keyword">DROP</span> <span class="token keyword">USER</span> qing<span class="token variable">@127.0.0.1</span><span class="token punctuation">;</span> <span class="token comment">-- 注意这里要同时指定用户和设置的访问权限地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 修改其他用户的密码</span>
<span class="token keyword">SET</span> PASSWORD <span class="token keyword">FOR</span> qing <span class="token operator">=</span> <span class="token string">'12345'</span><span class="token punctuation">;</span>

<span class="token comment">-- 修改自己的尼玛</span>
<span class="token keyword">SET</span> PASSWORD <span class="token operator">=</span> <span class="token string">'12345'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="授予权限"><a href="#授予权限" class="headerlink" title="授予权限"></a>授予权限</h3><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html" title="点击跳转"><code>MySQL</code>权限相关文档</a>：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html">https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html</a></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 创建用户</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> qing<span class="token variable">@127.0.0.1</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'1234'</span><span class="token punctuation">;</span>

<span class="token comment">-- 授予一些所需要的权限</span>
<span class="token keyword">GRANT</span>
	<span class="token keyword">SELECT</span><span class="token punctuation">,</span>  <span class="token comment">-- 指定权限范围</span>
	<span class="token keyword">INSERT</span><span class="token punctuation">,</span>
	<span class="token keyword">UPDATE</span><span class="token punctuation">,</span>
	<span class="token keyword">DELETE</span><span class="token punctuation">,</span>
	<span class="token keyword">EXECUTE</span>
<span class="token keyword">ON</span> sql_store<span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token comment">-- 数据库 sql_store 的所有表</span>
	sql_store<span class="token punctuation">.</span>customers <span class="token comment">-- 当然也可是单独一张表</span>
<span class="token keyword">TO</span> qing<span class="token variable">@127.0.0.1</span> <span class="token comment">-- 指定账号，如果设置了主机地址这里也需要加上</span>

<span class="token comment">-- 给与管理员权限， 可以查看上面的文档来确定所需要的权限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token comment">-- 给与所有权限，当然也可以根据上面的文档，选取部分</span>
<span class="token keyword">ON</span> sql_store<span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token comment">-- 指定数据库中的所有表</span>
<span class="token comment">-- ON *.* -- 指定所有数据库所有表</span>
<span class="token keyword">TO</span> qing<span class="token variable">@127.0.0.1</span><span class="token punctuation">;</span>

<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token punctuation">`</span>sql_store<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> qing<span class="token variable">@127.0.0.1</span><span class="token punctuation">;</span>  <span class="token comment">-- 当然也可以一次给与所有权限</span>
<span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token punctuation">`</span>sql_store<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> qing<span class="token variable">@127.0.0.1</span><span class="token punctuation">;</span> <span class="token comment">-- 授予 最基础的权限</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="查看权限"><a href="#查看权限" class="headerlink" title="查看权限"></a>查看权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看权限</span>
<span class="token keyword">SHOW</span> GRANTS <span class="token keyword">FOR</span> qing<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="撤销权限"><a href="#撤销权限" class="headerlink" title="撤销权限"></a>撤销权限</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 撤销权限</span>
<span class="token keyword">REVOKE</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> <span class="token comment">-- 需要取消的权限</span>
<span class="token keyword">ON</span> sql_store<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token comment">-- 所需要取消的数据库和表范围</span>
<span class="token keyword">FROM</span> qing<span class="token variable">@127.0.0.1</span><span class="token punctuation">;</span> <span class="token comment">-- 指定用户</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<hr>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>B站视频，SQL进阶教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UE41147KC?p=1&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959">https://www.bilibili.com/video/BV1UE41147KC?p=1&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io" rel="external nofollow noreferrer">Robert Sunq</a>
                    </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io/2023/04/23/cs-data/data-sql/">https://robertsunq.github.io/2023/04/23/cs-data/data-sql/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://robertsunq.github.io" target="_blank">Robert Sunq</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%8E%9F%E5%88%9B/">
                                    <span class="chip bg-color">原创</span>
                                </a>
                            
                                <a href="/tags/note/">
                                    <span class="chip bg-color">note</span>
                                </a>
                            
                                <a href="/tags/mysql/">
                                    <span class="chip bg-color">mysql</span>
                                </a>
                            
                                <a href="/tags/sql/">
                                    <span class="chip bg-color">sql</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/05/09/cs-frameworks-tools/linux-install-gitea/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="基于Linux系统安装Gitea">
                        
                        <span class="card-title">基于Linux系统安装Gitea</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            基于Linux系统安装Gitea，主要是记录自己的安装过程，方便自己下次安装参考。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-05-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cs-frameworks-tools/" class="post-category">
                                    cs-frameworks-tools
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">原创</span>
                    </a>
                    
                    <a href="/tags/git/">
                        <span class="chip bg-color">git</span>
                    </a>
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                    <a href="/tags/gitea/">
                        <span class="chip bg-color">gitea</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/04/23/cs-dev-ops/k8s-statefulset-yaml/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="kubernetes yaml配置详解——StatefulSet篇">
                        
                        <span class="card-title">kubernetes yaml配置详解——StatefulSet篇</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            kubernetes对资源管理和资源对象编排使用的yaml文件详解，StatefulSet篇
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-04-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cs-dev-ops/" class="post-category">
                                    cs-dev-ops
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">原创</span>
                    </a>
                    
                    <a href="/tags/%E5%BE%85%E7%BB%AD/">
                        <span class="chip bg-color">待续</span>
                    </a>
                    
                    <a href="/tags/kubernetes/">
                        <span class="chip bg-color">kubernetes</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Qing<br />'
            + '文章作者: Robert Sunq<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '<原创文章> 著作权归Robert Sunq所有，<转载文章> 著作权归原作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <a href="/about" target="_blank">Robert Sunq</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">127.5k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/RobertSunq" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:loading@xx.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=loading..." class="tooltipped" target="_blank" data-tooltip="QQ联系我: loading..." data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"left","width":150,"height":350},"mobile":{"show":true},"log":false});</script></body>

</html>
