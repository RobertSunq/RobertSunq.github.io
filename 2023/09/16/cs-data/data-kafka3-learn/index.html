<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="kafka, note, java">
    <meta name="description" content="基于尚硅谷的视频 kafka3 学习笔记">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>kafka3学习笔记 | Qing</title>
    <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qing</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/solution" class="waves-effect waves-light">

      
      <i class="fas fa-flag" style="zoom: 0.6;"></i>
      
      <span>题解系列</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/solution/leetcode">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Leetcode</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qing</div>
        <div class="logo-desc">
            
            这个人没啥子特点 喜欢一切随缘咯 ( •̀ ω •́ )✧
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-flag"></i>
			
			题解系列
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/solution/leetcode " style="margin-left:75px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:50px" ></i>
			      
		          <span>Leetcode</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/RobertSunq/RobertSunq.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/RobertSunq/RobertSunq.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('哟！你知道密码不？')).toString(CryptoJS.enc.Hex)) {
                alert('好可惜你不知道哎，那只能回到主页咯！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">kafka3学习笔记</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/note/">
                                <span class="chip bg-color">note</span>
                            </a>
                        
                            <a href="/tags/%E9%83%A8%E5%88%86%E5%8E%9F%E5%88%9B/">
                                <span class="chip bg-color">部分原创</span>
                            </a>
                        
                            <a href="/tags/kafka/">
                                <span class="chip bg-color">kafka</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/cs-data/" class="post-category">
                                cs-data
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-09-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-09-16
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    31.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    144 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="kafka3学习笔记"><a href="#kafka3学习笔记" class="headerlink" title="kafka3学习笔记"></a>kafka3学习笔记</h1><blockquote>
<p>说明：基于尚硅谷的视频 <code>kafka3</code> 学习笔记</p>
</blockquote>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="Kafka概述"><a href="#Kafka概述" class="headerlink" title="Kafka概述"></a>Kafka概述</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><ul>
<li><p><strong>传统定义</strong>：一个<strong>分布式</strong>的基于<strong>发布/订阅模式</strong>的<strong>消息队列</strong>（<code>Message Queue</code>），主要应用于大数据实时处理领域。</p>
</li>
<li><p><strong>发布/订阅</strong>：消息的发布者不会将消息直接发送给特定的订阅者，而是<strong>将发布的消息分为不同的类别</strong>，订阅者<strong>只接收感兴趣的消息</strong>。</p>
</li>
<li><p><strong>最新定义</strong>：是一个开源的<strong>分布式事件流平台</strong>（<code>Event Streaming Platform</code>），用于高性能<strong>数据管道</strong>、<strong>流分析</strong>、<strong>数据集成</strong>和<strong>关键任务应用</strong>。</p>
</li>
</ul>
<h4 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h4><p>目前企业中比较常见的消息队列产品主要有 <code>Kafka</code>、<code>ActiveMQ</code> 、<code>RabbitMQ</code> 、 <code>RocketMQ</code> 等。 在大数据场景主要采用 <code>Kafka</code> 作为消息队列。在 <code>JavaEE</code> 开发中主要采用 <code>ActiveMQ</code>、 <code>RabbitMQ</code>、<code>RocketMQ</code>。</p>
<h5 id="传统消息队列的应用场景"><a href="#传统消息队列的应用场景" class="headerlink" title="传统消息队列的应用场景"></a>传统消息队列的应用场景</h5><p>传统的消息队列的主要应用场景：<strong>缓存/消峰</strong>、<strong>解耦</strong>和<strong>异步通信</strong>。</p>
<h6 id="缓存-x2F-消峰"><a href="#缓存-x2F-消峰" class="headerlink" title="缓存/消峰"></a>缓存/消峰</h6><p>有助于控制和优化数据流经过系统的速度，解决产生消息和消费消息的处理速度不一致的情况。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-001.png" class="" title="image-001">

<h6 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h6><p>允许独立的扩展或者修改两边的处理过程，只要确保它们遵守同样的接口约束</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-002.png" class="" title="image-002">



<h6 id="异步通信"><a href="#异步通信" class="headerlink" title="异步通信"></a>异步通信</h6><p>用户把消息放入队列，但并不立即处理它，然后再需要的时候再去处理它们。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-003.png" class="" title="image-003">

<h5 id="消息队列的两种模式"><a href="#消息队列的两种模式" class="headerlink" title="消息队列的两种模式"></a>消息队列的两种模式</h5><ul>
<li><p>点对点模式</p>
<ul>
<li>消费者主动拉取数据，消息收到后清除消息</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-004.png" class="" title="image-005">
</li>
<li><p>发布/订阅模式</p>
<ul>
<li>可用有多个topic主题</li>
<li>消费者消费数据之后，不删除数据。（实际会根据配置的存活时间等来删除过期数据）</li>
<li>每个消费者相互独立，都可以消费到数据</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-005.png" class="" title="image-004"></li>
</ul>
<h4 id="Kafka基础架构"><a href="#Kafka基础架构" class="headerlink" title="Kafka基础架构"></a>Kafka基础架构</h4><ol>
<li><p><span style="color: red;">为了方便扩展，并提高吞吐量，一个topic分为多个pattition。</span></p>
</li>
<li><p><span style="color: red;">配合分区的设计、提出消费者组的概念、组内每个消费者并行消费。</span></p>
<ol>
<li>一个分区的数据只能由一个消费者消费。</li>
</ol>
</li>
<li><p><span style="color: red;">为提高可用性，为灭个partition增加若干个副本，类似NameNode HA。</span></p>
<ol>
<li>消费只针对leader消费，在leader挂掉的时候，follower 可变为新的leader提供消费。</li>
<li>kafka中还存在部分数据存储在Zookeeper中。记录着服务中的所有服务器节点信息和运行状态；同时记录分区leader的信息。</li>
</ol>
</li>
<li><p><span style="color: red;">kafka-2.8之前必须有Zookeeper配合存储leader信息；该版本之后可用不使用Zookeeper存储，切换为Kraft模式。</span></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-006.png" class="" title="image-006"></li>
</ol>
<ul>
<li><code>Producer</code>：生产者</li>
<li><code>Consumer</code>：消费者</li>
<li><code>Consumer Group（CG）</code>：消费者组，右多个<code>Consumer</code>组成。<span style="color: red;">消费者组每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费；消费者组之间互不影响</span>。所有的消费者都属于某个消费者组，即<span style="color: red;">消费者组是逻辑上的一个订阅者</span>。</li>
<li><code>Broker</code>：一台<code>Kafka</code>服务器就是一个<code>broker</code>。一个集群由多个<code>broker</code>组成。一个<code>broker</code>可用容纳多个topic。</li>
<li><code>Topic</code>：可用理解为一个队列，<span style="color: red;">生产者和消费者面向的都是一个<code>topic</code></span>。</li>
<li><code>Partion</code>：为了实现扩展性，一个非常大的<code>topic</code>可用分布到多个<code>broker</code>（即服务器）上，<span style="color: red;">一个<code>topic</code>可用分为多个partition</span>，每个<code>partition</code>是一个<span style="color: red;">有序的队列</span>。</li>
<li><code>Replica</code>：副本。一个<code>topic</code>的米格分区都有若干个副本，一个<code>Leader</code>和若干个<code>Follower</code>。</li>
<li><code>Leader</code>：每个分区多个<strong>副本的“主”</strong>，生产者发送数据的对象，以及消费者消费数据的对都是<code>Leader</code>。</li>
<li><code>Follower</code>：每个分区多个<strong>副本中的“从”</strong>，实时从<code>Leader</code>中同步数据，保持和<code>Leader</code>数据的同步。<code>Leader</code>发生故障时，某个<code>Follower</code>会成为新的<code>Leader</code>。</li>
</ul>
<h3 id="Kafka快速入门"><a href="#Kafka快速入门" class="headerlink" title="Kafka快速入门"></a>Kafka快速入门</h3><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><h5 id="前提环境准备"><a href="#前提环境准备" class="headerlink" title="前提环境准备"></a>前提环境准备</h5><p>安装 <code>Java OpenJDK 11</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 tmp]$ sudo dnf install java-11-openjdk

# 提示劝人安装时，输入 y 并按下 ENTER 继续

# 确认版本
[robert@cluster01 tmp]$ java --version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h5><table>
<thead>
<tr>
<th>cluster01</th>
<th>cluster02</th>
<th>cluster03</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.1.111</td>
<td>192.168.1.112</td>
<td>192.168.1.113</td>
</tr>
<tr>
<td>zookeeper</td>
<td>zookeeper</td>
<td>zookeeper</td>
</tr>
<tr>
<td>kafka</td>
<td>kafka</td>
<td>kafka</td>
</tr>
</tbody></table>
<h5 id="集群部署"><a href="#集群部署" class="headerlink" title="集群部署"></a>集群部署</h5><p><a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads.html" title="点击跳转">官网下载地址</a>：<a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads.html">https://kafka.apache.org/downloads.html</a></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 解压安装包
[robert@cluster01 tmp]$ tar -zxvf kafka_2.12-3.0.0.tgz -C /opt/qing/module
## z：使用 gzip 解压缩压缩文件。
## x：解压缩 tar 文件的内容。
## v：详细模式，显示解压缩过程的进度和详细信息。
## f：指定输入文件，这里是 "kafka_2.12-3.0.0.tgz"。
## -C /opt/qing/module：指定要将 tar 文件的内容解压缩到的目录，这里是 "/opt/qing/module"。


# 修改解压后的文件名
[robert@cluster01 module]$ mv kafka_2.12-3.0.0/ kafka

# 进入到/opt/qing/module/kafka目录，修改配置文件
[robert@cluster03 kafka]$ cd kafka/config/
[robert@cluster01 config]$ vim server.properties
# 输入以下内容<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>根据需求修改以下内容</strong></p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment"># broker的全局唯一编号，不能重复，只能是数字。  				## 注意这里</span>
<span class="token attr-name">broker.id</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token attr-value">/opt/qing/module/kafka/datas/logs/</span>
<span class="token comment"># 处理网络请求的线程数量</span>
<span class="token attr-name">num.network.threads</span><span class="token punctuation">=</span><span class="token attr-value">3</span>
<span class="token comment"># 用来处理磁盘 IO 的线程数量</span>
<span class="token attr-name">num.io.threads</span><span class="token punctuation">=</span><span class="token attr-value">8</span>
<span class="token comment"># 发送套接字的缓冲区大小</span>
<span class="token attr-name">socket.send.buffer.bytes</span><span class="token punctuation">=</span><span class="token attr-value">102400</span>
<span class="token comment"># 接收套接字的缓冲区大小</span>
<span class="token attr-name">socket.receive.buffer.bytes</span><span class="token punctuation">=</span><span class="token attr-value">102400</span>
<span class="token comment"># 请求套接字的缓冲区大小</span>
<span class="token attr-name">socket.request.max.bytes</span><span class="token punctuation">=</span><span class="token attr-value">104857600</span>
<span class="token comment"># kafka 运行日志(数据)存放的路径，路径不需要提前创建，kafka 自动帮你创建，可以配置多个磁盘路径，路径与路径之间可以用"，"分隔										## 注意这里</span>
<span class="token attr-name">log.dirs</span><span class="token punctuation">=</span><span class="token attr-value">/opt/qing/module/kafka/data     </span>
<span class="token comment"># topic 在当前 broker 上的分区个数</span>
<span class="token attr-name">num.partitions</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token comment"># 用来恢复和清理 data 下数据的线程数量</span>
<span class="token attr-name">num.recovery.threads.per.data.dir</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token comment"># 每个 topic 创建时的副本数，默认时 1 个副本</span>
<span class="token attr-name">offsets.topic.replication.factor</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token comment"># segment 文件保留的最长时间，超时将被删除</span>
<span class="token attr-name">log.retention.hours</span><span class="token punctuation">=</span><span class="token attr-value">168</span>
<span class="token comment"># 每个 segment 文件的大小，默认最大 1G</span>
<span class="token attr-name">log.segment.bytes</span><span class="token punctuation">=</span><span class="token attr-value">1073741824</span>
<span class="token comment"># 检查过期数据的时间，默认 5 分钟检查一次是否数据过期</span>
<span class="token attr-name">log.retention.check.interval.ms</span><span class="token punctuation">=</span><span class="token attr-value">300000</span>
<span class="token comment"># 配置连接 Zookeeper 集群地址（在 zk 根目录下创建/kafka，方便管理）</span>
<span class="token comment"># 注意这里使用的是主机名，所以需要修改自己的hosts中的主机名和IP的映射    		## 注意这里</span>
<span class="token attr-name">zookeeper.connect</span><span class="token punctuation">=</span><span class="token attr-value">cluster01:2181,cluster02:2181,cluster03:2181/kafka</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>修改主机名和IP的映射</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 修改 hosts 文件
[robert@cluster03 kafka]$ sudo vi /etc/hosts

####### 增加如下内容  ######## 

192.168.1.111 cluster01
192.168.1.112 cluster02
192.168.1.113 cluster03

####### 增加如上内容  ######## 

# 保存文件后，重启网络服务或者重新加载DNS配置
[robert@cluster03 kafka]$ sudo systemctl restart network
# or
[robert@cluster03 kafka]$ sudo systemctl restart systemd-resolved
# ro
[robert@cluster03 kafka]$ sudo systemctl restart NetworkManager


# 验证
[robert@cluster03 kafka]$ ping clustert01
[robert@cluster03 kafka]$ ping clustert02
[robert@cluster03 kafka]$ ping clustert03<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</blockquote>
<p>之后在集群其他主机上执行相同的操作，需要注意的是，<strong>配置文件中的 broker.id = 2、broker.id=3 要分别设置，保证其在整个集群中的唯一。</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 module ]$ vim kafka/config/server.properties
########## 修改内容如下 ##########
# The id of the broker. This must be set to a unique integer for each broker.
broker.id=1
########## 修改内容如上 ##########


[robert@cluster02 module ]$ vim kafka/config/server.properties
########## 修改内容如下 ##########
# The id of the broker. This must be set to a unique integer for each broker.
broker.id=2
########## 修改内容如上 ##########


[robert@cluster03 module ]$ vim kafka/config/server.properties
########## 修改内容如下 ##########
# The id of the broker. This must be set to a unique integer for each broker.
broker.id=3
########## 修改内容如上 ##########<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置环境变量</p>
<blockquote>
<p>可参考同站文章：<a href="https://robertsunq.github.io/2021/12/30/cs/command-note/">命令备忘录</a></p>
</blockquote>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 配置环境变量
[robert@cluster01 module ]$ sudo vim /etc/profile

####### 增加如下内容  ######## 

####### kafka config start #######
export KAFKA_HOME=/opt/qing/module/kafka
export PATH=$PATH:$KAFKA_HOME/bin
####### kafka config end #######

####### 增加如上内容  ######## 


# 之后刷新环境变量
[robert@cluster01 module ]$ source /etc/profile


# 然后再 cluster02 和 cluster03 环境上分别配置以上环境变量



## 也可以在 /etc/profile.d/ 中创建环境变量初始化脚本
[robert@cluster01 module ]$ sudo vim /etc/profile.d/env_robert.sh

####### 增加如下内容  ######## 

#!/usr/bin/env bash


####### kafka config start #######

KAFKA_HOME=/opt/qing/module/kafka
PATH=$PATH:$KAFKA_HOME/bin

export KAFKA_HOME

####### kafka config end #######

export PATH

####### 增加如上内容  ######## 



# 之后刷新环境变量
[robert@cluster01 module ]$ source /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>启动集群</p>
<blockquote>
<p>Zookeeper集群安装与启动可查看本站文章：<a href="https://robertsunq.github.io/2023/08/14/cs-dev-ops/ops-zookeeper-learn/">Zookeeper学习笔记</a> ： <a href="https://robertsunq.github.io/2023/08/14/cs-dev-ops/ops-zookeeper-learn/">https://robertsunq.github.io/2023/08/14/cs-dev-ops/ops-zookeeper-learn/</a></p>
</blockquote>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 先启动 Zookeeper 集群，然后启动Kafka
[robert@cluster01 module]$ /home/robert/bin/zk.sh start


# 然后依次再 cluster01 cluster02 cluster03 节点上启动 Kafka
[robert@cluster01 kafka]$ bin/kafka-server-start.sh -daemon config/server.properties
[robert@cluster02 kafka]$ bin/kafka-server-start.sh -daemon config/server.properties
[robert@cluster03 kafka]$ bin/kafka-server-start.sh -daemon config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关闭集群</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 kafka]$ bin/kafka-server-stop.sh 
[robert@cluster02 kafka]$ bin/kafka-server-stop.sh 
[robert@cluster03 kafka]$ bin/kafka-server-stop.sh <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="集群启停脚本"><a href="#集群启停脚本" class="headerlink" title="集群启停脚本"></a>集群启停脚本</h5><blockquote>
<p> 需要配置服务器之间的免密登录</p>
<p>本站文章教程：<a href="https://robertsunq.github.io/2021/12/30/cs/command-note/">https://robertsunq.github.io/2021/12/30/cs/command-note/</a></p>
</blockquote>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 bin]$ vim kafka.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编写内容如下</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">#! /bin/bash
case $1 in
"start") {
        for i in cluster01 cluster02 cluster03
        do
                echo "--------启动 $i Kafka-------"
                ssh $i "/opt/qing/module/kafka/bin/kafka-server-start.sh -daemon /opt/qing/module/kafka/config/server.properties"
        done
};;
"stop") {
        for i in cluster01 cluster02 cluster03
        do
                echo "--------停止 $i Kafka-------"
                ssh $i "/opt/qing/module/kafka/bin/kafka-server-stop.sh"
        done
};;
esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加执行权限</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 bin]$ chmod +x kafka.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动集群命令</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 bin]$ /home/robert/bin/kafka.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>停止集群命令</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">[robert@cluster01 bin]$ /home/robert/bin/kafka.sh stop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>注意：停止 <code>Kafka</code> 集群时，一定要等 <code>Kafka</code> 所有节点进程全部停止后再停止 <code>Zookeeper</code> 集群。因为 <code>Zookeeper</code> 集群当中记录着 <code>Kafka</code> 集群相关信息，<code>Zookeeper</code> 集群一旦先停止， <code>Kafka</code> 集群就没有办法再获取停止进程的信息，只能手动杀死 <code>Kafka</code> 进程了。</strong></p>
<h4 id="Kafka命令行操作"><a href="#Kafka命令行操作" class="headerlink" title="Kafka命令行操作"></a>Kafka命令行操作</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-007.png" class="" title="image-007">

<h5 id="主题命令行操作"><a href="#主题命令行操作" class="headerlink" title="主题命令行操作"></a>主题命令行操作</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看操作主题命令参数</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>--bootstrap-server &lt;String: server toconnect to&gt;</code></td>
<td>连接的 Kafka Broker 主机名称和端口号</td>
</tr>
<tr>
<td><code>--topic &lt;String: topic&gt;</code></td>
<td>操作的 topic 名称</td>
</tr>
<tr>
<td><code>--create</code></td>
<td>创建主题</td>
</tr>
<tr>
<td><code>--delete</code></td>
<td>删除主题</td>
</tr>
<tr>
<td><code>--alter</code></td>
<td>修改主题</td>
</tr>
<tr>
<td><code>--list</code></td>
<td>查看所有主题</td>
</tr>
<tr>
<td><code>--describe</code></td>
<td>查看主题详细描述</td>
</tr>
<tr>
<td><code>--partitions &lt;Integer: # of partitions&gt;</code></td>
<td>设置分区数</td>
</tr>
<tr>
<td><code>--replication-factor&lt;Integer: replication factor&gt;</code></td>
<td>设置分区副本</td>
</tr>
<tr>
<td><code>--config &lt;String: name=value&gt;</code></td>
<td>更新系统默认配置</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看当前服务器中的所有 topic</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --list
<span class="token comment"># 注意，如果cluser映射的是具体的ip，请检查端口是否防火墙放行</span>


<span class="token comment"># 创建 first topic</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">1</span> --replication-factor <span class="token number">3</span> --topic first
<span class="token comment">## --topic 					定义 topic 名</span>
<span class="token comment">## --replication-factor		定义副本数</span>
<span class="token comment">## --partitions				定义分区数</span>



<span class="token comment"># 查看 first 主题的详情</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic first


<span class="token comment"># 修改分区数（注意：分区数只能增加，不能减少）</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --alter --topic first --partitions <span class="token number">3</span>


<span class="token comment"># 再次查看 first 主题的详情</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic first



<span class="token comment"># 删除 topic</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --delete --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="生产者命令行操作"><a href="#生产者命令行操作" class="headerlink" title="生产者命令行操作"></a>生产者命令行操作</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看操作生产者命令参数</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>–bootstrap-server &lt;String: server toconnect to&gt;</td>
<td>连接的 Kafka Broker 主机名和端口号</td>
</tr>
<tr>
<td>–topic &lt;String: topic&gt;</td>
<td>操作的 topic名称</td>
</tr>
<tr>
<td>–from-beginning</td>
<td>从头开始消费</td>
</tr>
<tr>
<td>–group &lt;String: consumer group id&gt;</td>
<td>指定消费者组名称</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first
<span class="token comment">### 输入</span>
<span class="token operator">&gt;</span>hello world
<span class="token operator">&gt;</span>robert sun<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="消费者命令行操作"><a href="#消费者命令行操作" class="headerlink" title="消费者命令行操作"></a>消费者命令行操作</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 消费 first 主题中的数据</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first



<span class="token comment"># 把主题中所有的数据都读取出来（包括历史数据）</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --from-beginning --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Kafka生产者"><a href="#Kafka生产者" class="headerlink" title="Kafka生产者"></a>Kafka生产者</h3><h4 id="生产者消息发送流程"><a href="#生产者消息发送流程" class="headerlink" title="生产者消息发送流程"></a>生产者消息发送流程</h4><h5 id="发送原理"><a href="#发送原理" class="headerlink" title="发送原理"></a>发送原理</h5><p>在消息发送的过程中，涉及到了<strong>两个线程——<code>main</code> 线程和 <code>Sender</code> 线程</strong>。在 <code>main</code> 线程 中创建了**一个双端队列 <code>RecordAccumulator</code>**。<code>main</code> 线程将消息发送给 <code>RecordAccumulator</code>， <code>Sender</code> 线程不断从 <code>RecordAccumulator</code> 中拉取消息发送到 <code>Kafka Broker</code>。</p>
<p><strong>发送流程</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-008.png" class="" title="image-008">

<h5 id="生产者重要参数列表"><a href="#生产者重要参数列表" class="headerlink" title="生产者重要参数列表"></a>生产者重要参数列表</h5><table>
<thead>
<tr>
<th>参数名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap.servers</code></td>
<td>生产者连接集群所需的 <code>broker</code> 地址清单 。 例 如 <code>cluster01:9092,cluster02:9092,cluster03:9092</code>，可以 设置 1 个或者多个，中间用逗号隔开。注意这里并非需要所有的 <code>broker</code> 地址，因为生产者从给定的 <code>broker</code> 里查找到其他 <code>broker</code> 信息。</td>
</tr>
<tr>
<td><code>key.serializer</code> 和 <code>value.seralizer</code></td>
<td>指定发送消息的 <code>key</code> 和 <code>value</code> 的序列化类型。一定要写 全类名。</td>
</tr>
<tr>
<td><code>buffer.memory</code></td>
<td><code>RecordAccumulator</code> 缓冲区总大小，默认 <code>32m</code>。</td>
</tr>
<tr>
<td><code>batch.size</code></td>
<td>缓冲区一批数据最大值，默认 <code>16k</code>。适当增加该值，可 以提高吞吐量，但是如果该值设置太大，会导致数据传输延迟增加。</td>
</tr>
<tr>
<td><code>linger.ms</code></td>
<td>如果数据迟迟未达到 <code>batch.size</code>，<code>sender</code> 等待 <code>linger.ms</code> 之后就会发送数据。单位 <code>ms</code>，默认值是 <code>0ms</code>，表示没有延迟。生产环境建议该值大小为 <code>5-100ms</code> 之间。</td>
</tr>
<tr>
<td><code>acks</code></td>
<td>0：生产者发送过来的数据，不需要等数据落盘应答。<br> 1：生产者发送过来的数据，<code>Leader</code> 收到数据后应答。<br> -1（all）：生产者发送过来的数据，<code>Leader+</code>和 isr 队列 里面的所有节点收齐数据后应答。<strong>默认值是-1，-1 和 all 是等价的</strong>。</td>
</tr>
<tr>
<td><code>max.in.flight.requests.per.connection</code></td>
<td>允许最多没有返回 <code>ack</code> 的次数，默认为 <code>5</code>，开启幂等性 要保证该值是 <code>1-5</code> 的数字。</td>
</tr>
<tr>
<td><code>retries</code></td>
<td>当消息发送出现错误的时候，系统会重发消息。<code>retries</code> 表示重试次数。默认是 <code>int</code> 最大值，<code>2147483647</code>。 如果设置了重试，还想保证消息的有序性，需要设置 <code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1</code> 否则在重试此失败消息的时候，其他的消息可能发送成功了。</td>
</tr>
<tr>
<td><code>retry.backoff.ms</code></td>
<td>两次重试之间的时间间隔，默认是 <code>100ms</code>。</td>
</tr>
<tr>
<td><code>enable.idempotence</code></td>
<td>是否开启幂等性，默认 <code>true</code>，开启幂等性。</td>
</tr>
<tr>
<td><code>compression.type</code></td>
<td>生产者发送的所有数据的压缩方式。默认是 <code>none</code>，也 就是不压缩。 <br>支持压缩类型：<code>none</code>、<code>gzip</code>、<code>snappy</code>、<code>lz4</code> 和 <code>zstd</code>。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="异步发送API"><a href="#异步发送API" class="headerlink" title="异步发送API"></a>异步发送API</h4><p><strong>异步发送流程</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-008.png" class="" title="image-008">

<h5 id="普通异步发送"><a href="#普通异步发送" class="headerlink" title="普通异步发送"></a>普通异步发送</h5><p><strong>导入依赖</strong></p>
<pre class="line-numbers language-pom" data-language="pom"><code class="language-pom">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;
    &lt;version&gt;3.5.1&lt;/version&gt;
&lt;/dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>不带回调函数的API代码</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token string">"atguigu "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 再 cluster01 上开启 kafka 消费者</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


<span class="token comment"># 在IDEA中执行代码，并观察 cluster01 控制台输出</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-052.png" class="" title="image-052">

<h5 id="带回调函数的异步发送"><a href="#带回调函数的异步发送" class="headerlink" title="带回调函数的异步发送"></a>带回调函数的异步发送</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-053.png" class="" title="image-052">

<p>回调函数会在 <code>producer</code> 收到 <code>ack</code> 时调用，为<strong>异步调用</strong>，该方法有两个参数，分别是元 数据信息（<code>RecordMetadata</code>）和异常信息（<code>Exception</code>），如果 <code>Exception</code> 为 <code>null</code>，说明消息发送成功，如果 <code>Exception</code> 不为 <code>null</code>，说明消息发送失败。</p>
<p><span style="color: red;">注意：消息发送失败会自动重试，不需要我们在回调函数中手动重试。</span></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-18 0:03
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallback</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerCallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加回调</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token string">"qing callback "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// 该方法在 Producer 收到 ack 时调用，为异步调用</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span>
                                         <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 没有异常,输出信息到控制台</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"主题 [{}] -&gt; 分区 [{}]"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 出现异常打印</span>
                        exception<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 延迟一会会看到数据发往不同分区</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 再 cluster01 上开启 kafka 消费者
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


# 在IDEA中执行代码，并观察 cluster01 控制台输出
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first

#### 控制台输出如下
qing callback 0
qing callback 1
qing callback 2
qing callback 3
qing callback 4


#### 在 IDEA 控制台观察回调信息
主题 [first] -&gt; 分区 [0]
主题 [first] -&gt; 分区 [0]
主题 [first] -&gt; 分区 [1]
主题 [first] -&gt; 分区 [1]
主题 [first] -&gt; 分区 [1]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="同步发送API"><a href="#同步发送API" class="headerlink" title="同步发送API"></a>同步发送API</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-008.png" class="" title="image-008">

<p>只需在异步发送的基础上，再调用一下 <code>get()</code>方法即可。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-18 0:14
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerSync</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerSync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 异步发送 默认</span>
            <span class="token comment">// kafkaProducer.send(newProducerRecord&lt;&gt;("first","kafka" + i));</span>
            <span class="token comment">// 同步发送</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span><span class="token string">"kafka sync"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>测试</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 再 cluster01 上开启 kafka 消费者
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


# 在IDEA中执行代码，并观察 cluster01 控制台输出
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first

#### 控制台输出如下
qing sync 0
qing sync 1
qing sync 2
qing sync 3
qing sync 4
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="生产者分区"><a href="#生产者分区" class="headerlink" title="生产者分区"></a>生产者分区</h4><h5 id="分区好处"><a href="#分区好处" class="headerlink" title="分区好处"></a>分区好处</h5><ul>
<li><strong>便于合理使用存储资源</strong>，每个<code>Partition</code>在一个<code>Broker</code>上存储，可以把海量的数据按照分区切割成一 块一块数据存储在多台<code>Broker</code>上。合理控制分区的任务，可以实现<strong>负载均衡</strong>的效果。</li>
<li><strong>提高并行度</strong>，生产者可以以分区为单位<strong>发送数据</strong>；消费者可以以分区为单位进行<strong>消费数据</strong>。</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-009.png" class="" title="image-009">

<h5 id="生产者发送消息的分区策略"><a href="#生产者发送消息的分区策略" class="headerlink" title="生产者发送消息的分区策略"></a>生产者发送消息的分区策略</h5><ol>
<li><p>默认的分区器是 <code>DefaultPartitioner</code></p>
<p>生产者客户端<code>3.3.0</code>版本之后开始废弃，改动方案为: 核心思想是对<strong>粘性分区策略问题的优化方案，</strong> 这些改动方案不会影响有<code>key</code>消息的分区逻辑，只会影响非<code>key</code>消息的分区逻辑。</p>
<blockquote>
<p>详细说明文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/dreamcatcher1314/article/details/127349140">Kafka由浅入深（3）一文读懂弃用默认分区器DefaultPartitioner KIP-794</a></p>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * NOTE this partitioner is deprecated and shouldn't be used.  To use default partitioning logic
 * remove partitioner.class configuration setting.  See KIP-794 for more info.
 *
 * The default partitioning strategy:
 * &lt;ul&gt;
 * &lt;li&gt;If a partition is specified in the record, use it
 * &lt;li&gt;If no partition is specified but a key is present choose a partition based on a hash of the key
 * &lt;li&gt;If no partition or key is present choose the sticky partition that changes when the batch is full.
 * 
 * See KIP-480 for details about sticky partitioning.
 */</span>
<span class="token annotation punctuation">@Deprecated</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>全局搜索 <code>ProducerRecord</code> 类，可用在类中看到如下构造方法。（IDEA 快捷键<strong>ctrl + n</strong>）</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-010.png" class="" title="image-010"></li>
</ol>
<h6 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h6><p><strong>将数据发往指定 <code>partition</code> 的情况</strong>下，例如，将所有数据发往<strong>分区 1</strong> 中。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 18:45
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackPartitions</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerCallbackPartitions</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 指定数据发送到 0 号分区，注意保证指定的分区存在，key 为空（IDEA 中 ctrl + p 查看参数）</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span>
                            <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>
                            <span class="token string">"qing custom producer callback partitions "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span>
                                                 <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" 主题 [{}] -&gt; 分区 [{}]"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 再 cluster01 上开启 kafka 消费者
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


# 在IDEA中执行代码，并观察 cluster01 控制台输出
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first

#### 控制台输出如下
qing custom producer callback partitions 0
qing custom producer callback partitions 1
qing custom producer callback partitions 2
qing custom producer callback partitions 3
qing custom producer callback partitions 4


##### idea上输出
# 主题 [first] -&gt; 分区 [1]
# 主题 [first] -&gt; 分区 [1]
# 主题 [first] -&gt; 分区 [1]
# 主题 [first] -&gt; 分区 [1]
# 主题 [first] -&gt; 分区 [1]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h6><p>没有指明 <code>partition</code> 值但有 <code>key</code> 的情况下，将 <code>key</code> 的 <code>hash</code> 值与 <code>topic</code> 的 <code>partition</code> 数进行取余得到 <code>partition</code> 值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 19:02
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerCallbackDefaultPartitions</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerCallbackPartitions</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> value <span class="token operator">=</span> values<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// 依次指定 key 值为 a,b,f ，数据 key 的 hash 值与 3 个分区求余，分别发往 1、2、0。注意保证对应的分区存在</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span>
                            value<span class="token punctuation">,</span>
                            <span class="token string">"qing custom producer callback default partitions "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span>
                                                 <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" 主题 [{}] -&gt; 分区 [{}], value: [{}]"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>测试</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 再 cluster01 上开启 kafka 消费者
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


# 在IDEA中执行代码，并观察 cluster01 控制台输出
[robert@cluster01 kafka] bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first

#### 输出如下
qing custom producer callback default partitions 2
qing custom producer callback default partitions 5
qing custom producer callback default partitions 1
qing custom producer callback default partitions 4
qing custom producer callback default partitions 0
qing custom producer callback default partitions 3


#### idea上输出
# 主题 [first] -&gt; 分区 [0], value: [f]
# 主题 [first] -&gt; 分区 [0], value: [f]
# 主题 [first] -&gt; 分区 [1], value: [a]
# 主题 [first] -&gt; 分区 [1], value: [a]
# 主题 [first] -&gt; 分区 [2], value: [b]
# 主题 [first] -&gt; 分区 [2], value: [b]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="自定义分区器"><a href="#自定义分区器" class="headerlink" title="自定义分区器"></a>自定义分区器</h5><p>实现一个分区器实现，发送过来的数据中如果包含 <code>qing</code>，就发往 0 号分区， 不包含 <code>qing</code>，就发往 1 号分区。</p>
<ol>
<li><p>定义类实现 <code>Partitioner</code> 接口</p>
</li>
<li><p>重写 <code>pattition()</code> 方法</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Cluster</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 19:32
 * @since: JDK-
 * 1. 实现接口 Partitioner
 * 2. 实现 3 个方法：partition、close、configure
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterQingPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">FilterQingPartitioner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 返回信息对应的分区
     *
     * @param topic      主题
     * @param key        消息的 key
     * @param keyBytes   消息的 key 序列化后的字节数组
     * @param value      消息的 value
     * @param valueBytes 消息的 value 序列化后的字节数组
     * @param cluster    集群元数据可以查看分区信息
     * @return partition
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
            keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取消息</span>
        <span class="token class-name">String</span> msgValue <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 partition</span>
        <span class="token keyword">int</span> partition<span class="token punctuation">;</span>
        <span class="token comment">// 判断消息是否包含 qing</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgValue<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 返回分区号</span>
        <span class="token keyword">return</span> partition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 关闭资源</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>使用分区器的方法，在生产者的配置中添加分区器的参数</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 20:11
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerUseQingPartitions</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerCallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span>
            <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 添加自定义分区器</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>PARTITIONER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cn.qing.experiment.core.kafka.partition.FilterQingPartitioner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token string">"qing "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span>
                                         <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">" 主题 [{}] -&gt; 分区 [{}]"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 再 cluster01 上开启 kafka 消费者</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first


<span class="token comment"># 在IDEA中执行代码，并观察 cluster01 控制台输出</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first

<span class="token comment">#### 输出如下</span>
qing <span class="token number">0</span>
qing <span class="token number">1</span>
qing <span class="token number">2</span>
qing <span class="token number">3</span>
qing <span class="token number">4</span>

<span class="token comment">##### idea上输出</span>
<span class="token comment"># 主题 [first] -&gt; 分区 [0]</span>
<span class="token comment"># 主题 [first] -&gt; 分区 [0]</span>
<span class="token comment"># 主题 [first] -&gt; 分区 [0]</span>
<span class="token comment"># 主题 [first] -&gt; 分区 [0]</span>
<span class="token comment"># 主题 [first] -&gt; 分区 [0]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="生产经验——生产者如何提高吞吐量"><a href="#生产经验——生产者如何提高吞吐量" class="headerlink" title="生产经验——生产者如何提高吞吐量"></a>生产经验——生产者如何提高吞吐量</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-011.png" class="" title="image-20230819213622797">

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 21:31
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerParameters</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerParameters</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// batch.size：批次大小，默认 16K</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BATCH_SIZE_CONFIG<span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// linger.ms：等待时间，默认 0</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>LINGER_MS_CONFIG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// RecordAccumulator：缓冲区大小，默认 32M：buffer.memory</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BUFFER_MEMORY_CONFIG<span class="token punctuation">,</span><span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// compression.type：压缩，默认 none，可配置值 gzip、snappy、lz4 和 zstd</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>COMPRESSION_TYPE_CONFIG<span class="token punctuation">,</span><span class="token string">"snappy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span><span class="token string">"qing "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="生产经验——数据可靠性"><a href="#生产经验——数据可靠性" class="headerlink" title="生产经验——数据可靠性"></a>生产经验——数据可靠性</h4><h5 id="ACK应答原理"><a href="#ACK应答原理" class="headerlink" title="ACK应答原理"></a>ACK应答原理</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-008.png" class="">

<p><strong>ACK应答级别</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-012.png" class="" title="image-012">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-013.png" class="" title="image-013">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-014.png" class="" title="image-014">

<p><strong>代码去重</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-19 22:29
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerAck</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerParameters</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置 acks</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>ACKS_CONFIG<span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 重试次数 retries，默认是 int 最大值，2147483647</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>RETRIES_CONFIG<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                    <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span><span class="token string">"qing "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="生产经验——数据去重"><a href="#生产经验——数据去重" class="headerlink" title="生产经验——数据去重"></a>生产经验——数据去重</h4><h5 id="数据传递语义"><a href="#数据传递语义" class="headerlink" title="数据传递语义"></a>数据传递语义</h5><ul>
<li><strong>至少一次</strong>（<code>At Least Once</code>）= <strong>ACK 级别设置为 -1 + 分区副本大于等于 2 + ISR 里应答的最小副本数量大于等于 2</strong><ul>
<li>可用保证数据不丢失，但是不能保证数据不重复</li>
</ul>
</li>
<li><strong>最多一次</strong>（<code>At Most Once</code>）= <strong>ACK 级别设置为0</strong><ul>
<li>可用保证数据不重复，但是不能保证数据不丢失</li>
</ul>
</li>
<li><strong>精确一次</strong>（<code>Exactly Once</code>）= <strong>对于一些非常重要的信息，要求数据既不能重复也不丢失</strong></li>
</ul>
<h5 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h5><p><strong>幂等性</strong>就是指<code>Producer</code>不论向<code>Broker</code>发送多少次重复数据，<code>Broker</code>端都只会持久化一条，保证了不重复。 </p>
<p><strong>精确一次</strong>（<code>Exactly Once</code>） = <strong>幂等性 + 至少一次（ ack=-1 + 分区副本数&gt;=2 + ISR最小副本数量&gt;=2） 。</strong> </p>
<p><strong>重复数据的判断标准</strong>：具有<code>&lt;PID, Partition, SeqNumber&gt;</code>相同主键的消息提交时，<code>Broker</code>只会持久化一条。<strong>其 中<code>PID</code>是<code>Kafka</code>每次重启都会分配一个新的；<code>Partition</code> 表示分区号；<code>Sequence Number</code>是单调自增的。</strong> </p>
<p>所以幂等性<strong>只能保证的是在单分区单会话内不重复。</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-015.png" class="" title="image-015">

<blockquote>
<p> 开启参数 <code>enable.idempotence</code> 默认为 <code>true</code>，<code>false</code> 关闭。</p>
</blockquote>
<h5 id="生产者事务"><a href="#生产者事务" class="headerlink" title="生产者事务"></a>生产者事务</h5><p><strong><code>Kafka</code>事务原理</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-016.png" class="" title="image-016">

<p>Kafka的事务一共有如下5个API</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1 初始化事务</span>
<span class="token keyword">void</span> <span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2 开启事务</span>
<span class="token keyword">void</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 3 在事务内提交已经消费的偏移量（主要用于消费者）</span>
<span class="token keyword">void</span> <span class="token function">sendOffsetsToTransaction</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> offsets<span class="token punctuation">,</span> <span class="token class-name">String</span> consumerGroupId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 4 提交事务</span>
<span class="token keyword">void</span> <span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 5 放弃事务（类似于回滚事务的操作）</span>
<span class="token keyword">void</span> <span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>单个Producer，使用事务保证消息的仅一次发送</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-21 22:48
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerTransactions</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomProducerSync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置事务 id（必须），事务 id 任意起名</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>TRANSACTIONAL_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"transaction_id_0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化事务</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启事务</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token comment">// 4. 调用 send 方法,发送消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 发送消息</span>
                kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token string">"qing "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// int i = 1 / 0;</span>
            <span class="token comment">// 提交事务</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 终止事务</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 5. 关闭资源</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="生产经验——数据有序"><a href="#生产经验——数据有序" class="headerlink" title="生产经验——数据有序"></a>生产经验——数据有序</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-017.png" class="" title="image-017">

<h4 id="生产经验——数据乱序"><a href="#生产经验——数据乱序" class="headerlink" title="生产经验——数据乱序"></a>生产经验——数据乱序</h4><ol>
<li><p><code>kafka</code>在<code>1.x</code>版本之前保证数据单分区有序，条件如下</p>
<p><code>max.in.flight.requests.per.connection=1</code>（不需要考虑是否开启幂等性）。</p>
</li>
<li><p><code>kafka</code>在<code>1.x</code>及以后版本保证数据单分区有序，条件如下</p>
<ul>
<li><p>未开启幂等性，<code>max.in.flight.requests.per.connection</code>需要设置为1</p>
</li>
<li><p>开启幂等性，<code>max.in.flight.requests.per.connection</code>需要设置小于等于5</p>
<p>原因说明：因为在<code>kafka1.x</code>以后，启用幂等后，<code>kafka</code>服务端会缓存<code>producer</code>发来的最近<code>5</code>个<code>request</code>的元数据， 故无论如何，都可以保证最近<code>5</code>个<code>request</code>的数据都是有序的。</p>
</li>
</ul>
</li>
</ol>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-018.png" class="" title="image-018">

<h3 id="Kafka-Broker"><a href="#Kafka-Broker" class="headerlink" title="Kafka Broker"></a>Kafka Broker</h3><h4 id="Kafka-Broker工作流程"><a href="#Kafka-Broker工作流程" class="headerlink" title="Kafka Broker工作流程"></a>Kafka Broker工作流程</h4><h5 id="Zookeeper存储的Kafka信息"><a href="#Zookeeper存储的Kafka信息" class="headerlink" title="Zookeeper存储的Kafka信息"></a>Zookeeper存储的Kafka信息</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动 Zookeeper 客户端</span>
<span class="token punctuation">[</span>robert@cluster01 zookeeper<span class="token punctuation">]</span> bin/zkCli.sh

<span class="token comment"># 查看kafka节点信息</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> /kafka
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-019.png" class="" title="image-019">

<h5 id="Kafka-Broker总体工作流程"><a href="#Kafka-Broker总体工作流程" class="headerlink" title="Kafka Broker总体工作流程"></a>Kafka Broker总体工作流程</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-020.png" class="" title="image-020">

<p><strong>模拟 Kafka上下线，Zookeeper中数变化</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看/kafka/brokers/ids 路径上的节点</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token function">ls</span> /kafka/brokers/ids
<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span>


<span class="token comment"># 查看/kafka/controller 路径上的数据</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> get /kafka/controlle

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"brokerid"</span>:1,<span class="token string">"timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"1693498156819"</span><span class="token punctuation">}</span>


<span class="token comment"># 查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">16</span><span class="token punctuation">]</span> get /kafka/brokers/topics/first/partitions/0/state

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">{</span><span class="token string">"controller_epoch"</span>:4,<span class="token string">"leader"</span>:1,<span class="token string">"version"</span>:1,<span class="token string">"leader_epoch"</span>:0,<span class="token string">"isr"</span>:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>


<span class="token comment"># 停止 cluster03 上的 kafka</span>
<span class="token punctuation">[</span>robert@cluster03 kafka<span class="token punctuation">]</span> bin//kafka-server-stop.sh


<span class="token comment"># 再次查看/kafka/brokers/ids 路径上的节点</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token function">ls</span> /kafka/brokers/ids

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">]</span>


<span class="token comment"># 再次查看/kafka/controller 路径上的数据</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">15</span><span class="token punctuation">]</span> get /kafka/controller

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"brokerid"</span>:1,<span class="token string">"timestamp"</span><span class="token builtin class-name">:</span><span class="token string">"1693498156819"</span><span class="token punctuation">}</span>


<span class="token comment"># 再次查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">16</span><span class="token punctuation">]</span> get /kafka/brokers/topics/first/partitions/0/state

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">{</span><span class="token string">"controller_epoch"</span>:4,<span class="token string">"leader"</span>:1,<span class="token string">"version"</span>:1,<span class="token string">"leader_epoch"</span>:0,<span class="token string">"isr"</span>:<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>


<span class="token comment"># 启动 cluster03 上的 kafka</span>
<span class="token punctuation">[</span>robert@cluster03 kafka<span class="token punctuation">]</span> bin/kafka-server-start.sh -daemon ./config/server.properties


<span class="token comment"># 再次观察上述的路径参数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="Broker重要参数"><a href="#Broker重要参数" class="headerlink" title="Broker重要参数"></a>Broker重要参数</h5><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>replica.lag.time.max.ms</code></td>
<td><code>ISR</code> 中，如果 <code>Follower</code> 长时间未向 <code>Leader</code> 发送通 信请求或同步数据，则该 <code>Follower</code> 将被踢出 <code>ISR</code>。 该时间阈值，<strong>默认 30s</strong>。</td>
</tr>
<tr>
<td><code>auto.leader.rebalance.enable</code></td>
<td><strong>默认是 true</strong>。 自动 <code>Leader Partition</code> 平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.per.broker.percentage</code></td>
<td>**默认是 10%**。每个 <code>broker</code> 允许的不平衡的 <code>leader</code> 的比率。如果每个 <code>broker</code> 超过了这个值，控制器 会触发 <code>leader</code> 的平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.check.interval.seconds</code></td>
<td><strong>默认值 300 秒</strong>。检查 <code>leader</code> 负载是否平衡的间隔时 间。</td>
</tr>
<tr>
<td><code>log.segment.bytes</code></td>
<td><code>Kafka</code> 中 <code>log</code> 日志是分成一块块存储的，此配置是 指 log 日志划分 成块的大小，<strong>默认值 1G</strong>。</td>
</tr>
<tr>
<td><code>log.index.interval.bytes</code></td>
<td><strong>默认 4kb</strong>，<code>kafka</code> 里面每当写入了 <code>4kb</code> 大小的日志 （<code>.log</code>），然后就往 <code>index</code> 文件里面记录一个索引。</td>
</tr>
<tr>
<td><code>log.retention.hours</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>默认 7 天</strong>。</td>
</tr>
<tr>
<td><code>log.retention.minutes</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>分钟级别，默认关闭</strong>。</td>
</tr>
<tr>
<td><code>log.retention.ms</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>毫秒级别，默认关闭</strong>。</td>
</tr>
<tr>
<td><code>log.retention.check.interval.ms</code></td>
<td>检查数据是否保存超时的间隔，<strong>默认是 5 分钟</strong>。</td>
</tr>
<tr>
<td><code>log.retention.bytes</code></td>
<td><strong>默认等于-1，表示无穷大</strong>。超过设置的所有日志总 大小，删除最早的 <code>segment</code>。</td>
</tr>
<tr>
<td><code>log.cleanup.policy</code></td>
<td><strong>默认是 delete，表示所有数据启用删除策略</strong>； 如果设置值为 <code>compact</code>，表示所有数据启用压缩策略。</td>
</tr>
<tr>
<td><code>num.io.threads</code></td>
<td><strong>默认是 8</strong>。负责写磁盘的线程数。整个参数值要占总核数的 50%。</td>
</tr>
<tr>
<td><code>num.replica.fetchers</code></td>
<td>副本拉取线程数，这个参数占总核数的 50%的 1/3</td>
</tr>
<tr>
<td><code>num.network.threads</code></td>
<td><strong>默认是 3</strong>。数据传输线程数，这个参数占总核数的 50%的 2/3 。</td>
</tr>
<tr>
<td><code>log.flush.interval.messages</code></td>
<td>强制页缓存刷写到磁盘的条数，<strong>默认是 long 的最大值</strong>，9223372036854775807。一般不建议修改， 交给系统自己管理。</td>
</tr>
<tr>
<td><code>log.flush.interval.ms</code></td>
<td>每隔多久，刷数据到磁盘，<strong>默认是 null</strong>。一般不建 议修改，交给系统自己管理。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="生产经验——节点服役和退役"><a href="#生产经验——节点服役和退役" class="headerlink" title="生产经验——节点服役和退役"></a>生产经验——节点服役和退役</h4><h5 id="服役新节点"><a href="#服役新节点" class="headerlink" title="服役新节点"></a>服役新节点</h5><ol>
<li><p>新节点准备</p>
<ol>
<li><p>关闭cluster03，并克隆出 cluster04</p>
</li>
<li><p>开启cluster04，并修改对应的<code>IP</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改 ip 地址和 dns</span>
<span class="token punctuation">[</span>root@rocky-gpt-bak robert<span class="token punctuation">]</span>$ <span class="token function">vim</span> /etc/NetworkManager/system-connections/ens160.nmconnection


<span class="token comment"># 重新加载配置文件</span>
<span class="token punctuation">[</span>root@rocky-gpt-bak robert<span class="token punctuation">]</span>$ nmcli connection load /etc/NetworkManager/system-connections/ens160.nmconnection


<span class="token comment"># 激活配置文件</span>
<span class="token punctuation">[</span>root@rocky-gpt-bak robert<span class="token punctuation">]</span>$ nmcli connection up /etc/NetworkManager/system-connections/ens160.nmconnection<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在 cluster04 上，修改主机名称为 cluster04</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@rocky-gpt-bak robert<span class="token punctuation">]</span>$ hostnamectl set-hostname cluster04<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>重新启动 cluster03、cluster04</p>
</li>
<li><p>修改 cluster04 中 kafka 的 broker.id 为4</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> config/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>删除 cluster04 中 kafka 下的 datas 和 logs</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ <span class="token function">rm</span> -rf data/* logs/* <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>启动 cluster01、cluster02、cluster03 上的 kafka 集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ zk.sh start

<span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ kf.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>单独启动 cluster04 上的kafka</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon ./config/server.properties
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
<li><p>执行负载均衡操作 </p>
<ol>
<li><p>创建一个要负载均衡的主题</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建存放自己脚本的目录</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> qing
 
 
<span class="token comment"># 进入</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token builtin class-name">cd</span> qing
 
 
<span class="token comment"># 创建文件</span>
<span class="token punctuation">[</span>robert@cluster01 qing<span class="token punctuation">]</span>$ <span class="token function">vim</span> topics-to-move.json
<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span>
        <span class="token string">"topics"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"first"</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span>

<span class="token comment"># 移动之前先保证topic first 的存在</span>
<span class="token comment"># 创建 first topic</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span> bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">3</span> --replication-factor <span class="token number">3</span> --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>生成一个负载均衡的计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --topics-to-move-json-file qing/topics-to-move.json --broker-list <span class="token string">"1,2,3,4"</span> --generate

<span class="token comment">#### 输出如下</span>
Current partition replica assignment
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Proposed partition reassignment configuration
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">4,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建副本存储计划（所有副本存储在 <code>broker0</code>、<code>broker1</code>、<code>broker2</code>、<code>broker3</code>）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json
<span class="token comment">############## 写入以下内容  ############## ## 这里就是上一步的数据</span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,3</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ############## </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute

<span class="token comment">#### 输出如下</span>
Current partition replica assignment

<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">4,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Save this to use as the --reassignment-json-file option during rollback
Successfully started partition reassignments <span class="token keyword">for</span> first-0,first-1,first-2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>验证副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --verify

<span class="token comment">#### 输出如下</span>
Status of partition reassignment:
Reassignment of partition first-0 is complete.
Reassignment of partition first-1 is complete.
Reassignment of partition first-2 is complete.

Clearing broker-level throttles on brokers <span class="token number">1,2</span>,3,4
Clearing topic-level throttles on topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
</ol>
<h5 id="退役旧节点"><a href="#退役旧节点" class="headerlink" title="退役旧节点"></a>退役旧节点</h5><ol>
<li><p>执行负载均衡操作</p>
<p>先按照退役一台节点，<strong>生成执行计划</strong>，然后按照服役时操作流程<strong>执行负载均衡</strong>。</p>
<ol>
<li><p>创建一个要均衡的主题</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建文件</span>
<span class="token punctuation">[</span>robert@cluster01 qing<span class="token punctuation">]</span>$ <span class="token function">vim</span> topics-to-move.json
<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span>
    <span class="token string">"topics"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"first"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>,
   <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建执行计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --topics-to-move-json-file qing/topics-to-move.json --broker-list <span class="token string">"1,2,3"</span> --generate

<span class="token comment">#### 输出如下</span>
Current partition replica assignment
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,3</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Proposed partition reassignment configuration
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建副本存储计划（所有副本存储在 <code>broker0</code>、<code>broker1</code>、<code>broker2</code>、<code>broker3</code>）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json
<span class="token comment">############## 写入以下内容  ############## ## 这里就是上一步的数据</span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ############## </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute

<span class="token comment">#### 输出如下</span>
Current partition replica assignment

<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,3</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Save this to use as the --reassignment-json-file option during rollback
Successfully started partition reassignments <span class="token keyword">for</span> first-0,first-1,first-2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>验证副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --verify

<span class="token comment">#### 输出如下</span>
Status of partition reassignment:
Reassignment of partition first-0 is complete.
Reassignment of partition first-1 is complete.
Reassignment of partition first-2 is complete.
Clearing broker-level throttles on brokers <span class="token number">1,2</span>,3,4
Clearing topic-level throttles on topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>执行停止命令</p>
<p>在 <code>cluster04</code> 上执行停止命令即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h4 id="Kafka-副本"><a href="#Kafka-副本" class="headerlink" title="Kafka 副本"></a>Kafka 副本</h4><h5 id="副本基本信息"><a href="#副本基本信息" class="headerlink" title="副本基本信息"></a>副本基本信息</h5><ol>
<li><p><code>Kafka</code> 副本作用：提高数据可靠性。</p>
</li>
<li><p><code>Kafka</code> 默认副本 1 个，生产环境一般配置为 2 个，保证数据可靠性；太多副本会增加磁盘存储空间，增加网络上数据传输，降低效率。</p>
</li>
<li><p><code>Kafka</code> 中副本分为：<code>Leader</code> 和 <code>Follower</code>。<code>Kafka</code> 生产者只会把数据发往 <code>Leader</code>， 然后 <code>Follower</code> 找 <code>Leader</code> 进行同步数据。</p>
</li>
<li><p><code>Kafka</code> 分区中的所有副本统称为 <code>AR</code>（<code>Assigned Repllicas</code>）。</p>
<p><code>AR = ISR + OSR</code></p>
<p><code>ISR</code>，表示和 <code>Leader</code> 保持同步的 <code>Follower</code> 集合。如果 <code>Follower</code> 长时间未向 <code>Leader</code> 发送通信请求或同步数据，则该 <code>Follower</code> 将被踢出 <code>ISR</code>。该时间阈值由 <code>replica.lag.time.max.ms</code> 参数设定，默认 <code>30s</code>。<code>Leader</code> 发生故障之后，就会从 <code>ISR</code> 中选举新的 <code>Leader</code>。</p>
<p><code>OSR</code>，表示 <code>Follower</code> 与 <code>Leader</code> 副本同步时，延迟过多的副本。</p>
</li>
</ol>
<h5 id="Leader选举流程"><a href="#Leader选举流程" class="headerlink" title="Leader选举流程"></a>Leader选举流程</h5><p><code>Kafka</code> 集群中有一个 <code>broker</code> 的 <code>Controller</code> 会被选举为 <code>Controller Leader</code>，负责管理集群 <code>broker</code> 的上下线，所有 <code>topic</code> 的分区副本分配和 <code>Leader</code> 选举等工作。</p>
<p><code>Controller</code> 的信息同步工作是依赖于 <code>Zookeeper</code> 的。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-020.png" class="" title="image-020">

<ol>
<li><p>创建一个新的 <code>topic</code>，4个分区，4个副本</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --topic qing_selete_leader --partitions <span class="token number">4</span> --replication-factor <span class="token number">4</span>

<span class="token comment">## 输出如下</span>
Created topic qing_selete_leader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看 <code>Leader</code> 分布情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
Topic: qing_selete_leader	TopicId: fwbZUP8pSheSK7bsvccX2Q	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">4</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">4,1</span>,2,3
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,4</span>,3,1
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">3,2</span>,1,4
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,3</span>,4,2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>停止掉 <code>cluster04</code> 的 <code>kafka</code> 进程，并查看 <code>Leader</code> 分区情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh


<span class="token comment"># 查看分区情况</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">1,2</span>,3
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,3</span>,1
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">3,2</span>,1
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,3</span>,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>停止掉 <code>cluster03</code> 的 <code>kafka</code> 进程，并查看 <code>Leader</code> 分区情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster03 kafka<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh


<span class="token comment"># 查看分区情况</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">1,2</span>
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,1</span>
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">2,1</span>
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>cluster04</code> 的 <code>kafka</code> 进程，并查看 <code>Leader</code> 分区情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster04 kafka<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon config/server.properties


<span class="token comment"># 查看分区情况</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
Topic: qing_selete_leader	TopicId: fwbZUP8pSheSK7bsvccX2Q	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">4</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">1,2</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,1</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">2,1</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,2</span>,4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>cluster03</code> 的 <code>kafka</code> 进程，并查看 <code>Leader</code> 分区情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster03 kafka<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon config/server.properties


<span class="token comment"># 查看分区情况</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
Topic: qing_selete_leader	TopicId: fwbZUP8pSheSK7bsvccX2Q	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">4</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">1,2</span>,4,3
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,1</span>,4,3
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">2,1</span>,4,3
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,2</span>,4,3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>停止掉 <code>cluster03</code> 的 <code>kafka</code> 进程，并查看 <code>Leader</code> 分区情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster03 kafka<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh


<span class="token comment"># 查看分区情况</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic qing_selete_leader

<span class="token comment">#### 输出如下</span>
Topic: qing_selete_leader	TopicId: fwbZUP8pSheSK7bsvccX2Q	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">4</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: qing_selete_leader	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">4,1</span>,2,3	Isr: <span class="token number">1,2</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">1</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3,1	Isr: <span class="token number">2,1</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">3,2</span>,1,4	Isr: <span class="token number">2,1</span>,4
	Topic: qing_selete_leader	Partition: <span class="token number">3</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4,2	Isr: <span class="token number">1,2</span>,4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="Leader和Follower故障处理细节"><a href="#Leader和Follower故障处理细节" class="headerlink" title="Leader和Follower故障处理细节"></a>Leader和Follower故障处理细节</h5><p><strong><code>Follower</code>故障处理细节</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-021.png" class="" title="image-021">

<p><strong><code>Leader</code>故障处理细节</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-022.png" class="" title="image-022">

<h5 id="分区副本分配"><a href="#分区副本分配" class="headerlink" title="分区副本分配"></a>分区副本分配</h5><p>如果 <code>kafka</code> 服务器只有 4 个节点，那么设置 <code>kafka</code> 的分区数大于服务器台数，在 <code>kafka</code> 底层如何分配存储副本呢？</p>
<p>创建 16 分区，3 个副本</p>
<ol>
<li><p>创建一个新的 <code>topic</code>，名称为 <code>second</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">16</span> --replication-factor <span class="token number">3</span> --topic second
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看分区和副本情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic second

<span class="token comment">#### 输出如下</span>
Topic: second	TopicId: <span class="token number">2</span>-0LtF_dSDi2bHHxju2FjA	PartitionCount: <span class="token number">16</span>	ReplicationFactor: <span class="token number">3</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: second	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,4</span>,2	Isr: <span class="token number">1,4</span>,2
	Topic: second	Partition: <span class="token number">1</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,2</span>,3	Isr: <span class="token number">4,2</span>,3
	Topic: second	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,3</span>,1	Isr: <span class="token number">2,3</span>,1
	Topic: second	Partition: <span class="token number">3</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,1</span>,4	Isr: <span class="token number">3,1</span>,4
	Topic: second	Partition: <span class="token number">4</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,2</span>,3	Isr: <span class="token number">1,2</span>,3
	Topic: second	Partition: <span class="token number">5</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,3</span>,1	Isr: <span class="token number">4,3</span>,1
	Topic: second	Partition: <span class="token number">6</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,1</span>,4	Isr: <span class="token number">2,1</span>,4
	Topic: second	Partition: <span class="token number">7</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,4</span>,2	Isr: <span class="token number">3,4</span>,2
	Topic: second	Partition: <span class="token number">8</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,3</span>,4	Isr: <span class="token number">1,3</span>,4
	Topic: second	Partition: <span class="token number">9</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,1</span>,2	Isr: <span class="token number">4,1</span>,2
	Topic: second	Partition: <span class="token number">10</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,4</span>,3	Isr: <span class="token number">2,4</span>,3
	Topic: second	Partition: <span class="token number">11</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,2</span>,1	Isr: <span class="token number">3,2</span>,1
	Topic: second	Partition: <span class="token number">12</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,4</span>,2	Isr: <span class="token number">1,4</span>,2
	Topic: second	Partition: <span class="token number">13</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,2</span>,3	Isr: <span class="token number">4,2</span>,3
	Topic: second	Partition: <span class="token number">14</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,3</span>,1	Isr: <span class="token number">2,3</span>,1
	Topic: second	Partition: <span class="token number">15</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,1</span>,4	Isr: <span class="token number">3,1</span>,4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-023.png" class="" title="image-023"></li>
</ol>
<h5 id="生产经验——手动调整分区副本存储"><a href="#生产经验——手动调整分区副本存储" class="headerlink" title="生产经验——手动调整分区副本存储"></a>生产经验——手动调整分区副本存储</h5><p>在生产环境中，每台服务器的配置和性能不一致，但是<code>Kafka</code>只会根据自己的代码规则创建对应的分区副 本，就会导致个别服务器存储压力较大。所有需要手动调整分区副本的存储。</p>
<p>需求：<strong>创建一个新的<code>topic</code>，4 个分区，两个副本，名称为 <code>three</code>。将该 <code>topic</code> 的所有副本都存储到 <code>broker0</code> 和 <code>broker1</code> 两台服务器上。</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-024.png" class="" title="image-024">

<p>手动调整分区副本存储的步骤如下：</p>
<ol>
<li><p>创建一个新的 <code>topic</code>，名称为 <code>three</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">4</span> --replication-factor <span class="token number">2</span> --topic three<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看分区副本存储情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic three

<span class="token comment">#### 输出如下</span>
Topic: three	TopicId: ObUlrwv3S0OPWkRfLGHvZg	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">2</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: three	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,2</span>	Isr: <span class="token number">1,2</span>
	Topic: three	Partition: <span class="token number">1</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,3</span>	Isr: <span class="token number">4,3</span>
	Topic: three	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,1</span>	Isr: <span class="token number">2,1</span>
	Topic: three	Partition: <span class="token number">3</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,4</span>	Isr: <span class="token number">3,4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建副本存储计划（所有副本都指定存储在 <code>broker0</code>、<code>broker1</code> 中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json

<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,1</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:3,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,1</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>验证副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server  cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --verify<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看分区副本存储情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic three<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h5 id="生产经验——Leader-Partition负载平衡"><a href="#生产经验——Leader-Partition负载平衡" class="headerlink" title="生产经验——Leader Partition负载平衡"></a>生产经验——Leader Partition负载平衡</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-025.png" class="" title="image-20230825003353564">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>auto.leader.rebalance.enable</code></td>
<td>**默认是 <code>true</code>**。 自动 <code>Leader Partition</code> 平衡。生产环境中，<code>leader</code> 重选举的代价比较大，可能会带来性能影响，建议设置为 <code>false</code> 关闭。</td>
</tr>
<tr>
<td><code>leader.imbalance.per.broker.percentage</code></td>
<td>**默认是 <code>10%</code>**。每个 <code>broker</code> 允许的不平衡的 <code>leader</code> 的比率。如果每个 <code>broker</code> 超过了这个值，控制器会触发 leader 的平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.check.interval.seconds</code></td>
<td><strong>默认值 300 秒</strong>。检查 <code>leader</code> 负载是否平衡的间隔 时间。</td>
</tr>
</tbody></table>
<h5 id="生产经验——增加副本因子"><a href="#生产经验——增加副本因子" class="headerlink" title="生产经验——增加副本因子"></a>生产经验——增加副本因子</h5><p>在生产环境当中，由于某个主题的重要等级需要提升，我们考虑增加副本。副本数的增加需要先制定计划，然后根据计划执行。</p>
<ol>
<li><p>创建 <code>topic</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">3</span> --replication-factor <span class="token number">1</span> --topic four<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>手动增加副本存储</p>
<ol>
<li><p>创建副本存储计划（所有副本都指定存储在 <code>broker0</code>、<code>broker1</code>、<code>broker2</code> 中）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json

<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span><span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,<span class="token string">"partitions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
</ol>
<h4 id="文件存储"><a href="#文件存储" class="headerlink" title="文件存储"></a>文件存储</h4><h5 id="文件存储机制"><a href="#文件存储机制" class="headerlink" title="文件存储机制"></a>文件存储机制</h5><h6 id="Topic-数据的存储机制"><a href="#Topic-数据的存储机制" class="headerlink" title="Topic 数据的存储机制"></a>Topic 数据的存储机制</h6><p><strong><code>Kafka</code>文件存储机制</strong></p>
<p><code>Topic</code>是逻辑上的概念，而<code>partition</code>是物理上的概念，每个<code>partition</code>对应于一个<code>log</code>文件，该<code>log</code>文件中存储的就是<code>Producer</code>生产的数 据。**<code>Producer</code>生产的数据会被不断追加到该<code>log</code>文件末端<strong>，为防止<code>log</code>文件过大导致数据定位效率低下，<code>Kafka</code>采取了</strong>分片<strong>和</strong>索引<strong>机制， <strong>将每个<code>partition</code>分为多个<code>segment</code><strong>。</strong>每个<code>segment</code>包括</strong>：“<code>.index</code>”文件、“<code>.log</code>”文件和<code>.timeindex</code>等文件。这些文件位于一个文件夹下，该 文件夹的命名规则为：</strong>topic名称+分区序号**，例如：<code>first-0</code>。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-026.png" class="" title="image-026">



<p><strong><code>Topic</code>数据存储在什么位置</strong></p>
<ol>
<li><p>启动生产者，并发送消息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first
<span class="token operator">&gt;</span>hello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查看 <code>cluster01</code>（或者 <code>cluster02</code>、<code>cluster03</code>）的<code>/opt/qing/module/kafka/data/first-1</code> （<code>first-0</code>、<code>first-2</code>）路径上的文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">ls</span>

<span class="token comment">#### 输出如下</span>
00000000000000000092.index
00000000000000000092.log
00000000000000000092.snapshot
00000000000000000092.timeindex
leader-epoch-checkpoint
partition.metadata
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>直接查看 log 日志，发现是乱码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 first-1<span class="token punctuation">]</span>$ <span class="token function">cat</span> 00000000000000000092.log

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">\</span>CYnF<span class="token operator">|</span>©<span class="token operator">|</span>©ÿ"hello world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>通过工具查看 index 和 log 信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-run-class.sh kafka.tools.DumpLogSegments --files data/first-1/00000000000000000000.index

<span class="token comment">#### 输出如下</span>
Dumping ./00000000000000000000.index
offset: <span class="token number">3</span> position: <span class="token number">152</span>


<span class="token punctuation">[</span>robert@cluster01 first-1<span class="token punctuation">]</span>$ kafka-run-class.sh kafka.tools.DumpLogSegments --files ./00000000000000000000.log

<span class="token comment">#### 输出如下</span>
Dumping data/first-2/00000000000000000000.log
Starting offset: <span class="token number">0</span>
baseOffset: <span class="token number">0</span> lastOffset: <span class="token number">0</span> count: <span class="token number">1</span> baseSequence: -1 lastSequence: -1 producerId: -1 producerEpoch: -1 partitionLeaderEpoch: <span class="token number">0</span> isTransactional: <span class="token boolean">false</span> isControl: <span class="token boolean">false</span> position: <span class="token number">0</span> CreateTime: <span class="token number">1693744505301</span> size: <span class="token number">79</span> magic: <span class="token number">2</span> compresscodec: none crc: <span class="token number">373723788</span> isvalid: <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p><strong><code>index</code>文件和<code>log</code>文件详解</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-027.png" class="" title="image-027">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>log.segment.bytes</code></td>
<td><code>Kafka</code>中 <code>log</code> 日志是分成一块块存储的，此配置是指 <code>log</code> 日志划分成块的大小，**默认值 <code>1G</code>**。</td>
</tr>
<tr>
<td><code>log.index.interval.bytes</code></td>
<td>**默认 <code>4kb</code>**，<code>kafka</code> 里面每当写入了 <code>4kb</code> 大小的日志（<code>.log</code>），然后就往index文件里面记录一个索引。稀疏索引。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h5 id="文件清理策略"><a href="#文件清理策略" class="headerlink" title="文件清理策略"></a>文件清理策略</h5><p><code>Kafka</code> 中<strong>默认的日志保存时间为 7 天</strong>，可以通过调整如下参数修改保存时间</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>log.retention.hours</code></td>
<td>日志的保存时间，最低优先级，小时，<strong>默认 7 天</strong></td>
</tr>
<tr>
<td><code>log.retention.minutes</code></td>
<td>日志的保存时间，分钟</td>
</tr>
<tr>
<td><code>log.retention.ms</code></td>
<td>日志的保存时间，最高优先级，毫秒</td>
</tr>
<tr>
<td><code>log.retention.check.interval.ms</code></td>
<td>日志的保存时间，负责设置检查周期，<strong>默认 5 分钟</strong></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><code>Kafka</code> 中提供的日志清理策略有 <code>delete</code> 和 <code>compact</code> 两种。</p>
<h6 id="delete-日志删除"><a href="#delete-日志删除" class="headerlink" title="delete 日志删除"></a>delete 日志删除</h6><p>将过期数据删除</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>log.cleanup.policy = delete</code></td>
<td>所有数据启用删除策略</td>
</tr>
</tbody></table>
<ul>
<li><strong>基于时间</strong><ul>
<li><strong>默认打开</strong>。以 <code>segment</code> 中所有记录中的最大时间戳作为该文件时间戳。</li>
</ul>
</li>
<li><strong>基于大小</strong><ul>
<li><strong>默认关闭</strong>。超过设置的所有日志总大小，删除最早的<code>segment</code>。</li>
<li><code>log.retention.bytes</code>，默认等于-1，表示无穷大。</li>
</ul>
</li>
</ul>
<h6 id="compact-日志压缩"><a href="#compact-日志压缩" class="headerlink" title="compact 日志压缩"></a>compact 日志压缩</h6><p><code>compact</code>日志压缩：<strong>对于相同<code>key</code>的不同<code>value</code>值，只保留最后一个版本</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>log.cleanup.policy = compact</code></td>
<td>所有数据启用压缩策略</td>
</tr>
</tbody></table>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-028.png" class="" title="image-028">

<p>压缩后的<code>offset</code>可能是不连续的，比如上图中没有<code>6</code>，当从这些<code>offset</code>消费消息时，将会拿到比这个<code>offset</code>大 的<code>offset</code>对应的消息，实际上会拿到<code>offset</code>为<code>7</code>的消息，并从这个位置开始消费。</p>
<p><strong>这种策略只适合特殊场景，比如消息的<code>key</code>是用户<code>ID</code>，<code>value</code>是用户的资料，通过这种压缩策略，整个消息集里就保存了所有用户最新的资料。</strong></p>
<h4 id="高效读写数据"><a href="#高效读写数据" class="headerlink" title="高效读写数据"></a>高效读写数据</h4><ol>
<li><p><strong><code>Kafka</code> 本身是分布式集群，可以采用分区技术，并行度高</strong></p>
</li>
<li><p><strong>读数据采用稀疏索引，可以快速定位要消费的数据</strong></p>
</li>
<li><p><strong>顺序写磁盘</strong></p>
<p><code>Kafka</code> 的 <code>producer</code> 生产数据，要写入到 <code>log</code> 文件中，写的过程是一直追加到文件末端， 为顺序写。官网有数据表明，同样的磁盘，顺序写能到 <code>600M/s</code>，而随机写只有 <code>100K/s</code>。这 与磁盘的机械机构有关，顺序写之所以快，是因为其省去了大量磁头寻址的时间。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-029.png" class="" title="image-029">
</li>
<li><p><strong>页缓存 + 零拷贝技术</strong></p>
<ul>
<li><strong>零拷贝</strong>：<code>Kafka</code>的数据加工处理操作交由<code>Kafka</code>生产者和<code>Kafka</code>消费者处理。**<code>Kafka Broker</code> 应用层不关心存储的数据，所以就不用走应用层，传输效率高**。</li>
<li><strong><code>PageCache</code>也缓存</strong>：<code>Kafka</code>重度依赖底层操作系统提供的<code>PageCache</code>功能。当上层有写操作时，操作系统只是将数据写入<code>PageCache</code>。当读操作发生时，先从<code>PageCache</code>中查找，如果找不到，再去磁盘中读取。实际上<code>PageCache</code>是把尽可能多的空闲内存都当作了磁盘缓存来使用。</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-030.png" class="" title="image-030">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>log.flush.interval.messages</code></td>
<td>强制页缓存刷写到磁盘的条数，默认是 <code>long</code> 的最大值， 9223372036854775807。一般不建议修改，交给系统自己管 理。</td>
</tr>
<tr>
<td><code>log.flush.interval.ms</code></td>
<td>每隔多久，刷数据到磁盘，默认是 <code>null</code>。一般不建议修改， 交给系统自己管理。</td>
</tr>
</tbody></table>
</li>
</ol>
<h3 id="Kafka消费者"><a href="#Kafka消费者" class="headerlink" title="Kafka消费者"></a>Kafka消费者</h3><h4 id="Kafka消费方式"><a href="#Kafka消费方式" class="headerlink" title="Kafka消费方式"></a>Kafka消费方式</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-031.png" class="" title="image-031">

<h4 id="Kafka消费者工作流程"><a href="#Kafka消费者工作流程" class="headerlink" title="Kafka消费者工作流程"></a>Kafka消费者工作流程</h4><h5 id="消费者总体工作流程"><a href="#消费者总体工作流程" class="headerlink" title="消费者总体工作流程"></a>消费者总体工作流程</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-032.png" class="" title="image-032">

<h5 id="消费者组原理"><a href="#消费者组原理" class="headerlink" title="消费者组原理"></a>消费者组原理</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-033.png" class="" title="image-033">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-034.png" class="" title="image-034">

<p><strong>消费者组初始化流程</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-035.png" class="" title="image-035">

<p><strong>消费者组详细消费流程</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-036.png" class="" title="image-036">

<h5 id="消费者重要参数"><a href="#消费者重要参数" class="headerlink" title="消费者重要参数"></a>消费者重要参数</h5><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap.servers</code></td>
<td>向 <code>Kafka</code> 集群建立初始连接用到的 <code>host/port</code> 列表。</td>
</tr>
<tr>
<td><code>key.deserializer</code></td>
<td>指定接收消息的 <code>key</code> 的反序列化类型。<strong>一定要写全类名</strong>。</td>
</tr>
<tr>
<td><code>value.deserializer</code></td>
<td>指定接收消息的  <code>value</code> 的反序列化类型。<strong>一定要写全类名</strong>。</td>
</tr>
<tr>
<td><code>group.id</code></td>
<td>标记消费者所属的消费者组。</td>
</tr>
<tr>
<td><code>enable.auto.commit</code></td>
<td><strong>默认值为 true</strong>，消费者会自动周期性地向服务器提交偏移量。</td>
</tr>
<tr>
<td><code>auto.commit.interval.ms</code></td>
<td>如果设置了 <code>enable.auto.commit</code> 的值为 <code>true</code>， 则该值定义了 消费者偏移量向 <code>Kafka</code> 提交的频率，<strong>默认 5s</strong>。</td>
</tr>
<tr>
<td><code>auto.offset.reset</code></td>
<td>当 <code>Kafka</code> 中没有初始偏移量或当前偏移量在服务器中不存在 （如，数据被删除了），该如何处理？ <br><code>earliest</code>：自动重置偏移量到最早的偏移量。 <br><code>latest</code>：<strong>默认</strong>，自动重置偏移量为最新的偏移量。<br> <code>none</code>：如果消费组原来的（<code>previous</code>）偏移量 不存在，则向消费者抛异常。<br> <code>anything</code>：向消费者抛异常。</td>
</tr>
<tr>
<td><code>offsets.topic.num.partitions</code></td>
<td><code>__consumer_offsets</code> 的分区数，<strong>默认是 50 个分区</strong>。</td>
</tr>
<tr>
<td><code>heartbeat.interval.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间的心跳时间，<strong>默认 3s</strong>。 该条目的值必须小于 <code>session.timeout.ms</code> ，也不应该高于 <code>session.timeout.ms</code> 的 <code>1/3</code>。</td>
</tr>
<tr>
<td><code>session.timeout.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间连接超时时间，<strong>默认 45s</strong>。 超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>max.poll.interval.ms</code></td>
<td>消费者处理消息的最大时长，<strong>默认是 5 分钟</strong>。超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>fetch.min.bytes</code></td>
<td><strong>默认 1 个字节</strong>。消费者获取服务器端一批消息最小的字节 数。</td>
</tr>
<tr>
<td><code>fetch.max.wait.ms</code></td>
<td><strong>默认 500ms</strong>。如果没有从服务器端获取到一批数据的最小字节数。该时间到，仍然会返回数据。</td>
</tr>
<tr>
<td><code>fetch.max.bytes</code></td>
<td><strong>默认 Default: 52428800（50 m）</strong>。消费者获取服务器端一批消息最大的字节数。如果服务器端一批次的数据大于该值 （50m）仍然可以拉取回来这批数据，因此，这不是一个绝 对最大值。一批次的大小受 <code>message.max.bytes</code> （<code>broker  config</code>）或 <code>max.message.bytes</code> （<code>topic config</code>）影响。</td>
</tr>
<tr>
<td><code>max.poll.records</code></td>
<td>一次 <code>poll</code> 拉取数据返回消息的最大条数，<strong>默认是 500 条</strong>。</td>
</tr>
</tbody></table>
<h4 id="消费者API"><a href="#消费者API" class="headerlink" title="消费者API"></a>消费者API</h4><h5 id="独立消费者案例（订阅主题）"><a href="#独立消费者案例（订阅主题）" class="headerlink" title="独立消费者案例（订阅主题）"></a>独立消费者案例（订阅主题）</h5><p><strong>需求</strong></p>
<p>创建一个独立消费者，消费 <code>first</code> 主题中数据。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-037.png" class="" title="image-037">

<p><span style="color: red;">注意：在消费者 <code>API</code> 代码中必须配置消费者组 <code>id</code>。命令行启动消费者不填写消费者组 <code>id</code> 会被自动填写随机的消费者组 <code>id</code>。</span></p>
<p><strong>代码示例</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 19:27
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumer</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1.创建消费者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.给消费者配置对象添加参数</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 配置消费者组（组名任意起名） 必须，命令行启动消费者不填写消费者组 id 会被自动填写随机的消费者组 id。</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 创建消费者对象</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 注册要消费的主题（可以消费多个主题）</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> topics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        topics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        kafkaConsumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>topics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拉取数据打印</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置 1s 中消费一批数据</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> kafkaConsumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打印消费到的数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer topic test, result [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>写入数据并观察IDEA输出</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first
<span class="token comment">#### 输入如下</span>
<span class="token operator">&gt;</span> hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>IDEA输出</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">consumer topic test, result <span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">0</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">0</span>, offset <span class="token operator">=</span> <span class="token number">1</span>, CreateTime <span class="token operator">=</span> <span class="token number">1693745069015</span>, serialized key size <span class="token operator">=</span> -1, serialized value size <span class="token operator">=</span> <span class="token number">11</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello world<span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h5 id="独立消费者案例（订阅分区"><a href="#独立消费者案例（订阅分区" class="headerlink" title="独立消费者案例（订阅分区)"></a>独立消费者案例（订阅分区)</h5><p><strong>需求</strong></p>
<p>创建一个独立消费者，消费 <code>first</code> 主题 <code>0</code> 号分区的数据。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-038.png" class="" title="image-038">

<p><strong>code</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">TopicPartition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 20:16
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerPartition</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerPartition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092 "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 配置消费者组（必须），名字可以任意起</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 消费某个主题的某个分区数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> topicPartitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        topicPartitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        kafkaConsumer<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>topicPartitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> kafkaConsumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span>
                    consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer topic test, partition 0, result [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行之前的生产者程序 <code>CustomProducerCallback()</code> ，观察输出</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">主题 <span class="token punctuation">[</span>first<span class="token punctuation">]</span> -<span class="token operator">&gt;</span> 分区 <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>IDEA <code>CustomConsumerPartition</code> 输出</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">consumer topic test, partition <span class="token number">0</span>, result <span class="token punctuation">[</span>ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">1</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">0</span>, offset <span class="token operator">=</span> <span class="token number">2</span>, CreateTime <span class="token operator">=</span> <span class="token number">1693745338096</span>, serialized key size <span class="token operator">=</span> -1, serialized value size <span class="token operator">=</span> <span class="token number">15</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> qing callback <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="消费者组案例"><a href="#消费者组案例" class="headerlink" title="消费者组案例"></a>消费者组案例</h5><p><strong>需求</strong></p>
<p>测试同一个主题的分区数据，只能由一个消费者组中的一个消费。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-039.png" class="" title="image-039">

<p>负责消费者 <code>CustomConsumer()</code> 为 <code>CustomConsumerOne()</code> 同时启动两个类, 即可启动同一个消费者组中 的两个消费者。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerOne</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>启动代码中的生产者发送消息，在 IDEA 控制台即可看到两个消费者在消费不同分区的数据（如果只发生到一个分区，可以在发送时增加延迟代码 <code>Thread.sleep(2);</code>）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">0</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">2</span>, 
offset <span class="token operator">=</span> <span class="token number">3</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169606820</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">8</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello1<span class="token punctuation">)</span>

ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">1</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">3</span>, 
offset <span class="token operator">=</span> <span class="token number">2</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169609524</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">6</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello2<span class="token punctuation">)</span>

ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">2</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">3</span>, 
offset <span class="token operator">=</span> <span class="token number">21</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169611884</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">6</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重新发送到一个全新的主题中，由于默认创建的主题分区数为 1，可以看到只能有一个消费者消费到数据。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">0</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">0</span>, 
offset <span class="token operator">=</span> <span class="token number">3</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169606820</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">8</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello1<span class="token punctuation">)</span>

ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">0</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">0</span>, 
offset <span class="token operator">=</span> <span class="token number">2</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169609524</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">6</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello2<span class="token punctuation">)</span>

ConsumerRecord<span class="token punctuation">(</span>topic <span class="token operator">=</span> first, partition <span class="token operator">=</span> <span class="token number">0</span>, leaderEpoch <span class="token operator">=</span> <span class="token number">0</span>, 
offset <span class="token operator">=</span> <span class="token number">21</span>, CreateTime <span class="token operator">=</span> <span class="token number">1629169611884</span>, serialized key size <span class="token operator">=</span> -1, 
serialized value size <span class="token operator">=</span> <span class="token number">6</span>, headers <span class="token operator">=</span> RecordHeaders<span class="token punctuation">(</span>headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, 
isReadOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>, key <span class="token operator">=</span> null, value <span class="token operator">=</span> hello3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="生产经验——分区的分配以及再平衡"><a href="#生产经验——分区的分配以及再平衡" class="headerlink" title="生产经验——分区的分配以及再平衡"></a>生产经验——分区的分配以及再平衡</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-040.png" class="" title="image-040">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>heartbeat.interval.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间的心跳时间，<strong>默认 3s</strong>。 该条目的值必须小于 <code>session.timeout.ms</code>，也不应该高于 <code>session.timeout.ms</code> 的 1/3。</td>
</tr>
<tr>
<td><code>session.timeout.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间连接超时时间，<strong>默认 45s</strong>。超 过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>max.poll.interval.ms</code></td>
<td>消费者处理消息的最大时长，<strong>默认是 5 分钟</strong>。超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>partition.assignment.strategy</code></td>
<td>消 费 者 分 区 分 配 策 略 ， 默 认 策 略 是 <code>Range + CooperativeSticky</code>。<code>Kafka</code> 可以同时使用多个分区分配策略。 可 以 选 择 的 策 略 包 括 ： <code>Range</code> 、 <code>RoundRobin</code> 、 <code>Sticky</code> 、 <code>CooperativeSticky</code>。**默认策略是<code>Range + CooperativeSticky</code>**。</td>
</tr>
</tbody></table>
<h5 id="Range以及再平衡"><a href="#Range以及再平衡" class="headerlink" title="Range以及再平衡"></a>Range以及再平衡</h5><p><strong>原理</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-041.png" class="" title="image-041">

<p><strong><code>Range</code>分区分配策略案例</strong></p>
<ol>
<li><p>修改主题 <code>first</code> 为 7 个分区</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --alter --topic first --partitions <span class="token number">7</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


</li>
<li><p>复制 <code>CustomConsumer</code> 类，创建 <code>CustomConsumerSecond</code>。这样可以由三个消费者 <code>CustomConsumer</code>、<code>CustomConsumerOne</code>、<code>CustomConsumerSecond</code> 组成消费者组，组名都为“<code>test</code>”， 同时启动 3 个消费者。</p>
</li>
<li><p>启动 <code>CustomProducer</code> 生产者，发送 500 条消息，随机发送到不同的分区。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-17 23:54
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建 kafka 生产者的配置对象</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 给 kafka 配置对象添加配置信息：bootstrap.servers</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// key,value 序列化（必须）：key.serializer，value.serializer</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 创建 kafka 生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 调用 send 方法,发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            kafkaProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"qing "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5. 关闭资源</span>
        kafkaProducer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><span style="color: red;">说明：Kafka 默认的分区分配策略就是 Range + CooperativeSticky，所以不需要修改策 略。</span></p>
</li>
<li><p>观看 3 个消费者分别消费哪些分区的数据。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-054.png" class="" title="image-054">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-055.png" class="" title="image-055">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-056.png" class="" title="image-056"></li>
</ol>
<p><strong><code>Range</code> 分区分配再平衡案例</strong></p>
<ol>
<li><p>停止掉 0 号消费者，快速重新发送消息观看结果（45s 以内，越快越好）。</p>
<p>1 号消费者：消费到 3、4 号分区数据。</p>
<p>2 号消费者：消费到 5、6 号分区数据。</p>
<p>0 号消费者的任务会整体被分配到 1 号消费者或者 2 号消费者。</p>
<p><span style="color: red;">说明：0 号消费者挂掉后，消费者组需要按照超时时间 45s 来判断它是否退出，所以需要等待，时间到了 45s 后，判断它真的退出就会把任务分配给其他 broker 执行。</span></p>
</li>
<li><p>再次重新发送消息观看结果（45s 以后）。</p>
<p>1 号消费者：消费到 0、1、2、3 号分区数据。</p>
<p>2 号消费者：消费到 4、5、6 号分区数据。</p>
<p><span style="color: red;">说明：消费者 0 已经被踢出消费者组，所以重新按照 range 方式分配。</span></p>
</li>
</ol>
<h5 id="RoundRobin以及再平衡"><a href="#RoundRobin以及再平衡" class="headerlink" title="RoundRobin以及再平衡"></a>RoundRobin以及再平衡</h5><p><strong>原理</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-042.png" class="" title="image-042">

<p><strong><code>RoundRobin</code> 分区分配策略案例</strong></p>
<ol>
<li><p>依次在 <code>CustomConsumer</code>、<code>CustomConsumerOne</code>、<code>CustomConsumerSecond</code> 三个消费者代 码中修改分区分配策略为 <code>RoundRobin</code>。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 修改分区分配策略</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>PARTITION_ASSIGNMENT_STRATEGY_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.clients.consumer.RoundRobinAssignor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-057.png" class="" title="image-057">
</li>
<li><p>重启 3 个消费者，重复发送消息的步骤，观看分区结果。</p>
<p>…图片</p>
</li>
</ol>
<p><strong><code>RoundRobin</code> 分区分配再平衡案例</strong></p>
<ol>
<li><p>停止掉 0 号消费者，快速重新发送消息观看结果（45s 以内，越快越好）。</p>
<p>1 号消费者：消费到 2、5 号分区数据</p>
<p>2 号消费者：消费到 4、1 号分区数据</p>
<p>0 号消费者的任务会<span style="color: red;">按照 <code>RoundRobin</code> 的方式，把数据轮询分成 0 、6 和 3 号分区数据， 分别由</span> 1 号消费者或者 2 号消费者消费。</p>
<p><span style="color: red;">说明：0 号消费者挂掉后，消费者组需要按照超时时间 45s 来判断它是否退出，所以需要等待，时间到了 45s 后，判断它真的退出就会把任务分配给其他 <code>broker</code> 执行。</span></p>
</li>
<li><p>再次重新发送消息观看结果（45s 以后）。</p>
<p>1 号消费者：消费到 0、2、4、6 号分区数据</p>
<p>2 号消费者：消费到 1、3、5 号分区数据</p>
<p><span style="color: red;">说明：消费者 0 已经被踢出消费者组，所以重新按照 <code>RoundRobin</code> 方式分配。</span></p>
</li>
</ol>
<h5 id="Sticky以及再平衡"><a href="#Sticky以及再平衡" class="headerlink" title="Sticky以及再平衡"></a>Sticky以及再平衡</h5><p><strong>粘性分区定义</strong>：可以理解为分配的结果带有“粘性的”。即在执行一次新的分配之前， 考虑上一次分配的结果，尽量少的调整分配的变动，可以节省大量的开销。</p>
<p> 粘性分区是 <code>Kafka</code> 从 <code>0.11.x</code> 版本开始引入这种分配策略，<strong>首先会尽量均衡的放置分区到消费者上面</strong>，在出现同一消费者组内消费者出现问题的时候，会<strong>尽量保持原有分配的分 区不变化</strong>。</p>
<p><strong><code>Sticky</code>分区分配策略案例</strong></p>
<ol>
<li><p>设置主题为 <code>first</code>，7 个分区；准备 3 个消费者，采用粘性分区策略，并进行消费，观察消费分配情况。然后再停止其中一个消费者，再次观察消费分配情况。</p>
<p>注意：3 个消费者都应该注释掉，之后重启 3 个消费者，如果出现报错，全部停止等会再重启，或者修改为全新的消费者组。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 修改分区分配策略</span>
<span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> startegys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
startegys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"org.apache.kafka.clients.consumer.StickyAssignor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>PARTITION_ASSIGNMENT_STRATEGY_CONFIG<span class="token punctuation">,</span> startegys<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用同样的生产者发送 500 条消息。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-058.png" class="" title="image-058"></li>
</ol>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-059.png" class="" title="image-059">

<p><strong><code>Sticky</code> 分区分配再平衡案例</strong></p>
<ol>
<li><p>停止掉 0 号消费者，快速重新发送消息观看结果（45s 以内，越快越好）。</p>
<p>1 号消费者：消费到 2、5、3 号分区数据。</p>
<p>2 号消费者：消费到 4、6 号分区数据。</p>
<p>0 号消费者的任务会<span style="color: red;">按照粘性规则，尽可能均衡的随机分成 0 和 1 号分区数据，分别</span>由 1 号消费者或者 2 号消费者消费。</p>
<p><span style="color: red;">说明：0 号消费者挂掉后，消费者组需要按照超时时间 45s 来判断它是否退出，所以需 要等待，时间到了 45s 后，判断它真的退出就会把任务分配给其他 broker 执行。</span></p>
</li>
<li><p>再次重新发送消息观看结果（45s 以后）。</p>
<p>1 号消费者：消费到 2、3、5 号分区数据。</p>
<p>2 号消费者：消费到 0、1、4、6 号分区数据。</p>
<p><span style="color: red;">说明：消费者 0 已经被踢出消费者组，所以重新按照粘性方式分配。</span></p>
</li>
</ol>
<h4 id="offset位移"><a href="#offset位移" class="headerlink" title="offset位移"></a>offset位移</h4><h5 id="offset的默认维护位置"><a href="#offset的默认维护位置" class="headerlink" title="offset的默认维护位置"></a>offset的默认维护位置</h5><img src="/2023/09/16/cs-data/data-kafka3-learn/image-043.png" class="" title="image-043">

<p><code>__consumer_offsets</code> 主题里面采用 <code>key</code> 和 <code>value</code> 的方式存储数据。<code>key</code> 是 <code>group.id+topic+ 分区号</code>，<code>value</code> 就是当前 <code>offset</code> 的值。每隔一段时间，<code>kafka</code> 内部会对这个 <code>topic</code> 进行 <code>compact</code>，也就是每个 <code>group.id+topic+分区号</code>就保留最新数据。</p>
<p><strong>消费 <code>offset</code> 案例</strong></p>
<ol>
<li><p>思想：<code>__consumer_offsets</code> 为 <code>Kafka</code> 中的 <code>topic</code>，那就可以通过消费者进行消费。</p>
</li>
<li><p>在配置文件 <code>config/consumer.properties</code> 中添加配置 <code>exclude.internal.topics=false</code>， **默认是 <code>true</code>**，表示不能消费系统主题。为了查看该系统主题数据，所以该参数修改为 <code>false</code>。</p>
</li>
<li><p>采用命令行方式，创建一个新的 <code>topic</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --topic qing --partitions <span class="token number">2</span> --replication-factor <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>启动生产者往 <code>qing</code> 生产数据。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --topic qing --bootstrap-server cluster01:9092
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>启动消费者消费 <code>qing</code> 数据。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic qing --group <span class="token builtin class-name">test</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意：指定消费者组名称，更好观察数据存储位置（<code>key</code> 是 <code>group.id+topic+分区号</code>）</p>
</li>
<li><p>查看消费者消费主题<code>__consumer_offsets</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-consumer.sh --topic __consumer_offsets --bootstrap-server cluster01:9092 --consumer.config config/consumer.properties --formatter <span class="token string">"kafka.coordinator.group.GroupMetadataManager\<span class="token variable">$OffsetsMessageFormatter</span>"</span> --from-beginning

<span class="token comment">#### 输出如下</span>
<span class="token punctuation">[</span>test,qing,1<span class="token punctuation">]</span>::OffsetAndMetadata<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">leaderEpoch</span><span class="token operator">=</span>Optional.empty, <span class="token assign-left variable">metadata</span><span class="token operator">=</span>, <span class="token assign-left variable">commitTimestamp</span><span class="token operator">=</span><span class="token number">1693747947866</span>, <span class="token assign-left variable">expireTimestamp</span><span class="token operator">=</span>None<span class="token punctuation">)</span>
<span class="token punctuation">[</span>test,qing,0<span class="token punctuation">]</span>::OffsetAndMetadata<span class="token punctuation">(</span>offset<span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">leaderEpoch</span><span class="token operator">=</span>Optional.empty, <span class="token assign-left variable">metadata</span><span class="token operator">=</span>, <span class="token assign-left variable">commitTimestamp</span><span class="token operator">=</span><span class="token number">1693747947866</span>, <span class="token assign-left variable">expireTimestamp</span><span class="token operator">=</span>None<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="自动提交offset"><a href="#自动提交offset" class="headerlink" title="自动提交offset"></a>自动提交offset</h5><p>为了使我们能够专注于自己的业务逻辑，<code>Kafka</code>提供了自动提交<code>offset</code>的功能。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-044.png" class="" title="image-044">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>enable.auto.commit</code></td>
<td>**默认值为 <code>true</code>**，消费者会自动周期性地向服务器提交偏移量。</td>
</tr>
<tr>
<td><code>auto.commit.interval.ms</code></td>
<td>如果设置了 <code>enable.auto.commit</code> 的值为 <code>true</code>， 则该值定义了消 费者偏移量向 <code>Kafka</code> 提交的频率，<strong>默认 5s</strong>。</td>
</tr>
</tbody></table>
<p><strong>自动提交Offset</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 22:29
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerAutoOffset</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerAutoOffset</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 消费者配置类</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 添加配置参数</span>

        <span class="token comment">// 添加连接</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置消费者组</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 是否自动提交 offset</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>ENABLE_AUTO_COMMIT_CONFIG<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 提交 offset 的时间周期 1000ms，默认 5s</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>AUTO_COMMIT_INTERVAL_MS_CONFIG<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 创建 kafka 消费者</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 设置消费主题 形参是列表</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 消费数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取消息</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 输出消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"auto offset, [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="手动提交offset"><a href="#手动提交offset" class="headerlink" title="手动提交offset"></a>手动提交offset</h5><p>虽然自动提交<code>offset</code>十分简单便利，但由于其是基于时间提交的，开发人员难以把握<code>offset</code>提交的时机。因 此<code>Kafka</code>还提供了手动提交<code>offset</code>的<code>API</code>。</p>
<p>手动提交<code>offset</code>的方法有两种：分别是<code>commitSync</code>（<strong>同步提交</strong>）和<code>commitAsync</code>（<strong>异步提交</strong>）。两者的相同点是，<strong>都会将本次提交的一批数据最高的偏移量提交</strong>；不同点是，<strong>同步提交阻塞当前线程</strong>，一直到提交成功，并且会自动失败重试（由不可控因素导致，也会出现提交失败）；而<strong>异步提交则没有失败重试机制</strong>，故有可能提交失败。</p>
<ul>
<li><code>commitSync</code>（同步提交）：必须等待<code>offset</code>提交完毕，再去消费下一批数据。</li>
<li><code>commitAsync</code>（异步提交） ：发送完提交<code>offset</code>请求后，就开始消费下一批数据了。</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-045.png" class="" title="image-045">

<p><strong>同步提交 offset</strong></p>
<p>由于同步提交 <code>offset</code> 有失败重试机制，故更加可靠，但是由于一直等待提交结果，提交的效率比较低。以下为同步提交 <code>offset</code> 的示例。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 22:42
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerByHandSync</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerByHandSync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 消费者配置类</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 添加配置参数</span>

        <span class="token comment">// 添加连接</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置消费者组</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 是否自动提交 offset</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>ENABLE_AUTO_COMMIT_CONFIG<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 提交 offset 的时间周期 1000ms，默认 5s</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>AUTO_COMMIT_INTERVAL_MS_CONFIG<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 创建 kafka 消费者</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 设置消费主题 形参是列表</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 消费数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取消息</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 输出消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"hand sync offset, [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 同步提交 offset</span>
            consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>异步提交 offset</strong></p>
<p>虽然同步提交 <code>offset</code> 更可靠一些，但是由于其会阻塞当前线程，直到提交成功。因此吞吐量会受到很大的影响。因此更多的情况下，会选用异步提交 <code>offset</code> 的方式。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 22:46
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerByHandAsync</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerByHandAsync</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 创建 kafka 消费者配置类</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 添加配置参数</span>

        <span class="token comment">// 添加连接</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置消费者组</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 是否自动提交 offset</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>ENABLE_AUTO_COMMIT_CONFIG<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 提交 offset 的时间周期 1000ms，默认 5s</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>AUTO_COMMIT_INTERVAL_MS_CONFIG<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 创建 kafka 消费者</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 设置消费主题 形参是列表</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 消费数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取消息</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 输出消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"hand async offset, [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 异步提交 offset</span>
            consumer<span class="token punctuation">.</span><span class="token function">commitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="指定Offset消费"><a href="#指定Offset消费" class="headerlink" title="指定Offset消费"></a>指定Offset消费</h5><p><code>auto.offset.reset = earliest | latest | none</code> 默认是 <code>latest</code>。</p>
<p>当 Kafka 中没有初始偏移量（消费者组第一次消费）或服务器上不再存在当前偏移量 时（例如该数据已被删除）</p>
<ul>
<li><code>earliest</code>：自动将偏移量重置为最早的偏移量，<code>--from-beginning</code>。</li>
<li><code>latest</code>（默认值）：自动将偏移量重置为最新偏移量。</li>
<li><code>none</code>：如果未找到消费者组的先前偏移量，则向消费者抛出异常。</li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-046.png" class="" title="image-046">

<p>任意指定 <code>offset</code> 位移开始消费。注意：每次执行完，需要修改消费者组名。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">TopicPartition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 22:56
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerSeek</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerSeek</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建 kafka 消费者配置类</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加配置参数</span>

        <span class="token comment">// 添加连接</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置消费者组</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 创建 kafka 消费者</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 设置消费主题 形参是列表</span>
        <span class="token comment">// 注意：每次执行完，需要修改消费者组名；</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> assignment<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>assignment<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取消费者分区分配信息（有了分区分配信息才能开始消费）</span>
            assignment <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">assignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 遍历所有分区，并指定 offset 从 1700 的位置开始消费</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token operator">:</span> assignment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            consumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> <span class="token number">1700</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 消费数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取消息</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 输出消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"hand seek offset, [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h5 id="指定时间消费"><a href="#指定时间消费" class="headerlink" title="指定时间消费"></a>指定时间消费</h5><p>在生产环境中，会遇到最近消费的几个小时数据异常，想重新按照时间消费。 例如要求按照时间消费前一天的数据。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>consumer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">TopicPartition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringDeserializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-08-28 23:00
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomConsumerForTime</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CustomConsumerForTime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建 kafka 消费者配置类</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加配置参数</span>

        <span class="token comment">// 添加连接</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置序列化 必须</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>KEY_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>VALUE_DESERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置消费者组</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span>GROUP_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">"test2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 创建 kafka 消费者</span>
        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置消费主题 形参是列表</span>
        <span class="token comment">// 注意：每次执行完，需要修改消费者组名；</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"qing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> assignment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>assignment<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取消费者分区分配信息（有了分区分配信息才能开始消费）</span>
            assignment <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">assignment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timestampToSearch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 封装集合存储，每个分区对应一天前的数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> topicPartition <span class="token operator">:</span> assignment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timestampToSearch<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取从 1 天前开始消费的每个分区的 offset</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndTimestamp</span><span class="token punctuation">&gt;</span></span> offsets <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">offsetsForTimes</span><span class="token punctuation">(</span>timestampToSearch<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历每个分区，对每个分区设置消费时间。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> topicPartition <span class="token operator">:</span> assignment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">OffsetAndTimestamp</span> offsetAndTimestamp <span class="token operator">=</span> offsets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据时间指定开始消费的位置</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offsetAndTimestamp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                consumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> offsetAndTimestamp<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 消费数据</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读取消息</span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecords <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 输出消息</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"hand time offset, [{}]"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="漏消费和重复消费"><a href="#漏消费和重复消费" class="headerlink" title="漏消费和重复消费"></a>漏消费和重复消费</h5><ul>
<li><p><strong>重复消费</strong>：已经消费了数据，但是 <code>offset</code> 没提交。</p>
<p>自动提交offset引起。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-047.png" class="" title="image-047">
</li>
<li><p><strong>漏消费</strong>：先提交 <code>offset</code> 后消费，有可能会造成数据的漏消费。</p>
<p>。设置<code>offset</code>为手动提交，当<code>offset</code>被提交时，数据还在内存中未落盘，此时刚好消费者线程被<code>kill</code>掉，那么<code>offset</code>已经提交，但是数据未处理，导致这部分内存中的数据丢失。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-048.png" class="" title="image-048"></li>
</ul>
<p>如何既不漏消费也不重复消费呢？详看消费者事务</p>
<h4 id="生产经验——消费者事务"><a href="#生产经验——消费者事务" class="headerlink" title="生产经验——消费者事务"></a>生产经验——消费者事务</h4><p>如果想完成<code>Consumer</code>端的精准一次性消费，那么需要<code>Kafka</code>消费端将消费过程和提交<code>offset</code> 过程做原子绑定。此时我们需要将<code>Kafka</code>的<code>offset</code>保存到支持事务的自定义介质（比如<code>MySQL</code>）。这部分知识见上面<strong>生产者–数据去重–生产者事务</strong>部分。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-049.png" class="" title="image-049">

<h4 id="生产经验——数据积压（消费者如何提高吞吐量）"><a href="#生产经验——数据积压（消费者如何提高吞吐量）" class="headerlink" title="生产经验——数据积压（消费者如何提高吞吐量）"></a>生产经验——数据积压（消费者如何提高吞吐量）</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-050.png" class="" title="image-050">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>fetch.max.bytes</code></td>
<td><strong>默认 Default: 52428800（50 m）</strong>。消费者获取服务器端一批 消息最大的字节数。如果服务器端一批次的数据大于该值 （50m）仍然可以拉取回来这批数据，因此，这不是一个绝对最大值。一批次的大小受 <code>message.max.bytes</code> （broker  config）或 <code>max.message.bytes</code> （topic config）影响。</td>
</tr>
<tr>
<td><code>max.poll.records</code></td>
<td>一次 poll 拉取数据返回消息的最大条数，<strong>默认是 500 条</strong>。</td>
</tr>
</tbody></table>
<h3 id="Kafka-Eagle监控"><a href="#Kafka-Eagle监控" class="headerlink" title="Kafka-Eagle监控"></a>Kafka-Eagle监控</h3><p><code>Kafka-Eagle</code> 框架可以监控 <code>Kafka</code> 集群的整体运行情况，在生产环境中经常使用。</p>
<h4 id="MySQL环境准备"><a href="#MySQL环境准备" class="headerlink" title="MySQL环境准备"></a>MySQL环境准备</h4><p><code>Kafka-Eagle</code> 的安装依赖于 <code>MySQL</code>，<code>MySQL</code> 主要用来存储可视化展示的数据。如果集群中之前安装过 <code>MySQL</code> 可以跨过该步。</p>
<p><a href="https://robertsunq.github.io/2023/04/13/cs-data/linux-install-mysql/">同站文件-基于Linux系统安装Mysql</a></p>
<h4 id="Kafka环境准备"><a href="#Kafka环境准备" class="headerlink" title="Kafka环境准备"></a>Kafka环境准备</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 关闭kafka集群</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ kafka.sh stop


<span class="token comment"># 修改/opt/qing/module/kafka/bin/kafka-server-start.sh 命令中</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> bin/kafka-server-start.sh
<span class="token comment">#################### 修改如下参数 ####################</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$KAFKA_HEAP_OPTS</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">"-Xmx1G -Xms1G"</span>
<span class="token keyword">fi</span>
<span class="token comment">#################### 为 ####################</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$KAFKA_HEAP_OPTS</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token comment"># export KAFKA_HEAP_OPTS="-Xmx1G -Xms1G"    </span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">"-server -Xms2G -Xmx2G -XX:PermSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=5 -XX:InitiatingHeapOccupancyPercent=70"</span>
    <span class="token builtin class-name">export</span> <span class="token assign-left variable">JMX_PORT</span><span class="token operator">=</span><span class="token string">"9999"</span>
<span class="token keyword">fi</span>
<span class="token comment">#################### ####################</span>
<span class="token comment">## 修改之后在启动 Kafka 之前要分发之其他节点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Kafka-Eagle安装"><a href="#Kafka-Eagle安装" class="headerlink" title="Kafka-Eagle安装"></a>Kafka-Eagle安装</h4><ol>
<li><p>官网：<a target="_blank" rel="noopener" href="https://www.kafka-eagle.org/">EFAK (kafka-eagle.org)</a></p>
</li>
<li><p>下载安装包，并上传压缩包 <code>kafka-eagle-bin-3.0.1.tar.gz</code> 到集群<code>/opt/qing/tmp</code> 目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ <span class="token function">scp</span> kafka-eagle-bin-3.0.1.tar.gz /opt/qing/tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>解压到本地</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 tmp<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxvf eagle-bin-3.0.1.tar.gz -C /opt/qing/tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


</li>
<li><p>进入刚才解压的目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka-eagle-bin-3.0.1<span class="token punctuation">]</span>$ ll

<span class="token comment">#### 输出如下</span>
总用量 <span class="token number">87840</span>
-rw-r--r--. <span class="token number">1</span> robert robert <span class="token number">89947836</span>  <span class="token number">9</span>月  <span class="token number">6</span>  <span class="token number">2022</span> efak-web-3.0.1-bin.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>将 <code>efak-web-3.0.1-bin.tar.gz</code> 解压至<code>/opt/module/qing</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka-eagle-bin-3.0.1<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxvf efak-web-3.0.1-bin.tar.gz -C /opt/qing/module/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>修改名称</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">mv</span> efak-web-3.0.1/ efak<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>修改配置文件 <code>/opt/qing/module/efak/conf/system-config.properties</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 conf<span class="token punctuation">]</span>$ <span class="token function">vim</span> system-config.properties<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改后如下，注意主要需要修改的部分</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token comment">######################################</span>
<span class="token comment"># multi zookeeper &amp; kafka cluster list</span>
<span class="token comment"># Settings prefixed with 'kafka.eagle.' will be deprecated, use 'efak.' instead</span>
<span class="token comment">######################################   # 注意，修改为对应的kafka节点信息</span>
<span class="token attr-name">efak.zk.cluster.alias</span><span class="token punctuation">=</span><span class="token attr-value">cluster1</span>
<span class="token attr-name">cluster1.zk.list</span><span class="token punctuation">=</span><span class="token attr-value">cluster01:2181,cluster02:2181,cluster03:2181/kafka</span>
<span class="token comment">######################################</span>
<span class="token comment"># zookeeper enable acl</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster1.zk.acl.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster1.zk.acl.schema</span><span class="token punctuation">=</span><span class="token attr-value">digest</span>
<span class="token attr-name">cluster1.zk.acl.username</span><span class="token punctuation">=</span><span class="token attr-value">test</span>
<span class="token attr-name">cluster1.zk.acl.password</span><span class="token punctuation">=</span><span class="token attr-value">test123</span>
<span class="token comment">######################################</span>
<span class="token comment"># broker size online list</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster1.efak.broker.size</span><span class="token punctuation">=</span><span class="token attr-value">20</span>
<span class="token comment">######################################</span>
<span class="token comment"># zk client thread limit</span>
<span class="token comment">######################################</span>
<span class="token attr-name">kafka.zk.limit.size</span><span class="token punctuation">=</span><span class="token attr-value">32</span>
<span class="token comment">######################################</span>
<span class="token comment"># EFAK webui port</span>
<span class="token comment">######################################</span>
<span class="token attr-name">efak.webui.port</span><span class="token punctuation">=</span><span class="token attr-value">8048</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka jmx acl and ssl authenticate</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster1.efak.jmx.acl</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster1.efak.jmx.user</span><span class="token punctuation">=</span><span class="token attr-value">keadmin</span>
<span class="token attr-name">cluster1.efak.jmx.password</span><span class="token punctuation">=</span><span class="token attr-value">keadmin123</span>
<span class="token attr-name">cluster1.efak.jmx.ssl</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster1.efak.jmx.truststore.location</span><span class="token punctuation">=</span><span class="token attr-value">/data/ssl/certificates/kafka.truststore</span>
<span class="token attr-name">cluster1.efak.jmx.truststore.password</span><span class="token punctuation">=</span><span class="token attr-value">ke123456</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka offset storage</span>
<span class="token comment">######################################    # 修改offset的保存位置</span>
<span class="token comment"># offset 保存在 kafka</span>
<span class="token attr-name">cluster1.efak.offset.storage</span><span class="token punctuation">=</span><span class="token attr-value">kafka</span>

<span class="token comment">######################################</span>
<span class="token comment"># kafka jmx uri</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster1.efak.jmx.uri</span><span class="token punctuation">=</span><span class="token attr-value">service:jmx:rmi:///jndi/rmi://%s/jmxrmi</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka metrics, 15 days by default</span>
<span class="token comment">######################################</span>
<span class="token attr-name">efak.metrics.charts</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token attr-name">efak.metrics.retain</span><span class="token punctuation">=</span><span class="token attr-value">15</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka sql topic records max</span>
<span class="token comment">######################################</span>
<span class="token attr-name">efak.sql.topic.records.max</span><span class="token punctuation">=</span><span class="token attr-value">5000</span>
<span class="token attr-name">efak.sql.topic.preview.records.max</span><span class="token punctuation">=</span><span class="token attr-value">10</span>
<span class="token comment">######################################</span>
<span class="token comment"># delete kafka topic token</span>
<span class="token comment">######################################</span>
<span class="token attr-name">efak.topic.token</span><span class="token punctuation">=</span><span class="token attr-value">keadmin</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka sasl authenticate</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster1.efak.sasl.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster1.efak.sasl.protocol</span><span class="token punctuation">=</span><span class="token attr-value">SASL_PLAINTEXT</span>
<span class="token attr-name">cluster1.efak.sasl.mechanism</span><span class="token punctuation">=</span><span class="token attr-value">SCRAM-SHA-256</span>
<span class="token attr-name">cluster1.efak.sasl.jaas.config</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.security.scram.ScramL</span>
<span class="token attr-name">oginModule</span> <span class="token attr-value">required username="kafka" password="kafka-eagle";</span>
<span class="token attr-name">cluster1.efak.sasl.client.id</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster1.efak.blacklist.topics</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster1.efak.sasl.cgroup.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster1.efak.sasl.cgroup.topics</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster2.efak.sasl.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster2.efak.sasl.protocol</span><span class="token punctuation">=</span><span class="token attr-value">SASL_PLAINTEXT</span>
<span class="token attr-name">cluster2.efak.sasl.mechanism</span><span class="token punctuation">=</span><span class="token attr-value">PLAIN</span>
<span class="token attr-name">cluster2.efak.sasl.jaas.config</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.security.plain.PlainL</span>
<span class="token attr-name">oginModule</span> <span class="token attr-value">required username="kafka" password="kafka-eagle";</span>
<span class="token attr-name">cluster2.efak.sasl.client.id</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster2.efak.blacklist.topics</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster2.efak.sasl.cgroup.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster2.efak.sasl.cgroup.topics</span><span class="token punctuation">=</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka ssl authenticate</span>
<span class="token comment">######################################</span>
<span class="token attr-name">cluster3.efak.ssl.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster3.efak.ssl.protocol</span><span class="token punctuation">=</span><span class="token attr-value">SSL</span>
<span class="token attr-name">cluster3.efak.ssl.truststore.location</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.truststore.password</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.keystore.location</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.keystore.password</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.key.password</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.endpoint.identification.algorithm</span><span class="token punctuation">=</span><span class="token attr-value">https</span>
<span class="token attr-name">cluster3.efak.blacklist.topics</span><span class="token punctuation">=</span>
<span class="token attr-name">cluster3.efak.ssl.cgroup.enable</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">cluster3.efak.ssl.cgroup.topics</span><span class="token punctuation">=</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka sqlite jdbc driver address</span>
<span class="token comment">######################################    # 配置对应的mysql连接</span>
<span class="token comment"># 配置 mysql 连接</span>
<span class="token attr-name">efak.driver</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.jdbc.Driver</span>
<span class="token attr-name">efak.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://cluster01:3306/ke?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull</span>
<span class="token attr-name">efak.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">efak.password</span><span class="token punctuation">=</span><span class="token attr-value">000000</span>
<span class="token comment">######################################</span>
<span class="token comment"># kafka mysql jdbc driver address</span>
<span class="token comment">######################################</span>
<span class="token comment">#efak.driver=com.mysql.cj.jdbc.Driver</span>
<span class="token comment">#efak.url=jdbc:mysql://127.0.0.1:3306/ke?useUnicode=true&amp;characterEncoding=U</span>
<span class="token attr-name">TF-8&amp;zeroDateTimeBehavior</span><span class="token punctuation">=</span><span class="token attr-value">convertToNull</span>
<span class="token comment">#efak.username=root</span>
<span class="token comment">#efak.password=123456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>添加环境变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 conf<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">vim</span> /etc/environment 

<span class="token comment">################## 写入以下内容 ################## </span>

<span class="token comment">####### eagle config start #######</span>

<span class="token assign-left variable">KE_HOME</span><span class="token operator">=</span>/opt/qing/module/efak
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KE_HOME</span>/bin
<span class="token builtin class-name">export</span> KE_HOME

<span class="token comment">####### eagle config end #######</span>

<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span>

<span class="token comment">################## 写入以上内容 ################## </span>

<span class="token comment">## 应用配置文件</span>
<span class="token punctuation">[</span>robert@cluster01 conf<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动 zookeeper</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ zk.sh start


<span class="token comment"># 启动 kafka</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ kafka.sh start


<span class="token comment"># 启动 efak</span>
<span class="token punctuation">[</span>robert@cluster01 efak<span class="token punctuation">]</span>$ bin/ke.sh start
<span class="token comment">#### 启动后输入如下</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-060.png" class="" title="image-060">
</li>
<li><p>停止命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 efak<span class="token punctuation">]</span>$ bin/ke.sh stop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h4 id="Kafka-Eagle页面操作"><a href="#Kafka-Eagle页面操作" class="headerlink" title="Kafka-Eagle页面操作"></a>Kafka-Eagle页面操作</h4><p>登录页面查看监控数据</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://192.168.1.111:8048/">http://192.168.1.111:8048</a></p>
</blockquote>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-061.png" class="" title="image-061">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-062.png" class="" title="image-062">

<h3 id="Kafka-Kraft模式"><a href="#Kafka-Kraft模式" class="headerlink" title="Kafka- Kraft模式"></a>Kafka- Kraft模式</h3><h4 id="Kafka-Kraft架构"><a href="#Kafka-Kraft架构" class="headerlink" title="Kafka- Kraft架构"></a>Kafka- Kraft架构</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-051.png" class="" title="image-051">

<p>左图为 <code>Kafka</code> 现有架构，元数据在 <code>zookeeper</code> 中，运行时动态选举 <code>controller</code>，由 <code>controller</code> 进行 <code>Kafka</code> 集群管理。右图为 <code>kraft</code> 模式架构（实验性），不再依赖 <code>zookeeper</code> 集群， 而是用三台 <code>controller</code> 节点代替 <code>zookeeper</code>，元数据保存在 <code>controller</code> 中，由 <code>controller</code> 直接进行 <code>Kafka</code> 集群管理。</p>
<p>这样做的好处有以下几个</p>
<ul>
<li><code>Kafka</code> 不再依赖外部框架，而是能够独立运行</li>
<li><code>controller</code> 管理集群时，不再需要从 <code>zookeeper</code> 中先读取数据，集群性能上升</li>
<li>由于不依赖 <code>zookeeper</code>，集群扩展时不再受到 <code>zookeeper</code> 读写能力限制</li>
<li><code>controller</code> 不再动态选举，而是由配置文件规定。这样我们可以有针对性的加强 <code>controller</code> 节点的配置，而不是像以前一样对随机 <code>controller</code> 节点的高负载束手无策</li>
</ul>
<h4 id="Kafka-Kraft集群部署"><a href="#Kafka-Kraft集群部署" class="headerlink" title="Kafka- Kraft集群部署"></a>Kafka- Kraft集群部署</h4><ol>
<li><p>再次解压一份 <code>kafka</code> 安装包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 tmp<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxvf kafka_2.12-3.0.0.tgz -C /opt/qing/module/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>重命名为 <code>kafka_kraft</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">mv</span> kafka_2.12-3.0.0/ kafka_kraft<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>在 <code>cluster01</code> 上修改<code>/opt/qing/module/kafka_kraft/config/kraft/server.properties</code> 配置文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kraft<span class="token punctuation">]</span>$ <span class="token function">vim</span> server.properties
<span class="token comment">################## 写入以下内容 ################## </span>

<span class="token comment">#kafka 的角色（controller 相当于主机、broker 节点相当于从机，主机类似 zk 功能）</span>
process.roles<span class="token operator">=</span>broker, controller
<span class="token comment">#节点 ID</span>
node.id<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#controller 服务协议别名</span>
controller.listener.names<span class="token operator">=</span>CONTROLLER
<span class="token comment">#全 Controller 列表</span>
controller.quorum.voters<span class="token operator">=</span><span class="token number">1</span>@cluster01:9093,2@cluster02:9093,3@cluster03:9093
<span class="token comment">#不同服务器绑定的端口</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9092,CONTROLLER://:9093
<span class="token comment">#broker 服务协议别名</span>
inter.broker.listener.name<span class="token operator">=</span>PLAINTEXT
<span class="token comment">#broker 对外暴露的地址</span>
advertised.Listeners<span class="token operator">=</span>PLAINTEXT://cluster01:9092
<span class="token comment">#协议别名到安全协议的映射</span>
listener.security.protocol.map<span class="token operator">=</span>CONTROLLER:PLAINTEXT,PLAINTEXT:PLA
INTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL
<span class="token comment">#kafka 数据存储目录</span>
log.dirs<span class="token operator">=</span>/opt/qing/module/kafka_kraft/data

<span class="token comment">################## 写入以上内容 ################## </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>分发 <code>kafka_kraft</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r kafka_draft robert@cluster02:/opt/qing/module/
<span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r kafka_draft robert@cluster03:/opt/qing/module/

<span class="token comment"># 注意 在对应的主机上，需要修改对应的 node.id</span>
<span class="token comment"># 同时也需要修改 advertised.Listeners 中的主机名</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>初始化集群数据目录</p>
<ol>
<li><p>首先生成存储目录唯一 <code>ID</code>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-storage.sh random-uuid
J7s9e8PPTKOO47PxzI39VA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>用该 ID 格式化 <code>kafka</code> 存储目录（三台节点）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-storage.sh <span class="token function">format</span> -t J7s9e8PPTKOO47PxzI39VA -c /opt/qing/module/kafka_kraft/config/kraft/server.properties

<span class="token punctuation">[</span>robert@cluster02 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-storage.sh <span class="token function">format</span> -t J7s9e8PPTKOO47PxzI39VA -c /opt/qing/module/kafka_kraft/config/kraft/server.properties

<span class="token punctuation">[</span>robert@cluster03 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-storage.sh <span class="token function">format</span> -t J7s9e8PPTKOO47PxzI39VA -c /opt/qing/module/kafka_kraft/config/kraft/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>启动 <code>kafka</code> 集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon 
config/kraft/server.properties

<span class="token punctuation">[</span>robert@cluster02 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon 
config/kraft/server.properties

<span class="token punctuation">[</span>robert@cluster03 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-start.sh -daemon 
config/kraft/server.properties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>停止 <code>kafka</code> 集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh
<span class="token punctuation">[</span>robert@cluster02 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh
<span class="token punctuation">[</span>robert@cluster03 kafka_kraft<span class="token punctuation">]</span>$ bin/kafka-server-stop.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="Kafka-Kraft集群启动停止脚本"><a href="#Kafka-Kraft集群启动停止脚本" class="headerlink" title="Kafka- Kraft集群启动停止脚本"></a>Kafka- Kraft集群启动停止脚本</h4><p>在<code>/home/roebrt/bin</code> 目录下创建文件 <code>kafka_kraft.sh</code> 脚本文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ <span class="token function">vim</span> kafka_kraft.sh
<span class="token comment">################## 写入以下内容 ################## </span>
<span class="token comment">#! /bin/bash</span>
<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
<span class="token string">"start"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> cluster01 cluster02 cluster03
    <span class="token keyword">do</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"--------启动 <span class="token variable">$i</span> Kafka-------"</span>
        <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">"/opt/qing/module/kafka_kraft/bin/kafka-server-start.sh -daemon /opt/qing/module/kafka_kraft/config/kraft/server.properties"</span>
    <span class="token keyword">done</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token string">"stop"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> cluster01 cluster02 cluster03
    <span class="token keyword">do</span>
        <span class="token builtin class-name">echo</span> <span class="token string">"--------停止 <span class="token variable">$i</span> Kafka-------"</span>
        <span class="token function">ssh</span> <span class="token variable">$i</span> <span class="token string">"/opt/qing/module/kafka_kraft/bin/kafka-server-stop.sh"</span>
    <span class="token keyword">done</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>

<span class="token comment">################## 写入以上内容 ################## </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>添加执行权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ <span class="token function">chmod</span> +x kafka_kraft.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动集群命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ kafka_kraft.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>停止集群命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ kafka_kraft.sh stop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="外部系统集成"><a href="#外部系统集成" class="headerlink" title="外部系统集成"></a>外部系统集成</h2><h3 id="集成Flume"><a href="#集成Flume" class="headerlink" title="集成Flume"></a>集成Flume</h3><p><code>Flume</code> 是一个在大数据开发中非常常用的组件。可以用于 <code>Kafka</code> 的生产者，也可以用于 <code>Flume</code> 的消费者。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-063.png" class="" title="image-063">

<h4 id="Flume生产者"><a href="#Flume生产者" class="headerlink" title="Flume生产者"></a>Flume生产者</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-064.png" class="" title="image-064">

<ol>
<li><p>启动 <code>kafka</code> 集群</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ zk.sh start
<span class="token punctuation">[</span>robert@cluster01 bin<span class="token punctuation">]</span>$ kafka.sh start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>kafka</code> 消费者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><code>Flume</code> 安装步骤</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 tmp<span class="token punctuation">]</span>$ <span class="token function">wget</span> -c http://archive.apache.org/dist/flume/1.11.0/apache-flume-1.11.0-bin.tar.gz -P /opt/qing/tmp
<span class="token comment"># -P 指定下载目录</span>
<span class="token comment"># -c --continue 如果首次下载中断，可用使用该参数进行续点下载</span>


<span class="token punctuation">[</span>robert@cluster01 tmp<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxf apache-flume-1.11.0-bin.tar.gz -C /opt/qing/module/


<span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">mv</span> apache-flume-1.11.0-bin flume


<span class="token comment"># 如果配合 hadoop使用的话</span>
<span class="token punctuation">[</span>robert@cluster01 lib<span class="token punctuation">]</span>$ <span class="token function">rm</span>  guava-11.0.2.jar
<span class="token comment"># hadoop的是guava-27.0-jre.jar</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置 <code>Flume</code></p>
<p>在 <code>cluster01</code> 节点的 <code>Flume</code> 的 <code>job</code> 目录下创建 <code>file_to_kafka.conf</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> <span class="token function">jobs</span>
<span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ <span class="token function">vim</span> jobs/file_to_kafka.conf <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>配置文件如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 组件定义</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment"># 2 配置 source</span>
a1.sources.r1.type <span class="token operator">=</span> TAILDIR
a1.sources.r1.filegroups <span class="token operator">=</span> f1
a1.sources.r1.filegroups.f1 <span class="token operator">=</span> /data/qing/logs/app.*
a1.sources.r1.positionFile <span class="token operator">=</span> /opt/qing/module/flume/taildir_position.json

<span class="token comment"># 3 配置 channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment"># 4 配置 sink</span>
a1.sinks.k1.type <span class="token operator">=</span> org.apache.flume.sink.kafka.KafkaSink
a1.sinks.k1.kafka.bootstrap.servers <span class="token operator">=</span> cluster01:9092,cluster01:9092,cluster01:9092
a1.sinks.k1.kafka.topic <span class="token operator">=</span> first
a1.sinks.k1.kafka.flumeBatchSize <span class="token operator">=</span> <span class="token number">20</span>
a1.sinks.k1.kafka.producer.acks <span class="token operator">=</span> <span class="token number">1</span>
a1.sinks.k1.kafka.producer.linger.ms <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment"># 5 拼接组件</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>Flume</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 module<span class="token punctuation">]</span>$ bin/flume-ng agent -c conf/ -n a1 -f jobs/file_to_kafka.conf <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>向 <code>/data/qing/logs/app.log</code> 里追加数据，查看 <code>kafka</code> 消费者消费情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 data<span class="token punctuation">]</span>$ <span class="token function">mkdir</span> -p /data/qing/logs
<span class="token punctuation">[</span>robert@cluster01 data<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> <span class="token string">"hello world"</span> <span class="token operator">&gt;&gt;</span> /data/qing/logs/app.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="Flume消费者"><a href="#Flume消费者" class="headerlink" title="Flume消费者"></a>Flume消费者</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-065.png" class="" title="image-065">

<ol>
<li><p>配置 <code>Flume</code></p>
<p>在 <code>cluster01</code>节点的 <code>Flume</code> 的 <code>/opt/module/flume/jobs</code> 目录下创建 <code>kafka_to_file.conf</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 jobs<span class="token punctuation">]</span>$ <span class="token function">vim</span> kafka_to_file.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>配置文件内容如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1 组件定义</span>
a1.sources <span class="token operator">=</span> r1
a1.sinks <span class="token operator">=</span> k1
a1.channels <span class="token operator">=</span> c1

<span class="token comment"># 2 配置 source</span>
a1.sources.r1.type <span class="token operator">=</span> org.apache.flume.source.kafka.KafkaSource
a1.sources.r1.batchSize <span class="token operator">=</span> <span class="token number">50</span>
a1.sources.r1.batchDurationMillis <span class="token operator">=</span> <span class="token number">200</span>
a1.sources.r1.kafka.bootstrap.servers <span class="token operator">=</span> cluster01:9092
a1.sources.r1.kafka.topics <span class="token operator">=</span> first
a1.sources.r1.kafka.consumer.group.id <span class="token operator">=</span> custom.g.id

<span class="token comment"># 3 配置 channel</span>
a1.channels.c1.type <span class="token operator">=</span> memory
a1.channels.c1.capacity <span class="token operator">=</span> <span class="token number">1000</span>
a1.channels.c1.transactionCapacity <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment"># 4 配置 sink</span>
a1.sinks.k1.type <span class="token operator">=</span> logger

<span class="token comment"># 5 拼接组件</span>
a1.sources.r1.channels <span class="token operator">=</span> c1
a1.sinks.k1.channel <span class="token operator">=</span> c1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>Flume</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 flume<span class="token punctuation">]</span>$ bin/flume-ng agent -c conf/ -n a1 -f jobs/kafka_to_file.conf -Dflume.root.logger<span class="token operator">=</span>INFO,console<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>启动 <code>kafka</code> 生产者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 flume<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>观察控制台输出的日志</p>
</li>
</ol>
<h3 id="集成-Flink"><a href="#集成-Flink" class="headerlink" title="集成 Flink"></a>集成 Flink</h3><h4 id="Flink生产者"><a href="#Flink生产者" class="headerlink" title="Flink生产者"></a>Flink生产者</h4><p><code>Flink</code> 是一个在大数据开发中非常常用的组件。可以用于 <code>Kafka</code> 的生产者，也可以用于 <code>Flink</code> 的消费者。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-066.png" class="" title="image-066">

<ol>
<li><p><code>Flink</code> 环境准备，在项目的 <code>pom</code> 文件中添加</p>
<pre class="line-numbers language-pom" data-language="pom"><code class="language-pom">            &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-java --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
                &lt;artifactId&gt;flink-java&lt;/artifactId&gt;
                &lt;version1.17.1&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-streaming-java --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
                &lt;artifactId&gt;flink-streaming-java&lt;/artifactId&gt;
                &lt;version&gt;1.17.1&lt;/version&gt;
&lt;!--                &lt;scope&gt;provided&lt;/scope&gt;--&gt;
            &lt;/dependency&gt;

            &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-clients --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
                &lt;artifactId&gt;flink-clients&lt;/artifactId&gt;
                &lt;version&gt;1.17.1&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-connector-kafka --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;
                &lt;artifactId&gt;flink-connector-kafka&lt;/artifactId&gt;
                &lt;version&gt;1.17.1&lt;/version&gt;
            &lt;/dependency&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p>将 <code>log4j.properties</code> 文件添加到 <code>resources</code> 里面，就能更改打印日志的级别为 <code>error</code></p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">log4j.rootLogger</span><span class="token punctuation">=</span><span class="token attr-value">error, stdout,R</span>
<span class="token attr-name">log4j.appender.stdout</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.ConsoleAppender</span>
<span class="token attr-name">log4j.appender.stdout.layout</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.PatternLayout</span>
<span class="token attr-name">log4j.appender.stdout.layout.ConversionPattern</span><span class="token punctuation">=</span><span class="token attr-value">%d{yyyy-MM-dd HH:mm:ss,SSS} %5p --- [%50t] %-80c(line:%5L) : %m%n</span>
<span class="token attr-name">log4j.appender.R</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.RollingFileAppender</span>
<span class="token attr-name">log4j.appender.R.File</span><span class="token punctuation">=</span><span class="token attr-value">../log/agent.log</span>
<span class="token attr-name">log4j.appender.R.MaxFileSize</span><span class="token punctuation">=</span><span class="token attr-value">1024KB</span>
<span class="token attr-name">log4j.appender.R.MaxBackupIndex</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">log4j.appender.R.layout</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.log4j.PatternLayout</span>
<span class="token attr-name">log4j.appender.R.layout.ConversionPattern</span><span class="token punctuation">=</span><span class="token attr-value">%d{yyyy-MM-dd HH:mm:ss,SSS} %5p --- [%50t] %-80c(line:%6L) : %m%n</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建 <code>Flink</code> 生产者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>flink</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">DeliveryGuarantee</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">KafkaRecordSerializationSchema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">KafkaSink</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">KafkaSinkBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaProducerBase</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-09-10 1:22
 * @since: JDK-
 * &lt;p&gt;
 * https://nightlies.apache.org/flink/flink-docs-release-1.15/zh/docs/connectors/datastream/kafka/
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlinkKafkaProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">FlinkKafkaProducer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">// 0 初始化 flink 环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1 读取集合中数据</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> wordsList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wordsList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wordsList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputDataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>wordsList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 kafka 生产者配置信息</span>
        <span class="token class-name">Properties</span> kafkaProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        kafkaProperties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3 创建 kafka 生产者</span>
        <span class="token class-name">KafkaSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> sink <span class="token operator">=</span> <span class="token class-name">KafkaSink</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//                .setBootstrapServers("cluster01:9092")</span>
                <span class="token punctuation">.</span><span class="token function">setKafkaProducerConfig</span><span class="token punctuation">(</span>kafkaProperties<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setRecordSerializer</span><span class="token punctuation">(</span><span class="token class-name">KafkaRecordSerializationSchema</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setValueSerializationSchema</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDeliveryGuarantee</span><span class="token punctuation">(</span><span class="token class-name">DeliveryGuarantee</span><span class="token punctuation">.</span>AT_LEAST_ONCE<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4 生产者和 flink 流关联</span>
        inputDataStream<span class="token punctuation">.</span><span class="token function">sinkTo</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5 执行</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 Kafka 消费者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-consumer.sh --bootstrap-server cluster01:9092 --topic first<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>执行生产者程序，观察消费者的情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hello
world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="Flink消费者"><a href="#Flink消费者" class="headerlink" title="Flink消费者"></a>Flink消费者</h4><ol>
<li><p>创建 <code>flink</code> 消费者</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>qing<span class="token punctuation">.</span>experiment<span class="token punctuation">.</span>core<span class="token punctuation">.</span>flink</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>eventtime<span class="token punctuation">.</span></span><span class="token class-name">WatermarkStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">KafkaSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>source<span class="token punctuation">.</span>enumerator<span class="token punctuation">.</span>initializer<span class="token punctuation">.</span></span><span class="token class-name">OffsetsInitializer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author: Robert Sun q
 * @date: 2023-09-10 2:22
 * @since: JDK-
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlinkKafkaConsumer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token comment">// 0 初始化 flink 环境</span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 创建 kafka 消费者</span>
        <span class="token class-name">KafkaSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">KafkaSource</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setBootstrapServers</span><span class="token punctuation">(</span><span class="token string">"cluster01:9092"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopics</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token string">"group-1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setStartingOffsets</span><span class="token punctuation">(</span><span class="token class-name">OffsetsInitializer</span><span class="token punctuation">.</span><span class="token function">earliest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setValueOnlyDeserializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 消费者和 fink 流关联</span>
        env<span class="token punctuation">.</span><span class="token function">fromSource</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">noWatermarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Kafka Source"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 执行</span>
        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 <code>FlinkKafkaConsumer</code> 消费者</p>
</li>
<li><p>启动 <code>kafka</code> 生产者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first

<span class="token comment">#### 输入如下内容</span>
<span class="token operator">&gt;</span>hello
<span class="token operator">&gt;</span>world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>观察消费者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hello
world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="集成SpringBoot"><a href="#集成SpringBoot" class="headerlink" title="集成SpringBoot"></a>集成SpringBoot</h3><p><code>SpringBoot</code> 是一个在 <code>JavaEE</code> 开发中非常常用的组件。可以用于 <code>Kafka</code> 的生产者，也可以 用于 <code>SpringBoot</code> 的消费者。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-067.png" class="" title="image-067">

<h4 id="SpringBoot生产者"><a href="#SpringBoot生产者" class="headerlink" title="SpringBoot生产者"></a>SpringBoot生产者</h4><ol>
<li><p>创建合适的 <code>springboot</code> 项目</p>
</li>
<li><p>pom 文件中天下对应的依赖</p>
<pre class="line-numbers language-pom" data-language="pom"><code class="language-pom">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;version&gt;2.7.14&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;version&gt;2.7.14&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;spring-kafka&lt;/artifactId&gt;
    &lt;version&gt;2.9.12&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.kafka&lt;/groupId&gt;
    &lt;artifactId&gt;spring-kafka-test&lt;/artifactId&gt;
    &lt;version&gt;2.9.12&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;version&gt;1.18.28&lt;/version&gt;
&lt;/dependency&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改 <code>SpringBoot</code> 核心配置文件 <code>application.propeties</code>，添加生产者相关信息</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">spring.kafka.bootstrap-servers</span><span class="token punctuation">=</span><span class="token attr-value">cluster01:9092,cluster02:9092,cluster03:9092</span>
<span class="token attr-name">spring.kafka.producer.key-serializer</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.serialization.StringSerializer</span>
<span class="token attr-name">spring.kafka.producer.value-serializer</span><span class="token punctuation">=</span><span class="token attr-value">org.apache.kafka.common.serialization.StringSerializer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建接口，从浏览器接收数据，并写入指定的topic</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/send_kafka"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendKafka</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"first"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
   
   
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKafkaTemplate</span><span class="token punctuation">(</span><span class="token class-name">KafkaTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> kafkaTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>kafkaTemplate <span class="token operator">=</span> kafkaTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="SpringBoot消费者"><a href="#SpringBoot消费者" class="headerlink" title="SpringBoot消费者"></a>SpringBoot消费者</h4><ol>
<li><p>添加 <code>kafka</code> 消费者的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">spring.kafka.bootstrap-servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092

spring.kafka.consumer.key-deserializer<span class="token operator">=</span>org.apache.kafka.common.serialization.StringSerializer
spring.kafka.consumer.value-deserializer<span class="token operator">=</span>org.apache.kafka.common.serialization.StringSerializer
spring.kafka.consumer.group-id<span class="token operator">=</span>qing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建消费者并指定 <code>topic</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">@Configurable
public class KafkaListenerConsumer <span class="token punctuation">{</span>

    private static final Logger logger <span class="token operator">=</span> LoggerFactory.getLogger<span class="token punctuation">(</span>KafkaListenerConsumer.class<span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 指定要监听的 topic
    @KafkaListener<span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"first"</span><span class="token punctuation">)</span>
    public void consumerFirstTopic<span class="token punctuation">(</span>String msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger.info<span class="token punctuation">(</span><span class="token string">"consumer topic first, msg: [{}]"</span>, msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>向 <code>first</code> 主题发送数据</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-console-producer.sh --bootstrap-server cluster01:9092 --topic first

<span class="token comment">#### 输入如下内容</span>
<span class="token operator">&gt;</span>hello
<span class="token operator">&gt;</span>world<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="集成Spark"><a href="#集成Spark" class="headerlink" title="集成Spark"></a>集成Spark</h3><p><code>Spark</code> 是一个在大数据开发中非常常用的组件。可以用于 <code>Kafka</code> 的生产者，也可以用于 <code>Spark</code> 的消费者。</p>
<p>暂略…</p>
<h2 id="生产调优手册"><a href="#生产调优手册" class="headerlink" title="生产调优手册"></a>生产调优手册</h2><h3 id="Kafka硬件配置选择"><a href="#Kafka硬件配置选择" class="headerlink" title="Kafka硬件配置选择"></a>Kafka硬件配置选择</h3><h3 id="场景说明"><a href="#场景说明" class="headerlink" title="场景说明"></a>场景说明</h3><p>100 万日活，每人每天 100 条日志，每天总共的日志条数是 100 万 * 100 条 = 1 亿条。 </p>
<p>1 亿/24 小时/60 分/60 秒 = 1150 条/每秒钟。 </p>
<p>每条日志大小：0.5k - 2k（取 1k）。 </p>
<p>1150 条/每秒钟 * 1k ≈ 1m/s 。 </p>
<p>高峰期每秒钟：1150 条 * 20 倍 = 23000 条。 </p>
<p>每秒多少数据量：20MB/s。</p>
<h4 id="服务器台数选择"><a href="#服务器台数选择" class="headerlink" title="服务器台数选择"></a>服务器台数选择</h4><p>服务器台数 = 2 * （生产者峰值生产速率 * 副本 / 100） + 1</p>
<p>​                     = 2 * （20m/s * 2 / 100） + 1 </p>
<p>​                     = 3 台 </p>
<p>建议 3 台服务器。</p>
<h4 id="磁盘选择"><a href="#磁盘选择" class="headerlink" title="磁盘选择"></a>磁盘选择</h4><p><code>kafka</code> 底层主要是<strong>顺序写</strong>，固态硬盘和机械硬盘的顺序写速度差不多。 </p>
<p>建议选择普通的机械硬盘。 </p>
<p>每天总数据量：1 亿条 * 1k ≈ 100g </p>
<p>100g * 副本 2 * 保存时间 3 天 / 0.7 ≈ 1T </p>
<p>建议三台服务器硬盘总大小，大于等于 1T。</p>
<h4 id="内存选择"><a href="#内存选择" class="headerlink" title="内存选择"></a>内存选择</h4><p><code>Kafka</code> 内存组成：<strong>堆内存 + 页缓存</strong></p>
<ol>
<li><p><code>Kafka</code> 堆内存建议每个节点：10G – 5G</p>
<ol>
<li><p>在 <code>kafka-server-start.sh</code> 中修改</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$KAFKA_HEAP_OPTS</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">"-Xmx10G -Xms10G"</span>
<span class="token keyword">fi</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看 <code>Kafka</code> 进程号</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ jps

<span class="token comment">#### 输出如下</span>
<span class="token number">127205</span> KafkaEagle
<span class="token number">45802</span> QuorumPeerMain
<span class="token number">126796</span> Kafka
<span class="token number">243934</span> Jps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>根据 <code>Kafka</code> 进程号，查看 <code>Kafka</code> 的 <code>GC</code> 情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ jstat -gc <span class="token number">126796</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-068.png" class="" title="image-068">

<p>参数说明</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>S0C</code></td>
<td>第一个幸存区的大小</td>
</tr>
<tr>
<td><code>S1C</code></td>
<td>第二个幸存区的大小</td>
</tr>
<tr>
<td><code>S0U</code></td>
<td>第一个幸存区的使用大小</td>
</tr>
<tr>
<td><code>S1U</code></td>
<td>第二个幸存区的使用大小</td>
</tr>
<tr>
<td><code>EC</code></td>
<td>伊甸园区的大小</td>
</tr>
<tr>
<td><code>EU</code></td>
<td>伊甸园区的使用大小</td>
</tr>
<tr>
<td><code>OC</code></td>
<td>老年代大小</td>
</tr>
<tr>
<td><code>OU</code></td>
<td>老年代使用大小</td>
</tr>
<tr>
<td><code>MC</code></td>
<td>方法区大小</td>
</tr>
<tr>
<td><code>MU</code></td>
<td>方法区使用大小</td>
</tr>
<tr>
<td><code>CCSC</code></td>
<td>压缩类空间大小</td>
</tr>
<tr>
<td><code>CCSU</code></td>
<td>压缩类空间使用大小</td>
</tr>
<tr>
<td><code>YGC</code></td>
<td>年轻代垃圾回收次数</td>
</tr>
<tr>
<td><code>YGCT</code></td>
<td>年轻代垃圾回收消耗时间</td>
</tr>
<tr>
<td><code>FGC</code></td>
<td>老年代垃圾回收次数</td>
</tr>
<tr>
<td><code>FGCT</code></td>
<td>老年代垃圾回收消耗时间</td>
</tr>
<tr>
<td><code>GCT</code></td>
<td>垃圾回收消耗总时</td>
</tr>
</tbody></table>
</li>
<li><p>根据 <code>Kafka</code> 进程号，查看 <code>Kafka</code> 的堆内存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 ~<span class="token punctuation">]</span>$ jhsdb jmap --pid <span class="token number">126796</span> --heap

<span class="token comment">#### 输出如下</span>
Attaching to process ID <span class="token number">126796</span>, please wait<span class="token punctuation">..</span>.
Debugger attached successfully.
Server compiler detected.
JVM version is <span class="token number">11.0</span>.20+8-LTS

using thread-local object allocation.
Garbage-First <span class="token punctuation">(</span>G1<span class="token punctuation">)</span> GC with <span class="token number">8</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span>

Heap Configuration:
   MinHeapFreeRatio         <span class="token operator">=</span> <span class="token number">40</span>
   MaxHeapFreeRatio         <span class="token operator">=</span> <span class="token number">70</span>
   MaxHeapSize              <span class="token operator">=</span> <span class="token number">2147483648</span> <span class="token punctuation">(</span><span class="token number">2048</span>.0MB<span class="token punctuation">)</span>
   NewSize                  <span class="token operator">=</span> <span class="token number">1363144</span> <span class="token punctuation">(</span><span class="token number">1</span>.2999954223632812MB<span class="token punctuation">)</span>
   MaxNewSize               <span class="token operator">=</span> <span class="token number">1287651328</span> <span class="token punctuation">(</span><span class="token number">1228</span>.0MB<span class="token punctuation">)</span>
   OldSize                  <span class="token operator">=</span> <span class="token number">5452592</span> <span class="token punctuation">(</span><span class="token number">5</span>.1999969482421875MB<span class="token punctuation">)</span>
   NewRatio                 <span class="token operator">=</span> <span class="token number">2</span>
   SurvivorRatio            <span class="token operator">=</span> <span class="token number">8</span>
   MetaspaceSize            <span class="token operator">=</span> <span class="token number">21807104</span> <span class="token punctuation">(</span><span class="token number">20</span>.796875MB<span class="token punctuation">)</span>
   CompressedClassSpaceSize <span class="token operator">=</span> <span class="token number">1073741824</span> <span class="token punctuation">(</span><span class="token number">1024</span>.0MB<span class="token punctuation">)</span>
   MaxMetaspaceSize         <span class="token operator">=</span> <span class="token number">17592186044415</span> MB
   G1HeapRegionSize         <span class="token operator">=</span> <span class="token number">1048576</span> <span class="token punctuation">(</span><span class="token number">1</span>.0MB<span class="token punctuation">)</span>

Heap Usage:
G1 Heap:
   regions  <span class="token operator">=</span> <span class="token number">2048</span>
   capacity <span class="token operator">=</span> <span class="token number">2147483648</span> <span class="token punctuation">(</span><span class="token number">2048</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">199957520</span> <span class="token punctuation">(</span><span class="token number">190</span>.69435119628906MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">1947526128</span> <span class="token punctuation">(</span><span class="token number">1857</span>.305648803711MB<span class="token punctuation">)</span>
   <span class="token number">9.311247617006302</span>% used   <span class="token comment"># 注意这里</span>
G1 Young Generation:
Eden Space:
   regions  <span class="token operator">=</span> <span class="token number">42</span>
   capacity <span class="token operator">=</span> <span class="token number">108003328</span> <span class="token punctuation">(</span><span class="token number">103</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">44040192</span> <span class="token punctuation">(</span><span class="token number">42</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">63963136</span> <span class="token punctuation">(</span><span class="token number">61</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">40.77669902912621</span>% used
Survivor Space:
   regions  <span class="token operator">=</span> <span class="token number">5</span>
   capacity <span class="token operator">=</span> <span class="token number">5242880</span> <span class="token punctuation">(</span><span class="token number">5</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">5242880</span> <span class="token punctuation">(</span><span class="token number">5</span>.0MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span>.0MB<span class="token punctuation">)</span>
   <span class="token number">100.0</span>% used
G1 Old Generation:
   regions  <span class="token operator">=</span> <span class="token number">147</span>
   capacity <span class="token operator">=</span> <span class="token number">2034237440</span> <span class="token punctuation">(</span><span class="token number">1940</span>.0MB<span class="token punctuation">)</span>
   used     <span class="token operator">=</span> <span class="token number">151723024</span> <span class="token punctuation">(</span><span class="token number">144</span>.69435119628906MB<span class="token punctuation">)</span>
   <span class="token function">free</span>     <span class="token operator">=</span> <span class="token number">1882514416</span> <span class="token punctuation">(</span><span class="token number">1795</span>.305648803711MB<span class="token punctuation">)</span>
   <span class="token number">7.4584717111489205</span>% used  <span class="token comment"># 注意这里</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li><p>页缓存：页缓存是 <code>Linux</code> 系统服务器的内存。我们只需要保证 1 个 <code>segment</code>（1g）中 25% 的数据在内存中就好。</p>
<p>每个节点页缓存大小 =（分区数 * 1g * 25%）/ 节点数。例如 10 个分区，页缓存大小 =（10 * 1g * 25%）/ 3 ≈ 1g </p>
<p>建议服务器内存大于等于 11G。</p>
</li>
</ol>
<h4 id="CPU选择"><a href="#CPU选择" class="headerlink" title="CPU选择"></a>CPU选择</h4><p><code>num.io.threads = 8</code> 负责写磁盘的线程数，整个参数值要占总核数的 <code>50%</code></p>
<p><code>num.replica.fetchers = 1</code> 副本拉取线程数，这个参数占总核数的 <code>50%</code>的 <code>1/3</code></p>
<p><code>num.network.threads = 3</code> 数据传输线程数，这个参数占总核数的 <code>50%</code> 的 <code>2/3</code>。</p>
<p>建议 32 个 <code>cpu core</code>。</p>
<h4 id="网络选择"><a href="#网络选择" class="headerlink" title="网络选择"></a>网络选择</h4><p>网络带宽 = 峰值吞吐量 ≈ 20MB/s 选择千兆网卡即可。</p>
<p>100Mbps 单位是 bit；10M/s 单位是 byte ; 1byte = 8bit，100Mbps/8 = 12.5M/s。</p>
<p>一般百兆的网卡（100Mbps ）、千兆的网卡（1000Mbps）、万兆的网卡（10000Mbps）。</p>
<h3 id="Kafka生产者-1"><a href="#Kafka生产者-1" class="headerlink" title="Kafka生产者"></a>Kafka生产者</h3><blockquote>
<p>3.1.1 Updating Broker Configs </p>
<p>From Kafka version 1.1 onwards, some of the broker configs can be  updated without restarting the broker. See the Dynamic Update Mode  column in Broker Configs for the update mode of each broker config.</p>
<p> <code>read-only</code>: Requires a broker restart for update </p>
<p><code>per-broker</code>: May be updated dynamically for each broker </p>
<p><code>cluster-wide</code>: May be updated dynamically as a cluster-wide default. </p>
<p>May also be updated as a per-broker value for testing.</p>
</blockquote>
<p><strong>具体可见上方入门章节中对应部分，以下为入门章节中内容的汇总</strong></p>
<h4 id="Kafka生产者核心参数配置"><a href="#Kafka生产者核心参数配置" class="headerlink" title="Kafka生产者核心参数配置"></a>Kafka生产者核心参数配置</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-053.png" class="" title="image-053">

<h5 id="生产者重要参数列表-1"><a href="#生产者重要参数列表-1" class="headerlink" title="生产者重要参数列表"></a>生产者重要参数列表</h5><table>
<thead>
<tr>
<th>参数名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap.servers</code></td>
<td>生产者连接集群所需的 <code>broker</code> 地址清单 。 例 如 <code>cluster01:9092,cluster02:9092,cluster03:9092</code>，可以 设置 1 个或者多个，中间用逗号隔开。注意这里并非需要所有的 <code>broker</code> 地址，因为生产者从给定的 <code>broker</code> 里查找到其他 <code>broker</code> 信息。</td>
</tr>
<tr>
<td><code>key.serializer</code> 和 <code>value.seralizer</code></td>
<td>指定发送消息的 <code>key</code> 和 <code>value</code> 的序列化类型。一定要写 全类名。</td>
</tr>
<tr>
<td><code>buffer.memory</code></td>
<td><code>RecordAccumulator</code> 缓冲区总大小，默认 <code>32m</code>。</td>
</tr>
<tr>
<td><code>batch.size</code></td>
<td>缓冲区一批数据最大值，默认 <code>16k</code>。适当增加该值，可 以提高吞吐量，但是如果该值设置太大，会导致数据传输延迟增加。</td>
</tr>
<tr>
<td><code>linger.ms</code></td>
<td>如果数据迟迟未达到 <code>batch.size</code>，<code>sender</code> 等待 <code>linger.ms</code> 之后就会发送数据。单位 <code>ms</code>，默认值是 <code>0ms</code>，表示没有延迟。生产环境建议该值大小为 <code>5-100ms</code> 之间。</td>
</tr>
<tr>
<td><code>acks</code></td>
<td>0：生产者发送过来的数据，不需要等数据落盘应答。<br> 1：生产者发送过来的数据，<code>Leader</code> 收到数据后应答。<br> -1（all）：生产者发送过来的数据，Leader+和 isr 队列 里面的所有节点收齐数据后应答。<strong>默认值是-1，-1 和 all 是等价的</strong>。</td>
</tr>
<tr>
<td><code>max.in.flight.requests.per.connection</code></td>
<td>允许最多没有返回 <code>ack</code> 的次数，默认为 <code>5</code>，开启幂等性 要保证该值是 <code>1-5</code> 的数字。</td>
</tr>
<tr>
<td><code>retries</code></td>
<td>当消息发送出现错误的时候，系统会重发消息。<code>retries</code> 表示重试次数。默认是 <code>int</code> 最大值，<code>2147483647</code>。 如果设置了重试，还想保证消息的有序性，需要设置 <code>MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1</code> 否则在重试此失败消息的时候，其他的消息可能发送成功了。</td>
</tr>
<tr>
<td><code>retry.backoff.ms</code></td>
<td>两次重试之间的时间间隔，默认是 <code>100ms</code>。</td>
</tr>
<tr>
<td><code>enable.idempotence</code></td>
<td>是否开启幂等性，默认 <code>true</code>，开启幂等性。</td>
</tr>
<tr>
<td><code>compression.type</code></td>
<td>生产者发送的所有数据的压缩方式。默认是 <code>none</code>，也 就是不压缩。 <br>支持压缩类型：<code>none</code>、<code>gzip</code>、<code>snappy</code>、<code>lz4</code> 和 <code>zstd</code>。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="生产者如何提高吞吐量"><a href="#生产者如何提高吞吐量" class="headerlink" title="生产者如何提高吞吐量"></a>生产者如何提高吞吐量</h4><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>buffer.memory</code></td>
<td><code>RecordAccumulator</code> 缓冲区总大小，<strong>默认 32m</strong>。</td>
</tr>
<tr>
<td><code>batch.size</code></td>
<td>缓冲区一批数据最大值，<strong>默认 16k</strong>。适当增加该值，可以提高吞吐量，但是如果该值设置太大，会导致数据传 输延迟增加。</td>
</tr>
<tr>
<td><code>linger.ms</code></td>
<td>如果数据迟迟未达到 <code>batch.size</code>，<code>sender</code> 等待 <code>linger.time</code> 之后就会发送数据。单位 <code>ms</code>，**默认值是 <code>0ms</code>**，表示没有延迟。生产环境建议该值大小为 <code>5-100ms</code> 之间。</td>
</tr>
<tr>
<td><code>compression.type</code></td>
<td>生产者发送的所有数据的压缩方式。**默认是 <code>none</code>**，也就 是不压缩。 <br>支持压缩类型：<code>none</code>、<code>gzip</code>、<code>snappy</code>、<code>lz4</code> 和 <code>zstd</code>。</td>
</tr>
</tbody></table>
<h4 id="数据可靠性"><a href="#数据可靠性" class="headerlink" title="数据可靠性"></a>数据可靠性</h4><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>acks</code></td>
<td>0：生产者发送过来的数据，不需要等数据落盘应答。<br> 1：生产者发送过来的数据，<code>Leader</code> 收到数据后应答。<br> -1（all）：生产者发送过来的数据，<code>Leader+</code>和 <code>isr</code> 队列 里面的所有节点收齐数据后应答。<strong>默认值是-1，-1 和 all 是等价的</strong>。</td>
</tr>
</tbody></table>
<ul>
<li>至少一次（<code>At Least Once</code>）= <code>ACK</code> 级别设置为-1 <code>+</code> 分区副本大于等于 2 <code>+</code> ISR 里应 答的最小副本数量大于等于 2</li>
</ul>
<h4 id="数据去重"><a href="#数据去重" class="headerlink" title="数据去重"></a>数据去重</h4><ol>
<li><p>配置参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>enable.idempotence</code></td>
<td>是否开启幂等性，<strong>默认 true</strong>，表示开启幂等性。</td>
</tr>
</tbody></table>
</li>
<li><p><code>Kafka</code> 的事务一共右如下 5 个 <code>API</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 1 初始化事务</span>
<span class="token keyword">void</span> <span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2 开启事务</span>
<span class="token keyword">void</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 3 在事务内提交已经消费的偏移量（主要用于消费者）</span>
<span class="token keyword">void</span> <span class="token function">sendOffsetsToTransaction</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> offsets<span class="token punctuation">,</span> <span class="token class-name">String</span> consumerGroupId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 4 提交事务</span>
<span class="token keyword">void</span> <span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>

<span class="token comment">// 5 放弃事务（类似于回滚事务的操作）</span>
<span class="token keyword">void</span> <span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="数据有序"><a href="#数据有序" class="headerlink" title="数据有序"></a>数据有序</h4><p><strong>单分区内，有序（有条件的，不能乱序）；多分区，分区与分区间无序；</strong></p>
<h4 id="数据乱序"><a href="#数据乱序" class="headerlink" title="数据乱序"></a>数据乱序</h4><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>enable.idempotence</code></td>
<td>是否开启幂等性，<strong>默认 true</strong>，表示开启幂等性。</td>
</tr>
<tr>
<td><code>max.in.flight.requests.per.connection</code></td>
<td>允许最多没有返回 ack 的次数，<strong>默认为 5</strong>，开启幂等性要保证该值是 1-5 的数字</td>
</tr>
</tbody></table>
<h3 id="Kafka-Broker-1"><a href="#Kafka-Broker-1" class="headerlink" title="Kafka Broker"></a>Kafka Broker</h3><h4 id="Broker核心参数配置"><a href="#Broker核心参数配置" class="headerlink" title="Broker核心参数配置"></a>Broker核心参数配置</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-020.png" class="" title="image-020">

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>replica.lag.time.max.ms</code></td>
<td><code>ISR</code> 中，如果 <code>Follower</code> 长时间未向 <code>Leader</code> 发送通 信请求或同步数据，则该 <code>Follower</code> 将被踢出 <code>ISR</code>。 该时间阈值，<strong>默认 30s</strong>。</td>
</tr>
<tr>
<td><code>auto.leader.rebalance.enable</code></td>
<td><strong>默认是 true</strong>。 自动 <code>Leader Partition</code> 平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.per.broker.percentage</code></td>
<td>**默认是 10%**。每个 <code>broker</code> 允许的不平衡的 <code>leader</code> 的比率。如果每个 <code>broker</code> 超过了这个值，控制器 会触发 <code>leader</code> 的平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.check.interval.seconds</code></td>
<td><strong>默认值 300 秒</strong>。检查 <code>leader</code> 负载是否平衡的间隔时 间。</td>
</tr>
<tr>
<td><code>log.segment.bytes</code></td>
<td><code>Kafka</code> 中 <code>log</code> 日志是分成一块块存储的，此配置是 指 log 日志划分 成块的大小，<strong>默认值 1G</strong>。</td>
</tr>
<tr>
<td><code>log.index.interval.bytes</code></td>
<td><strong>默认 4kb</strong>，<code>kafka</code> 里面每当写入了 <code>4kb</code> 大小的日志 （<code>.log</code>），然后就往 <code>index</code> 文件里面记录一个索引。</td>
</tr>
<tr>
<td><code>log.retention.hours</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>默认 7 天</strong>。</td>
</tr>
<tr>
<td><code>log.retention.minutes</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>分钟级别，默认关闭</strong>。</td>
</tr>
<tr>
<td><code>log.retention.ms</code></td>
<td><code>Kafka</code> 中数据保存的时间，<strong>毫秒级别，默认关闭</strong>。</td>
</tr>
<tr>
<td><code>log.retention.check.interval.ms</code></td>
<td>检查数据是否保存超时的间隔，<strong>默认是 5 分钟</strong>。</td>
</tr>
<tr>
<td><code>log.retention.bytes</code></td>
<td><strong>默认等于-1，表示无穷大</strong>。超过设置的所有日志总 大小，删除最早的 <code>segment</code>。</td>
</tr>
<tr>
<td><code>log.cleanup.policy</code></td>
<td><strong>默认是 delete，表示所有数据启用删除策略</strong>； 如果设置值为 <code>compact</code>，表示所有数据启用压缩策略。</td>
</tr>
<tr>
<td><code>num.io.threads</code></td>
<td><strong>默认是 8</strong>。负责写磁盘的线程数。整个参数值要占总核数的 50%。</td>
</tr>
<tr>
<td><code>num.replica.fetchers</code></td>
<td>副本拉取线程数，这个参数占总核数的 50%的 1/3</td>
</tr>
<tr>
<td><code>num.network.threads</code></td>
<td><strong>默认是 3</strong>。数据传输线程数，这个参数占总核数的 50%的 2/3 。</td>
</tr>
<tr>
<td><code>log.flush.interval.messages</code></td>
<td>强制页缓存刷写到磁盘的条数，<strong>默认是 long 的最大值</strong>，9223372036854775807。一般不建议修改， 交给系统自己管理。</td>
</tr>
<tr>
<td><code>log.flush.interval.ms</code></td>
<td>每隔多久，刷数据到磁盘，<strong>默认是 null</strong>。一般不建 议修改，交给系统自己管理。</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="服役新节点-x2F-退役旧节点"><a href="#服役新节点-x2F-退役旧节点" class="headerlink" title="服役新节点/退役旧节点"></a>服役新节点/退役旧节点</h4><ol>
<li><p>创建一个要均衡的主题</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建文件</span>
<span class="token punctuation">[</span>robert@cluster01 qing<span class="token punctuation">]</span>$ <span class="token function">vim</span> topics-to-move.json
<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span>
    <span class="token string">"topics"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"first"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>,
   <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>生成一个要均衡的主题</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --topics-to-move-json-file qing/topics-to-move.json --broker-list <span class="token string">"1,2,3,4"</span> --generate

<span class="token comment">#### 输出如下</span>
Current partition replica assignment
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Proposed partition reassignment configuration
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">4,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建副本存储计划（所有副本存储在 <code>broker0</code>、<code>broker1</code>、<code>broker2</code>、<code>broker3</code> 中）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json
<span class="token comment">############## 写入以下内容  ############## ## 这里就是上一步的数据</span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,3</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,4</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,2<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ############## </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute

<span class="token comment">#### 输出如下</span>
Current partition replica assignment

<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">4,2</span>,3<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,3</span>,1<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"first"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">3,1</span>,4<span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

Save this to use as the --reassignment-json-file option during rollback
Successfully started partition reassignments <span class="token keyword">for</span> first-0,first-1,first-2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>验证副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --verify

<span class="token comment">#### 输出如下</span>
Status of partition reassignment:
Reassignment of partition first-0 is complete.
Reassignment of partition first-1 is complete.
Reassignment of partition first-2 is complete.

Clearing broker-level throttles on brokers <span class="token number">1,2</span>,3,4
Clearing topic-level throttles on topic first<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="增加分区"><a href="#增加分区" class="headerlink" title="增加分区"></a>增加分区</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --alter --topic first --partitions <span class="token number">3</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="增加副本因子"><a href="#增加副本因子" class="headerlink" title="增加副本因子"></a>增加副本因子</h4><ol>
<li><p>创建 <code>topic</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">3</span> --replication-factor <span class="token number">1</span> --topic four<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>手动增加副本存储</p>
<ol>
<li><p>创建副本存储计划（所有副本都指定存储在 <code>broker0</code>、<code>broker1</code>、<code>broker2</code> 中）。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json

<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span><span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,<span class="token string">"partitions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span> <span class="token string">"four"</span>,<span class="token string">"partition"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,<span class="token string">"replicas"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
</li>
</ol>
<h4 id="手动调整分区副本存储"><a href="#手动调整分区副本存储" class="headerlink" title="手动调整分区副本存储"></a>手动调整分区副本存储</h4><p>手动调整分区副本存储的步骤如下：</p>
<ol>
<li><p>创建一个新的 <code>topic</code>，名称为 <code>three</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --create --partitions <span class="token number">4</span> --replication-factor <span class="token number">2</span> --topic three<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看分区副本存储情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic three

<span class="token comment">#### 输出如下</span>
Topic: three	TopicId: ObUlrwv3S0OPWkRfLGHvZg	PartitionCount: <span class="token number">4</span>	ReplicationFactor: <span class="token number">2</span>	Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
	Topic: three	Partition: <span class="token number">0</span>	Leader: <span class="token number">1</span>	Replicas: <span class="token number">1,2</span>	Isr: <span class="token number">1,2</span>
	Topic: three	Partition: <span class="token number">1</span>	Leader: <span class="token number">4</span>	Replicas: <span class="token number">4,3</span>	Isr: <span class="token number">4,3</span>
	Topic: three	Partition: <span class="token number">2</span>	Leader: <span class="token number">2</span>	Replicas: <span class="token number">2,1</span>	Isr: <span class="token number">2,1</span>
	Topic: three	Partition: <span class="token number">3</span>	Leader: <span class="token number">3</span>	Replicas: <span class="token number">3,4</span>	Isr: <span class="token number">3,4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建副本存储计划（所有副本都指定存储在 <code>broker0</code>、<code>broker1</code> 中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ <span class="token function">vim</span> qing/increase-replication-factor.json

<span class="token comment">############## 写入以下内容  ############## </span>
<span class="token punctuation">{</span><span class="token string">"version"</span>:1,<span class="token string">"partitions"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:0,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:1,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">1,2</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:2,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,1</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token builtin class-name">:</span><span class="token string">"three"</span>,<span class="token string">"partition"</span>:3,<span class="token string">"replicas"</span>:<span class="token punctuation">[</span><span class="token number">2,1</span><span class="token punctuation">]</span>,<span class="token string">"log_dirs"</span>:<span class="token punctuation">[</span><span class="token string">"any"</span>,<span class="token string">"any"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token comment">############## 写入以上内容  ##############</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --execute<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>验证副本存储计划</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-reassign-partitions.sh --bootstrap-server  cluster01:9092 --reassignment-json-file qing/increase-replication-factor.json --verify<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看分区副本存储情况</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --describe --topic three<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h4 id="Leader-Partition负载平衡"><a href="#Leader-Partition负载平衡" class="headerlink" title="Leader Partition负载平衡"></a>Leader Partition负载平衡</h4><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>auto.leader.rebalance.enable</code></td>
<td>**默认是 <code>true</code>**。 自动 <code>Leader Partition</code> 平衡。生产环境中，<code>leader</code> 重选举的代价比较大，可能会带来性能影响，建议设置为 <code>false</code> 关闭。</td>
</tr>
<tr>
<td><code>leader.imbalance.per.broker.percentage</code></td>
<td>**默认是 <code>10%</code>**。每个 <code>broker</code> 允许的不平衡的 <code>leader</code> 的比率。如果每个 <code>broker</code> 超过了这个值，控制器会触发 leader 的平衡。</td>
</tr>
<tr>
<td><code>leader.imbalance.check.interval.seconds</code></td>
<td><strong>默认值 300 秒</strong>。检查 <code>leader</code> 负载是否平衡的间隔 时间。</td>
</tr>
</tbody></table>
<h4 id="自动创建主题"><a href="#自动创建主题" class="headerlink" title="自动创建主题"></a>自动创建主题</h4><p>如果 <code>broker</code> 端配置参数 <code>auto.create.topics.enable</code> 设置为 <code>true</code>（默认值是 <code>true</code>），那么当生产者向一个未创建的主题发送消息时，会自动创建一个分区数为 <code>num.partitions</code>（默认值为 1）、副本因子为<code>default.replication.factor</code>（默认值为 1）的主题。除此之外，当一个消费者开始从未知主题中读取消息时，或者当任意一个客户端向未知主题发送元数据请求时，都会自动创建一个相应主题。<strong>这种创建主题的方式是非预期的，增加了主题管理和维护的难度。</strong> </p>
<p><strong>生产环境建议将该参数设置为 false</strong>。</p>
<h3 id="Kafka消费者-1"><a href="#Kafka消费者-1" class="headerlink" title="Kafka消费者"></a>Kafka消费者</h3><h4 id="Kafka消费者核心参数配置"><a href="#Kafka消费者核心参数配置" class="headerlink" title="Kafka消费者核心参数配置"></a>Kafka消费者核心参数配置</h4><img src="/2023/09/16/cs-data/data-kafka3-learn/image-035.png" class="" title="image-035">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-036.png" class="" title="image-036">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>bootstrap.servers</code></td>
<td>向 <code>Kafka</code> 集群建立初始连接用到的 <code>host/port</code> 列表。</td>
</tr>
<tr>
<td><code>key.deserializer</code></td>
<td>指定接收消息的 <code>key</code> 的反序列化类型。<strong>一定要写全类名</strong>。</td>
</tr>
<tr>
<td><code>value.deserializer</code></td>
<td>指定接收消息的  <code>value</code> 的反序列化类型。<strong>一定要写全类名</strong>。</td>
</tr>
<tr>
<td><code>group.id</code></td>
<td>标记消费者所属的消费者组。</td>
</tr>
<tr>
<td><code>enable.auto.commit</code></td>
<td><strong>默认值为 true</strong>，消费者会自动周期性地向服务器提交偏移量。</td>
</tr>
<tr>
<td><code>auto.commit.interval.ms</code></td>
<td>如果设置了 <code>enable.auto.commit</code> 的值为 <code>true</code>， 则该值定义了 消费者偏移量向 <code>Kafka</code> 提交的频率，<strong>默认 5s</strong>。</td>
</tr>
<tr>
<td><code>auto.offset.reset</code></td>
<td>当 <code>Kafka</code> 中没有初始偏移量或当前偏移量在服务器中不存在 （如，数据被删除了），该如何处理？ <br><code>earliest</code>：自动重置偏移量到最早的偏移量。 <br><code>latest</code>：<strong>默认</strong>，自动重置偏移量为最新的偏移量。<br> <code>none</code>：如果消费组原来的（<code>previous</code>）偏移量 不存在，则向消费者抛异常。<br> <code>anything</code>：向消费者抛异常。</td>
</tr>
<tr>
<td><code>offsets.topic.num.partitions</code></td>
<td><code>__consumer_offsets</code> 的分区数，<strong>默认是 50 个分区</strong>。</td>
</tr>
<tr>
<td><code>heartbeat.interval.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间的心跳时间，<strong>默认 3s</strong>。 该条目的值必须小于 <code>session.timeout.ms</code> ，也不应该高于 <code>session.timeout.ms</code> 的 <code>1/3</code>。</td>
</tr>
<tr>
<td><code>session.timeout.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间连接超时时间，<strong>默认 45s</strong>。 超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>max.poll.interval.ms</code></td>
<td>消费者处理消息的最大时长，<strong>默认是 5 分钟</strong>。超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>fetch.min.bytes</code></td>
<td><strong>默认 1 个字节</strong>。消费者获取服务器端一批消息最小的字节 数。</td>
</tr>
<tr>
<td><code>fetch.max.wait.ms</code></td>
<td><strong>默认 500ms</strong>。如果没有从服务器端获取到一批数据的最小字节数。该时间到，仍然会返回数据。</td>
</tr>
<tr>
<td><code>fetch.max.bytes</code></td>
<td><strong>默认 Default: 52428800（50 m）</strong>。消费者获取服务器端一批消息最大的字节数。如果服务器端一批次的数据大于该值 （50m）仍然可以拉取回来这批数据，因此，这不是一个绝 对最大值。一批次的大小受 <code>message.max.bytes</code> （<code>broker  config</code>）或 <code>max.message.bytes</code> （<code>topic config</code>）影响。</td>
</tr>
<tr>
<td><code>max.poll.records</code></td>
<td>一次 <code>poll</code> 拉取数据返回消息的最大条数，<strong>默认是 500 条</strong>。</td>
</tr>
</tbody></table>
<h4 id="消费者再平衡"><a href="#消费者再平衡" class="headerlink" title="消费者再平衡"></a>消费者再平衡</h4><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>heartbeat.interval.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间的心跳时间，<strong>默认 3s</strong>。 该条目的值必须小于 <code>session.timeout.ms</code>，也不应该高于 <code>session.timeout.ms</code> 的 1/3。</td>
</tr>
<tr>
<td><code>session.timeout.ms</code></td>
<td><code>Kafka</code> 消费者和 <code>coordinator</code> 之间连接超时时间，<strong>默认 45s</strong>。超 过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>max.poll.interval.ms</code></td>
<td>消费者处理消息的最大时长，<strong>默认是 5 分钟</strong>。超过该值，该消费者被移除，消费者组执行再平衡。</td>
</tr>
<tr>
<td><code>partition.assignment.strategy</code></td>
<td>消 费 者 分 区 分 配 策 略 ， 默 认 策 略 是 <code>Range + CooperativeSticky</code>。<code>Kafka</code> 可以同时使用多个分区分配策略。 可 以 选 择 的 策 略 包 括 ： <code>Range</code> 、 <code>RoundRobin</code> 、 <code>Sticky</code> 、 <code>CooperativeSticky</code>。**默认策略是<code>Range + CooperativeSticky</code>**。</td>
</tr>
</tbody></table>
<h4 id="指定Offset消费-1"><a href="#指定Offset消费-1" class="headerlink" title="指定Offset消费"></a>指定Offset消费</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java">kafkaConsumer<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="指定时间消费-1"><a href="#指定时间消费-1" class="headerlink" title="指定时间消费"></a>指定时间消费</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timestampToSearch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
timestampToSearch<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kafkaConsumer<span class="token punctuation">.</span><span class="token function">offsetsForTimes</span><span class="token punctuation">(</span>timestampToSearch<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="消费者事务"><a href="#消费者事务" class="headerlink" title="消费者事务"></a>消费者事务</h4><p>如果想完成<code>Consumer</code>端的精准一次性消费，那么需要<code>Kafka</code>消费端将消费过程和提交<code>offset</code> 过程做原子绑定。此时我们需要将<code>Kafka</code>的<code>offset</code>保存到支持事务的自定义介质（比如<code>MySQL</code>）。这部分知识见上面<strong>入门–生产者–数据去重–生产者事务</strong>部分。</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-049.png" class="" title="image-049">

<h4 id="消费者如何提高吞吐量"><a href="#消费者如何提高吞吐量" class="headerlink" title="消费者如何提高吞吐量"></a>消费者如何提高吞吐量</h4><p><strong>增加分区数</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 --alter --topic first --partitions <span class="token number">3</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-050.png" class="" title="image-050">

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>fetch.max.bytes</code></td>
<td><strong>默认 Default: 52428800（50 m）</strong>。消费者获取服务器端一批 消息最大的字节数。如果服务器端一批次的数据大于该值 （50m）仍然可以拉取回来这批数据，因此，这不是一个绝对最大值。一批次的大小受 <code>message.max.bytes</code> （broker  config）或 <code>max.message.bytes</code> （topic config）影响。</td>
</tr>
<tr>
<td><code>max.poll.records</code></td>
<td>一次 poll 拉取数据返回消息的最大条数，<strong>默认是 500 条</strong>。</td>
</tr>
</tbody></table>
<h3 id="Kafka总体"><a href="#Kafka总体" class="headerlink" title="Kafka总体"></a>Kafka总体</h3><h4 id="如何提升吞吐量"><a href="#如何提升吞吐量" class="headerlink" title="如何提升吞吐量"></a>如何提升吞吐量</h4><ol>
<li>提升生产吞吐量 <ol>
<li><code>buffer.memory</code>：发送消息的缓冲区大小，<strong>默认值是 32m</strong>，可以增加到 <code>64m</code>。</li>
<li><code>batch.size</code>：<strong>默认是 16k</strong>。如果 <code>batch</code> 设置太小，会导致频繁网络请求，吞吐量下降； 如果 <code>batch</code> 太大，会导致一条消息需要等待很久才能被发送出去，增加网络延时。</li>
<li><code>linger.ms</code>：这个值，<strong>默认是 0</strong>，意思就是消息必须立即被发送。一般设置一个 5-100 毫秒。如果 <code>linger.ms</code> 设置的太小，会导致频繁网络请求，吞吐量下降；如果 <code>linger.ms</code> 太长， 会导致一条消息需要等待很久才能被发送出去，增加网络延时。</li>
<li><code>compression.type</code>：<strong>默认是 none</strong>，不压缩，但是也可以使用 <code>lz4</code> 压缩，效率还是不 错的，压缩之后可以减小数据量，提升吞吐量，但是会加大 <code>producer</code> 端的 <code>CPU</code> 开销。</li>
</ol>
</li>
<li>增加分区 </li>
<li>消费者提高吞吐量<ol>
<li>调整 <code>fetch.max.bytes</code> 大小，默认是 <code>50m</code>。</li>
<li>调整 <code>max.poll.records</code> 大小，默认是 <code>500</code> 条。</li>
</ol>
</li>
<li>增加下游消费者处理能力</li>
</ol>
<h4 id="数据精准一次"><a href="#数据精准一次" class="headerlink" title="数据精准一次"></a>数据精准一次</h4><ol>
<li>生产者角度<ol>
<li><code>acks</code> 设置为<code>-1</code> （<code>acks=-1</code>）。</li>
<li>幂等性（<code>enable.idempotence = true</code>） + 事务 。</li>
</ol>
</li>
<li><code>broker</code> 服务端角度<ol>
<li>分区副本大于等于 2 （<code>--replication-factor 2</code>）。</li>
<li><code>ISR</code> 里应答的最小副本数量大于等于 2 （<code>min.insync.replicas = 2</code>）。</li>
</ol>
</li>
<li>消费者<ol>
<li>**事务 + 手动提交 <code>offset</code> **（<code>enable.auto.commit = false</code>）。</li>
<li>消费者输出的目的地必须支持事务（<code>MySQL</code>、<code>Kafka</code>）。</li>
</ol>
</li>
</ol>
<h4 id="合理设置分区数"><a href="#合理设置分区数" class="headerlink" title="合理设置分区数"></a>合理设置分区数</h4><ol>
<li>创建一个只有 1 个分区的 <code>topic</code>。</li>
<li>测试这个 <code>topic</code> 的 <code>producer</code> 吞吐量和 <code>consumer</code> 吞吐量。</li>
<li>假设他们的值分别是 <code>Tp</code> 和 <code>Tc</code>，单位可以是 <code>MB/s</code>。</li>
<li>然后假设总的目标吞吐量是 <code>Tt</code>，那么分区数 = <code>Tt / min（Tp，Tc）</code>。</li>
</ol>
<p>例如：<code>producer</code> 吞吐量 = <code>20m/s</code>；<code>consumer</code> 吞吐量 = <code>50m/s</code>，期望吞吐量 <code>100m/s</code>；</p>
<p>分区数 = 100 / 20 = 5 分区</p>
<p>分区数一般设置为：3-10 个</p>
<p>分区数不是越多越好，也不是越少越好，需要搭建完集群，进行压测，再灵活调整分区 个数。</p>
<h4 id="单条日志大于-1m"><a href="#单条日志大于-1m" class="headerlink" title="单条日志大于 1m"></a>单条日志大于 1m</h4><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>message.max.bytes</code></td>
<td><strong>默认 1m</strong>，broker 端接收每个批次消息最大值。</td>
</tr>
<tr>
<td><code>max.request.size</code></td>
<td><strong>默认 1m</strong>，生产者发往 broker 每个请求消息最大值。针对 topic 级别设置消息体的大小。</td>
</tr>
<tr>
<td><code>repica.fetch.max.bytes</code></td>
<td><strong>默认 1m</strong>，副本同步数据，每个批次消息最大值。</td>
</tr>
<tr>
<td><code>fetch.max.bytes</code></td>
<td><strong>默认 Default: 52428800（50 m）</strong>。<strong>消费者</strong>获取服务器端一批 消息最大的字节数。如果服务器端一批次的数据大于该值 （<code>50m</code>）仍然可以拉取回来这批数据，因此，这不是一个绝对 最大值。一批次的大小受 <code>message.max.bytes</code> （<code>broker config</code>） or <code>max.message.bytes</code> （<code>topic config</code>）影响。</td>
</tr>
</tbody></table>
<h4 id="服务器挂了"><a href="#服务器挂了" class="headerlink" title="服务器挂了"></a>服务器挂了</h4><p>在生产环境中，如果某个 Kafka 节点挂掉。</p>
<p>正常处理办法：</p>
<ol>
<li>先尝试重新启动一下，如果能启动正常，那直接解决。</li>
<li>如果重启不行，考虑增加内存、增加 CPU、网络带宽。</li>
<li>如果将 <code>kafka</code> 整个节点误删除，如果副本数大于等于 2，可以按照服役新节点的方式重新服役一个新节点，并执行负载均衡。</li>
</ol>
<h4 id="集群压力测试"><a href="#集群压力测试" class="headerlink" title="集群压力测试"></a>集群压力测试</h4><h5 id="Kafka压测"><a href="#Kafka压测" class="headerlink" title="Kafka压测"></a>Kafka压测</h5><p>用 <code>Kafka</code> 官方自带的脚本，对 <code>Kafka</code> 进行压测</p>
<ul>
<li>生产者压测：<code>kafka-producer-perf-test.sh</code></li>
<li>消费者压测：<code>kafka-consumer-perf-test.sh</code></li>
</ul>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-069.png" class="" title="image-069">

<h5 id="Kafka-Producer-压力测试"><a href="#Kafka-Producer-压力测试" class="headerlink" title="Kafka Producer 压力测试"></a>Kafka Producer 压力测试</h5><ol>
<li><p>创建一个 <code>topic</code> ： <code>test</code>，设置为 3 个分区 3 个副本</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-topics.sh --bootstrap-server cluster01:9092 -create --replication-factor <span class="token number">3</span> --partitions <span class="token number">3</span> --topic <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>在<code>/opt/qing/module/kafka/bin</code> 目录下面有这两个文件，可以进行以下测试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">16384</span> linger.ms<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># record-size  一条信息有多大，单位是字节</span>
<span class="token comment"># num-records  总共发送多少条信息</span>
<span class="token comment"># throughput  每秒多少条信息，设成-1，表示不限流，尽可能快的生产数据，可测出生产者最大吞吐量</span>
<span class="token comment"># producer-props 后面可以配置生产者相关参数，batch.size 配置为 16k</span>

<span class="token comment">#### 输出如下</span>
<span class="token number">49934</span> records sent, <span class="token number">9984.8</span> records/sec <span class="token punctuation">(</span><span class="token number">9.75</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">170.9</span> ms avg latency, <span class="token number">702.0</span> ms max latency.
<span class="token number">50068</span> records sent, <span class="token number">9977.7</span> records/sec <span class="token punctuation">(</span><span class="token number">9.74</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.6</span> ms avg latency, <span class="token number">42.0</span> ms max latency.
<span class="token number">50050</span> records sent, <span class="token number">10010.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.78</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.0</span> ms avg latency, <span class="token number">82.0</span> ms max latency.
<span class="token number">50077</span> records sent, <span class="token number">10015.4</span> records/sec <span class="token punctuation">(</span><span class="token number">9.78</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">4.4</span> ms avg latency, <span class="token number">27.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">49965</span> records sent, <span class="token number">9985.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.75</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">3.1</span> ms avg latency, <span class="token number">21.0</span> ms max latency.
<span class="token number">45756</span> records sent, <span class="token number">9123.8</span> records/sec <span class="token punctuation">(</span><span class="token number">8.91</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">3.1</span> ms avg latency, <span class="token number">453.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9998.600196</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">950.46</span> ms avg latency, <span class="token number">18248.00</span> ms max latency, <span class="token number">5</span> ms 50th, <span class="token number">6518</span> ms 95th, <span class="token number">16828</span> ms 99th, <span class="token number">18026</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-070.png" class="" title="image-070">
</li>
<li><p>调整 <code>batch.size</code> 大小</p>
<ol>
<li><p><code>batch.size</code> 默认值是 16k。本次实验 <code>batch.size</code> 设置为 32k</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">32768</span> linger.ms<span class="token operator">=</span><span class="token number">0</span>

<span class="token comment">#### 输出如下</span>
<span class="token number">49992</span> records sent, <span class="token number">9998.4</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">4.3</span> ms avg latency, <span class="token number">217.0</span> ms max latency.
<span class="token number">50010</span> records sent, <span class="token number">10002.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.77</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">3.0</span> ms avg latency, <span class="token number">23.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">50176</span> records sent, <span class="token number">10035.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.80</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">3.9</span> ms avg latency, <span class="token number">63.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9998.000400</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">223.55</span> ms avg latency, <span class="token number">5488.00</span> ms max latency, <span class="token number">3</span> ms 50th, <span class="token number">2185</span> ms 95th, <span class="token number">4476</span> ms 99th, <span class="token number">5340</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-071.png" class="" title="image-071">
</li>
<li><p>本次实验 <code>batch.size</code> 设置为 4k</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">0</span>

<span class="token comment">#### 输出如下</span>
<span class="token number">41649</span> records sent, <span class="token number">8329.8</span> records/sec <span class="token punctuation">(</span><span class="token number">8.13</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">67.0</span> ms avg latency, <span class="token number">1196.0</span> ms max latency.
<span class="token number">49159</span> records sent, <span class="token number">2640.5</span> records/sec <span class="token punctuation">(</span><span class="token number">2.58</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">191.3</span> ms avg latency, <span class="token number">14543.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">72315</span> records sent, <span class="token number">14463.0</span> records/sec <span class="token punctuation">(</span><span class="token number">14.12</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">3283.6</span> ms avg latency, <span class="token number">7410.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">8248.034906</span> records/sec <span class="token punctuation">(</span><span class="token number">8.05</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">2712.04</span> ms avg latency, <span class="token number">27927.00</span> ms max latency, <span class="token number">2011</span> ms 50th, <span class="token number">9893</span> ms 95th, <span class="token number">27832</span> ms 99th, <span class="token number">27922</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-072.png" class="" title="image-072"></li>
</ol>
</li>
<li><p>调整 <code>linger.ms</code> 时间</p>
<p><code>linger.ms</code> 默认是 <code>0ms</code>。本次实验 <code>linger.ms</code> 设置为 <code>50ms</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span>

<span class="token comment">#### 输出如下</span>
<span class="token number">48835</span> records sent, <span class="token number">9767.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.54</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">31.3</span> ms avg latency, <span class="token number">195.0</span> ms max latency.
<span class="token number">45282</span> records sent, <span class="token number">9056.4</span> records/sec <span class="token punctuation">(</span><span class="token number">8.84</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">102.9</span> ms avg latency, <span class="token number">778.0</span> ms max latency
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">49992</span> records sent, <span class="token number">9996.4</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.2</span> ms avg latency, <span class="token number">31.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9997.800484</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">329.75</span> ms avg latency, <span class="token number">5294.00</span> ms max latency, <span class="token number">6</span> ms 50th, <span class="token number">1538</span> ms 95th, <span class="token number">4984</span> ms 99th, <span class="token number">5276</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-073.png" class="" title="image-073">
</li>
<li><p>调整压缩方式</p>
<ol>
<li><p>默认的压缩方式是 <code>none</code>。本次实验 <code>compression.type</code> 设置为 <code>snappy</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span> compression.type<span class="token operator">=</span>snappy

<span class="token comment">#### 输出如下</span>
<span class="token number">49976</span> records sent, <span class="token number">9995.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">136.1</span> ms avg latency, <span class="token number">540.0</span> ms max latency.
<span class="token number">49891</span> records sent, <span class="token number">9978.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.74</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">6.0</span> ms avg latency, <span class="token number">59.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">50091</span> records sent, <span class="token number">10018.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.78</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">6.7</span> ms avg latency, <span class="token number">88.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9999.000100</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">12.35</span> ms avg latency, <span class="token number">540.00</span> ms max latency, <span class="token number">5</span> ms 50th, <span class="token number">15</span> ms 95th, <span class="token number">349</span> ms 99th, <span class="token number">514</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-074.png" class="" title="image-074">
</li>
<li><p>本次实验 <code>compression.type</code> 设置为 <code>zstd</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span> compression.type<span class="token operator">=</span>zstd

<span class="token comment">#### 输出如下</span>
<span class="token number">49939</span> records sent, <span class="token number">9973.8</span> records/sec <span class="token punctuation">(</span><span class="token number">9.74</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">18.6</span> ms avg latency, <span class="token number">209.0</span> ms max latency.
<span class="token number">50031</span> records sent, <span class="token number">10006.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.77</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.0</span> ms avg latency, <span class="token number">61.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">49957</span> records sent, <span class="token number">9977.4</span> records/sec <span class="token punctuation">(</span><span class="token number">9.74</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">4.9</span> ms avg latency, <span class="token number">69.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9997.900441</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">147.11</span> ms avg latency, <span class="token number">3467.00</span> ms max latency, <span class="token number">5</span> ms 50th, <span class="token number">1310</span> ms 95th, <span class="token number">2893</span> ms 99th, <span class="token number">3415</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-075.png" class="" title="image-074">
</li>
<li><p>本次实验 <code>compression.type</code> 设置为 <code>gzip</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span> compression.type<span class="token operator">=</span>gzip

<span class="token comment">#### 输出如下</span>
<span class="token number">49958</span> records sent, <span class="token number">9991.6</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">19.4</span> ms avg latency, <span class="token number">296.0</span> ms max latency.
<span class="token number">49958</span> records sent, <span class="token number">9991.6</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">4.0</span> ms avg latency, <span class="token number">20.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">49984</span> records sent, <span class="token number">9996.8</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">4.5</span> ms avg latency, <span class="token number">20.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9998.500225</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.54</span> ms avg latency, <span class="token number">296.00</span> ms max latency, <span class="token number">4</span> ms 50th, <span class="token number">9</span> ms 95th, <span class="token number">50</span> ms 99th, <span class="token number">161</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-076.png" class="" title="image-076">
</li>
<li><p>本次实验 <code>compression.type</code> 设置为 <code>lz4</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span> compression.type<span class="token operator">=</span>lz4

<span class="token comment">#### 输出如下</span>
<span class="token number">49869</span> records sent, <span class="token number">9965.8</span> records/sec <span class="token punctuation">(</span><span class="token number">9.73</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">18.1</span> ms avg latency, <span class="token number">233.0</span> ms max latency.
<span class="token number">50135</span> records sent, <span class="token number">10027.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.79</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">6.0</span> ms avg latency, <span class="token number">51.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.
<span class="token number">50110</span> records sent, <span class="token number">10022.0</span> records/sec <span class="token punctuation">(</span><span class="token number">9.79</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">7.6</span> ms avg latency, <span class="token number">87.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9998.100361</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">10.42</span> ms avg latency, <span class="token number">341.00</span> ms max latency, <span class="token number">5</span> ms 50th, <span class="token number">22</span> ms 95th, <span class="token number">180</span> ms 99th, <span class="token number">299</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-077.png" class="" title="image-077"></li>
</ol>
</li>
<li><p>调整缓存大小</p>
<p>默认生产者端缓存大小 <code>32m</code>。本次实验 <code>buffer.memory</code> 设置为 <code>64m</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-producer-perf-test.sh --topic <span class="token builtin class-name">test</span> --record-size <span class="token number">1024</span> --num-records <span class="token number">1000000</span> --throughput <span class="token number">10000</span> --producer-props bootstrap.servers<span class="token operator">=</span>cluster01:9092,cluster02:9092,cluster03:9092 batch.size<span class="token operator">=</span><span class="token number">4096</span> linger.ms<span class="token operator">=</span><span class="token number">50</span> buffer.memory<span class="token operator">=</span><span class="token number">67108864</span>

<span class="token comment">#### 输出如下</span>
<span class="token number">49866</span> records sent, <span class="token number">9973.2</span> records/sec <span class="token punctuation">(</span><span class="token number">9.74</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">114.3</span> ms avg latency, <span class="token number">302.0</span> ms max latency.
<span class="token number">50027</span> records sent, <span class="token number">10005.4</span> records/sec <span class="token punctuation">(</span><span class="token number">9.77</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">7.7</span> ms avg latency, <span class="token number">79.0</span> ms max latency.
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token number">49533</span> records sent, <span class="token number">9906.6</span> records/sec <span class="token punctuation">(</span><span class="token number">9.67</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">5.6</span> ms avg latency, <span class="token number">76.0</span> ms max latency.
<span class="token number">1000000</span> records sent, <span class="token number">9998.200324</span> records/sec <span class="token punctuation">(</span><span class="token number">9.76</span> MB/sec<span class="token punctuation">)</span>, <span class="token number">11.36</span> ms avg latency, <span class="token number">302.00</span> ms max latency, <span class="token number">5</span> ms 50th, <span class="token number">30</span> ms 95th, <span class="token number">220</span> ms 99th, <span class="token number">278</span> ms <span class="token number">99</span>.9th.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-078.png" class="" title="image-078"></li>
</ol>
<h5 id="Kafka-Consumer-压力测试"><a href="#Kafka-Consumer-压力测试" class="headerlink" title="Kafka Consumer 压力测试"></a>Kafka Consumer 压力测试</h5><ol>
<li><p>修改<code>/opt/qing/module/kafka/config/consumer.properties</code> 文件中的一次拉取条数为 <code>500</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">max.poll.records<span class="token operator">=</span><span class="token number">500</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>消费 <code>100</code> 万条日志进行压测</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-consumer-perf-test.sh --bootstrap-server cluster01:9092,cluster02:9092,cluster03:9092 --topic <span class="token builtin class-name">test</span> --messages <span class="token number">1000000</span> --consumer.config config/consumer.properties
<span class="token comment"># --bootstrap-server  指定 Kafka 集群地址</span>
<span class="token comment"># --topic  指定 topic 的名称</span>
<span class="token comment"># --messages  总共要消费的消息个数。本次实验 100 万条</span>

<span class="token comment">#### 输出如下</span>
start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec
<span class="token number">2023</span>-09-13 <span class="token number">23</span>:08:23:085, <span class="token number">2023</span>-09-13 <span class="token number">23</span>:08:33:116, <span class="token number">0.0000</span>, <span class="token number">0.0000</span>, <span class="token number">0</span>, <span class="token number">0.0000</span>, <span class="token number">0</span>, <span class="token number">10031</span>, <span class="token number">0.0000</span>, <span class="token number">0.0000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改<code>/opt/qing/module/kafka/config/consumer.properties</code> 文件中的一次拉取条数为 <code>2000</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 再次执行</span>
<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-consumer-perf-test.sh --bootstrap-server cluster01:9092,cluster02:9092,cluster03:9092 --topic <span class="token builtin class-name">test</span> --messages <span class="token number">1000000</span> --consumer.config config/consumer.properties

<span class="token comment">#### 输出如下</span>
start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec
<span class="token number">2023</span>-09-13 <span class="token number">23</span>:09:44:507, <span class="token number">2023</span>-09-13 <span class="token number">23</span>:09:54:615, <span class="token number">0.0000</span>, <span class="token number">0.0000</span>, <span class="token number">0</span>, <span class="token number">0.0000</span>, <span class="token number">0</span>, <span class="token number">10108</span>, <span class="token number">0.0000</span>, <span class="token number">0.0000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改<code>/opt/qing/module/kafka/config/consumer.properties</code> 文件中的拉取一批数据大小 <code>100m</code>，调整 <code>fetch.max.bytes</code> 大小为 <code>100m</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># fetch.max.bytes=104857600</span>


<span class="token punctuation">[</span>robert@cluster01 kafka<span class="token punctuation">]</span>$ bin/kafka-consumer-perf-test.sh --bootstrap-server cluster01:9092,cluster02:9092,cluster03:9092 --topic <span class="token builtin class-name">test</span> --messages <span class="token number">1000000</span> --consumer.config config/consumer.properties

<span class="token comment">#### 输出如下</span>
start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec
<span class="token number">2023</span>-09-13 <span class="token number">23</span>:13:30:957, <span class="token number">2023</span>-09-13 <span class="token number">23</span>:13:34:387, <span class="token number">976.6885</span>, <span class="token number">284.7488</span>, <span class="token number">1000129</span>, <span class="token number">291582.7988</span>, <span class="token number">332</span>, <span class="token number">3098</span>, <span class="token number">315.2642</span>, <span class="token number">322830.5358</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><blockquote>
<p>loading…</p>
</blockquote>
<h3 id="源码环境准备"><a href="#源码环境准备" class="headerlink" title="源码环境准备"></a>源码环境准备</h3><h4 id="源码下载地址"><a href="#源码下载地址" class="headerlink" title="源码下载地址"></a>源码下载地址</h4><p><a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads">下载地址</a>：<a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-079.png" class="" title="image-079">

<h4 id="安装JDK-amp-Scala"><a href="#安装JDK-amp-Scala" class="headerlink" title="安装JDK&amp;Scala"></a>安装JDK&amp;Scala</h4><ul>
<li><p>需要安装<code>JDK 8</code> 或者 <code>JDK 8</code> 以上版本</p>
<p>同站文章<a href="https://robertsunq.github.io/2023/08/12/cs-languages/cs-install-java/">Java安装</a></p>
</li>
<li><p>需要安装 <code>Scala2.12</code></p>
<p>需要先安装 <code>Java 8</code></p>
<ol>
<li><p>下载 <a target="_blank" rel="noopener" href="https://scala-lang.org/download/">Scala</a>，<a target="_blank" rel="noopener" href="https://github.com/lampepfl/dotty/tree/main">GitHub-Scala</a></p>
</li>
<li><p>解压到本地</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-080.png" class="" title="image-080">
</li>
<li><p>配置环境变量</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-081.png" class="" title="image-081">
</li>
<li><p>验证</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-082.png" class="" title="image-082"></li>
</ol>
</li>
</ul>
<h4 id="安装Gradle"><a href="#安装Gradle" class="headerlink" title="安装Gradle"></a>安装Gradle</h4><p><code>Gradle</code> 是类似于 <code>maven</code> 的代码管理工具。安卓程序管理通常采用 <code>Gradle</code>。</p>
<blockquote>
<p>需要先安装 <code>Java 8</code></p>
</blockquote>
<ol>
<li><p>下载页面 <a target="_blank" rel="noopener" href="https://gradle.org/releases/">Gradle</a>：<a target="_blank" rel="noopener" href="https://gradle.org/releases/">https://gradle.org/releases/</a></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-083.png" class="" title="image-083">
</li>
<li><p>解压到合适的目录</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-084.png" class="" title="image-084">
</li>
<li><p>配置环境变量</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-085.png" class="" title="image-085">

<img src="/2023/09/16/cs-data/data-kafka3-learn/image-086.png" class="" title="image-086">
</li>
<li><p>验证</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-087.png" class="" title="image-087">
</li>
<li><p><strong>配置下载源</strong></p>
<p><code>Gradle</code>自带 <code>Maven</code>下载源是国外的，在后续下载依赖的过程中会比较慢。这里我们需要将下载源换成国内镜像</p>
<p>新建并打开<code>init.gradle</code>文件，将下面的内容粘贴到文件中</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-088.png" class="" title="image-088">

<pre class="line-numbers language-python" data-language="python"><code class="language-python">allprojects <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span> 
        mavenLocal<span class="token punctuation">(</span><span class="token punctuation">)</span> 
        maven <span class="token punctuation">{</span> name <span class="token string">"Alibaba"</span> <span class="token punctuation">;</span> url <span class="token string">"https://maven.aliyun.com/repository/public"</span> <span class="token punctuation">}</span> 
        maven <span class="token punctuation">{</span> name <span class="token string">"Bstek"</span> <span class="token punctuation">;</span> url <span class="token string">"https://nexus.bsdn.org/content/groups/public/"</span> <span class="token punctuation">}</span> 
        mavenCentral<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    buildscript <span class="token punctuation">{</span>
        repositories <span class="token punctuation">{</span> 
            maven <span class="token punctuation">{</span> name <span class="token string">"Alibaba"</span> <span class="token punctuation">;</span> url <span class="token string">'https://maven.aliyun.com/repository/public'</span> <span class="token punctuation">}</span> 
            maven <span class="token punctuation">{</span> name <span class="token string">"Bstek"</span> <span class="token punctuation">;</span> url <span class="token string">'https://nexus.bsdn.org/content/groups/public/'</span> <span class="token punctuation">}</span> 
            maven <span class="token punctuation">{</span> name <span class="token string">"M2"</span> <span class="token punctuation">;</span> url <span class="token string">'https://plugins.gradle.org/m2/'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


</li>
<li><p><code>IDEA</code> 中的配置</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-089.png" class="" title="image-089"></li>
</ol>
<h3 id="生产者源码"><a href="#生产者源码" class="headerlink" title="生产者源码"></a>生产者源码</h3><p><strong>发送流程如下</strong></p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-008.png" class="" title="image-008">

<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>生产者 <code>main</code> 线程初始化</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-090.png" class="" title="image-090">

<p>生产者 <code>sender</code> 线程初始化</p>
<img src="/2023/09/16/cs-data/data-kafka3-learn/image-091.png" class="" title="image-091">

<h5 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h5><h4 id="发送数据到缓冲区"><a href="#发送数据到缓冲区" class="headerlink" title="发送数据到缓冲区"></a>发送数据到缓冲区</h4><h4 id="sender线程发送数据"><a href="#sender线程发送数据" class="headerlink" title="sender线程发送数据"></a>sender线程发送数据</h4><h3 id="消费者源码"><a href="#消费者源码" class="headerlink" title="消费者源码"></a>消费者源码</h3><h4 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h4><h4 id="消费者订阅主题"><a href="#消费者订阅主题" class="headerlink" title="消费者订阅主题"></a>消费者订阅主题</h4><h4 id="消费者拉取和处理数据"><a href="#消费者拉取和处理数据" class="headerlink" title="消费者拉取和处理数据"></a>消费者拉取和处理数据</h4><h4 id="消费者Offset提交"><a href="#消费者Offset提交" class="headerlink" title="消费者Offset提交"></a>消费者Offset提交</h4><h4 id="服务器源码"><a href="#服务器源码" class="headerlink" title="服务器源码"></a>服务器源码</h4><h3 id="程序入口-1"><a href="#程序入口-1" class="headerlink" title="程序入口"></a>程序入口</h3><hr>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vr4y1677k?p=1&amp;vd_source=524a1f1a08bc3654682c93e61bb0b959">尚硅谷 kafka3.x教程</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io" rel="external nofollow noreferrer">Robert Sunq</a>
                    </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://robertsunq.github.io/2023/09/16/cs-data/data-kafka3-learn/">https://robertsunq.github.io/2023/09/16/cs-data/data-kafka3-learn/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-SA 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://robertsunq.github.io" target="_blank">Robert Sunq</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/note/">
                                    <span class="chip bg-color">note</span>
                                </a>
                            
                                <a href="/tags/%E9%83%A8%E5%88%86%E5%8E%9F%E5%88%9B/">
                                    <span class="chip bg-color">部分原创</span>
                                </a>
                            
                                <a href="/tags/kafka/">
                                    <span class="chip bg-color">kafka</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/03/20/cs-program-design/cs-design-pattern/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="设计模式">
                        
                        <span class="card-title">设计模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            设计模式，java版
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-03-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cs-program-design/" class="post-category">
                                    cs-program-design
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/note/">
                        <span class="chip bg-color">note</span>
                    </a>
                    
                    <a href="/tags/%E9%83%A8%E5%88%86%E5%8E%9F%E5%88%9B/">
                        <span class="chip bg-color">部分原创</span>
                    </a>
                    
                    <a href="/tags/cs-program-design/">
                        <span class="chip bg-color">cs-program-design</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/08/14/cs-dev-ops/ops-zookeeper-learn/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Zookeeper学习笔记">
                        
                        <span class="card-title">Zookeeper学习笔记</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            基于尚硅谷的视频 Zookeeper 教程学习笔记
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-08-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cs-dev-ops/" class="post-category">
                                    cs-dev-ops
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/zookeeper/">
                        <span class="chip bg-color">zookeeper</span>
                    </a>
                    
                    <a href="/tags/zk/">
                        <span class="chip bg-color">zk</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Qing<br />'
            + '文章作者: Robert Sunq<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '<原创文章> 著作权归Robert Sunq所有，<转载文章> 著作权归原作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2024</span>
            
            <a href="/about" target="_blank">Robert Sunq</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">244.4k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/RobertSunq" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:loading@xx.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=loading..." class="tooltipped" target="_blank" data-tooltip="QQ联系我: loading..." data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"left","width":150,"height":350},"mobile":{"show":true},"log":false});</script></body>

</html>
